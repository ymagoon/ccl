const express = require("express");
const serveIndex = require("serve-index");

const serveStatic = (folders, req, res, next) => {
    const folderName = req.url.split("/")[1];
    req.url = req.url.substr(folderName.length + 1);
    if (!folders[folderName]) {
        res
            .status(404)
            .send([
                `Could not find the alias: "${folderName}". `,
                "Make sure that the alias exists in the plugin ",
                "configuration. This can be done by accessing the ",
                "Content Server settings on the web interface."
            ].join(""));
        return;
    };
    express.static(folders[folderName])(req, res, next);
};

const content = (gaia, args, req, res, next) => {
    gaia.runCommand(
        "contentserver",
        "allFolders",
        args
    )
    .then(
        (folders) => {
            req.url = req.url.substr("/contentserver/content".length);
            if (req.url == "") {
                req.url = "/";
            }
            serveStatic(folders, req, res, next);
        }
    );
};

module.exports = {
    content
};
