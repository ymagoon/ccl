function AdvGrowthChartStyle(){this.initByNamespace("agc");
}AdvGrowthChartStyle.prototype=new ComponentStyle();
AdvGrowthChartStyle.prototype.constructor=ComponentStyle;
function AdvGrowthChart(criterion){this.tabRefId=0;
this.chartSourceFlag=0;
this.timeUnitEnum={DAYS:0,WEEKS:1,MONTHS:2,YEARS:3};
this.chartSourceEnum={CDC:1,FENTON:2,WHO:3};
this.showCDCChart=true;
this.showFentonChart=true;
this.setCriterion(criterion);
this.setStyles(new AdvGrowthChartStyle());
this.setComponentLoadTimerName("USR:MPG.ADVGROWTHCHART.O1 - load component");
this.setComponentRenderTimerName("ENG:MPG.ADVGROWTHCHART.O1 - render component");
this.compMenuGraph={};
}AdvGrowthChart.prototype=new MPageComponent();
AdvGrowthChart.prototype.constructor=MPageComponent;
AdvGrowthChart.prototype.openTab=function(){var criterion=this.getCriterion();
if(this.tabRefId>0){var paramString=criterion.person_id+"|"+criterion.encntr_id+"|"+this.tabRefId+"|0|0";
logger.logMPagesEventInfo(this,"POWERFORM",paramString,"advgrowthchart-o1.js","openTab");
MPAGES_EVENT("POWERFORM",paramString);
CERN_EventListener.fireEvent(null,this,EventListener.EVENT_CLINICAL_EVENT,"AdvGrowthChart");
}};
AdvGrowthChart.prototype.loadDisplayFilters=function(){var dateFilter=new MP_Core.CriterionFilters(this.getCriterion());
var dateCheck=new Date();
dateCheck.setFullYear(dateCheck.getFullYear()-22);
dateFilter.addFilter(MP_Core.CriterionFilters.DOB_YOUNGER_THAN,dateCheck);
this.addDisplayFilter(dateFilter);
};
AdvGrowthChart.prototype.loadFilterMappings=function(){this.addFilterMappingObject("WF_AGC_CDC_FLAG",{setFunction:this.setShowCDC,type:"Boolean",field:"FREETEXT_DESC"});
this.addFilterMappingObject("WF_AGC_FENTON_FLAG",{setFunction:this.setShowFenton,type:"Boolean",field:"FREETEXT_DESC"});
this.addFilterMappingObject("WF_AGC_ZSCORE_FLAG",{setFunction:this.setShowZScore,type:"Boolean",field:"FREETEXT_DESC"});
};
AdvGrowthChart.prototype.setShowCDC=function(isShown){this.showCDCChart=isShown;
};
AdvGrowthChart.prototype.setShowFenton=function(isShown){this.showFentonChart=isShown;
};
AdvGrowthChart.prototype.setShowZScore=function(toShow){this.showZScoreAll=toShow;
};
AdvGrowthChart.prototype.preProcessing=function(){if(this.showCDCChart||this.showFentonChart){if(this.showCDCChart&&this.validateAgeAtLeast(this.getCriterion().getPatientInfo().getDOB(),2,this.timeUnitEnum.YEARS)){this.chartSourceFlag=this.chartSourceEnum.CDC;
}else{this.chartSourceFlag=this.chartSourceEnum.WHO;
}this.initComponentMenu();
}else{this.chartSourceFlag=this.chartSourceEnum.WHO;
}};
AdvGrowthChart.prototype.initComponentMenu=function(){var compMenu=this.getMenu();
var allCompMenuEntries=[];
var agcI18n=i18n.discernabu.agc;
var compID=this.getComponentId();
var self=this;
if(compMenu){var compMenuWHO=new MenuSelection("compMenuWho"+compID);
var compMenuFenton;
var compMenuCDC;
if(this.showCDCChart){compMenuCDC=new MenuSelection("compMenuCdc"+compID);
compMenuCDC.setLabel(agcI18n.CDC);
compMenu.addMenuItem(compMenuCDC);
this.compMenuGraph[compMenuCDC.getId()]=compMenuCDC;
allCompMenuEntries.push(compMenuCDC);
if(this.chartSourceFlag==this.chartSourceEnum.CDC){compMenuCDC.setIsSelected(true);
}}compMenuWHO.setLabel(agcI18n.WHO);
compMenu.addMenuItem(compMenuWHO);
this.compMenuGraph[compMenuWHO.getId()]=compMenuWHO;
allCompMenuEntries.push(compMenuWHO);
if(this.chartSourceFlag==this.chartSourceEnum.WHO){compMenuWHO.setIsSelected(true);
}if(this.showFentonChart){compMenuFenton=new MenuSelection("compMenuFenton"+compID);
compMenuFenton.setLabel(agcI18n.FENTON);
compMenu.addMenuItem(compMenuFenton);
this.compMenuGraph[compMenuFenton.getId()]=compMenuFenton;
allCompMenuEntries.push(compMenuFenton);
if(this.chartSourceFlag==this.chartSourceEnum.FENTON){compMenuFenton.setIsSelected(true);
}}var unselectMenuEntries=function(){for(var i=allCompMenuEntries.length;
i--;
){allCompMenuEntries[i].setIsSelected(false);
}};
compMenuWHO.setClickFunction(function(){self.chartSourceFlag=self.chartSourceEnum.WHO;
unselectMenuEntries();
compMenuWHO.setIsSelected(true);
self.retrieveComponentData();
});
if(compMenuCDC){compMenuCDC.setClickFunction(function(){self.chartSourceFlag=self.chartSourceEnum.CDC;
unselectMenuEntries();
compMenuCDC.setIsSelected(true);
self.retrieveComponentData();
});
}if(compMenuFenton){compMenuFenton.setClickFunction(function(){self.chartSourceFlag=self.chartSourceEnum.FENTON;
unselectMenuEntries();
compMenuFenton.setIsSelected(true);
self.retrieveComponentData();
});
}}MP_MenuManager.updateMenuObject(compMenu);
};
AdvGrowthChart.prototype.getEventViewerLink=function(agcResultId,agcResultItem,agcGroupName){var ar=[];
ar.push("<a onclick='ResultViewer.launchAdHocViewer(",agcResultId,",",+agcGroupName+"); return false;' href='#'>",agcResultItem,"</a>");
return ar.join("");
};
AdvGrowthChart.prototype.convertName=function(agcName,graphHTML){var agcI18n=i18n.discernabu.agc;
switch(agcName){case"Height":graphHTML.push("<div class = 'floatleft'><h2>HEIGHT</h2><div id = 'HEIGHT' class = 'placeholder'><span class = 'align-graph'>",agcI18n.HEIGHT,"</span></div>");
return agcI18n.HEIGHT;
case"Weight":graphHTML.push("<div class = 'floatleft'><h2>WEIGHT</h2><div id = 'WEIGHT' class = 'placeholder'><span class = 'align-graph'>",agcI18n.WEIGHT,"</span></div>");
return agcI18n.WEIGHT;
case"BMI":graphHTML.push("<div class = 'floatleft'><h2>BMI</h2><div id = 'BMI' class = 'placeholder'><span class = 'align-graph'>",agcI18n.BMI,"</span></div>");
return agcI18n.BMI;
case"Head Circ":graphHTML.push("<div class = 'floatleft'><h2>HEAD</h2><div id = 'HEAD' class = 'placeholder'><span class = 'align-graph'>",agcI18n.HEAD,"</span></div>");
return agcI18n.HEADCIRCUMFERENCE;
}};
AdvGrowthChart.prototype.retrieveComponentData=function(){var sendAr=[];
var criterion=this.getCriterion();
var lookBackUnits=this.getLookbackUnits()||"0";
var lookBackType=this.getLookbackUnitTypeFlag()||"-1";
var prsnlInfo=criterion.getPersonnelInfo();
var encntrs=prsnlInfo.getViewableEncounters();
var encntrVal=encntrs?"value("+encntrs+")":"0.0";
var encntrValScope=this.getScope()==2?"value("+criterion.encntr_id+".0 )":encntrVal;
var viewCategoryMean=criterion.category_mean;
var loadTimer=new RTMSTimer(this.getComponentLoadTimerName(),viewCategoryMean);
var renderTimer=new RTMSTimer(this.getComponentRenderTimerName(),viewCategoryMean);
sendAr.push("^MINE^",criterion.person_id+".0",criterion.provider_id+".0",encntrValScope,lookBackUnits,lookBackType,criterion.ppr_cd+".0",this.chartSourceFlag);
var request=new ComponentScriptRequest();
request.setProgramName("MP_RETRIEVE_ADV_GROWTH_CHART");
request.setParameterArray(sendAr);
request.setComponent(this);
request.setLoadTimer(loadTimer);
request.setRenderTimer(renderTimer);
request.performRequest();
};
AdvGrowthChart.prototype.renderComponent=function(reply){var recordData=null;
var timerRenderComponent=MP_Util.CreateTimer(this.getComponentRenderTimerName());
try{recordData=reply;
var precision=2;
var dtFormat=this.getDateFormat();
var graphHTML=[];
var tableHTML=[];
var agcLen=0;
var countText="";
var agcObj=recordData.AGC;
this.tabRefId=recordData.PLUS_ADD_FORM.REF_ID;
agcLen=agcObj.length;
var patBirthDtTm=new Date();
patBirthDtTm.setISO8601(recordData.BIRTH_DT_TM);
var agcI18n=i18n.discernabu.agc;
var df=new mp_formatter.DateTimeFormatter(MPAGE_LOCALE);
var nf=new mp_formatter.NumericFormatter(MPAGE_LOCALE);
var latestText=dtFormat==3?agcI18n.LATEST+"<br/>"+agcI18n.WITHIN:agcI18n.LATEST;
var previousText=dtFormat==3?agcI18n.PREVIOUS+"<br/>"+agcI18n.WITHIN:agcI18n.PREVIOUS;
var contentClass=MP_Util.GetContentClass(this,agcLen);
var headerClass="agc-hdr";
if(this.isScrollingEnabled()&&agcLen>=this.getScrollNumber()){contentClass+=" gc-scrl-tbl";
headerClass+=" gc-scrl-tbl-hdr";
}var labelText="";
switch(this.chartSourceFlag){case this.chartSourceEnum.WHO:labelText=agcI18n.WHO;
break;
case this.chartSourceEnum.CDC:labelText=agcI18n.CDC;
break;
case this.chartSourceEnum.FENTON:labelText=agcI18n.FENTON;
break;
}tableHTML.push("<span class = 'agc-chart-type-label' >",labelText,"</span>");
tableHTML.push("<div id = 'hideTable' class = 'content-border'>");
tableHTML.push("<div class='",headerClass,"'><table class='agc-table'><thead ><tr><th class='agc-lbl'><span>&nbsp;</span></th><th class='agc-latest-hdr'><span>",latestText,"</span></th><th class='agc-prev-hdr'><span>",previousText,"</span></th></tr></thead></table></div>");
tableHTML.push("<div class='",contentClass,"'><table class='agc-table'></div>");
for(var i=0;
i<agcLen;
i++){var agcItem=agcObj[i];
var agcName=agcItem.EVENT_NAME;
agcName=this.convertName(agcName,graphHTML);
var oddEven="odd";
if(i%2===1){oddEven="even";
}tableHTML.push("<tr class='",oddEven,"'><td class='agc-lbl'><span class='row-label'>",agcName,"</span></td>");
var agcMeas=agcItem.MEASUREMENTS;
var agcResLen=agcMeas.length;
if(agcResLen>5){agcResLen=5;
}for(var j=0;
j<5;
j++){if(j<agcResLen){var agcRes=agcMeas[j];
var agcVal=nf.format(agcRes.VALUE);
var agcPct=nf.format(agcRes.PERCENTILE,"."+precision);
var agcUnits=agcRes.RESULT_UNITS;
var agcResultVal="";
var agcHvrVal="";
var resModified=agcRes.MODIFIED_IND===1?"<span class='res-modified'>&nbsp;</span>":"";
var measDate=new Date();
measDate.setISO8601(agcRes.MEAS_DT_TM);
var measAge=MP_Util.CalcAge(patBirthDtTm,measDate);
var measDateDisp=df.format(measDate,mp_formatter.DateTimeFormatter.FULL_DATE_TIME_4YEAR);
var faceUpMeasDateDisp=MP_Util.DisplayDateByOption(this,measDate);
agcResultVal=agcVal+" "+agcUnits+" ("+agcPct+"%)";
agcHvrVal=agcVal;
tableHTML.push("<td class='agc-res",j+1,"'><dl class='agc-info'><dd class='agc-res'>",this.getEventViewerLink(agcRes.EVENT_ID,agcResultVal,agcName),resModified);
if(this.showZScoreAll){tableHTML.push("<span class='within new-line'>Z = ",nf.format(agcRes.Z_SCORE),"</span>");
}tableHTML.push("<span class='within new-line'>",faceUpMeasDateDisp,"</span></dd></dl><h4 class='det-hd'><span>",agcI18n.RESULT_DETAILS,":</span></h4><div class='hvr'><dl class='agc-det-age'>","<dt><span>",agcI18n.AGE,":</span></dt><dd>",measAge,"</dd>","<dt><span>",agcI18n.RESULT_DT_TM,":</span></dt><dd>",measDateDisp,"</dd>","<dt><span>",agcI18n.RESULT,":</span></dt><dd>",agcHvrVal+" "+agcRes.RESULT_UNITS,"</dd><dt><span>",agcI18n.PERCENTILE,":</span></dt><dd><span>",agcPct,"</span></dd><dt><span>",agcI18n.ZSCORE,":</span></dt><dd><span>",nf.format(agcRes.Z_SCORE),"</span></dd><dt><span>",agcI18n.STATUS,":</span></dt><dd><span>",agcRes.STATUS_DISP,"</span></dd></dl></div></td>");
graphHTML.push("<div class = 'spanwidth'><span class='agc-res graphview'>",agcVal+"&nbsp;"+agcRes.RESULT_UNITS,"</span><span class='graphview'>",agcPct,"&nbsp;",agcI18n.PERCENTILE,"</span><span class='graphview'>",measAge,"&nbsp;(",measDateDisp,")</span></div>");
}else{tableHTML.push("<td class='agc-res",j+1," result-align'><span>--</span></td>");
}}tableHTML.push("</tr>");
graphHTML.push("</div>");
}graphHTML.push("</div>");
tableHTML.push("</table>");
tableHTML.push("</div>");
tableHTML.push("</div>");
tableHTML.push("<div id = 'hideGraph' class = 'hidden'>");
var fullTable=tableHTML.join("");
var fullGraph=graphHTML.join("");
var jsAgcHTML=fullTable.concat(fullGraph);
countText=MP_Util.CreateTitleText(this,agcLen);
MP_Util.Doc.FinalizeComponent(jsAgcHTML,this,countText);
}catch(err){if(timerRenderComponent){timerRenderComponent.Abort();
timerRenderComponent=null;
}logger.logJSError(this,err,"advgrowthchart-o1.js","renderComponent");
throw err;
}finally{if(timerRenderComponent){timerRenderComponent.Stop();
}}};
AdvGrowthChart.prototype.postProcessing=function(){CERN_EventListener.addListener(this,EventListener.EVENT_CLINICAL_EVENT,this.retrieveComponentData,this);
};
AdvGrowthChart.prototype.validateAgeAtLeast=function(patDOB,age,units){var dateAtGivenAge=new Date();
var currDtTm=new Date();
var dayLengthMS=86400000;
var weekLengthMS=7*dayLengthMS;
var monthLengthMS=30*dayLengthMS;
switch(units){case this.timeUnitEnum.DAYS:dateAtGivenAge.setTime(patDOB.getTime()+age*dayLengthMS);
break;
case this.timeUnitEnum.WEEKS:dateAtGivenAge.setTime(patDOB.getTime()+age*weekLengthMS);
break;
case this.timeUnitEnum.MONTHS:dateAtGivenAge.setTime(patDOB.getTime()+age*monthLengthMS);
break;
default:dateAtGivenAge.setTime(patDOB.getTime());
dateAtGivenAge.setFullYear(patDOB.getFullYear()+age);
break;
}return currDtTm>=dateAtGivenAge;
};
MP_Util.setObjectDefinitionMapping("wf_adv_growth_chart",AdvGrowthChart);
