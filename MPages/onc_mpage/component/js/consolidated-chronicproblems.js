(function(){ChronicProblemsTab=function(component){this.historyComp=component;
this.compId=component.getComponentId();
this.sidePanelMinHeight="175px";
this.chxi18n=i18n.discernabu.consolidated_history;
this.inMillenniumContext=CERN_Platform.inMillenniumContext();
this.m_hiValidData=false;
this.tableObj=null;
this.probTable=null;
this.sidePanelContainer=null;
this.sidePanel=null;
this.panelShowing=false;
this.previousClickedRow="";
this.canModifyChronic=false;
this.canAddChronicFreeText=false;
this.sharedCondResource=null;
this.bedrockConfig=null;
this.hiTable=null;
this.hiTableObj=null;
this.hiMoreDataAvail=false;
this.m_hiTotalResults=0;
this.pageIndex=0;
this.m_patientRequests=null;
this.m_conditions=null;
this.m_privsObj=null;
};
ChronicProblemsTab.prototype.getPatientRequests=function(){return this.m_patientRequests;
};
ChronicProblemsTab.prototype.setPatientRequests=function(patientRequests){this.m_patientRequests=patientRequests;
};
ChronicProblemsTab.prototype.setConditions=function(conditions){this.m_conditions=conditions;
};
ChronicProblemsTab.prototype.getConditions=function(){return this.m_conditions;
};
ChronicProblemsTab.prototype.setPrivsObj=function(privs){this.m_privsObj=privs;
};
ChronicProblemsTab.prototype.getPrivsObj=function(){return this.m_privsObj;
};
ChronicProblemsTab.ChronicProblemsTabRow=function(chronicTab){this.ChronicProbTab=chronicTab;
};
var ChronicProblemsTabRow=ChronicProblemsTab.ChronicProblemsTabRow;
ChronicProblemsTabRow.prototype.updateSidePanel=function(sidePanel){var compContentId=this.ChronicProbTab.historyComp.getStyles().getContentId();
sidePanel.setTitleText(this.getSidePanelTitleText());
sidePanel.setActionsAsHTML(this.getSidePanelActionsHtml());
sidePanel.setContents(this.getSidePanelContentHtml(),compContentId);
this.sidePanelPostProcessing(sidePanel);
};
ChronicProblemsTabRow.prototype.getSidePanelActionsHtml=function(){return"";
};
ChronicProblemsTabRow.prototype.getSidePanelTitleText=function(){return this.DISPLAY_NAME;
};
ChronicProblemsTabRow.prototype.getSidePanelContentHtml=function(){return"";
};
ChronicProblemsTabRow.prototype.sidePanelPostProcessing=function(sidePanel){var chronicTab=this.ChronicProbTab;
$("#chxProb"+chronicTab.compId+"errorMsgBanner").css("display","none");
if(this.showCommentsIcon){sidePanel.expandSidePanel();
this.renderComments();
}sidePanel.resizePanel();
};
ChronicProblemsTabRow.prototype.renderComments=function(){var commentsContainer=null;
var commentsList=[];
this.comments.each(function(comment){commentsList.push("<div class='chx-prob-comment'><div class='chx-prob-comment-text'>",comment.getText().replace(/\n/g,"<br />"),"</div><div class='chx-prob-comment-header'>",comment.getFormattedHeader(),"</div></div>");
});
commentsContainer=$("#chx-comments-container"+this.ChronicProbTab.compId);
commentsContainer.empty();
commentsContainer.append(commentsList.join(""));
};
ChronicProblemsTabRow.prototype.getClassificationRenderTemplate=function(){return this.CLASS_DISPLAY;
};
ChronicProblemsTabRow.prototype.getRequestRenderTemplate=function(){return"--";
};
ChronicProblemsTab.ChronicProblemsRow=function(chronicTab,condition,privsObj){this.condition=condition;
this.ChronicProbTab=chronicTab;
this.isNKPRow=false;
this.privsObj=privsObj;
this.showCommentsIcon=false;
this.comments=condition.getComments();
if(condition.getIsCernerNKP()){this.setNKPRow();
}else{this.DISPLAY_NAME=condition.getDisplay()||"--";
this.CLASS_DISPLAY=condition.getClassification().getDisplay()||"--";
}if(this.comments.length){this.showCommentsIcon=true;
}};
var ChronicProblemsRow=ChronicProblemsTab.ChronicProblemsRow;
ChronicProblemsRow.prototype=new ChronicProblemsTabRow();
ChronicProblemsRow.prototype.getRenderTemplate=function(){var NKPText=this.ChronicProbTab.chxi18n.NO_CHRONIC_PROBLEMS_FOR_THIS_PATIENT;
var inactiveHTML=this.condition.getIsInactive()?"<span class='chx-inactive-ind'>"+this.ChronicProbTab.chxi18n.INACTIVE+"</span>":"";
if(this.isNKPRow){return"<span class='priority'><i>"+NKPText+"</i></span>";
}else{return this.DISPLAY_NAME+inactiveHTML;
}};
ChronicProblemsRow.prototype.getCommentsIndRenderTemplate=function(){if(this.showCommentsIcon){return"<div class='chx-prob-comment-indicator'></div>";
}else{return"";
}};
ChronicProblemsRow.prototype.setNKPRow=function(){this.isNKPRow=true;
this.DISPLAY_NAME="--";
if(this.privsObj.canUpdtNKP){this.CLASS_DISPLAY="<a id=chxProb"+this.ChronicProbTab.compId+"removeNKPRowBtn>"+this.ChronicProbTab.chxi18n.REMOVE+"</a>";
}else{this.ClASS_DISPLAY="";
}};
ChronicProblemsRow.prototype.getSidePanelActionsHtml=function(){var tab=this.ChronicProbTab;
return"<div id='chxProb"+tab.compId+"errorMsgBanner' class='chx-error-message'><div class='error-container inline-message'><span id='chxProb"+tab.compId+"errorMsgText' class='error-text message-info-text'>Error Message is displayed</span></div></div><div id='chxProb"+tab.compId+"btnHolder' class='chx-prob-side-panel-btn-holder'><div id = 'chxProb"+tab.compId+"cancelBtn' class='chx-prob-side-panel-btn'>"+i18n.CANCEL+"</div><div id = 'chxProb"+tab.compId+"resolveBtn' class='chx-prob-side-panel-btn'>"+tab.chxi18n.RESOLVE+"</div><div id = 'chxProb"+tab.compId+"modifyBtn' class='chx-prob-side-panel-btn'>"+tab.chxi18n.MODIFY+"</div></div>";
};
ChronicProblemsRow.prototype.getSidePanelContentHtml=function(){var chxi18n=this.ChronicProbTab.chxi18n;
var compId=this.ChronicProbTab.compId;
var condition=this.condition;
var onset=condition.getOnset();
var onsetDate="";
var sidePanelHTML="";
var conditionType="";
var classification="";
var confirmation="";
if(onset){var dateFormatter=MP_Util.GetDateFormatter();
onsetDate=dateFormatter.format(onset,mp_formatter.DateTimeFormatter.FULL_DATE_4YEAR);
}else{onsetDate="--";
}if(condition.getIsHistorical()){conditionType=chxi18n.HISTORICAL;
}else{if(condition.getIsChronic()){conditionType=chxi18n.CHRONIC;
}}status=condition.getLifeCycleStatus().getDisplay()||"--";
condition.STATUS=status;
classification=this.CLASS_DISPLAY||"--";
confirmation=condition.getConfirmationStatus().getDisplay()||"--";
sidePanelHTML="</div><div class='sp-body-contents-padding'><div id='sidePanelScrollContainer"+compId+"' class='sp-body-content-area'><dl class='chx-prob-side-panel-detail-item'><dt>Description</dt><dd class='chx-prob-side-panel-description secondary-text'>"+chxi18n.ONSET+" "+chxi18n.DATE+":</dd><dt>Value</dt><dd class='chx-prob-side-panel-value'>"+onsetDate+"</dd></dl><dl class='chx-prob-side-panel-detail-item'><dt>Description</dt><dd class='chx-prob-side-panel-description secondary-text'>"+chxi18n.PROBLEM_TYPE+":</dd><dt>Value</dt><dd class='chx-prob-side-panel-value'>"+conditionType+"</dd></dl><dl class='chx-prob-side-panel-detail-item'><dt>Description</dt><dd class='chx-prob-side-panel-description secondary-text'>"+chxi18n.STATUS+":</dd><dt>Value</dt><dd class='chx-prob-side-panel-value'>"+status+"</dd></dl><dl class='chx-prob-side-panel-detail-item'><dt>Description</dt><dd class='chx-prob-side-panel-description secondary-text'>"+chxi18n.CLASSIFICATION+":</dd><dt>Value</dt><dd class='chx-prob-side-panel-value'>"+classification+"</dd></dl><dl class='chx-prob-side-panel-detail-item'><dt>Description</dt><dd class='chx-prob-side-panel-description secondary-text'>"+chxi18n.CONFIRMATION+":</dd><dt>Value</dt><dd class='chx-prob-side-panel-value'>"+confirmation+"</dd></dl>";
if(this.showCommentsIcon){sidePanelHTML+="<div class='chx-prob-comments-separator'><div class='sp-separator2'></div></div><div>"+chxi18n.COMMENTS+"</div><div id='chx-comments-container"+compId+"' class='chx-prob-comments-container'><div class='loading'></div></div></div>";
}else{sidePanelHTML+="</div>";
}return sidePanelHTML;
};
ChronicProblemsRow.prototype.sidePanelPostProcessing=function(sidePanel){ChronicProblemsTabRow.prototype.sidePanelPostProcessing.call(this,sidePanel);
var tab=this.ChronicProbTab;
var condition=this.condition;
tab.determineAvailableButtons(condition);
tab.bindButtonEvents(condition);
};
ChronicProblemsTab.PatientRequestRow=function(chronicTab,condition,privsObj,patientRequest){this.patientRequest=patientRequest;
this.condition=null;
this.patRequestInd=true;
this.m_removeRequestButton=null;
this.showPatReqSecCommentsIcon=false;
if(patientRequest.getComments().length){this.showPatReqSecCommentsIcon=true;
}else{if(condition){if(condition.getComments().length){this.showPatReqSecCommentsIcon=true;
}}}this.CLASS_DISPLAY="--";
this.DISPLAY_NAME=patientRequest.getHealthIssue();
var chxi18n=i18n.discernabu.consolidated_history;
if(patientRequest&&patientRequest.getRequestType()){var requestType=patientRequest.getRequestType().getMeaning();
switch(requestType){case"ADD":this.REQUEST_TEXT=chxi18n.ADD;
break;
case"UPDATE":this.REQUEST_TEXT=chxi18n.MODIFY;
break;
case"REMOVE":this.REQUEST_TEXT=chxi18n.REMOVE;
break;
}}this.ChronicProbTab=chronicTab;
if(condition){ChronicProblemsRow.call(this,chronicTab,condition,privsObj);
}};
var PatientRequestRow=ChronicProblemsTab.PatientRequestRow;
PatientRequestRow.prototype=new ChronicProblemsTabRow();
PatientRequestRow.prototype.getRenderTemplate=function(){var patientRequest=this.patientRequest;
var nameDisplay=this.DISPLAY_NAME;
if(patientRequest.getRequestType().getMeaning()==="REMOVE"){return"<div class='chx-remove-strike'>"+nameDisplay+"</div>";
}return nameDisplay;
};
PatientRequestRow.prototype.getClassificationRenderTemplate=function(){var patientRequest=this.patientRequest;
var classDisplay=this.CLASS_DISPLAY;
if(patientRequest.getRequestType().getMeaning()==="REMOVE"){return"<div class='chx-remove-strike'>"+classDisplay+"</div>";
}return classDisplay;
};
PatientRequestRow.prototype.getCommentsIndRenderTemplate=function(){return(this.showPatReqSecCommentsIcon)?"<div class='chx-prob-comment-indicator'></div>":"";
};
PatientRequestRow.prototype.getRequestRenderTemplate=function(){var patientRequest=this.patientRequest;
var chxi18n=i18n.discernabu.consolidated_history;
if(patientRequest&&patientRequest.getRequestType()){var requestType=patientRequest.getRequestType().getMeaning();
switch(requestType){case"ADD":return chxi18n.ADD;
break;
case"UPDATE":return chxi18n.MODIFY;
break;
case"REMOVE":return chxi18n.REMOVE;
break;
}}else{return"--";
}};
PatientRequestRow.prototype.setNKPRow=function(){if(this.condition){return ChronicProblemsRow.prototype.setNKPRow.call(this);
}};
PatientRequestRow.prototype.getSidePanelActionsHtml=function(){var self=this;
var tab=this.ChronicProbTab;
var chxi18n=tab.chxi18n;
var privsObj=tab.getPrivsObj();
var createButtonInd=0;
if(this.condition){if(this.condition.canModifyChronic()){createButtonInd=1;
}else{createButtonInd=0;
}}else{if(privsObj.canAddChronicFreeText){createButtonInd=1;
}else{createButtonInd=0;
}}var sidePanelError="<div id='chxProb"+tab.compId+"errorMsgBanner' class='chx-error-message'><div class='error-container inline-message'><span id='chxProb"+tab.compId+"errorMsgText' class='error-text message-info-text'>Error Message is displayed</span></div></div>";
if(createButtonInd){var removeRequestsBtn=new MPageUI.Button();
removeRequestsBtn.setLabel(chxi18n.REMOVE_REQUEST);
removeRequestsBtn.setStyle(MPageUI.BUTTON_OPTIONS.STYLE.SECONDARY);
removeRequestsBtn.setOnClickCallback(function(){self.acknowledgeRequest();
});
this.m_removeRequestButton=removeRequestsBtn;
return sidePanelError+removeRequestsBtn.render();
}else{return sidePanelError;
}};
PatientRequestRow.prototype.sidePanelPostProcessing=function(sidePanel){ChronicProblemsTabRow.prototype.sidePanelPostProcessing.call(this,sidePanel);
if(this.m_removeRequestButton){this.m_removeRequestButton.attachEvents();
}};
PatientRequestRow.prototype.acknowledgeRequest=function(){try{var probReconcileCAPTimer=new CapabilityTimer("CAP:MPG Histories_Problem History Reconcile Patient Entered Data");
probReconcileCAPTimer.capture();
var patientRequest=this.patientRequest;
var component=this.ChronicProbTab.historyComp;
var criterion=component.getCriterion();
var extDataInfoId=patientRequest.getId();
var statusCode=patientRequest.getResponseMeta().ACKNOWLEDGE_CD;
var chartReferenceId=patientRequest.getProblemValue();
var personnelId=criterion.provider_id;
var encounterId=criterion.encntr_id;
var requestJson='{"REQUESTIN":{"UPDATESTATUS":[{"EXT_DATA_INFO_ID":'+extDataInfoId+'.0,"STATUS_CODE":'+statusCode+'.0,"CHART_REFERENCE_ID":'+chartReferenceId+'.0,"PERSONNEL_ID":'+personnelId+'.0,"ENCNTR_ID":'+encounterId+".0}]}}";
var scriptRequest=new ScriptRequest();
var self=this;
scriptRequest.setProgramName("mp_exec_std_request");
scriptRequest.setRawDataIndicator(true);
scriptRequest.setDataBlob(requestJson);
scriptRequest.setParameterArray(["^MINE^","^^",3202004,3202004,964756]);
scriptRequest.setResponseHandler(function(scriptReply){try{var responseData=JSON.parse(scriptReply.getResponse());
if(responseData.RECORD_DATA.STATUS.SUCCESS_INDICATOR===1){component.retrieveComponentData();
}else{self.displaySidePanelError();
}}catch(err){self.displaySidePanelError();
}});
scriptRequest.performRequest();
}catch(err){this.displaySidePanelError();
}};
PatientRequestRow.prototype.displaySidePanelError=function(){var tab=this.ChronicProbTab;
var chxi18n=tab.chxi18n;
var $prbSpBanner=$("#chxProb"+tab.compId+"errorMsgBanner");
var alertBanner=new MPageUI.AlertBanner();
alertBanner.setType(MPageUI.ALERT_OPTIONS.TYPE.ERROR);
alertBanner.setPrimaryText(chxi18n.REMOVE_PAT_REQUEST_ERROR_TEXT);
$prbSpBanner.siblings(".chx-ped-prob-err-remove").remove();
$prbSpBanner.parent().append("<div class='chx-ped-prob-err-remove'>"+alertBanner.render()+"</div>");
};
PatientRequestRow.prototype.getSidePanelContentHtml=function(){var patientRequestHtml="<div class='chx-sp-body-contents'>";
patientRequestHtml+=this.createProbSidePanelPEDHTML();
if(this.condition){patientRequestHtml+=ChronicProblemsRow.prototype.getSidePanelContentHtml.call(this);
}patientRequestHtml+="";
return patientRequestHtml;
};
PatientRequestRow.prototype.createProbSidePanelPEDHTML=function(){var inMillenniumContextInd=CERN_Platform.inMillenniumContext();
var tab=this.ChronicProbTab;
var component=tab.historyComp;
var chxi18n=this.ChronicProbTab.chxi18n;
var patientRequest=this.patientRequest;
var condition=this.condition;
var requestType=patientRequest.getRequestType().getMeaning();
var tempSubmittedDate=patientRequest.getSubmissionDate();
var submittedDtTmDisplay=tempSubmittedDate?tempSubmittedDate.format("longDateTime3"):null;
var requestOnsetDateString=patientRequest.getOnsetDate().getDisplay()||"--";
var managingProvider=patientRequest.getManagingProvider().getDisplay()||"--";
var requestSource=patientRequest.getSubmittedByType().getDisplay()||"--";
var author=patientRequest.getSubmittedBy()||"--";
var comments=patientRequest.getComments();
var comment="--";
if(comments.length){comment=comments[0].getComment();
}var requestionActionHtml="";
var requestDetailsHtml="";
var requestSourceHtml="";
var requestCommentHtml="";
var modifyLabel="";
var removeLabel="";
var problemsLink=component.getProblemsLink();
var isProbLinkDisabled=!(inMillenniumContextInd&&(problemsLink||component.getLink()));
switch(requestType){case"ADD":requestionActionHtml='<dl class="chx-sp-detail-group"><dt class="chx-request-label">'+chxi18n.ADDITION+"</dt><dt>"+chxi18n.ADD_THIS_PROBLEM_BY_SEARCH+"</dt></dl>";
requestDetailsHtml='<dl class="chx-sp-detail-group"><dl class="chx-sp-details-sub-section"><dt class="chx-request-label">'+chxi18n.ONSET_DATE+"</dt><dd>"+requestOnsetDateString+'</dd></dl><dl class="chx-sp-details-sub-section"><dt class="chx-request-label">'+chxi18n.MANAGING_PROVIDER+"</dt><dd>"+managingProvider+"</dd></dl></dl>";
break;
case"UPDATE":modifyLabel=condition.getIsChronic()?chxi18n.MODIFICATION_OF_CHRONIC:chxi18n.MODIFICATION_OF_RESOLVED;
requestionActionHtml='<dl class="chx-sp-detail-group"><dt class="chx-request-label">'+modifyLabel+"</dt><dt>";
if(condition.canModifyChronic()){var updateProblemLink=component.createTabLink(chxi18n.PROBLEMS,isProbLinkDisabled,"chx-problems-sp-link");
requestionActionHtml+=chxi18n.UPDATE_PROBLEM_WITHIN.replace(/\{0\}/g,updateProblemLink)+"</dt><div>"+this.buildProblemModificationHtml()+"</div></dl>";
}break;
case"REMOVE":removeLabel=condition.getIsChronic()?chxi18n.REMOVAL_OF_CHRONIC:chxi18n.REMOVAL_OF_RESOLVED;
requestionActionHtml='<dl class="chx-sp-detail-group"><dt class="chx-request-label">'+removeLabel+"</dt><dt>";
if(condition.canModifyChronic()){var updateProblemLink=component.createTabLink(chxi18n.PROBLEMS,isProbLinkDisabled,"chx-problems-sp-link");
requestionActionHtml+=chxi18n.UPDATE_PROBLEM_WITHIN.replace(/\{0\}/g,updateProblemLink)+"</dt><div></div></dl>";
}break;
}requestSourceHtml+='<dl class="chx-sp-detail-group"><dl class="chx-sp-details-sub-section"><dt class="chx-request-label">'+chxi18n.ORIGINATING_SOURCE+"</dt><dd>"+requestSource+'</dd></dl><dl class="chx-sp-details-sub-section"><dt class="chx-request-label">'+chxi18n.ORIGINATING_AUTHOR+"</dt><dd>"+author+"</dd></dl></dl>";
if(comment){requestCommentHtml+='<dl><dt class="chx-request-label">'+chxi18n.PATIENT_COMMENT+"</dt><dd>"+comment+"</dd></dl>";
}var sidePanelHTMLPed='<dl><dd><dt class="chx-expand-content-section"><span class="chx-side-panel-tgl chx-hide-expand-btn" title="collapse">&nbsp;</span><span class="chx-pat-req-icon">&nbsp</span><span>'+chxi18n.OUTSIDE_REQUESTS+'</span><span class="chx-pull-right">';
sidePanelHTMLPed+=(submittedDtTmDisplay||"--")+'</span></dt></dl><div class="chx-expand-content"><dl>'+requestionActionHtml+requestDetailsHtml+requestSourceHtml+requestCommentHtml+"</dd></div></dl>";
sidePanelHTMLPed+='</div><div class="sp-separator">&nbsp;</div>';
return sidePanelHTMLPed;
};
PatientRequestRow.prototype.buildProblemModificationHtml=function(){var chxi18n=this.ChronicProbTab.chxi18n;
var patientRequest=this.patientRequest;
var modificationsHtml='<ul class="chx-sp-item-list">';
var onsetDate=patientRequest.getOnsetDate();
var managingProvider=patientRequest.getManagingProvider();
var onsetDateDisplay="";
var modifiedOnsetDateDisplay="";
var managingProviderDisplay="";
var modifiedManagingProviderDisplay="";
if(onsetDate&&onsetDate.getModifyStatusValue()){onsetDateDisplay=onsetDate.getDisplay()||"--";
modifiedOnsetDateDisplay=onsetDate.getModifiedDisplay()||"--";
modificationsHtml+="<li>"+chxi18n.CHANGE_ONSET_FROM.replace(/\{0\}/g,onsetDateDisplay).replace(/\{1\}/g,modifiedOnsetDateDisplay)+"</li>";
}if(managingProvider&&managingProvider.getModifyStatusValue()){managingProviderDisplay=managingProvider.getDisplay()||"--";
modifiedManagingProviderDisplay=managingProvider.getModifiedDisplay()||"--";
modificationsHtml+="<li>"+chxi18n.CHANGE_MANAGING_PROVIDER.replace(/\{0\}/g,managingProviderDisplay).replace(/\{1\}/g,modifiedManagingProviderDisplay)+"</li>";
}modificationsHtml+="</ul>";
return modificationsHtml;
};
ChronicProblemsTab.prototype.shouldLoadPatientRequests=function(){var patientEnteredDataFilter=this.historyComp.getPatientEnteredDataInd();
var displayHiDataInd=this.historyComp.getDisplayHiDataInd();
var viewOutsideRecsSelected=this.historyComp.getViewOutsideHistoriesInd();
var patRequestsDisplayInd=(patientEnteredDataFilter&&viewOutsideRecsSelected&&!displayHiDataInd)?true:false;
return patRequestsDisplayInd;
};
ChronicProblemsTab.prototype.renderComponent=function(){this.panelShowing=false;
var self=this;
function wrappedSelfCallback(conditions,privsObj){self.setConditions(conditions);
self.setPrivsObj(privsObj);
self.setupChronicProblems();
}if(this.shouldLoadPatientRequests()){this.retrievePatientRequests();
}if(!this.sharedCondResource){this.sharedCondResource=SharedConditionResource.getSharedResource(wrappedSelfCallback,self);
}else{this.sharedCondResource.retrieveSharedResourceData();
}};
ChronicProblemsTab.prototype.retrievePatientRequests=function(){var self=this;
var criterion=this.historyComp.getCriterion();
var probLoadCAPTimer=new CapabilityTimer("CAP:MPG Histories_Problem History Load Patient Entered Data");
probLoadCAPTimer.capture();
this.historyComp.PEDLoadCAPTimers.PROBLEMS_LOADED=true;
MPageEntity.entities.PatientProblemRequest.list({personId:criterion.person_id+".0"},function(patientRequests,response,error){self.setPatientRequests(patientRequests);
self.setupChronicProblems();
});
};
ChronicProblemsTab.prototype.filterAddModifyRequestsWithoutMatchingProblem=function(patientRequests){var self=this;
var filteredRequests=patientRequests.filterFunction(function(patientRequest){var problemId=patientRequest.getProblemValue();
if(problemId){return self.getConditionWithProblemId(problemId)?true:false;
}return true;
});
return filteredRequests;
};
ChronicProblemsTab.prototype.getConditionWithProblemId=function(problemId){var conditions=this.getConditions();
var conditionCnt=conditions.length;
var problemCnt=0;
var condition=null;
var problem=null;
var problems;
var currProblemId=0;
for(var i=0;
i<conditionCnt;
i++){condition=conditions[i];
problems=condition.getProblems();
problemCnt=problems.length;
for(var x=0;
x<problemCnt;
x++){problem=problems[x];
currProblemId=problem.getId();
if(problemId===currProblemId){return condition;
}}}return null;
};
ChronicProblemsTab.prototype.generateRequestMap=function(requests){var requestMap={};
var requestCnt=requests.length;
var request=null;
var problemId=0;
var condition=null;
for(var i=0;
i<requestCnt;
i++){request=requests[i];
requestId=request.getId();
problemId=request.getProblemValue();
condition=this.getConditionWithProblemId(problemId);
requestMap[requestId]=condition;
}return requestMap;
};
ChronicProblemsTab.prototype.createHIAddDataControl=function(){var hiAddDataContainer="<div id='chx-hi-ext-label-outer"+this.compId+"' class='chx-hi-ext-div'><div class='chx-hi-ext-label'>";
var imgUrl=this.historyComp.getCriterion().static_content+"/images/";
var imgSuccess="6965.png";
imgUrl+=imgSuccess;
var msg="";
var hiTitleSpan;
var btnSpan;
if(!this.m_hiTotalResults>0){return"";
}else{if(this.m_hiValidData){btnSpan="<span style='float:right'><button ";
btnSpan+="class='chx-hi-ext-btn' id='hiDataControlBtn";
btnSpan+=this.compId;
btnSpan+="'>";
btnSpan+=this.chxi18n.HI_BTN_TXT;
btnSpan+="</button></span>";
msg=this.chxi18n.HI_EXT_LABEL;
}else{msg=this.chxi18n.EXTERNAL_DATA_LABEL_ERR;
btnSpan="";
}}var imgSpan="<span><img height='22'	width='22' style='float:left' id='externalDataAvailableImg' src= '";
imgSpan+=imgUrl;
imgSpan+="'></span>";
hiTitleSpan="<span style='margin-left:5px; padding-top:5px;'>";
hiTitleSpan+=msg;
hiTitleSpan+="</span>";
hiAddDataContainer+=imgSpan;
hiAddDataContainer+=hiTitleSpan;
hiAddDataContainer+=btnSpan;
hiAddDataContainer+="</div></div><div id='placeholder_emptydiv'></div>";
return hiAddDataContainer;
};
ChronicProblemsTab.prototype.processExtData=function(conditionsArray){try{for(var i=0;
i<conditionsArray.length;
i++){var effectDt=conditionsArray[i].most_recent_condition.effective_date;
var status=conditionsArray[i].most_recent_condition.status;
if(effectDt){var dateTime=new Date();
dateTime.setISO8601(effectDt);
effectDt=MP_Util.GetDateFormatter().format(dateTime,mp_formatter.DateTimeFormatter.FULL_DATE_4YEAR);
conditionsArray[i].EFFECT_UTC=effectDt;
}else{conditionsArray[i].EFFECT_UTC="--";
}if(!status){conditionsArray[i].most_recent_condition.status="--";
}}return conditionsArray;
}catch(err){this.m_hiValidData=false;
}};
ChronicProblemsTab.prototype.validateHIData=function(reply){this.m_hiValidData=false;
var recordData;
try{if(typeof reply==="object"){recordData=reply;
}else{recordData=JSON.parse(reply).RECORD_DATA;
}var hiStatus=recordData.STATUS_DATA.SUBEVENTSTATUS[0].OPERATIONSTATUS;
if(hiStatus==="S"){var conditions=JSON.parse(recordData.HTTPREPLY.BODY);
this.m_hiTotalResults=conditions.total_results;
if(this.m_hiTotalResults>0&&(conditions.groups[0].most_recent_condition)){this.m_hiValidData=true;
}else{this.m_hiValidData=false;
}}else{this.m_hiValidData=false;
}}catch(err){MP_Util.LogJSError(err,this,"consolidated-chronicproblems.js","validateHIData");
this.m_hiValidData=false;
}};
ChronicProblemsTab.prototype.setHITable=function(replyData){var self=this;
var recordData;
var status;
var conditionGroups;
this.validateHIData(replyData);
try{if(this.m_hiValidData){var jsonEval=JSON.parse(replyData);
recordData=jsonEval.RECORD_DATA;
conditionGroups=JSON.parse(recordData.HTTPREPLY.BODY);
this.hiMoreDataAvail=conditionGroups.more_results;
this.m_hiTotalResults=conditionGroups.total_results;
conditionGroups=this.processExtData(conditionGroups.groups);
this.hiTable=new ComponentTable();
this.hiTable.setNamespace("hiDataConsProbHist"+this.compId);
var nameColumn=new TableColumn();
nameColumn.setColumnId("Problem");
nameColumn.setCustomClass("chx-hi-prob-col-name");
nameColumn.setColumnDisplay(this.chxi18n.PROBLEMS);
nameColumn.setPrimarySortField("NAME_TEXT");
nameColumn.setIsSortable(true);
nameColumn.setRenderTemplate("${name}");
var effectiveDateColumn=new TableColumn();
effectiveDateColumn.setColumnId("EffectiveDate");
effectiveDateColumn.setCustomClass("chx-hi-hide");
effectiveDateColumn.setColumnDisplay(this.chxi18n.EFFECTIVE_DATE);
effectiveDateColumn.setPrimarySortField("EffectiveDate");
effectiveDateColumn.setIsSortable(true);
effectiveDateColumn.setRenderTemplate("${EFFECT_UTC}");
var typeColumn=new TableColumn();
typeColumn.setColumnId("Type");
typeColumn.setCustomClass("chx-hi-hide");
typeColumn.setColumnDisplay(this.chxi18n.TYPE);
typeColumn.setPrimarySortField("TYPE");
typeColumn.setIsSortable(true);
typeColumn.setRenderTemplate("${most_recent_condition.type}");
this.hiTable.addColumn(nameColumn);
this.hiTable.addColumn(typeColumn);
this.hiTable.addColumn(effectiveDateColumn);
this.hiTable.bindData(conditionGroups);
var clickExtension=new TableCellClickCallbackExtension();
clickExtension.setCellClickCallback(function(event,data){self.onRowClick(event,data);
});
this.hiTable.addExtension(clickExtension);
}}catch(err){this.m_hiValidData=false;
}};
ChronicProblemsTab.prototype.LoadHIConditionsPage=function(self){var component=self.historyComp;
var criterion=component.getCriterion();
var request=null;
var sendAr=[];
var aliasPoolCd=0;
var hiPrLookUpKey="null";
var hiTestUri="null";
var aliasType=(component.getAliasType().length>0)?component.getAliasType():"null";
if($.trim(component.getHILookupKey()).length>0){hiPrLookUpKey=component.getHILookupKey();
}if($.trim(component.getHITestUri()).length>0){hiTestUri=component.getHITestUri();
}if($.trim(component.getAliasPoolCd())){aliasPoolCd=component.getAliasPoolCd()+".0";
}sendAr.push("^MINE^","^"+hiPrLookUpKey+"^","^"+aliasType+"^",aliasPoolCd,"^"+hiTestUri+"^",self.pageIndex,criterion.person_id+".0",criterion.provider_id+".0",criterion.ppr_cd+".0");
var request=new MP_Core.ScriptRequest(self,component.getComponentLoadTimerName());
request.setProgramName("MP_GET_CONDITIONS_JSON");
request.setParameters(sendAr);
request.setAsync(true);
MP_Core.XMLCCLRequestCallBack(self,request,function(reply){try{var response=reply.getResponse();
self.validateHIData(response);
if(self.m_hiValidData){self.externalCondData=JSON.parse(response.HTTPREPLY.BODY);
var conditionsArray=self.processExtData(self.externalCondData.groups);
self.hiTable.bindData(conditionsArray);
self.hiTable.refresh();
if(self.panelShowing){if(self.previousClickedRow.split(":")[0].match(self.hiTable.getNamespace())!=null){var rowSelected=self.hiTable.getRows()[0];
self.renderPanelDetails(rowSelected.resultData);
self.highlightSelectedRow($(self.hiTableObj.find(".result-info")[0]));
}}}else{var errMsg="Error in retriving external data";
self.hiTableObj.html(MP_Util.HandleErrorResponse("",errMsg));
}}catch(err){MP_Util.LogJSError(err,self,"consolidated-chronicproblems.js","LoadHIConditionsPage");
}finally{self.hiTableObj.find(".loading-screen").remove();
self.historyComp.resizeComponent();
}});
};
ChronicProblemsTab.prototype.showHIData=function(){var hiProbTimer=new CapabilityTimer("CAP:MPG Display HealtheIntent Data");
hiProbTimer.capture();
var label="<p id = 'externalDataLabel'>";
label+="<span class='chx-ext-data-indicator'></span>";
label+="<span style='margin-left:5px text-align:left;padding-left: 7px;font-weight: bold;'>";
label+=this.chxi18n.HI_BTN_LBL_UPON_CLICK+"</span></p><br>";
$("#chx-hi-ext-label-outer"+this.compId).html(label);
var probTabContent=$("#probTabContent"+this.compId);
if(this.hiMoreDataAvail==true&&this.m_hiTotalResults!=null&&this.m_hiTotalResults>20){var spinnerDiv="<div id='spinner"+this.historyComp.getComponentId()+"' style='position:relative'>";
var self=this;
var noOfPages=Math.ceil(this.m_hiTotalResults/20);
var lastPageNo=0;
this.pager=new MPageUI.Pager().setNumberPages(noOfPages).setCurrentPageLabelPattern("${currentPage}/${numberPages}").setNextLabel(this.chxi18n.NEXT+" >").setPreviousLabel("< "+this.chxi18n.PREV);
this.pager.setOnPageChangeCallback(function(){MP_Util.LoadSpinner(self.hiTable.getNamespace());
if(lastPageNo<arguments[0].currentPage){self.pageIndex=self.pageIndex+20;
}else{self.pageIndex=this.pageIndex-20;
}self.LoadHIConditionsPage(self);
lastPageNo=arguments[0].currentPage;
});
var pagerDiv="<div id='pager"+this.compId+"'  class='chx-row-pager'>"+this.pager.render()+"</div>";
probTabContent.prepend(spinnerDiv+this.hiTable.render()+"</div>"+pagerDiv+"<br><br>");
this.pager.attachEvents();
}else{probTabContent.prepend(this.hiTable.render()+"<br><br>");
}this.hiTable.finalize();
this.hiTableObj=$("#hiDataConsProbHist"+this.compId+"table");
if(this.panelShowing){this.hiTableObj.addClass("chx-hi-hide-mode");
}};
ChronicProblemsTab.prototype.setupChronicProblems=function(){var problem=null;
var shouldLoadPatReq=this.shouldLoadPatientRequests();
if(shouldLoadPatReq&&(!this.getConditions()||!this.getPatientRequests())){return;
}var conditions=this.getConditions();
var privsObj=this.getPrivsObj();
var chronicProbsRows=[];
var historicProbsRows=[];
var historiesTabsArray=this.historyComp.m_tabControl.getTabs();
var problemsTab=historiesTabsArray[this.historyComp.HistoryComponentIndexObj.PROBLEMS];
var patientRequestRows=[];
var requestMap={};
var requestCnt=0;
if(privsObj){this.canModifyChronic=privsObj.canModifyChronic;
this.canAddChronicFreeText=privsObj.canAddChronicFreeText;
}var patientRequests=this.getPatientRequests();
if(patientRequests&&patientRequests.length&&shouldLoadPatReq){patientRequests=this.filterAddModifyRequestsWithoutMatchingProblem(patientRequests);
this.setPatientRequests(patientRequests);
requestMap=this.generateRequestMap(patientRequests);
requestCnt=patientRequests.length;
}var conditionHasPatientRequest=function(condition){var problems=condition.getProblems();
var problemCnt=problems.length;
var problemId=0;
var requestId;
var request=null;
for(var i=0;
i<requestCnt;
i++){request=patientRequests[i];
requestId=request.getId();
if(requestMap[requestId]===condition){return true;
}}return false;
};
var chronicProbs=conditions.filter(function(condition){return condition.getIsChronic()===true&&(!conditionHasPatientRequest(condition))&&(condition.getIsCernerNKP()===true||condition.getClassification().getMeaning()==="MEDICAL"||condition.getClassification().getMeaning()==="PATSTATED");
});
var historicProbs=conditions.filter(function(condition){return condition.getIsHistorical()===true&&(!conditionHasPatientRequest(condition))&&(condition.getClassification().getMeaning()==="MEDICAL"||condition.getClassification().getMeaning()==="PATSTATED");
});
for(var i=requestCnt;
i--;
){var currRequest=patientRequests[i];
var currRequestId=currRequest.getId();
var associatedCondition=requestMap[currRequestId];
patientRequestRows[i]=new PatientRequestRow(this,associatedCondition,privsObj,currRequest);
}for(var i=chronicProbs.length;
i--;
){chronicProbsRows[i]=new ChronicProblemsRow(this,chronicProbs[i],privsObj);
}for(i=historicProbs.length;
i--;
){historicProbsRows[i]=new ChronicProblemsRow(this,historicProbs[i],privsObj);
}if(problemsTab.id!==this.historyComp.m_tabControl.m_defaultTab){problemsTab.hasIndicator=false;
problemsTab.count=chronicProbsRows.length+historicProbsRows.length;
this.historyComp.tabsData[problemsTab.index].count=chronicProbsRows.length+historicProbsRows.length;
if(patientRequestRows.length>0&&this.historyComp.getViewOutsideHistoriesInd()){this.historyComp.updateTabIndicator(problemsTab,"<span class='chx-pat-req-icon'></span>");
problemsTab.count+=patientRequestRows.length;
this.historyComp.tabsData[problemsTab.index].count+=patientRequestRows.length;
}this.historyComp.updateTabCount();
return;
}this.createTable(chronicProbsRows,historicProbsRows,privsObj,conditions,patientRequestRows);
};
ChronicProblemsTab.prototype.renderNKPBanner=function(){var targetElement=null;
var messageType=null;
var messageTemplate=null;
var noChronicAlertMsg=null;
var nkpMessageLink="";
var documentNKPMessage="";
var nkpMsgHTML="";
var self=this;
targetElement=$("#noChronicProbMsg"+this.compId);
messageType=MPageControls.AlertMessage.MessageTypes.INFORMATION;
messageTemplate=MPageControls.getDefaultTemplates().messageBar;
noChronicAlertMsg=new MPageControls.AlertMessage(targetElement,messageTemplate,messageType);
nkpMessageLink="<a id=chxProb"+this.compId+"documentNKPBtn>"+this.chxi18n.NO_CHRONIC_PROBLEMS+"</a>";
documentNKPMessage=this.chxi18n.DOCUMENT_NO_CHRONIC_PROBLEMS.replace(/\{0\}/g,nkpMessageLink);
nkpMsgHTML="<span>"+this.chxi18n.NO_CHRONIC_PROBLEMS_DOCUMENTED+"</span><span class ='conprobo3-document-ncp'>&nbsp;"+documentNKPMessage+"</span>";
noChronicAlertMsg.render(nkpMsgHTML);
};
ChronicProblemsTab.prototype.getCancelledNKPCondition=function(){return this.sharedCondResource.getResourceData().filter("isCernerNKP",true).filter("isChronic",false)[0];
};
ChronicProblemsTab.prototype.getActiveNKPCondition=function(){return this.sharedCondResource.getResourceData().filter("isCernerNKP",true).filter("isChronic",true)[0];
};
ChronicProblemsTab.prototype.bindNKPEvents=function(){var self=this;
var removeNKPBtn=$("#chxProb"+this.compId+"removeNKPRowBtn");
var documentNKPBtn=$("#chxProb"+this.compId+"documentNKPBtn");
removeNKPBtn.click(function(){var activeNKPCondition=self.getActiveNKPCondition();
self.removeNKPCondition(activeNKPCondition);
});
documentNKPBtn.click(function(){self.documentNoChronicProblems(self);
});
};
ChronicProblemsTab.prototype.removeNKPCondition=function(activeNKPCondition){var self=this;
activeNKPCondition.cancel(function(){self.sharedCondResource.retrieveSharedResourceData();
});
};
ChronicProblemsTab.prototype.documentNoChronicProblems=function(self){var cancelledNKPCondition=self.getCancelledNKPCondition();
if(cancelledNKPCondition){cancelledNKPCondition.setIsChronic(true);
cancelledNKPCondition.activate(function(){self.sharedCondResource.retrieveSharedResourceData();
});
}else{var cond=new MPageEntity.entities.Condition();
var criterion=this.historyComp.getCriterion();
var encntr=criterion.encntr_id;
var prsn=criterion.person_id;
var cernerNKPNomenclature=this.sharedCondResource.getCernerNKPNomenclature();
cond.setIsThisVisit(false);
cond.setIsChronic(true);
cond.setClassificationValue(0);
cond.setNomenclatureValue(cernerNKPNomenclature);
cond.setTargetNomenclatureValue(cernerNKPNomenclature);
cond.setEncounterValue(encntr);
cond.setPersonValue(prsn);
cond.create(function(){self.sharedCondResource.retrieveSharedResourceData();
});
}};
ChronicProblemsTab.prototype.resetNKPRow=function(chronicRowsObj){for(var i=chronicRowsObj.length;
i--;
){if(chronicRowsObj[i].isNKPRow){var nkpRowId="chxProb"+this.compId+":CHRONIC_GROUP:row"+i;
var nkpRow=document.getElementById(nkpRowId);
this.moveNKPToTop(nkpRow);
break;
}}this.resetPreviousHighlightedRow();
};
ChronicProblemsTab.prototype.resetPreviousHighlightedRow=function(){if(this.previousClickedRow!==""){var selectedRow=document.getElementById(this.previousClickedRow);
this.highlightSelectedRow($(selectedRow));
}};
ChronicProblemsTab.prototype.moveNKPToTop=function(nkpRow){if(nkpRow){$("#chxProb"+this.compId+"\\:CHRONIC_GROUP\\:content").prepend(nkpRow);
this.fixZebraStripes();
}};
ChronicProblemsTab.prototype.fixZebraStripes=function(){var tableBodyArr=$("#chxProb"+this.compId+"\\:CHRONIC_GROUP\\:content").children();
for(var i=0;
i<tableBodyArr.length;
i++){tableBodyArr[i].className="result-info "+((i%2===0)?"odd":"even");
}this.resetPreviousHighlightedRow();
};
ChronicProblemsTab.prototype.checkShowNKPBanner=function(nkpPrivsObj,conditions){var showNKPBanner=false;
var hasNKPFlag=false;
var activeConditions=conditions.filter("isCernerNKP",true).filter("isChronic",true);
if(activeConditions.length){hasNKPFlag=true;
}if(!(nkpPrivsObj.hasChronicProbs)&&nkpPrivsObj.cernerNKPNomenclature>0){if(nkpPrivsObj.canViewNKP&&nkpPrivsObj.canUpdtNKP){if(!hasNKPFlag){showNKPBanner=true;
}}}return showNKPBanner;
};
ChronicProblemsTab.prototype.createTable=function(chronicProblems,historicalProblems,nkpPrivsObj,conditions,patientRequestRows){var patientEnteredDataFilter=this.historyComp.getPatientEnteredDataInd();
var displayHiDataInd=this.historyComp.getDisplayHiDataInd();
var viewOutsideRecsSelected=this.historyComp.getViewOutsideHistoriesInd();
var patRequestsDisplayInd=this.shouldLoadPatientRequests();
var tablePanelHTML="";
var problemCnt=chronicProblems.length+historicalProblems.length;
var historiesTabsArray=this.historyComp.m_tabControl.getTabs();
var self=this;
var nkpMsgContainerHTML="<div class ='message-container cpo3-nkp-msg' id ='noChronicProbMsg"+self.compId+"'></div>";
var segmentedControl=null;
this.historyComp.isProblemsRendered=true;
var hiDatalabel="";
var probTabContainer="<div id='probTabContent"+this.compId+"' style='position:relative'>";
var segmentedControlHTML="";
if(viewOutsideRecsSelected&&this.historyComp.getExternalDataInd()){segmentedControl=this.historyComp.createSegmentedControl(this.historyComp.HistoryComponentIndexObj.PROBLEMS);
segmentedControlHTML="<div class='chx-seg-control-container'>"+segmentedControl.render()+"</div>";
}var prbTableUI=new MPageUI.Table();
prbTableUI.setOptions({namespace:"chx-main-prb-table",rows:{striped:true},columns:{separators:false},sortable:true,select:MPageUI.TABLE_OPTIONS.SELECT.SINGLE_ROW});
this.prbTableUI=prbTableUI;
this.createProblemsTableColumns(patientRequestRows);
this.createProblemsTableGroups(chronicProblems,historicalProblems,patientRequestRows);
prbTableUI.setOnRowClickCallback(function(data){var rowSelectionArr=this.getSelection();
self.highlightSelectedRow(false);
if(rowSelectionArr.length===1){self.renderPanelDetails(rowSelectionArr[0]);
}else{self.sidePanel.m_cornerCloseButton.click();
}});
if(displayHiDataInd||(this.historyComp.getExternalDataInd()&&!patientEnteredDataFilter)){hiDatalabel=this.createHIAddDataControl();
tablePanelHTML=nkpMsgContainerHTML;
if(displayHiDataInd){tablePanelHTML+=segmentedControlHTML+"<div id='chx-hi-ext-label-outer"+this.compId+"' class='chx-hi-ext-div'></div>";
}else{tablePanelHTML+=hiDatalabel;
}tablePanelHTML+="<div id ='chxProb";
tablePanelHTML+=this.compId;
tablePanelHTML+="sidePanelContainer' class='chx-prob-side-panel'>&nbsp;</div>";
tablePanelHTML+=probTabContainer+prbTableUI.render()+"</div>";
}else{tablePanelHTML=nkpMsgContainerHTML;
if(this.historyComp.m_mfaBanner){tablePanelHTML+=this.historyComp.m_mfaBanner.render();
}tablePanelHTML+=segmentedControlHTML;
tablePanelHTML+="<div id ='chxProb";
tablePanelHTML+=this.compId;
tablePanelHTML+="sidePanelContainer' class='chx-prob-side-panel'>&nbsp;</div>";
tablePanelHTML+=probTabContainer+prbTableUI.render()+"</div>";
}this.historyComp.loadTabData(problemCnt,tablePanelHTML,this.historyComp.HistoryComponentIndexObj.PROBLEMS,function(){if(segmentedControl){segmentedControl.clearElementCache();
segmentedControl.attachEvents();
}},patientRequestRows.length);
var problemsTab=historiesTabsArray[this.historyComp.HistoryComponentIndexObj.PROBLEMS];
problemsTab.hasIndicator=false;
this.historyComp.renderTabDetails(problemsTab);
problemsTab.count=problemCnt;
if(patientRequestRows.length>0&&viewOutsideRecsSelected){problemsTab.hasIndicator=true;
this.historyComp.updateTabIndicator(problemsTab,"<span class='chx-pat-req-icon'></span>");
problemsTab.count=problemCnt+patientRequestRows.length;
}this.historyComp.updateTabCount();
if(this.checkShowNKPBanner(nkpPrivsObj,conditions)){this.renderNKPBanner();
}this.bindNKPEvents();
var vpHeightAvailable=parseInt($("#vwpBody").height(),10);
var tabContainerOffsetTop=parseInt($("#tabContainer"+this.compId).offset().top,10);
var probTabContentOffsetTop=parseInt($("#probTabContent"+this.compId).offset().top,10);
if(vpHeightAvailable&&tabContainerOffsetTop&&probTabContentOffsetTop){vpHeightAvailable=vpHeightAvailable-(probTabContentOffsetTop-tabContainerOffsetTop);
vpHeightAvailable-=60;
}else{vpHeightAvailable=$(prbTableUI.getRootElement()).height();
}prbTableUI.setMaxHeight(vpHeightAvailable);
prbTableUI.attachEvents();
this.tableObj=prbTableUI.getRootElement();
this.initializeSearchBox(conditions.getICD10CodeValuesFromMeta());
this.initializeSidePanel();
if(displayHiDataInd&&viewOutsideRecsSelected){this.historyComp.showHIData();
}this.initializePEDEvents();
};
ChronicProblemsTab.prototype.createProblemsTableGroups=function(chronicProblems,historicalProblems,patientRequestRows){var prbBaseGroupArray=[{label:this.chxi18n.CHRONIC_PROBLEMS,css:"secondary-group",collapsible:true,showCount:true,records:chronicProblems},{label:this.chxi18n.RESOLVED_PROBLEMS,css:"secondary-group",collapsible:true,expanded:false,showCount:true,records:historicalProblems}];
if(this.shouldLoadPatientRequests()){this.prbTableUI.setData({groups:[{showCount:true,collapsible:false,label:"<span class='pat-req-icon table-grp-header'></span>"+this.chxi18n.PATIENT_REQUESTS,records:patientRequestRows},{collapsible:false,label:this.chxi18n.OTHER_CHART_PROBLEMS,groups:prbBaseGroupArray}]});
}else{this.prbTableUI.setData({groups:prbBaseGroupArray});
}};
ChronicProblemsTab.prototype.createProblemsTableColumns=function(patientRequestRows){var tableColumns=[{id:"prbdisplay",label:this.chxi18n.NAME,css:"chx-prb-name",contents:function(record){return record.getRenderTemplate();
},sortOptions:{primary:{field:"DISPLAY_NAME",direction:MPageUI.TABLE_OPTIONS.SORT.ASCENDING}}},{id:"commInd",css:"chx-prb-comm-ind",contents:function(record){return record.getCommentsIndRenderTemplate();
}},{id:"prbclass",label:this.chxi18n.CLASSIFICATION,css:"chx-prb-class",contents:function(record){return record.getClassificationRenderTemplate();
},sortOptions:{primary:{field:"CLASS_DISPLAY",direction:MPageUI.TABLE_OPTIONS.SORT.ASCENDING}}}];
if(this.shouldLoadPatientRequests()&&patientRequestRows.length){var requestCol={id:"prbrequest",label:this.chxi18n.REQUEST,css:"chx-prb-request",contents:function(record){return record.getRequestRenderTemplate();
},sortOptions:{primary:{field:"REQUEST_TEXT",direction:MPageUI.TABLE_OPTIONS.SORT.ASCENDING},secondary:[{field:"DISPLAY_NAME",direction:MPageUI.TABLE_OPTIONS.SORT.ASCENDING}]}};
tableColumns.unshift(requestCol);
}this.prbTableUI.setColumns(tableColumns);
if(this.shouldLoadPatientRequests()){this.prbTableUI.sortBy({column:{id:"prbrequest",direction:MPageUI.TABLE_OPTIONS.SORT.ASCENDING}});
}else{this.prbTableUI.sortBy({column:{id:"prbdisplay",direction:MPageUI.TABLE_OPTIONS.SORT.ASCENDING}});
}};
ChronicProblemsTab.prototype.initializePEDEvents=function(){var self=this;
var inMillenniumContextInd=CERN_Platform.inMillenniumContext();
var compSecContentId=this.historyComp.getSectionContentNode().id;
var problemsLink=this.historyComp.getProblemsLink();
var mainHeaderLink=this.historyComp.getLink();
if(inMillenniumContextInd&&(problemsLink||mainHeaderLink)){$("#"+compSecContentId).find(".chx-problems").on("click",".chx-problems-sp-link",function(){self.openProblemsTab();
});
}var sidePanel=this.sidePanel;
var sidePanelContainer=sidePanel.m_sidePanelContents;
sidePanelContainer.on("click",".chx-side-panel-tgl",function(){var patReqSubSection=sidePanelContainer.find(".chx-expand-content");
if(patReqSubSection.hasClass("chx-section-closed")){$(this).removeClass("chx-show-expand-btn").addClass("chx-hide-expand-btn");
patReqSubSection.removeClass("chx-section-closed");
}else{$(this).removeClass("chx-hide-expand-btn").addClass("chx-show-expand-btn");
patReqSubSection.addClass("chx-section-closed");
}});
};
ChronicProblemsTab.prototype.openProblemsTab=function(){var criterion=this.historyComp.getCriterion();
var problemsTabLink=this.historyComp.getProblemsLink()?this.historyComp.getProblemsLink():this.historyComp.getLink();
var sParms="/PERSONID="+criterion.person_id+" /ENCNTRID="+criterion.encntr_id+" /FIRSTTAB=^"+problemsTabLink+"^";
APPLINK(0,criterion.executable,sParms);
};
ChronicProblemsTab.prototype.initializeSearchBox=function(icd10CodeValues){try{var searchBoxObj=$("#chxProbSearchContainer"+this.compId);
var probSearchBox=null;
var self=this;
if(searchBoxObj.length){probSearchBox=new MPageControls.NomenclatureSearch(searchBoxObj);
}probSearchBox.setCaption(this.chxi18n.ADD_PROBLEM);
probSearchBox.setICD10CodeValues(icd10CodeValues);
probSearchBox.activateCaption();
var probSearchInputElement=searchBoxObj.find("input");
var targetVocab=this.historyComp.getProbTargetVocab();
var searchVocab=this.historyComp.getProbSearchVocab();
var validSearchFlags=[1,2,3,4,5,6,7];
if(!this.inMillenniumContext){probSearchBox.disable();
return;
}if(!this.canModifyChronic){probSearchBox.disable();
logger.logWarning("The current user has insufficient privs for modifying chronic problems.");
return;
}if(!searchVocab){probSearchBox.disable();
logger.logWarning("The search vocabulary is not set to a valid value in bedrock for the chronic problems histories tab.");
return;
}if(searchVocab&&targetVocab){var searchVocabCv=new MPageEntity.CodeValue();
searchVocabCv.setId(searchVocab);
probSearchBox.setSourceVocabCodeValue(searchVocabCv);
}else{probSearchBox.disable();
logger.logWarning("The target vocabulary or search vocabulary are not properly set in bedrock for the chronic problems histories tab.");
return;
}probSearchBox.getList().setOnSelect(function(nomen){probSearchBox.activateCaption();
probSearchBox.close();
self.handleSelectedProblem(nomen.getId());
});
}catch(err){logger.logJSError(err,this.historyComp,"consolidate-chronicproblems.js","initializeSearchBox");
}};
ChronicProblemsTab.prototype.handleSelectedProblem=function(nomenclatureID){var actionTimer=new RTMSTimer("USR:MPG.CONSOLIDATED_HISTORY - chronic problem action",this.historyComp.criterion.category_mean);
MP_Util.LoadSpinner("chxContent"+this.compId);
try{var cond=new MPageEntity.entities.Condition();
var criterion=this.historyComp.getCriterion();
var encntr=criterion.encntr_id;
var prsn=criterion.person_id;
var targetVocab=this.historyComp.getProbTargetVocab();
var searchVocab=this.historyComp.getProbSearchVocab();
var conf=this.historyComp.getProbTargetConf()?this.historyComp.getProbTargetConf():null;
var medicalCVObj=MP_Util.GetCodeValueByMeaning("MEDICAL",12033);
var self=this;
if(!this.bedrockConfig){this.bedrockConfig=new MPageEntity.BedrockConfig();
this.bedrockConfig.setDefaultSearchVocab(searchVocab);
this.bedrockConfig.setChronicVocab(targetVocab);
this.bedrockConfig.setProblemClassification(medicalCVObj.codeValue);
if(conf){this.bedrockConfig.setProblemConfirmation(conf);
}}actionTimer.addMetaData("rtms.legacy.metadata.1","Add");
actionTimer.start();
cond.setIsChronic(true);
cond.setClassificationValue(medicalCVObj.codeValue);
cond.setNomenclatureValue(nomenclatureID);
cond.setEncounterValue(encntr);
cond.setPersonValue(prsn);
if(conf){cond.setConfirmationStatusValue(conf);
}cond.getCrossMapping(this.bedrockConfig);
cond.create(function(responseObj,reply,error){if(error){actionTimer.fail();
$("#chxContent"+self.compId).find(".loading-screen").remove();
self.showErrorModal(1);
return;
}var replyJSON=JSON.parse(reply);
if(replyJSON.RECORD_DATA.META.ERRORCD==1){actionTimer.fail();
$("#chxContent"+self.compId).find(".loading-screen").remove();
self.showErrorModal(2);
return;
}if(replyJSON.RECORD_DATA.META.STATUS==="success"){$("#chxContent"+self.compId).find(".loading-screen").remove();
actionTimer.stop();
self.renderComponent();
}});
}catch(err){actionTimer.fail();
$("#chxContent"+this.compId).find(".loading-screen").remove();
this.showErrorModal(0);
}finally{actionTimer.stop();
}};
ChronicProblemsTab.prototype.showErrorModal=function(errorType){var modalBodyHTML="";
if(!errorType){modalBodyHTML="<div class='chx-modal-container'><div class='error-icon-component'><span class='error-text'>"+this.chxi18n.ERROR_ADD_PROB_BODY+"</span> "+i18n.CONTACT_ADMINISTRATOR+"</div></div>";
}else{if(errorType===1){modalBodyHTML="<div class='chx-modal-container'><div class='error-icon-component'><span class='error-text'>"+this.chxi18n.ERROR_ADD_PROB_PRIV+"</span></div></div>";
}else{if(errorType===2){modalBodyHTML="<div class='chx-modal-container'><div class='information-container'>"+this.chxi18n.ERROR_ADD_DUP_BODY_ACTION+" "+this.chxi18n.ERROR_ADD_DUP_BODY_NOT_ADDED+"</div></div>";
}}}var modalObjExists=MP_ModalDialog.retrieveModalDialogObject("addProblemErrorModal");
var addProblemErrorModalObj=modalObjExists?modalObjExists:new ModalDialog("addProblemErrorModal");
if(!modalObjExists){var okCloseErrorBtn=new ModalButton("okCloseErrorBtn");
okCloseErrorBtn.setText(i18n.discernabu.CONFIRM_OK);
okCloseErrorBtn.setFocusInd(true);
okCloseErrorBtn.setCloseOnClick(true);
addProblemErrorModalObj.setTopMarginPercentage(25).setRightMarginPercentage(30).setBottomMarginPercentage(25).setLeftMarginPercentage(30).setIsBodySizeFixed(false);
if(errorType===2){addProblemErrorModalObj.setHeaderTitle(this.chxi18n.ERROR_ADD_DUP_TITLE);
}else{addProblemErrorModalObj.setHeaderTitle(this.chxi18n.ERROR_ADD_PROB_TITLE);
}addProblemErrorModalObj.addFooterButton(okCloseErrorBtn);
addProblemErrorModalObj.setShowCloseIcon(true);
MP_ModalDialog.addModalDialogObject(addProblemErrorModalObj);
MP_ModalDialog.showModalDialog("addProblemErrorModal");
addProblemErrorModalObj.setBodyHTML(modalBodyHTML);
}else{MP_ModalDialog.showModalDialog("addProblemErrorModal");
if(errorType===2){addProblemErrorModalObj.setHeaderTitle(this.chxi18n.ERROR_ADD_DUP_TITLE);
}else{addProblemErrorModalObj.setHeaderTitle(this.chxi18n.ERROR_ADD_PROB_TITLE);
}addProblemErrorModalObj.setBodyHTML(modalBodyHTML);
}};
ChronicProblemsTab.prototype.initializeSidePanel=function(){var sidePanelContId="chxProb"+this.compId+"sidePanelContainer";
this.sidePanelContainer=$("#"+sidePanelContId);
var tableHeight=null;
var self=this;
if(this.tableObj&&this.tableObj.length){tableHeight=this.tableObj.css("height");
}else{tableHeight=this.sidePanelMinHeight;
}if(this.sidePanelContainer.length){this.sidePanel=new CompSidePanel(this.compId,sidePanelContId);
this.sidePanel.setExpandOption(this.sidePanel.expandOption.EXPAND_DOWN);
this.sidePanel.setHeight(tableHeight);
this.sidePanel.setMinHeight(this.sidePanelMinHeight);
this.sidePanel.renderPreBuiltSidePanel();
this.sidePanel.setContents("<div></div>","chxProb"+this.compId+"table");
this.sidePanel.showCornerCloseButton();
this.sidePanel.setCornerCloseFunction(function(){$("#probTabContent"+self.compId).removeClass("chx-prob-table-with-panel");
$("#hiDataConsProbHist"+self.compId+"table").removeClass("chx-hi-hide-mode");
self.panelShowing=false;
self.highlightSelectedRow(false);
self.previousClickedRow="";
});
this.sidePanel.setOnExpandFunction(function(){$("#chxProb"+self.compId+"sidePanelContainer").attr("style","").addClass("chx-prob-side-panel-rel");
});
}};
ChronicProblemsTab.prototype.onRowClick=function(event,data){var selRow=$(event.target).parents("dl.result-info");
var panelId="chxProb"+this.compId+"sidePanelContainer";
if(!selRow.length||(data.RESULT_DATA.condition===null&&!(data.RESULT_DATA instanceof PatientRequestRow))||data.RESULT_DATA.isNKPRow){return;
}this.prbTableUI.deselectAll();
if(selRow[0].id===this.previousClickedRow){this.sidePanel.m_cornerCloseButton.click();
return;
}this.previousClickedRow=selRow[0].id;
this.renderPanelDetails(data.RESULT_DATA);
this.highlightSelectedRow(selRow);
};
ChronicProblemsTab.prototype.highlightSelectedRow=function(selRowObj){if(this.hiTableObj&&(this.hiTableObj.find(".selected"))){this.hiTableObj.find(".selected").removeClass("chx-prob-selected-row selected");
}if(selRowObj){selRowObj.addClass("chx-prob-selected-row selected");
}};
ChronicProblemsTab.prototype.renderPanelDetails=function(selRowObj){var tableHeight=null;
var onsetDate=null;
var conditionType=null;
var status=null;
var classification=null;
var confirmation=null;
var condition=selRowObj.condition;
var sidePanelHTML="";
if(!this.panelShowing){if(this.hiTableObj){tableHeight=this.hiTableObj.css("height");
this.hiTableObj.addClass("chx-hi-hide-mode");
}else{tableHeight=this.tableObj.css("height");
}$("#probTabContent"+this.compId).addClass("chx-prob-table-with-panel");
this.sidePanel.setHeight(tableHeight);
this.sidePanel.resizePanel();
this.sidePanelContainer.removeClass("chx-prob-side-panel");
this.sidePanelContainer.addClass("chx-prob-side-panel-init");
this.panelShowing=true;
this.sidePanel.showPanel();
}if(selRowObj.most_recent_condition){this.sidePanel.setTitleText(selRowObj.name);
var label="<p id = 'externalDataLabel' class='secondary-text';>";
label+="<span class='chx-ext-data-indicator'></span>";
label+="<span style='margin-left:5px text-align:left;padding-left: 7px;'>";
label+=this.chxi18n.HI_BTN_LBL_UPON_CLICK+"</span></p>";
label+="<div class='chx-sp-date-container'>";
label+=selRowObj.most_recent_condition.source.partition_description;
label+=" ("+selRowObj.most_recent_condition.source.type+")";
label+="</div><div class='sp-separator2'>&nbsp;</div>";
var sidePanelHtml=label;
sidePanelHtml+="</div><div><div class='chx-hi-sp-date-provider' id='probSPDateContainer";
sidePanelHtml+=this.historyComp.getComponentId();
sidePanelHtml+="'><dd class='secondary-text'>";
sidePanelHtml+=this.chxi18n.CONDITION_TYPE;
sidePanelHtml+="</dd><dd class='chx-read-only-date'>";
sidePanelHtml+=selRowObj.most_recent_condition.type;
sidePanelHtml+="</dd></div><div class='sp-separator2'>&nbsp;</div>";
sidePanelHtml+="<div><div class='chx-hi-sp-date-provider'>";
sidePanelHtml+="<dd class='secondary-text'>";
sidePanelHtml+=this.chxi18n.EFFECTIVE_DATE;
sidePanelHtml+="</dd><dd class='chx-read-only-date'>";
sidePanelHtml+=selRowObj.EFFECT_UTC;
sidePanelHtml+="</dd></div><div class='chx-hi-sp-date-provider'>";
sidePanelHtml+="<dd class='secondary-text'>";
sidePanelHtml+=this.chxi18n.STATUS;
sidePanelHtml+="</dd><dd class='chx-read-only-date'>";
sidePanelHtml+=selRowObj.most_recent_condition.status;
sidePanelHtml+="</dd></li></ul></div></div></div>";
this.sidePanel.setContents(sidePanelHtml,"hiDataConsProbHist"+this.compId+"table");
this.sidePanel.showPanel();
if($("#chxProb"+this.compId+"btnHolder")){$("#chxProb"+this.compId+"btnHolder").css("visibility","hidden");
}return;
}else{selRowObj.updateSidePanel(this.sidePanel);
}};
ChronicProblemsTab.prototype.enableOutsideReqToggle=function(){var sidePanelContainer=$("#sidePanel"+this.compId);
sidePanelContainer.on("click",".chx-side-panel-tgl",function(){var patReqSubSection=sidePanelContainer.find(".chx-expand-content");
$(this).toggleClass("chx-show-expand-btn chx-hide-expand-btn");
patReqSubSection.toggleClass("chx-section-closed");
});
};
ChronicProblemsTab.prototype.determineAvailableButtons=function(condition){var btnHolder=$("#chxProb"+this.compId+"btnHolder");
var cancelBtn=$("#chxProb"+this.compId+"cancelBtn");
var resolveBtn=$("#chxProb"+this.compId+"resolveBtn");
var modifyBtn=$("#chxProb"+this.compId+"modifyBtn");
var diags=condition.getDiagnoses();
var probs=condition.getProblems();
var nomenId=parseInt(condition.getNomenclatureValue(),10);
var isResolved=this.canModifyChronic&&condition.isResolved();
if(!this.canModifyChronic){btnHolder.css("visibility","hidden");
return;
}try{if(!(probs.length&&probs.filter("id",condition.getProblemDriverValue())[0].getCanCondModify())){btnHolder.css("visibility","hidden");
return;
}}catch(err){logger.logJSError(err,this.historyComp,"consolidate-chronicproblems.js","determineAvailableButtons");
}if(!this.inMillenniumContext){btnHolder.css("visibility","hidden");
return;
}if(!nomenId){resolveBtn.addClass("hidden");
cancelBtn.addClass("hidden");
return;
}if(isResolved){resolveBtn.addClass("hidden");
}};
ChronicProblemsTab.prototype.bindButtonEvents=function(condition){var resolveBtn=$("#chxProb"+this.compId+"resolveBtn");
var cancelBtn=$("#chxProb"+this.compId+"cancelBtn");
var modifyBtn=$("#chxProb"+this.compId+"modifyBtn");
var actionTimer=new RTMSTimer("USR:MPG.CONSOLIDATED_HISTORY - chronic problem action",this.historyComp.criterion.category_mean);
var self=this;
resolveBtn.on("click",function(event){try{MP_Util.LoadSpinner("chxContent"+this.compId);
actionTimer.addMetaData("rtms.legacy.metadata.1","Resolve");
actionTimer.start();
condition.moveToHistorical(function(responseObj,reply,error){if(error){showPanelError(0);
return;
}var replyJSON=JSON.parse(reply);
if(replyJSON.RECORD_DATA.META.STATUS==="success"){actionTimer.stop();
self.renderComponent();
}});
}catch(err){showPanelError(0);
$("#chxContent"+self.compId).find(".loading-screen").remove();
}finally{if(actionTimer){actionTimer.stop();
}}});
cancelBtn.on("click",function(event){try{MP_Util.LoadSpinner("chxContent"+this.compId);
actionTimer.addMetaData("rtms.legacy.metadata.1","Cancel");
actionTimer.start();
condition.cancel(function(responseObj,reply,error){if(error){showPanelError(1);
return;
}var replyJSON=JSON.parse(reply);
if(replyJSON.RECORD_DATA.META.STATUS==="success"){actionTimer.stop();
self.renderComponent();
}});
}catch(err){showPanelError(1);
$("#chxContent"+self.compId).find(".loading-screen").remove();
}finally{if(actionTimer){actionTimer.stop();
}}});
modifyBtn.on("click",function(event){MPageEntity.Win32ConditionModifier(condition,function(){self.renderComponent();
self.sharedCondResource.retrieveSharedResourceData();
},"Histories",true);
});
showPanelError=function(buttonClicked){var errorMsg="";
if(buttonClicked===0){errorMsg=self.chxi18n.ERROR_MSG_RESOLVE;
}else{if(buttonClicked===1){errorMsg=self.chxi18n.ERROR_MSG_CANCEL;
}}$("#chxProb"+self.compId+"errorMsgText").html(errorMsg);
$("#chxProb"+self.compId+"errorMsgBanner").css("display","inline-block");
actionTimer.fail();
};
};
ChronicProblemsTab.prototype.resizeComponent=function(){if(this.panelShowing&&this.sidePanel){var tableHeight=null;
var probsTable=this.tableObj;
if(probsTable){tableHeight=probsTable.css("height");
}this.sidePanel.setHeight(tableHeight);
this.sidePanel.resizePanel();
}};
})();
