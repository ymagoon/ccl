function CaseClosureWfStyle(){this.initByNamespace("caseClosureWf");
}CaseClosureWfStyle.prototype=new ComponentStyle();
CaseClosureWfStyle.prototype.constructor=ComponentStyle;
function CaseClosureWf(criterion){this.setCriterion(criterion);
this.setComponentLoadTimerName("USR:MPG.CASE_CLOSURE.O2 - load component");
this.setComponentRenderTimerName("ENG:MPG.CASE_CLOSURE.O2 - render component");
this.setStyles(new CaseClosureWfStyle());
this.namespace=this.getStyles().getNameSpace();
this.i18n=i18n.discernabu.CaseClosureO2;
this.hasOpenReminders=false;
}CaseClosureWf.prototype=new MPageComponent();
CaseClosureWf.prototype.constructor=MPageComponent;
CaseClosureWf.prototype.retrieveComponentData=function(){var component=this;
var criterion=component.getCriterion();
if(criterion.encntr_id){component.scriptRequest({name:"HCM_GET_CASE",params:[criterion.encntr_id+".0"]});
}else{component.finalizeComponent('<span class="disabled">'+component.i18n.NO_ENCNTR_CASE_TYPE+"</span>");
}};
CaseClosureWf.prototype.selectTag=function(name,idDisplayList,options){idDisplayList=$.makeArray(idDisplayList);
options=options||{prompt:null,selected:null,disabled:""};
var selectTag="<select "+options.disabled+' name="'+name+'">';
if(options.prompt){idDisplayList.unshift({id:"",display:options.prompt});
}selectTag+=$.map(idDisplayList,function(value){if(options.selected&&options.selected===value.id){return'<option value="'+value.id+'" selected>'+value.display+"</option>";
}else{return'<option value="'+value.id+'">'+value.display+"</option>";
}}).join("");
selectTag+="</select>";
return selectTag;
};
CaseClosureWf.prototype.caseClosureHtml=function(reply){var component=this;
var closureReasons=reply.AVAILABLE_CASE_STATUSES.CLOSURE_REASONS;
var selectedReason="";
var disabled="";
var currentStatus=reply.CURRENT_STATUS_CD;
var closureStatus=component.getCaseClosure(reply.CASE_STATUSES);
if(!closureStatus&&!reply.HAS_MODIFY_CASE_IND){var errorPrivilegeMessage=component.i18n.PRIVILEGE_ERROR;
return errorPrivilegeMessage;
}if(closureStatus&&closureStatus.STATUS_CD===currentStatus){selectedReason=reply.CLOSURE_REASON_CD;
disabled="disabled";
}var formStr='<form id="'+component.getComponentId()+'-filter-form" class="'+component.namespace+'-filter-form"><div>';
var closureOptions=$.map(closureReasons,function(closureReason){return{id:closureReason.REASON_CD,display:closureReason.REASON_DISP};
});
formStr+='<div class="'+component.namespace+'-reason-label">'+component.i18n.CLOSURE_REASON+"</div><div>"+component.selectTag("reason",closureOptions,{prompt:" ",selected:selectedReason,disabled:disabled});
formStr+='</div><div class="'+component.namespace+'-button-div"><input type="button" class="'+component.namespace+'-right-aligned-button" id="'+component.getComponentId()+'-clear-cases" value="'+component.i18n.CLEAR+'" disabled="disabled">';
formStr+='<input type="button" id="'+component.getComponentId()+'-close-case" class="'+component.namespace+'-right-aligned-button" value="'+component.i18n.CLOSURE_CONFIRM+'" disabled="disabled"></div> ';
formStr+="</form>";
return formStr;
};
CaseClosureWf.prototype.getCaseClosure=function(statuses){return $.grep(statuses,function(caseStatus){return caseStatus.STATUS_CDF_MEANING==="CLOSED";
})[0];
};
CaseClosureWf.prototype.renderComponent=function(reply){if(reply.STATUS_DATA.STATUS==="S"&&reply.CASE_TYPE_IND===0){this.finalizeComponent('<p class="disabled">'+this.i18n.NO_ENCNTR_CASE_TYPE+"</p>");
return;
}var component=this;
var componentId=component.getComponentId();
var $mainContainerObj=$('<div id="'+componentId+'-main-container" class="'+this.nameSpace+'-main-container">');
var filterFormStr=component.caseClosureHtml(reply);
$mainContainerObj.append(filterFormStr);
component.finalizeComponent($mainContainerObj[0].outerHTML);
$("#"+componentId+"-filter-form select").change(function(){component.disableButtons($.trim(this.value)==="");
});
$("#"+componentId+"-filter-form #"+componentId+"-clear-cases").click(function(){$("#"+componentId+"-filter-form select").prop("selectedIndex",0);
component.disableButtons(true);
});
$("#"+componentId+"-filter-form #"+componentId+"-close-case").click(function(){component.getOpenReminders(reply);
});
};
CaseClosureWf.prototype.closeCaseEncounters=function(caseInfo,reasonId){var component=this;
var componentId=component.getComponentId();
var caseInfoJson=this.caseInformation(caseInfo,reasonId);
component.disableButtons(true);
MP_Util.LoadSpinner(component.getSectionContentNode().id,1);
component.scriptRequest({name:"HCM_CHG_CASE",params:[component.criterion.person_id+".0",component.criterion.encntr_id+".0","^"+caseInfoJson+"^"],success:function(reply){component.checkForFailedUpdate(reply);
}});
};
CaseClosureWf.prototype.checkForFailedUpdate=function(reply){var component=this;
var componentId=component.getComponentId();
component.disableButtons(false);
if(reply.STATUS_DATA.STATUS!=="S"){$("#"+componentId+"-main-container").find(".loading-screen").remove();
component.displayErrorModal();
}else{component.retrieveComponentData();
}};
CaseClosureWf.prototype.displayErrorModal=function(){var component=this;
var compNS=component.namespace;
var modalId=component.getComponentId()+"displayError";
var modalDialog;
var modalBody='<span class="'+compNS+'-error-icon">'+component.i18n.CLOSURE_FAILURE+"</span><br>";
MP_ModalDialog.deleteModalDialogObject(modalId);
modalDialog=new ModalDialog(modalId);
modalDialog.setHeaderTitle(this.i18n.ERROR_OCCURRED).setTopMarginPercentage(25).setRightMarginPercentage(35).setBottomMarginPercentage(20).setLeftMarginPercentage(30).setIsBodySizeFixed(false).setHasGrayBackground(true).setIsFooterAlwaysShown(true);
modalDialog.setBodyDataFunction(function(modalObj){modalObj.setBodyElementId(component.namespace+"modalBody");
modalObj.setBodyHTML("<div><p>"+modalBody+"</p></div>");
});
var cancelButton=new ModalButton("Close");
cancelButton.setText(this.i18n.CLOSE).setIsDithered(false).setOnClickFunction(function(){MP_ModalDialog.closeModalDialog(modalId);
});
modalDialog.addFooterButton(cancelButton);
MP_ModalDialog.updateModalDialogObject(modalDialog);
MP_ModalDialog.showModalDialog(modalId);
};
CaseClosureWf.prototype.caseInformation=function(caseInfo,reasonId){var CASE_INFO={};
CASE_INFO.CASE_INFORMATION={};
CASE_INFO.CASE_INFORMATION.VERSION=caseInfo.VERSION;
CASE_INFO.CASE_INFORMATION.CURRENT_STATUS_CD=caseInfo.CURRENT_STATUS_CD;
CASE_INFO.CASE_INFORMATION.CURRENT_CARE_MANAGER_PRSNL_RELTN_ID=caseInfo.CURRENT_CARE_MANAGER_PRSNL_RELTN_ID;
CASE_INFO.CASE_INFORMATION.CASE_STATUS={};
var caseStatus=this.getCaseClosure(caseInfo.AVAILABLE_CASE_STATUSES.STATUSES);
CASE_INFO.CASE_INFORMATION.CASE_STATUS.CASE_CD=caseStatus.STATUS_CD;
CASE_INFO.CASE_INFORMATION.CASE_STATUS.REASON_CD=parseFloat(reasonId);
var caseInfoJsonString=JSON.stringify(CASE_INFO);
return caseInfoJsonString.replace(/"/g,"'");
};
CaseClosureWf.prototype.confirmCloseCase=function(caseInfo,reasonId){var component=this;
var compNS=component.namespace;
var modalId=component.getComponentId()+"confirmCloseCase";
var modalDialog;
var modalBody="";
if(component.hasOpenReminders){modalBody='<span class="'+compNS+'-warn-icon">'+component.i18n.OPEN_REMINDERS+"</span><br>";
}else{modalBody='<span class="'+compNS+'-warn-icon">'+component.i18n.CLOSURE_WARNING+"</span><br>";
}MP_ModalDialog.deleteModalDialogObject(modalId);
modalDialog=new ModalDialog(modalId);
modalDialog.setHeaderTitle(this.i18n.CASE_CLOSURE).setTopMarginPercentage(25).setRightMarginPercentage(35).setBottomMarginPercentage(20).setLeftMarginPercentage(30).setIsBodySizeFixed(false).setHasGrayBackground(true).setIsFooterAlwaysShown(true);
modalDialog.setBodyDataFunction(function(modalObj){modalObj.setBodyElementId(compNS+"modalBody");
modalObj.setBodyHTML("<div><p>"+modalBody+"</p></div>");
});
var confirmButton=new ModalButton("Confirm");
confirmButton.setText(this.i18n.CONFIRM).setIsDithered(false).setFocusInd(true).setOnClickFunction(function(){new CapabilityTimer("CAP:MPG CASE CLOSURE O2 CASE CLOSED").capture();
MP_ModalDialog.closeModalDialog(modalId);
component.closeCaseEncounters(caseInfo,reasonId);
});
modalDialog.addFooterButton(confirmButton);
var cancelButton=new ModalButton("Cancel");
cancelButton.setText(this.i18n.CANCEL).setIsDithered(false).setOnClickFunction(function(){MP_ModalDialog.closeModalDialog(modalId);
});
modalDialog.addFooterButton(cancelButton);
MP_ModalDialog.updateModalDialogObject(modalDialog);
MP_ModalDialog.showModalDialog(modalId);
};
CaseClosureWf.prototype.disableButtons=function(bool){$("#"+this.getComponentId()+"-clear-cases").prop("disabled",bool);
$("#"+this.getComponentId()+"-close-case").prop("disabled",bool);
};
CaseClosureWf.prototype.scriptRequest=function(settings){var component=this;
settings=settings||{};
var loadTimer=settings.loadTimer||new RTMSTimer(component.getComponentLoadTimerName());
var renderTimer=settings.renderTimer||new RTMSTimer(component.getComponentRenderTimerName());
var scriptRequest=new ComponentScriptRequest();
scriptRequest.setComponent(component);
scriptRequest.setLoadTimer(loadTimer);
scriptRequest.setRenderTimer(renderTimer);
scriptRequest.setProgramName(settings.name);
if(settings.params){scriptRequest.setParameterArray(["^MINE^"].concat(settings.params));
}if(settings.success){scriptRequest.setResponseHandler(function(reply){settings.success(reply.getResponse());
});
}scriptRequest.performRequest();
};
CaseClosureWf.prototype.getOpenReminders=function(caseInfo){var component=this;
var criterion=component.getCriterion();
var encntrVal="value("+criterion.encntr_id+")";
var stickNoteTypes=0;
var loadingPolicy=14;
var lookbackUnits=0;
var lookbackFlag=0;
var componentId=component.getComponentId();
MP_Util.LoadSpinner(component.getSectionContentNode().id,1);
component.scriptRequest({name:"MP_RETRIEVE_NOTE_REMINDER_JSON",params:[criterion.person_id+".0",stickNoteTypes,loadingPolicy,encntrVal,lookbackUnits,lookbackFlag,criterion.provider_id+".0",criterion.ppr_cd+".0"],success:function(reply){var reminders=reply.REMINDERS;
component.hasOpenReminders=reminders.length>0;
$("#"+component.getSectionContentNode().id).find(".loading-screen").remove();
component.confirmCloseCase(caseInfo,$("#"+componentId+"-filter-form select").val());
}});
};
MP_Util.setObjectDefinitionMapping("WF_CASE_CLOSURE",CaseClosureWf);
