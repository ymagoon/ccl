function DocumentComponent2Style(){this.initByNamespace("doc2");
}DocumentComponent2Style.prototype=new ComponentStyle();
DocumentComponent2Style.prototype.constructor=ComponentStyle;
function DocumentComponent2(criterion){var docI18n=i18n.discernabu.documents_o2;
this.setStyles(new DocumentComponent2Style());
this.setCriterion(criterion);
this.setComponentLoadTimerName("USR:MPG.DOCUMENTS.O2 - load component");
this.setComponentRenderTimerName("ENG:MPG.DOCUMENTS.O2 - render component");
this.setLookBackDropDown(true);
this.setIncludeLineNumber(true);
this.setPregnancyLookbackInd(true);
this.m_PowerNoteFavInd=false;
this.clinicalLabel=docI18n.FACILITY_DEFINED;
this.m_docImagesInd=false;
this.m_allCompletedDocList=[];
this.m_incompleteDocList=[];
this.m_filteredCompletedDocList=[];
this.m_patRequestDocList=[];
this.m_isMyNoteOnly=false;
this.m_isByEncounter=false;
this.m_nSortInd=10;
this.m_sidePanel=null;
this.m_isContainerFocused=false;
this.m_isChildFocused=false;
this.m_documentDisplayCache={};
this.m_offsetTopAdjustment=null;
this.m_lastXNoteCap=50;
this.m_showingLastXNotes=false;
this.m_resultRangeSelectionDisplayString=i18n.discernabu.render_strategy.LAST_N_NOTES;
this.setLookbackUnits(this.m_lastXNoteCap);
this.setLookbackUnitTypeFlag(ResultRangeSelectionUtility.CustomType);
this.m_grouper_arr=[];
this.m_patSubmittedDocsInd=true;
this.m_docsCodes=[];
this.m_addDocPriv=0;
this.m_adddDocPrivExptions=[];
this.m_docAcceptButton=null;
this.m_docRejectButton=null;
}DocumentComponent2.prototype=new MPageComponent();
DocumentComponent2.prototype.constructor=MPageComponent;
DocumentComponent2.prototype.setClinicallabel=function(value){this.clinicalLabel=value;
};
DocumentComponent2.prototype.openTab=function(){var criterion=this.getCriterion();
var sParms="/PERSONID="+criterion.person_id+" /ENCNTRID="+criterion.encntr_id+" /FIRSTTAB=^"+this.getLink()+"+^";
APPLINK(0,criterion.executable,sParms);
};
DocumentComponent2.prototype.getPowerNoteFavInd=function(){return this.m_PowerNoteFavInd;
};
DocumentComponent2.prototype.setPowerNoteFavInd=function(value){this.m_PowerNoteFavInd=(value===1?true:false);
};
DocumentComponent2.prototype.getDocImagesInd=function(){return this.m_docImagesInd;
};
DocumentComponent2.prototype.isTaggingEnabled=function(){var inMilleniumContext=CERN_Platform.inMillenniumContext();
var taggingEnabled=MP_TaggingHandler&&MP_TaggingHandler.isTaggingAvailable();
var DocUtilsHelper=DocumentationUtils.getDocUtilsHelper();
var cleanHtmlAvailable=DocUtilsHelper!==null&&typeof DocUtilsHelper!=="undefined"&&typeof DocUtilsHelper.CleanHtml!=="undefined";
return inMilleniumContext&&taggingEnabled&&cleanHtmlAvailable;
};
DocumentComponent2.prototype.setDocImagesInd=function(value){this.m_docImagesInd=(value===1?true:false);
};
DocumentComponent2.prototype.setPatSubmittedDocsCheckBoxPref=function(value){this.m_patSubmittedDocsInd=value;
var cookieValue=(value)?"yes":"no";
MP_Util.AddCookieProperty(this.getComponentId(),"VIEW_PATIENT_SUBMITTED_DOCS",cookieValue);
MP_Util.WriteCookie();
};
DocumentComponent2.prototype.getPatSubmittedDocsCheckBoxPref=function(){var viewOutsideRecordsCookie=MP_Util.GetCookieProperty(this.getComponentId(),"VIEW_PATIENT_SUBMITTED_DOCS");
if(viewOutsideRecordsCookie){this.setPatSubmittedDocsCheckBoxPref((viewOutsideRecordsCookie==="yes")?true:false);
}return this.m_patSubmittedDocsInd;
};
DocumentComponent2.prototype.setDocumentsCodes=function(codeArray){this.m_docsCodes=MP_Util.LoadCodeListJSON(codeArray);
};
DocumentComponent2.prototype.getDocumentsCodes=function(){return this.m_docsCodes;
};
DocumentComponent2.prototype.setAddDocPriv=function(priv){this.m_addDocPriv=priv;
};
DocumentComponent2.prototype.getAddDocPriv=function(){return this.m_addDocPriv;
};
DocumentComponent2.prototype.setAdddDocPrivExptions=function(privExceptions){this.m_adddDocPrivExptions=privExceptions;
};
DocumentComponent2.prototype.getAdddDocPrivExptions=function(){return this.m_adddDocPrivExptions;
};
DocumentComponent2.prototype.isDisplayPatSubmittedDocsEnabled=function(){return(this.getPatientEnteredDataInd()&&this.getPatSubmittedDocsCheckBoxPref());
};
DocumentComponent2.prototype.resizeComponent=function(){this.m_offsetTopAdjustment=null;
var compID=this.getComponentId();
MPageComponent.prototype.resizeComponent.call(this,null);
var contentContainer=$("#"+this.getStyles().getContentId());
var contentBody=contentContainer.find(".content-body");
if(contentBody.length){var docHeader=$("#docHdrRow"+compID);
var maxHeight=parseInt($(contentBody).css("max-height").replace("px",""),10);
var contentHeight=contentBody[0].scrollHeight;
if(!isNaN(maxHeight)&&contentHeight>maxHeight){docHeader.addClass("shifted");
}else{docHeader.removeClass("shifted");
}}this.resizeSidePanel();
this.resizeSidePanelIFrame();
};
DocumentComponent2.prototype.resizeSidePanel=function(){var compID=this.getComponentId();
var sidePanel=this.m_sidePanel;
if(sidePanel&&this.m_selectedRowObj){var viewContainer=$("#vwpBody");
var componentContainer=$("#"+this.getStyles().getId());
var contentContainer=$("#"+this.getStyles().getContentId());
var contentBody=contentContainer.find(".content-body");
var componentHeader=componentContainer.find(".sec-hd");
var menuRow=componentContainer.find(".doc2-menu-row");
var contentHeader=$("#docHdrRow"+this.getComponentId());
var rowBorder=2;
var sidePanelWidth=contentBody.outerWidth()-contentHeader.find(".doc2-cat-hd").position().left+rowBorder;
sidePanel.m_parentContainer.width(sidePanelWidth);
var miscPaddings=parseInt(componentContainer.css("padding-top").replace("px",""),10)+parseInt(contentContainer.css("padding-top").replace("px",""),10)+parseInt(contentContainer.css("padding-bottom").replace("px",""),10);
var sidePanelContentContainer=sidePanel.m_sidePanelContents;
var contentPaddingHeight=parseInt(sidePanelContentContainer.css("padding-top").replace("px",""),10)+parseInt(sidePanelContentContainer.css("padding-bottom").replace("px",""),10);
var maxPanelHeight=viewContainer.height()-componentHeader.outerHeight()-menuRow.outerHeight()-miscPaddings-contentPaddingHeight;
var actionBar=sidePanelContentContainer.find(".doc2-sp-action-holder");
var actionBarHeight=actionBar.outerHeight()+parseInt(actionBar.css("margin-bottom").replace("px",""),10);
var headerContainer=sidePanelContentContainer.find(".sp-header");
var headerHeight=headerContainer.outerHeight();
var viewingAreaMargins=parseInt($("#doc2SidePanelViewableContent"+compID).css("margin-top"),10);
var maxViewingHeight=maxPanelHeight-actionBarHeight-headerHeight-viewingAreaMargins;
$("#doc2SidePanelViewableContent"+compID).height(maxViewingHeight);
sidePanel.resizePanel(maxPanelHeight+"px");
}};
DocumentComponent2.prototype.resizeSidePanelIFrame=function(){var iframe;
var eventId;
if(this.m_sidePanel&&this.m_selectedRowObj){eventId=this.m_selectedRowObj.attr("data-eventid");
if(eventId&&this.m_documentDisplayCache[eventId]){iframe=this.m_documentDisplayCache[eventId].iframe;
}if(iframe){iframe.resize();
}}};
DocumentComponent2.prototype.loadFilterMappings=function(){this.addFilterMappingObject("FACILITY_DEFINED_LABEL",{setFunction:this.setClinicallabel,type:"String",field:"FREETEXT_DESC"});
this.addFilterMappingObject("WF_DOC_SPECIALTY_GRP1_LABEL",{setFunction:this.setGrp1Label,type:"String",field:"FREETEXT_DESC"});
this.addFilterMappingObject("WF_DOC_SPECIALTY_GRP1_ES",{setFunction:this.setGrp1Criteria,type:"Array",field:"PARENT_ENTITY_ID"});
this.addFilterMappingObject("WF_DOC_SPECIALTY_GRP2_LABEL",{setFunction:this.setGrp2Label,type:"String",field:"FREETEXT_DESC"});
this.addFilterMappingObject("WF_DOC_SPECIALTY_GRP2_ES",{setFunction:this.setGrp2Criteria,type:"Array",field:"PARENT_ENTITY_ID"});
this.addFilterMappingObject("WF_DOC_SPECIALTY_GRP3_LABEL",{setFunction:this.setGrp3Label,type:"String",field:"FREETEXT_DESC"});
this.addFilterMappingObject("WF_DOC_SPECIALTY_GRP3_ES",{setFunction:this.setGrp3Criteria,type:"Array",field:"PARENT_ENTITY_ID"});
this.addFilterMappingObject("WF_DOC_SPECIALTY_GRP4_LABEL",{setFunction:this.setGrp4Label,type:"String",field:"FREETEXT_DESC"});
this.addFilterMappingObject("WF_DOC_SPECIALTY_GRP4_ES",{setFunction:this.setGrp4Criteria,type:"Array",field:"PARENT_ENTITY_ID"});
this.addFilterMappingObject("WF_DOC_SPECIALTY_GRP5_LABEL",{setFunction:this.setGrp5Label,type:"String",field:"FREETEXT_DESC"});
this.addFilterMappingObject("WF_DOC_SPECIALTY_GRP5_ES",{setFunction:this.setGrp5Criteria,type:"Array",field:"PARENT_ENTITY_ID"});
this.addFilterMappingObject("WF_DOC_SPECIALTY_GRP6_LABEL",{setFunction:this.setGrp6Label,type:"String",field:"FREETEXT_DESC"});
this.addFilterMappingObject("WF_DOC_SPECIALTY_GRP6_ES",{setFunction:this.setGrp6Criteria,type:"Array",field:"PARENT_ENTITY_ID"});
this.addFilterMappingObject("WF_DOC_SPECIALTY_GRP7_LABEL",{setFunction:this.setGrp7Label,type:"String",field:"FREETEXT_DESC"});
this.addFilterMappingObject("WF_DOC_SPECIALTY_GRP7_ES",{setFunction:this.setGrp7Criteria,type:"Array",field:"PARENT_ENTITY_ID"});
this.addFilterMappingObject("WF_DOC_SPECIALTY_GRP8_LABEL",{setFunction:this.setGrp8Label,type:"String",field:"FREETEXT_DESC"});
this.addFilterMappingObject("WF_DOC_SPECIALTY_GRP8_ES",{setFunction:this.setGrp8Criteria,type:"Array",field:"PARENT_ENTITY_ID"});
this.addFilterMappingObject("WF_DOC_SPECIALTY_GRP9_LABEL",{setFunction:this.setGrp9Label,type:"String",field:"FREETEXT_DESC"});
this.addFilterMappingObject("WF_DOC_SPECIALTY_GRP9_ES",{setFunction:this.setGrp9Criteria,type:"Array",field:"PARENT_ENTITY_ID"});
this.addFilterMappingObject("WF_DOC_SPECIALTY_GRP10_LABEL",{setFunction:this.setGrp10Label,type:"String",field:"FREETEXT_DESC"});
this.addFilterMappingObject("WF_DOC_SPECIALTY_GRP10_ES",{setFunction:this.setGrp10Criteria,type:"Array",field:"PARENT_ENTITY_ID"});
this.addFilterMappingObject("WF_DOC_POWERNOTE_FAVOR_IND",{setFunction:this.setPowerNoteFavInd,type:"Boolean",field:"FREETEXT_DESC"});
this.addFilterMappingObject("WF_DOC_IMAGE_IND",{setFunction:this.setDocImagesInd,type:"BOOLEAN",field:"FREETEXT_DESC"});
this.addFilterMappingObject("WF_PAT_ENTERED_CLIN_DOC",{setFunction:this.setPatientEnteredDataInd,type:"BOOLEAN",field:"FREETEXT_DESC"});
};
DocumentComponent2.prototype.createDisclaimerMessage=function(){var lookbackDisplay="";
switch(this.getBrLookbackUnitTypeFlag()){case 1:lookbackDisplay=i18n.discernabu.LAST_N_HOURS_LOWER.replace("{0}",this.getBrLookbackUnits());
break;
case 2:lookbackDisplay=i18n.discernabu.LAST_N_DAYS_LOWER.replace("{0}",this.getBrLookbackUnits());
break;
case 3:lookbackDisplay=i18n.discernabu.LAST_N_WEEKS_LOWER.replace("{0}",this.getBrLookbackUnits());
break;
case 4:lookbackDisplay=i18n.discernabu.LAST_N_MONTHS_LOWER.replace("{0}",this.getBrLookbackUnits());
break;
case 5:lookbackDisplay=i18n.discernabu.LAST_N_YEARS_LOWER.replace("{0}",this.getBrLookbackUnits());
break;
default:lookbackDisplay=(this.getScope()===2)?i18n.discernabu.SELECTED_VISIT_LOWER:i18n.discernabu.All_VISITS_LOWER;
}return"* "+i18n.discernabu.documents_o2.DISCLAIMER.replace("{0}",this.m_lastXNoteCap).replace("{1}",lookbackDisplay);
};
DocumentComponent2.prototype.preProcessing=function(){var customMenuItem=new ResultRangeSelection();
customMenuItem.setType(ResultRangeSelectionUtility.CustomType);
customMenuItem.setDirection(ResultRangeSelectionUtility.direction.BACKWARD);
customMenuItem.setUnits(this.m_lastXNoteCap);
customMenuItem.setScope(this.getScope());
customMenuItem.setDisplay(this.m_resultRangeSelectionDisplayString);
ResultRangeSelectionUtility.addCustomResultRangeSelectionItem(this,customMenuItem);
};
DocumentComponent2.prototype.getComponentEventSets=function(){var eventSetArr=[];
var bedrockFilterGroups=this.getGroups();
var facEvents=(bedrockFilterGroups&&bedrockFilterGroups.length>0)?bedrockFilterGroups[0].getEventSets():[];
var grouperCnt=this.m_grouper_arr.length;
var grouperEventSetArr=null;
var criteriaArray=this.m_grouperFilterCriteria;
var grouperItem=null;
if(criteriaArray instanceof Array&&criteriaArray.length){if($.inArray(this.clinicalLabel,criteriaArray)!==-1){eventSetArr=eventSetArr.concat(facEvents);
}for(var x=0;
x<grouperCnt;
x++){grouperItem=this.m_grouper_arr[x];
if(grouperItem&&$.inArray(grouperItem.label+x,criteriaArray)!==-1){grouperEventSetArr=this.getGrouperCriteria(x);
if(grouperEventSetArr){eventSetArr=eventSetArr.concat(grouperEventSetArr);
}}}}if(eventSetArr.length===0){eventSetArr=eventSetArr.concat(facEvents);
}return eventSetArr;
};
DocumentComponent2.prototype.retrieveComponentData=function(){var criterion=this.getCriterion();
var encntrSelection=0;
var loadDocImages=0;
var loadPowerNoteFavs=0;
var deferViewerTypeInd=1;
var eventSetArr=this.getComponentEventSets();
encntrSelection=(this.getScope()===2)?(criterion.encntr_id+".0"):"0.0";
loadDocImages=(this.getDocImagesInd())?1:0;
if(this.isPlusAddEnabled()){loadPowerNoteFavs=this.getPowerNoteFavInd()?1:0;
}var lookbackUnits=this.getLookbackUnits();
var lookbackType=this.getLookbackUnitTypeFlag();
if(lookbackType===ResultRangeSelectionUtility.CustomType){lookbackUnits=this.getBrLookbackUnits();
lookbackType=this.getBrLookbackUnitTypeFlag();
this.m_showingLastXNotes=true;
}else{this.m_showingLastXNotes=false;
}var resultCap=(this.m_showingLastXNotes)?this.m_lastXNoteCap:40000;
var loadPatSubmittedDocs=0;
var patSubmittedDocTimer=null;
if(this.isDisplayPatSubmittedDocsEnabled()){loadPatSubmittedDocs=1;
patSubmittedDocTimer=new CapabilityTimer("CAP:MPG Documents Load Patient Entered Data");
patSubmittedDocTimer.capture();
if(this.getScope()===1){var encntrs=criterion.getPersonnelInfo().getViewableEncounters();
encntrSelection=(encntrs)?"value("+encntrs+")":encntrSelection;
}}var paramArr=["^MINE^",criterion.person_id+".0",encntrSelection,criterion.provider_id+".0",lookbackUnits,MP_Util.CreateParamArray(eventSetArr,1),0,criterion.ppr_cd+".0",lookbackType,loadDocImages,loadPowerNoteFavs,deferViewerTypeInd,resultCap,loadPatSubmittedDocs];
var self=this;
var loadTimer=new RTMSTimer(this.getComponentLoadTimerName(),this.getCriterion().category_mean);
var renderTimer=new RTMSTimer(this.getComponentRenderTimerName(),this.getCriterion().category_mean);
var scriptRequest=new ComponentScriptRequest();
scriptRequest.setProgramName("MP_RETRIEVE_DOCUMENTS_JSON_DP");
scriptRequest.setParameterArray(paramArr);
scriptRequest.setComponent(this);
scriptRequest.setLoadTimer(loadTimer);
scriptRequest.setRenderTimer(renderTimer);
scriptRequest.setResponseHandler(function(scriptReply){self.renderComponent(scriptReply);
});
scriptRequest.performRequest();
this.m_documentDisplayCache={};
};
DocumentComponent2.prototype.appendDropDown=function(powernotes){var uniqueComponentId=this.getStyles().getId();
if(!powernotes||!powernotes.length){return;
}if($(this.getRootComponentNode()).find("#headerMenu"+uniqueComponentId).length){return;
}var dropDownSpan=Util.cep("span",{className:"drop-down-ctrl"});
var link=Util.cep("a",{className:"drop-Down",id:"headerMenu"+uniqueComponentId});
var menu=Util.cep("div",{id:uniqueComponentId+"Menu",className:"form-menu menu-hide"});
Util.ac(dropDownSpan,link);
var sec=_g(this.getStyles().getId());
var secCL=Util.Style.g("sec-hd",sec,"h2");
var secSpan=secCL[0];
var secTitle=Util.Style.g("sec-title",secSpan,"span");
var secTitleSpan=secTitle[0];
Util.ac(link,secTitleSpan);
Util.ac(secTitleSpan,secSpan);
Util.ac(menu,secSpan);
this.fillPowernotesMenu(powernotes);
};
DocumentComponent2.prototype.fillPowernotesMenu=function(powernotes){var uniqueComponentId=this.getStyles().getId();
var criterion=this.getCriterion();
var docDropId="headerMenu"+uniqueComponentId;
var docDrop=_g(docDropId);
var numId=0;
powernotes.sort(function(obj1,obj2){function checkStrings(s1,s2){return(s1===s2)?0:((s1>s2)?1:-1);
}return checkStrings(obj1.DISPLAY.toUpperCase(),obj2.DISPLAY.toUpperCase());
});
var component=this;
function handleDocumentClickFunction(encounterPathVal,ckiIdent,ckiSource,sourceIdent){return function(){try{var PowerNoteMPageUtils=CERN_Platform.getDiscernObject("POWERNOTE");
logger.logDiscernInfo(null,"POWERNOTE","document.js","addDocDet");
if(PowerNoteMPageUtils){if(encounterPathVal===0){PowerNoteMPageUtils.BeginNoteFromPrecompletedNote(parseFloat(criterion.person_id),parseFloat(criterion.encntr_id),parseFloat(sourceIdent));
}else{if(encounterPathVal===1){PowerNoteMPageUtils.BeginNoteFromEncounterPathway(parseFloat(criterion.person_id),parseFloat(criterion.encntr_id),ckiSource,ckiIdent);
}}component.retrieveComponentData();
}}catch(exe){alert('An error has occured calling DiscernObjectFactory("POWERNOTE"): '+exe.name+" "+exe.message);
return;
}};
}var headerMenu=new Menu("headerMenu"+uniqueComponentId);
headerMenu.setTypeClass("header-dropdown-menu");
headerMenu.setAnchorElementId("headerMenu"+uniqueComponentId);
headerMenu.setAnchorConnectionCorner(["bottom","left"]);
headerMenu.setContentConnectionCorner(["top","left"]);
headerMenu.setIsRootMenu(true);
$(docDrop).click(function(){if(!headerMenu.isActive()){MP_MenuManager.showMenu("headerMenu"+uniqueComponentId);
}else{MP_MenuManager.closeMenuStack(true);
}});
var pcNote=null;
var headerMenuItem=null;
for(var j=0,l=powernotes.length;
j<l;
j++){pcNote=powernotes[j];
numId=numId+1;
headerMenuItem=new MenuSelection("pcnFavorite"+uniqueComponentId+"-"+j);
headerMenuItem.setCloseOnClick(true);
headerMenuItem.setClickFunction(handleDocumentClickFunction(pcNote.PRE_ENCPTH_VAL,pcNote.CKI_IDENT,pcNote.CKI_SRC,pcNote.SOURCE_IDENTIFIER));
headerMenuItem.setLabel(pcNote.DISPLAY);
headerMenu.addMenuItem(headerMenuItem);
}MP_MenuManager.updateMenuObject(headerMenu);
};
DocumentComponent2.prototype.isBlankString=function(str){return(!str||/^\s*$/.test(str));
};
DocumentComponent2.prototype.singleRowDocHTML=function(docDataObj,isInProgress){var docI18n=i18n.discernabu.documents_o2;
var compNS=this.getStyles().getNameSpace();
var docDataInfoExtId=(docDataObj.patSubmittedInd)?docDataObj.interopData.EXT_DATA_INFO_ID:0;
var sHTMLArr=["<h3 class='info-hd'>Document Information</h3><dl class='",compNS,"-info result-info' data-doc-info-ext-id='"+docDataInfoExtId+"' data-eventid='"+docDataObj.eventId+"'>"];
var noteType=docDataObj.noteType;
if(this.isBlankString(noteType)){noteType="&nbsp;";
}var subject=docDataObj.subject;
if(this.isBlankString(subject)){subject="&nbsp;";
}var author=docDataObj.authorName;
if(this.isBlankString(author)){author="&nbsp;";
}var lastPrsnl=docDataObj.lastUpdatedBy;
if(this.isBlankString(lastPrsnl)){lastPrsnl="&nbsp;";
}var noteTypeHTML="";
if(isInProgress){noteTypeHTML="<dd class='doc2-cat in-progress'>"+noteType+"<span class='comment'> ("+docI18n.IN_PROGRESS+")</span>";
}else{noteTypeHTML="<dd class='doc2-cat'>"+noteType;
}if(docDataObj.docStatusMean==="MODIFIED"||docDataObj.docStatusMean==="ALTERED"){noteTypeHTML+="<span class='res-modified'>&nbsp;</span>";
}noteTypeHTML+="</dd>";
sHTMLArr.push("<dd class='",compNS,"-dt'>",docDataObj.timeOfServiceDateDisplay,"</dd>","<dd class='",compNS,"-subj'>",subject,"</dd>",noteTypeHTML,"<dd class='",compNS,"-auth'>",author,"</dd>","<dd class='",compNS,"-updt-dt'>",docDataObj.lastUpdatedDateDisplay,"</dd>","<dd class='",compNS,"-updt-prsnl'>",lastPrsnl,"</dd>","<dd class='",compNS,"-image'>");
if(docDataObj.imageUrl!==""){sHTMLArr.push("<a class='",compNS,"-image-found'>&nbsp;</a></dd></dl>");
}else{sHTMLArr.push("&nbsp;","</dd></dl>");
}return sHTMLArr.join("");
};
DocumentComponent2.prototype.refreshSpecialtyFilterDisplay=function(){var criteriaArray=this.m_grouperFilterCriteria;
var compID=this.getComponentId();
var groupLen=this.m_grouper_arr.length;
var grouperItem=null;
var z=0;
var isFilterSelected=false;
var selectedSpecFilterCount=0;
if(criteriaArray instanceof Array&&criteriaArray.length){for(z=0;
z<groupLen;
z++){grouperItem=this.m_grouper_arr[z];
if(grouperItem){isFilterSelected=($.inArray(grouperItem.label+z,criteriaArray)!==-1);
$("#specFil"+compID+z).prop("checked",isFilterSelected);
if(isFilterSelected){selectedSpecFilterCount++;
}}}var isFacilityDefinedSelected=($.inArray(this.clinicalLabel,criteriaArray)!==-1);
if(selectedSpecFilterCount===0){isFacilityDefinedSelected=true;
}$("#facilityDefined"+compID).prop("checked",isFacilityDefinedSelected);
}else{for(z=0;
z<groupLen;
z++){$("#specFil"+compID+z).prop("checked",false);
}$("#facilityDefined"+compID).prop("checked",true);
}};
DocumentComponent2.prototype.toggleSpecialtyFilterPanel=function(){var compID=this.getComponentId();
var panel=$("#QFilterDiv"+compID);
var specFilter=$("#doc-spec-filter"+compID);
if(specFilter.hasClass("doc2-visible")){specFilter.removeClass("doc2-visible");
panel.removeClass("doc2-qHvr-click");
}else{specFilter.addClass("doc2-visible");
panel.removeClass("doc2-qFilter-hover").addClass("doc2-qHvr-click");
}};
DocumentComponent2.prototype.getQuickFilterLabel=function(){var noteCount=0;
var docI18n=i18n.discernabu.documents_o2;
var groupLen=this.m_grouper_arr.length;
var grouperItem=null;
var noteStatus=this.clinicalLabel;
if(this.m_grouperFilterCriteria&&$.inArray(this.clinicalLabel,this.m_grouperFilterCriteria)!==-1){noteCount=noteCount+1;
noteStatus=this.clinicalLabel;
}for(var z=0;
z<groupLen;
z++){grouperItem=this.m_grouper_arr[z];
if(this.m_grouperFilterCriteria&&grouperItem&&$.inArray(grouperItem.label+z,this.m_grouperFilterCriteria)!==-1){noteCount++;
if(noteCount>1){noteStatus=docI18n.MULTIPLE_NOTES;
break;
}else{noteStatus=this.m_grouper_arr[z].label;
}}}return noteStatus;
};
DocumentComponent2.prototype.renderComponent=function(scriptReply){try{if(!this.m_wasListenerAdded){CERN_EventListener.addListener(this,EventListener.EVENT_ADD_DOC,this.retrieveComponentData,this);
this.m_wasListenerAdded=true;
}var repStatus=scriptReply.getStatus();
if(repStatus==="F"){var errMsg=scriptReply.getError();
this.finalizeComponent(MP_Util.HandleErrorResponse(this.getStyles().getNameSpace(),errMsg),"(0)");
}else{var recordData=scriptReply.getResponse();
if(this.isPlusAddEnabled()&&CERN_Platform.inMillenniumContext()){var favData=recordData.PRE_COMPLETED;
if(favData){this.appendDropDown(favData);
}}this.processDocumentData(recordData);
this.filterDocuments();
var colNum=Math.floor(this.m_nSortInd/10)-1;
this.sortDocuments(colNum,this.m_nSortInd%2);
this.displayComponent();
}}catch(err){logger.logJSError(err,this,"document-o2.js","renderComponent");
throw (err);
}};
DocumentComponent2.prototype.generateHeaderRowHTML=function(contentHeaderClass){var compNS=this.getStyles().getNameSpace();
var docI18n=i18n.discernabu.documents_o2;
var compID=this.getComponentId();
var jsHTML=[];
contentHeaderClass=contentHeaderClass||"";
jsHTML.push("<div class='content-hdr ",contentHeaderClass,"'><dl class='",compNS,"-info-hdr hdr' id = 'docHdrRow",compID,"'>","<dd class='",compNS,"-info-hdr-sortIcon ",compNS,"-dt-hd'>",docI18n.DATE_TIME,"</dd>","<dd class='",compNS,"-info-hdr-sortIcon ",compNS,"-subj-hd'>",docI18n.SUBJECT,"</dd>","<dd class='",compNS,"-info-hdr-sortIcon ",compNS,"-cat-hd'>",docI18n.NOTE_TYPE,"</dd>","<dd class='",compNS,"-info-hdr-sortIcon ",compNS,"-auth-hd'>",docI18n.AUTHOR,"</dd>","<dd class='",compNS,"-info-hdr-sortIcon ",compNS,"-updt-dt-hd'>",docI18n.LAST_UPDATED,"</dd>","<dd class='",compNS,"-info-hdr-sortIcon ",compNS,"-updt-prsnl-hd'>",docI18n.LAST_UPDATED_BY,"</dd>","</dl></div>");
return jsHTML.join("");
};
DocumentComponent2.prototype.generateGroupedRowsHTML=function(docArray){var docI18n=i18n.discernabu.documents_o2;
var groups={};
var x=0;
var encntrDate;
var groupType;
var groupLocation;
var curEnc;
var encLength=this.ENCOUNTERS.length;
var jsHTML=[];
for(x=0;
x<encLength;
x++){curEnc=this.ENCOUNTERS[x];
if(curEnc.ENCNTR_ID===0){encntrDate="["+docI18n.UNKOWN_DATE+"]";
groupType="["+docI18n.UNKOWN_ENC_TYPE+"]";
groupLocation="["+docI18n.UNKOWN_LOCATION+"]";
}else{encntrDate=curEnc.isDateEmpty?"["+docI18n.UNKOWN_DATE+"]":curEnc.encounterDate.format("shortDate3");
groupType=curEnc.TYPE?curEnc.TYPE:"["+docI18n.UNKOWN_ENC_TYPE+"]";
groupLocation=curEnc.LOCATION?curEnc.LOCATION:"["+docI18n.UNKOWN_LOCATION+"]";
}groups[curEnc.ENCNTR_ID]={type:groupType,location:groupLocation,date:encntrDate,docHTMLs:[]};
}for(x=0;
x<docArray.length;
x++){if(groups.hasOwnProperty(docArray[x].encounterId)){groups[docArray[x].encounterId].docHTMLs.push(docArray[x].rowHtml);
}else{groups[0].docHTMLs.push(docArray[x].rowHtml);
}}var z=0;
for(x=0;
x<encLength;
x++){var encID=this.ENCOUNTERS[x].ENCNTR_ID;
var group=groups[encID];
var groupLen=group.docHTMLs.length;
if(groupLen){var groupHeaderClass=(this.isDisplayPatSubmittedDocsEnabled())?"sub-sec-hd doc2-secondary-hd":"sub-sec-hd";
jsHTML.push("<div class='sub-sec'><h3 class='"+groupHeaderClass+"'><span class='sub-sec-hd-tgl' title='",i18n.discernabu.HIDE_SECTION,"'>-</span><span class='sub-sec-title'>");
jsHTML.push("<dl><dd>",group.type,"</dd><dd>",group.location,"</dd><dd>",group.date,"</dd></dl>");
jsHTML.push("</span></h3><div class='sub-sec-content'>");
for(z=0;
z<groupLen;
z++){jsHTML.push("<div class='",z%2?"even":"odd","'>",group.docHTMLs[z],"</div>");
}jsHTML.push("</div></div>");
}}return jsHTML.join("");
};
DocumentComponent2.prototype.extractActionProviderInfo=function(docObj,curProviderId){var docI18n=i18n.discernabu.documents_o2;
var lastUpdatedDateObj=null;
var lastUpdatedBy=docI18n.UNKNOWN;
var authorName=null;
var authorID=0;
var contributors=[];
var participant=null;
var type_cd=null;
var status_cd=null;
var strPerform="PERFORM";
var strmodify="MODIFY";
var strCompleted="COMPLETED";
var actionPrsnlName="";
var isModifiedByCurProvider=false;
var i=0;
var isContributorNew=false;
for(var x=docObj.ACTION_PROVIDERS.length;
x--;
){participant=docObj.ACTION_PROVIDERS[x];
actionPrsnlName=participant.PRSNL_NAME;
type_cd=participant.TYPE_CD_MEANING;
status_cd=participant.STATUS_CD_MEANING;
if((type_cd===strPerform)&&(status_cd===strCompleted)&&!authorName){authorName=actionPrsnlName;
authorID=participant.PRSNL_ID;
}if(!lastUpdatedDateObj||participant.DATE>lastUpdatedDateObj){lastUpdatedDateObj=participant.DATE;
lastUpdatedBy=actionPrsnlName;
}if((type_cd===strmodify)&&(participant.PRSNL_ID===curProviderId)){isModifiedByCurProvider=true;
}isContributorNew=false;
for(i=contributors.length;
i--;
){if(contributors[i]===actionPrsnlName){isContributorNew=true;
break;
}}if(!isContributorNew){contributors.push(actionPrsnlName);
}}if(!authorName){authorName=docI18n.UNKNOWN;
}for(i=contributors.length;
i--;
){if(contributors[i]===authorName){contributors.splice(i,1);
break;
}}return{authorName:authorName,authorID:authorID,lastUpdatedBy:lastUpdatedBy,lastUpdatedDateTime:lastUpdatedDateObj,isModifiedByCurProvider:isModifiedByCurProvider,contributors:contributors};
};
DocumentComponent2.prototype.createFilterHTML=function(){var compID=this.getComponentId();
var i18nCore=i18n.discernabu;
var compNS=this.getStyles().getNameSpace();
var docI18n=i18n.discernabu.documents_o2;
var jsHTML=[];
var groupLen=this.m_grouper_arr.length;
var filterId="";
jsHTML.push("<div class='",compNS,"-menu-row'>");
if(this.getPatientEnteredDataInd()){jsHTML.push("<span id = 'doc2OutsideRecsSec",compID,"' class = '",compNS,"-fil-group'><input id = 'doc2OutsideRecs",compID,"' type='checkbox'"+((this.getPatSubmittedDocsCheckBoxPref())?" checked ='checked'":"")+" />",docI18n.VIEW_OUTSIDE_RECORDS,"</span>");
}jsHTML.push("<span id = 'Doc2MyNotesOnlySec",compID,"' class = '",compNS,"-fil-group'><input id = 'Doc2MyNotesOnly",compID,"' type='checkbox' name='group'"+(this.m_isMyNoteOnly?" checked ='checked'":"")+" />",docI18n.MY_DOCUMENTS,"</span>");
jsHTML.push("<span id = 'Doc2GroupByEncSec",compID,"' class = '",compNS,"-fil-group'><input id = 'Doc2GroupByEnc",compID,"' type='checkbox' name='group'"+(this.m_isByEncounter?" checked ='checked'":"")+" />",docI18n.By_ENCOUNTER,"</span>");
jsHTML.push("<span class='doc2-partition'>",docI18n.DISPLAY,":</span><span id='QFilterDiv",compID,"' class = 'doc2-q-hover'>",this.getQuickFilterLabel(),"<span class='wrkflw-selectArrow'></span></span><div id='doc-spec-filter",compID,"' class='doc2-qfilter-panel'>");
jsHTML.push("<div class='doc2-sec-separator'>");
filterId="facDefDiv"+compID;
jsHTML.push("<div class='doc2-allfil' id='",filterId,"'><input id='facilityDefined",compID,"' type='checkbox' class='lb-mnu' />",this.clinicalLabel,"</div>");
for(var z=0;
z<groupLen;
z++){if(this.getGrouperLabel(z)){filterId="specFilOuterDiv"+compID+z;
jsHTML.push("<div class='doc2-allfil' id='",filterId,"''><input id='specFil",compID,z,"' type='checkbox' class='lb-mnu' />",this.m_grouper_arr[z].label,"</div>");
}}jsHTML.push("</div><div class='doc2-last-div'><span><a id ='Doc2-resetAll",compID,"' class='doc2-resetAll'>",i18nCore.RESET_ALL,"</a></span>");
jsHTML.push("<span class='doc2-btn-div'><input class= 'doc2-btn' id='specCancel",compID,"' type='button' value='",docI18n.CANCEL,"' /></span>");
jsHTML.push("<span class='doc2-btn-div'><input class= 'doc2-btn' id='specApply",compID,"' type='button' value='",docI18n.APPLY,"' /></span></div></div></div>");
return jsHTML.join("");
};
DocumentComponent2.prototype.filterDocuments=function(){var allCompletedDocs=this.m_allCompletedDocList;
var filteredCompletedDocs=[];
if(this.m_isMyNoteOnly){for(var i=0,len=allCompletedDocs.length;
i<len;
i++){if(allCompletedDocs[i].isMyNote){filteredCompletedDocs.push(allCompletedDocs[i]);
}}}else{filteredCompletedDocs=allCompletedDocs;
}this.m_filteredCompletedDocList=filteredCompletedDocs;
};
DocumentComponent2.prototype.displayComponent=function(){var compNS=this.getStyles().getNameSpace();
var docI18n=i18n.discernabu.documents_o2;
var jsHTML=[];
var incompletedDocs=this.m_incompleteDocList;
var filteredCompletedDocs=this.m_filteredCompletedDocList;
var pendingCnt=incompletedDocs.length;
var signedCnt=filteredCompletedDocs.length;
var patSubmittedCnt=this.m_patRequestDocList.length;
this.m_sidePanel=null;
this.m_selectedRowObj=null;
var displayPatSubmittedDocsInd=this.isDisplayPatSubmittedDocsEnabled();
var countText="";
jsHTML.push(this.createFilterHTML());
var disclaimerMessage="<div class='doc2-disclaimer'>"+this.createDisclaimerMessage()+"</div>";
var footnote="";
jsHTML.push("<div class='doc2-table-content'>");
var extraClass="";
var chartDocsCount=pendingCnt+signedCnt;
if(chartDocsCount+patSubmittedCnt){if(this.m_isByEncounter&&signedCnt){extraClass=" grouped";
}if(pendingCnt&&signedCnt){extraClass+=" with-section-header";
}jsHTML.push(this.generateHeaderRowHTML(extraClass));
}if(displayPatSubmittedDocsInd+chartDocsCount===0){jsHTML.push("<span class='res-none'>",docI18n.NO_RESULTS_FOUND,"</span>");
}else{jsHTML.push("<div class='content-body doc2-table-view",extraClass,"'>");
if(displayPatSubmittedDocsInd){jsHTML.push("<div class='sub-sec'><h3 class='sub-sec-hd'><span class='doc2-pat-req-icon'>&nbsp;</span><span class='sub-sec-title doc2-section-title'>");
jsHTML.push(docI18n.PATIENT_SUBMITTED_DOCUMENTS+"</span> <span>("+patSubmittedCnt+")</span></h3><div class='sub-sec-content'>");
if(patSubmittedCnt){for(var j=0;
j<patSubmittedCnt;
j++){jsHTML.push("<div class='",j%2?"even":"odd","'>",this.m_patRequestDocList[j].rowHtml,"</div>");
}}else{jsHTML.push("<span class='res-none'>",docI18n.NO_RESULTS_FOUND,"</span>");
}jsHTML.push("</div></div>");
jsHTML.push("<div class='sub-sec'><h3 class='sub-sec-hd'><span class='sub-sec-title doc2-section-title'>");
jsHTML.push(docI18n.CHART_DOCUMENTS+"</span> <span>("+chartDocsCount+")</span></h3><div class='sub-sec-content'>");
}if(chartDocsCount){if(pendingCnt){for(var i=0;
i<pendingCnt;
i++){jsHTML.push("<div class='",i%2?"even":"odd","'>",this.m_incompleteDocList[i].rowHtml,"</div>");
}if(signedCnt){jsHTML.push("<div class='sub-sec-hd ",compNS,"-section-title'>",docI18n.COMPLETED_DOCS,"</div>");
}}if(signedCnt){if(this.m_isByEncounter){jsHTML.push(this.generateGroupedRowsHTML(filteredCompletedDocs));
}else{for(var x=0;
x<filteredCompletedDocs.length;
x++){jsHTML.push("<div class='",x%2?"even":"odd","'>",filteredCompletedDocs[x].rowHtml,"</div>");
}}}}else{jsHTML.push("<span class='res-none'>",docI18n.NO_RESULTS_FOUND,"</span>");
}jsHTML.push("</div>");
}if(this.m_showingLastXNotes){footnote=disclaimerMessage;
}if(displayPatSubmittedDocsInd){jsHTML.push("</div></div>");
}if(chartDocsCount){jsHTML.push(footnote);
}jsHTML.push("<div id='doc2SidePanel"+this.getComponentId()+"' class='doc2-side-panel'>&nbsp;</div></div>");
var totalDocsCount=pendingCnt+signedCnt+patSubmittedCnt;
countText=MP_Util.CreateTitleText(this,totalDocsCount);
this.finalizeComponent(jsHTML.join(""),countText);
CERN_EventListener.fireEvent(this,this,EventListener.EVENT_COUNT_UPDATE,{count:totalDocsCount});
this.displayCurrentSortIndicator(this.m_nSortInd);
this.attachListeners();
this.qFilterHover();
this.refreshSpecialtyFilterDisplay();
};
DocumentComponent2.prototype.checkSortingOrder=function(colNum){var compID=this.getComponentId();
var headerColumn=$("#docHdrRow"+compID).find(".doc2-info-hdr-sortIcon").eq(colNum);
if(headerColumn.hasClass("ascend")){return 1;
}else{return 0;
}};
DocumentComponent2.prototype.sortDocuments=function(colNum,newSortOrder){var sortOrd=-1;
if(typeof newSortOrder!=="undefined"){sortOrd=newSortOrder;
}else{sortOrd=1-this.checkSortingOrder(colNum);
}var sortRes=0;
switch(colNum){case 0:function sortByDate(a,b){if(a.timeOfServiceDateObj<b.timeOfServiceDateObj){sortRes=1;
if(sortOrd===1){sortRes=sortRes*-1;
}return sortRes;
}else{if(a.timeOfServiceDateObj>b.timeOfServiceDateObj){sortRes=-1;
if(sortOrd===1){sortRes=sortRes*-1;
}return sortRes;
}}return 0;
}this.m_incompleteDocList.sort(sortByDate);
this.m_filteredCompletedDocList.sort(sortByDate);
this.m_patRequestDocList.sort(sortByDate);
break;
case 1:function sortBySubject(a,b){if(a.subject.toUpperCase()<b.subject.toUpperCase()){sortRes=1;
}else{sortRes=-1;
}if(sortOrd===1){sortRes=sortRes*-1;
}return sortRes;
}this.m_incompleteDocList.sort(sortBySubject);
this.m_filteredCompletedDocList.sort(sortBySubject);
this.m_patRequestDocList.sort(sortBySubject);
break;
case 2:function sortByNoteType(a,b){if(a.noteType.toUpperCase()<b.noteType.toUpperCase()){sortRes=1;
}else{sortRes=-1;
}if(sortOrd===1){sortRes=sortRes*-1;
}return sortRes;
}this.m_incompleteDocList.sort(sortByNoteType);
this.m_filteredCompletedDocList.sort(sortByNoteType);
this.m_patRequestDocList.sort(sortByNoteType);
break;
case 3:function sortByAuthorName(a,b){var auteurA=a.authorName.toUpperCase(),auteurB=b.authorName.toUpperCase();
if(auteurA<auteurB){sortRes=1;
if(sortOrd==1){sortRes=sortRes*-1;
}return sortRes;
}else{if(auteurA>auteurB){sortRes=-1;
if(sortOrd===1){sortRes=sortRes*-1;
}return sortRes;
}}if(a.timeOfServiceDateObj>b.timeOfServiceDateObj){return -1;
}if(a.timeOfServiceDateObj<b.timeOfServiceDateObj){return 1;
}return 0;
}this.m_incompleteDocList.sort(sortByAuthorName);
this.m_filteredCompletedDocList.sort(sortByAuthorName);
this.m_patRequestDocList.sort(sortByAuthorName);
break;
case 4:function sortByUpdateDateTime(a,b){if(a.lastUpdatedDateObj<b.lastUpdatedDateObj){sortRes=1;
if(sortOrd===1){sortRes=sortRes*-1;
}return sortRes;
}else{if(a.lastUpdatedDateObj>b.lastUpdatedDateObj){sortRes=-1;
if(sortOrd===1){sortRes=sortRes*-1;
}return sortRes;
}}return 0;
}this.m_incompleteDocList.sort(sortByUpdateDateTime);
this.m_filteredCompletedDocList.sort(sortByUpdateDateTime);
this.m_patRequestDocList.sort(sortByUpdateDateTime);
break;
case 5:function sortByUpdatePersonnel(a,b){var prsnlA=a.lastUpdatedBy.toUpperCase(),prsnlB=b.lastUpdatedBy.toUpperCase();
if(prsnlA<prsnlB){sortRes=1;
if(sortOrd===1){sortRes=sortRes*-1;
}return sortRes;
}else{if(prsnlA>prsnlB){sortRes=-1;
if(sortOrd===1){sortRes=sortRes*-1;
}return sortRes;
}}if(a.timeOfServiceDateObj>b.timeOfServiceDateObj){return -1;
}if(a.timeOfServiceDateObj<b.timeOfServiceDateObj){return 1;
}return 0;
}this.m_incompleteDocList.sort(sortByUpdatePersonnel);
this.m_filteredCompletedDocList.sort(sortByUpdatePersonnel);
this.m_patRequestDocList.sort(sortByUpdatePersonnel);
break;
}this.m_nSortInd=(colNum+1)*10+sortOrd;
};
DocumentComponent2.prototype.displayCurrentSortIndicator=function(nSortInd){var compID=this.getComponentId();
var columnIndex=Math.floor(nSortInd/10)-1;
var sortingStyle=nSortInd%2?"ascend":"descend";
$("#docHdrRow"+compID).find(".doc2-info-hdr-sortIcon").eq(columnIndex).addClass(sortingStyle);
};
DocumentComponent2.prototype.hideSidePanel=function(){if(this.m_selectedRowObj){this.selectDocument(this.m_selectedRowObj);
}};
DocumentComponent2.prototype.attachListeners=function(){var compID=this.getComponentId();
var component=this;
$("#docHdrRow"+compID).on("click",".doc2-info-hdr-sortIcon",function(){var columnIndex=$(this).index();
component.sortDocuments(columnIndex);
component.displayComponent();
component.resizeComponent();
});
$("#Doc2-resetAll"+compID).click(function(){var groupLen=component.m_grouper_arr.length;
for(var z=0;
z<groupLen;
z++){$("#specFil"+compID+z).prop("checked",false);
}$("#facilityDefined"+compID).prop("checked",true);
});
$("#doc2OutsideRecsSec"+compID).click(function(){var isChecked=component.getPatSubmittedDocsCheckBoxPref();
component.setPatSubmittedDocsCheckBoxPref(!isChecked);
component.retrieveComponentData();
});
$("#Doc2MyNotesOnlySec"+compID).click(function(){component.m_isMyNoteOnly=!component.m_isMyNoteOnly;
component.filterDocuments();
var colNum=Math.floor(component.m_nSortInd/10)-1;
component.sortDocuments(colNum,component.m_nSortInd%2);
component.displayComponent();
component.resizeComponent();
});
$("#Doc2GroupByEncSec"+compID).click(function(){component.m_isByEncounter=!component.m_isByEncounter;
component.displayComponent();
component.resizeComponent();
});
$(".doc2-allfil").click(function(event){var targetObj=$(event.target);
if(targetObj.is(":checkbox")){return;
}var insideCheckbox=$(this).find(":checkbox");
insideCheckbox.prop("checked",!insideCheckbox.prop("checked"));
});
$("#specCancel"+compID).click(function(){component.refreshSpecialtyFilterDisplay();
component.toggleSpecialtyFilterPanel();
});
$("#QFilterDiv"+compID).click(function(){component.toggleSpecialtyFilterPanel();
});
$("#specApply"+compID).click(function(){var selectedFilters=[];
var groupLen=component.m_grouper_arr.length;
var z=0;
var specialtyFilter=null;
for(z=0;
z<groupLen;
z++){specialtyFilter=_g("specFil"+compID+z);
if(specialtyFilter&&specialtyFilter.checked){selectedFilters.push(component.m_grouper_arr[z].label+z);
}}var facilityDefinedFilter=_g("facilityDefined"+compID);
if(facilityDefinedFilter&&facilityDefinedFilter.checked){selectedFilters.push(component.clinicalLabel);
}component.hideSidePanel();
MP_Util.LoadSpinner("doc2Content"+compID);
component.toggleSpecialtyFilterPanel();
component.m_grouperFilterCriteria=selectedFilters;
MP_Core.AppUserPreferenceManager.SaveCompPreferences(compID);
component.retrieveComponentData();
});
$("#"+component.getStyles().getContentId()+" .content-body .sub-sec-hd-tgl").each(function(){Util.removeEvent($(this).get(0),"click",MP_Util.Doc.ExpandCollapse);
$(this).on("click.doc2",function(){var i18nCore=i18n.discernabu;
if($(this).closest(".sub-sec").hasClass("closed")){$(this).closest(".sub-sec").removeClass("closed");
$(this).html("-");
$(this).attr("title",i18nCore.HIDE_SECTION);
}else{$(this).closest(".sub-sec").addClass("closed");
$(this).html("+");
$(this).attr("title",i18nCore.SHOW_SECTION);
}component.resizeComponent();
});
});
var sidePanelParentContainer=$("#doc2SidePanel"+compID);
sidePanelParentContainer.on("click",".sp-button",function(){var currentRow=component.m_selectedRowObj;
component.selectDocument(currentRow);
var eventId=parseInt(currentRow.attr("data-eventid"),10);
var categoryMean=component.getCriterion().category_mean;
if(component.isIncompleteDocument(eventId)&&CERN_Platform.inMillenniumContext()){DocumentComponent2.LaunchDocumentEditor(eventId,categoryMean);
}else{DocumentComponent2.LaunchDocumentViewer(eventId,categoryMean);
}});
var displaySidePanelTimeout=null;
var componentTable=$("#"+component.getStyles().getContentId()+" .content-body");
componentTable.on("click",".doc2-info",function(event){var targetObj=$(event.target||event.srcElement);
var rowObj=null;
var eventId=0;
var categoryMean=component.getCriterion().category_mean;
if(targetObj.hasClass("doc2-image-found")){rowObj=targetObj.parent().parent();
eventId=rowObj.attr("data-eventid");
eventId=parseInt(eventId,10);
DocumentComponent2.LaunchDocumentImageViewer(eventId,categoryMean);
return;
}else{rowObj=$(this);
eventId=rowObj.attr("data-eventid");
eventId=parseInt(eventId,10);
if(displaySidePanelTimeout===null){displaySidePanelTimeout=setTimeout(function(){component.selectDocument(rowObj);
displaySidePanelTimeout=null;
},200);
}}});
componentTable.on("dblclick",".doc2-info",function(event){if(displaySidePanelTimeout){clearTimeout(displaySidePanelTimeout);
displaySidePanelTimeout=null;
}var targetObj=$(event.target||event.srcElement);
if(targetObj.hasClass("doc2-image-found")){return;
}var rowObj=$(this);
var eventId=parseInt(rowObj.attr("data-eventid"),10);
var categoryMean=component.getCriterion().category_mean;
component.hideSidePanel();
if(component.isIncompleteDocument(eventId)&&CERN_Platform.inMillenniumContext()){DocumentComponent2.LaunchDocumentEditor(eventId,categoryMean);
}else{DocumentComponent2.LaunchDocumentViewer(eventId,categoryMean);
}});
var componentContainer=$("#"+component.getStyles().getId());
componentContainer.attr("tabindex",1).off(".doc2sp");
componentContainer.on("keydown.doc2sp",function(event){var selectedRow=component.m_selectedRowObj;
if(!selectedRow){return;
}var zebraContainer=selectedRow.parent();
var zebraParent=null;
var subsecContainer=null;
var rowCount=0;
if(event.keyCode===38){event.preventDefault();
var prevRow=zebraContainer.prev();
if(prevRow.length===0){zebraParent=zebraContainer.parent();
if(zebraParent.hasClass("sub-sec-content")){subsecContainer=zebraParent.parent();
if(subsecContainer.hasClass("sub-sec")){prevRow=subsecContainer.prev();
}}}if(prevRow.length){if(prevRow.hasClass("doc2-section-title")){prevRow=prevRow.prev();
}var rowsAbove=prevRow.find(".doc2-info");
rowCount=rowsAbove.length;
if(rowCount){component.selectDocument(rowsAbove.eq(rowCount-1));
}}}else{if(event.keyCode===40){event.preventDefault();
var nextRow=zebraContainer.next();
if(nextRow.length===0){zebraParent=zebraContainer.parent();
if(zebraParent.hasClass("sub-sec-content")){subsecContainer=zebraParent.parent();
if(subsecContainer.hasClass("sub-sec")){nextRow=subsecContainer.next();
}}}if(nextRow.length){if(nextRow.hasClass("doc2-section-title")){nextRow=nextRow.next();
}var rowsBelow=nextRow.find(".doc2-info");
if(rowsBelow.length){component.selectDocument(rowsBelow.eq(0));
}}}}});
};
DocumentComponent2.prototype.qFilterHover=function(){var compID=this.getComponentId();
var quickFilter=_g("QFilterDiv"+compID);
quickFilter.onmouseenter=function(){if(!($("#doc-spec-filter"+compID).hasClass("doc2-visible"))){$(this).removeClass("doc2-qHvr-unclick");
$(this).addClass("doc2-qFilter-hover");
}};
quickFilter.onmouseleave=function(){if(!($("#doc-spec-filter"+compID).hasClass("doc2-visible"))){$(this).removeClass("doc2-qHvr-unclick");
$(this).removeClass("doc2-qFilter-hover");
}};
};
DocumentComponent2.prototype.processDocumentData=function(recordData){var docI18n=i18n.discernabu.documents_o2;
var criterion=this.getCriterion();
var providerID=criterion.provider_id;
this.m_allCompletedDocList=[];
this.m_incompleteDocList=[];
this.m_patRequestDocList=[];
var docCnt=recordData.DOCS.length;
var pendingCnt=0;
var signedCnt=0;
for(var x=0;
x<docCnt;
x++){var dateLastUpdated=docI18n.UNKNOWN;
var lastPrsnl=docI18n.UNKNOWN;
var authorName=docI18n.UNKNOWN;
var authorID=0;
var docObj=recordData.DOCS[x];
var docStatusMean=docObj.RESULT_STATUS_CD_MEAN;
var dateOfService=docI18n.UNKNOWN;
var dateTime=new Date();
var dtTm=new Date();
var rawLastUpdatedDT=null;
var actionProviderInfo=null;
var docInteropInd=(docObj.INTEROP&&docObj.INTEROP.length&&docObj.INTEROP[0].EXT_DATA_INFO_ID);
if(docObj.EFFECTIVE_DATE){dateTime.setISO8601(docObj.EFFECTIVE_DATE);
if(this.getDateFormat()===3){dateOfService=MP_Util.CalcWithinTime(dateTime);
if(dateOfService!==docI18n.UNKNOWN){dateOfService=docI18n.AGO.replace("{0}",dateOfService);
}}else{dateOfService=MP_Util.DisplayDateByOption(this,dateTime);
}}if(docInteropInd){authorName=docObj.INTEROP[0].SUBMITTED_BY_NAME;
authorID="";
lastPrsnl="--";
dateLastUpdated="--";
}else{actionProviderInfo=this.extractActionProviderInfo(docObj,providerID);
authorName=actionProviderInfo.authorName;
authorID=actionProviderInfo.authorID;
lastPrsnl=actionProviderInfo.lastUpdatedBy;
rawLastUpdatedDT=actionProviderInfo.lastUpdatedDateTime;
}if(rawLastUpdatedDT&&!(docObj.EDITOR_TYPE==="DYNDOC"&&docStatusMean==="IN PROGRESS"&&docInteropInd)){dtTm.setISO8601(rawLastUpdatedDT);
if(this.getDateFormat()===3){dateLastUpdated=MP_Util.CalcWithinTime(dtTm);
if(dateLastUpdated!==docI18n.UNKNOWN){dateLastUpdated=docI18n.AGO.replace("{0}",dateLastUpdated);
}}else{dateLastUpdated=MP_Util.DisplayDateByOption(this,dtTm);
}}if(docObj.EDITOR_TYPE==="DYNDOC"&&docStatusMean==="IN PROGRESS"){dtTm.setISO8601(docObj.UPDATE_DATE);
if(this.getDateFormat()===3){dateLastUpdated=MP_Util.CalcWithinTime(dtTm);
if(dateLastUpdated!==docI18n.UNKNOWN){dateLastUpdated=docI18n.AGO.replace("{0}",dateLastUpdated);
}}else{dateLastUpdated=MP_Util.DisplayDateByOption(this,dtTm);
}}var isMyNote=!docInteropInd&&(authorID==providerID||actionProviderInfo.isModifiedByCurProvider);
var thisDoc={timeOfServiceDateObj:docObj.EFFECTIVE_DT_TM,timeOfServiceDateDisplay:dateOfService,authorName:authorName,docStatusDisplay:docObj.RESULT_STATUS_CD_DISP,docStatusMean:docStatusMean,noteType:docObj.EVENT_CD_DISP,encounterId:docObj.ENCNTR_ID,eventId:docObj.EVENT_ID,subject:(docObj.SUBJECT).replace(/</g,"&lt;").replace(/>/g,"&gt;"),lastUpdatedBy:lastPrsnl,lastUpdatedDateObj:dtTm,lastUpdatedDateDisplay:dateLastUpdated,imageUrl:docObj.IMAGE_URL,isMyNote:isMyNote,contributors:(docInteropInd)?"":actionProviderInfo.contributors,rowHtml:""};
if(docInteropInd){thisDoc.patSubmittedInd=true;
thisDoc.interopData=docObj.INTEROP[0];
thisDoc.subject=thisDoc.subject||"--";
dtTm.setISO8601(docObj.INTEROP[0].SUBMITTED_ON);
var submittedDtTmDisplay=MP_Util.DisplayDateByOption(this,dtTm);
thisDoc.timeOfServiceDateDisplay=submittedDtTmDisplay;
thisDoc.lastUpdatedDateDisplay=submittedDtTmDisplay;
thisDoc.rowHtml=this.singleRowDocHTML(thisDoc);
this.m_patRequestDocList.push(thisDoc);
}else{if(isMyNote&&docStatusMean==="IN PROGRESS"){thisDoc.rowHtml=this.singleRowDocHTML(thisDoc,true);
this.m_incompleteDocList.push(thisDoc);
pendingCnt++;
}else{thisDoc.rowHtml=this.singleRowDocHTML(thisDoc);
this.m_allCompletedDocList.push(thisDoc);
signedCnt++;
}}}this.ENCOUNTERS=recordData.ENCOUNTERS;
var encLength=this.ENCOUNTERS.length;
var encounter=null;
var encounterDate=null;
for(var yy=0;
yy<encLength;
yy++){encounter=this.ENCOUNTERS[yy];
encounter.isDateEmpty=/^\s*$/.test(encounter.DATEVC);
if(!encounter.isDateEmpty){encounterDate=new Date();
encounterDate.setISO8601(encounter.DATEVC);
encounter.encounterDate=encounterDate;
}else{encounter.encounterDate=0;
}}this.ENCOUNTERS.sort(function(a,b){return -(a.encounterDate-b.encounterDate);
});
this.setDocumentsCodes(recordData.CODES);
this.setAddDocPriv(recordData.ADD_DOC_PRIV);
this.setAdddDocPrivExptions(recordData.ADD_DOC_PRIV_EXCEPTIONS);
};
DocumentComponent2.prototype.selectDocument=function(rowObj){var currentDocRowIdentifier="";
var selectedDocRowIdentifier="";
var eventId=rowObj.attr("data-eventid");
var extDataInfoId=rowObj.attr("data-doc-info-ext-id");
if(parseInt(extDataInfoId,10)){currentDocRowIdentifier=extDataInfoId;
selectedDocRowIdentifier=(this.m_selectedRowObj)?this.m_selectedRowObj.attr("data-doc-info-ext-id"):"";
}else{currentDocRowIdentifier=eventId;
selectedDocRowIdentifier=(this.m_selectedRowObj)?this.m_selectedRowObj.attr("data-eventid"):"";
}if(typeof eventId==="undefined"||eventId===null){throw new Error("The selected row does't contain an attribute data-eventid that refers to the document ID. ");
}if(this.m_selectedRowObj&&(selectedDocRowIdentifier===currentDocRowIdentifier)){this.m_selectedRowObj=null;
this.m_sidePanel.hidePanel();
this.unhighlightSelectedRow(rowObj);
$(".doc2-side-panel").removeClass("doc2-side-panel-activated");
}else{$(".doc2-side-panel").addClass("doc2-side-panel-activated");
if(this.m_selectedRowObj){this.unhighlightSelectedRow(this.m_selectedRowObj);
}this.m_selectedRowObj=rowObj;
this.showSidePanel(rowObj);
this.highlightSelectedRow(rowObj);
}};
DocumentComponent2.prototype.unhighlightSelectedRow=function(selRowObj){selRowObj.removeClass("row-selected");
};
DocumentComponent2.prototype.highlightSelectedRow=function(selRowObj){var compDOMObj=$("#"+this.getStyles().getContentId());
var contentBodyObj=$(compDOMObj).find(".content-body");
selRowObj.addClass("row-selected");
selRowObj.attr("style","");
var newScrollTop=contentBodyObj[0].scrollTop;
var rowOffsetTop=selRowObj[0].offsetTop;
var rowOffsetHeight=selRowObj[0].offsetHeight;
var contentBodyHeight=contentBodyObj[0].clientHeight;
if(rowOffsetTop<newScrollTop){newScrollTop=rowOffsetTop;
}if(rowOffsetTop+rowOffsetHeight>newScrollTop+contentBodyHeight){newScrollTop=rowOffsetTop+rowOffsetHeight-contentBodyHeight;
}contentBodyObj.scrollTop(newScrollTop);
};
DocumentComponent2.prototype.isIncompleteDocument=function(eventId){var incompleteList=this.m_incompleteDocList;
for(var i=incompleteList.length;
i--;
){if(eventId===incompleteList[i].eventId){return true;
}}return false;
};
DocumentComponent2.prototype.getDocumentDataObjByEventId=function(eventId){if(typeof eventId!=="number"){throw new Error("Function getDocumentDataObjByEventId is expecting a number for parameter eventId");
}var documentObj=null;
var i=0;
var count=0;
var filteredList=this.m_filteredCompletedDocList;
count=filteredList.length;
for(i=0;
i<count;
i++){if(filteredList[i].eventId===eventId){documentObj=filteredList[i];
break;
}}if(documentObj===null){var incompleteList=this.m_incompleteDocList;
count=incompleteList.length;
for(i=0;
i<count;
i++){if(incompleteList[i].eventId===eventId){documentObj=incompleteList[i];
break;
}}}if(documentObj===null){throw new Error("Function getDocumentDataObjByEventId fails to find the document with event ID="+eventId+" from Filtere");
}return documentObj;
};
DocumentComponent2.prototype.getDocumentDataObjByExtInfoDataId=function(extDataInfoId){var docsCount=this.m_patRequestDocList.length;
for(var i=0;
i<docsCount;
i++){if(this.m_patRequestDocList[i].interopData.EXT_DATA_INFO_ID===extDataInfoId){return this.m_patRequestDocList[i];
}}return null;
};
DocumentComponent2.prototype.getDocEncounterInfo=function(docObj){if(!docObj.encounterId){throw new Error("The document object passed to the getDocEncounterInfo function does not have an encounter id");
}var docI18n=i18n.discernabu.documents_o2;
var encounters=this.ENCOUNTERS;
var encLength=encounters.length;
var encntrInfoObj=null;
var encntrLocation="";
var encntrDate="";
var encntrFin="";
var curEncntr=null;
for(var x=0;
x<encLength;
x++){curEncntr=encounters[x];
if(curEncntr.ENCNTR_ID===docObj.encounterId){encntrLocation=curEncntr.LOCATION?curEncntr.LOCATION:"["+docI18n.UNKOWN_LOCATION+"]";
encntrDate=curEncntr.isDateEmpty?"["+docI18n.UNKOWN_DATE+"]":MP_Util.DisplayDateByOption(this,curEncntr.encounterDate);
encntrFin=curEncntr.FIN_NBR||"--";
encntrInfoObj={facility:encntrLocation,date:encntrDate,fin:encntrFin};
return encntrInfoObj;
}}return null;
};
DocumentComponent2.prototype.createPatSubmittedDocsActions=function(docObj){var component=this;
var docI18n=i18n.discernabu.documents_o2;
var codesArray=this.getDocumentsCodes();
var acceptedStatusCode=MP_Util.GetCodeByMeaning(codesArray,"ACCEPTED").codeValue;
var rejectedStatusCode=MP_Util.GetCodeByMeaning(codesArray,"REJECTED").codeValue;
var buttonStyleEnum=MPageUI.BUTTON_OPTIONS.STYLE;
this.m_docAcceptButton=(new MPageUI.Button()).setLabel(docI18n.ACCEPT).setStyle(buttonStyleEnum.SECONDARY).setOnClickCallback(function(){component.acknowledgePatSubmittedDoc(docObj,"ACCEPT",acceptedStatusCode);
});
this.m_docRejectButton=(new MPageUI.Button()).setLabel(docI18n.REJECT).setStyle(buttonStyleEnum.SECONDARY).setOnClickCallback(function(){component.acknowledgePatSubmittedDoc(docObj,"REJECT",rejectedStatusCode);
});
var actionButtonsHTML='<div class="doc2-sp-action-holder"><div class="doc2-sp-button">'+this.m_docAcceptButton.render()+'</div><div class="doc2-sp-button">'+this.m_docRejectButton.render()+"</div></div>";
return actionButtonsHTML;
};
DocumentComponent2.prototype.createSidePanelHeaderHTML=function(docObj){var component=this;
var componentId=component.getComponentId();
var docI18n=i18n.discernabu.documents_o2;
var allContributorDisplay="<div class='doc2-sp-contributers' title='";
if(docObj.contributors.length){if(docObj.authorName!==docI18n.UNKNOWN){allContributorDisplay+=docObj.authorName+"; "+docObj.contributors.join("; ")+"'><span class='doc2-sp-author'>"+docObj.authorName+";</span>"+docObj.contributors.join("; ");
}else{allContributorDisplay+=docObj.contributors.join("; ")+"'>"+docObj.contributors.join("; ");
}}else{allContributorDisplay+=docObj.authorName+"'><span class='doc2-sp-author'>"+docObj.authorName+"</span>";
}allContributorDisplay+="</div>";
var headerButtonsHTML="";
var lastUpdatedLabel=docI18n.LAST_UPDATED;
var docActionErrorHTML="";
if(docObj.patSubmittedInd){lastUpdatedLabel=docI18n.SUBMITTED;
var addDocPrivGranted=this.isAddDocPrivGranted(docObj);
if(addDocPrivGranted){headerButtonsHTML=component.createPatSubmittedDocsActions(docObj);
docActionErrorHTML="<div id='docActionError"+componentId+"''></div>";
}else{headerButtonsHTML='<div class="doc2-sp-action-holder"></div>';
}}else{headerButtonsHTML='<div class="doc2-sp-action-holder "><div class="sp-button">'+docI18n.OPEN_DOCUMENT+"</div></div>";
}var headerHTML=headerButtonsHTML+"<div class='sp-header'><div class='doc2-sp-header-left'><div class='doc2-sp-subject' title='"+docObj.subject+"'>"+docObj.subject+"</div>"+allContributorDisplay+"</div><div class='doc2-sp-header-right'><div class='doc2-sp-last-updated-label'>"+lastUpdatedLabel+"</div><div class='doc2-sp-last-updated'>"+docObj.lastUpdatedDateDisplay+"</div></div>"+docActionErrorHTML+"</div>";
return headerHTML;
};
DocumentComponent2.prototype.findExceptionByEventCode=function(eventCode){var addDocPrivExceptions=this.getAdddDocPrivExptions();
var exceptionsCnt=addDocPrivExceptions.length;
for(var i=0;
i<exceptionsCnt;
i++){if(addDocPrivExceptions[i].EVENT_CODE===eventCode){return addDocPrivExceptions[i];
}}return null;
};
DocumentComponent2.prototype.isPrivExceptionSetForDocEventCodes=function(docObj){var addDocPriv=this.getAddDocPriv();
var exceptionFound=false;
var docQuestions=docObj.interopData.QUESTIONS;
var docQuestionsCnt=docQuestions.length;
var x=0;
if(addDocPriv){if(this.findExceptionByEventCode(docObj.interopData.DOC_TYPE_CODE)){exceptionFound=true;
}else{for(x=0;
!exceptionFound&&x<docQuestionsCnt;
x++){if(this.findExceptionByEventCode(docQuestions[x].EVENT_CODE)){exceptionFound=true;
}}}}else{if(this.findExceptionByEventCode(docObj.interopData.DOC_TYPE_CODE)){exceptionFound=true;
for(x=0;
exceptionFound&&x<docQuestionsCnt;
x++){if(!this.findExceptionByEventCode(docQuestions[x].EVENT_CODE)){exceptionFound=false;
}}}else{exceptionFound=false;
}}return exceptionFound;
};
DocumentComponent2.prototype.isAddDocPrivGranted=function(docObj){var addDocPriv=this.getAddDocPriv();
var addDocPrivExceptions=this.getAdddDocPrivExptions();
var privGrantedInd=false;
if(addDocPriv){if(addDocPrivExceptions.length){privGrantedInd=(this.isPrivExceptionSetForDocEventCodes(docObj))?false:true;
}else{privGrantedInd=true;
}}else{if(addDocPrivExceptions.length){privGrantedInd=(this.isPrivExceptionSetForDocEventCodes(docObj))?true:false;
}else{privGrantedInd=false;
}}return privGrantedInd;
};
DocumentComponent2.prototype.acknowledgePatSubmittedDoc=function(docObj,requestType,requestStatusCode){var patSubmittedDocTimer=new CapabilityTimer("CAP:MPG Documents Reconcile Patient Entered Data");
patSubmittedDocTimer.capture();
var component=this;
var extDataInfoId=docObj.interopData.EXT_DATA_INFO_ID;
var criterion=this.getCriterion();
var personnelId=criterion.provider_id;
var encounterId=(docObj.encounterId)?docObj.encounterId:criterion.encntr_id;
var pprCd=criterion.ppr_cd;
var requestNumber=0;
var requestJson="";
if(requestType==="ACCEPT"){requestNumber=964761;
requestJson='{"REQUESTIN":{"QUESTIONNAIRES":[{"EXT_DATA_INFO_ID":'+extDataInfoId+'.0,"STATUS_CODE":'+requestStatusCode+'.0}],"PERSONNEL_ID":'+personnelId+'.0,"ENCOUNTER_ID":'+encounterId+'.0,"PPR_CD":'+pprCd+".0}}";
}else{if(requestType==="REJECT"){requestNumber=964756;
requestJson='{"REQUESTIN":{"UPDATESTATUS":[{"EXT_DATA_INFO_ID":'+extDataInfoId+'.0,"STATUS_CODE":'+requestStatusCode+'.0,"CHART_REFERENCE_ID":0.0,"PERSONNEL_ID":'+personnelId+'.0,"ENCNTR_ID":'+encounterId+".0}]}}";
}}var scriptRequest=new ScriptRequest();
scriptRequest.setProgramName("mp_exec_std_request");
scriptRequest.setRawDataIndicator(true);
scriptRequest.setDataBlob(requestJson);
scriptRequest.setParameterArray(["^MINE^","^^",3202004,3202004,requestNumber]);
scriptRequest.setResponseHandler(function(scriptReply){try{var responseData=JSON.parse(scriptReply.getResponse());
if(responseData.RECORD_DATA.STATUS.SUCCESS_INDICATOR===1){component.retrieveComponentData();
}else{component.createSidePanelErrorBanner();
}}catch(err){component.createSidePanelErrorBanner();
}});
scriptRequest.performRequest();
};
DocumentComponent2.prototype.createSidePanelErrorBanner=function(){var docI18n=i18n.discernabu.documents_o2;
var compId=this.getComponentId();
var alertBanner=new MPageUI.AlertBanner();
alertBanner.setType(MPageUI.ALERT_OPTIONS.TYPE.ERROR);
alertBanner.setPrimaryText(docI18n.DOC_ACTION_ERROR_MSG);
$("#docActionError"+compId).html(alertBanner.render());
};
DocumentComponent2.prototype.getDocCodeDisplay=function(codeValue){var docsCodesArray=this.getDocumentsCodes();
var codeInfoObj=MP_Util.GetValueFromArray(codeValue,docsCodesArray);
var questionDtaType=(codeInfoObj)?codeInfoObj.display:"";
return questionDtaType;
};
DocumentComponent2.prototype.getDocCodeCDFMeaning=function(codeValue){var docsCodesArray=this.getDocumentsCodes();
var codeInfoObj=MP_Util.GetValueFromArray(codeValue,docsCodesArray);
var questionDtaCDFMeaning=(codeInfoObj)?codeInfoObj.meaning:"";
return questionDtaCDFMeaning;
};
DocumentComponent2.prototype.createPatQuestionHtml=function(question){var questionDtaCDFMeaning=this.getDocCodeCDFMeaning(question.EVENT_TYPE);
var prompt=question.QUESTION;
var answers=[];
var answersHtml="";
var questionHtml="";
var dtTm=new Date();
var i=0;
var alphaCount=question.ALPHA_VALUES.length;
switch(questionDtaCDFMeaning){case"3":var unitCdDisplay=this.getDocCodeDisplay(question.UNIT_CODE);
answers[0]=(question.NUMERIC_VALUE)?(question.NUMERIC_VALUE+" "+unitCdDisplay):"--";
break;
case"2":if(alphaCount){answers[0]=question.ALPHA_VALUES[0].LABEL||"--";
}else{answers[0]="--";
}break;
case"21":if(alphaCount){answers[0]=question.ALPHA_VALUES[0].LABEL||"--";
}else{answers[0]=question.FREE_TEXT_VALUE||"--";
}break;
case"5":if(alphaCount){for(i=0;
i<alphaCount;
i++){answers[i]=question.ALPHA_VALUES[i].LABEL||"--";
}}else{answers[0]="--";
}break;
case"22":if(alphaCount){for(i=0;
i<alphaCount;
i++){answers[i]=question.ALPHA_VALUES[i].LABEL||"--";
}}if(question.FREE_TEXT_VALUE){answers[i]=question.FREE_TEXT_VALUE;
}if(!answers.length){answers[0]="--";
}break;
case"7":answers[0]=question.FREE_TEXT_VALUE||"--";
break;
case"6":if(question.DATE_VALUE){dtTm.setISO8601(question.DATE_VALUE);
answers[0]=dtTm.format("shortDate3");
}else{answers[0]="--";
}break;
case"10":answers[0]=question.DATE_VALUE||"--";
break;
}for(i=0;
i<answers.length;
i++){answersHtml+="<dd>"+answers[i]+"</dd>";
}questionHtml="<dl class='doc2-preview-section'><dt>"+prompt+"</dt>"+answersHtml+"</dl>";
return questionHtml;
};
DocumentComponent2.prototype.createSidePanelPatSubmittedDocContent=function(docDataInfoExtId){var docI18n=i18n.discernabu.documents_o2;
var compID=this.getComponentId();
var compContentID=this.getStyles().getContentId();
var sidePanel=this.m_sidePanel;
var docObj=this.getDocumentDataObjByExtInfoDataId(docDataInfoExtId);
var patQuestionsArray=docObj.interopData.QUESTIONS;
var patQuestionsCount=patQuestionsArray.length;
var criterion=this.getCriterion();
var currentEncntrId=criterion.encntr_id;
var questionHtml="";
var headerHTML=this.createSidePanelHeaderHTML(docObj);
var msgBannerHTML="";
var addDocPrivGranted=this.isAddDocPrivGranted(docObj);
if(addDocPrivGranted){if(!docObj.encounterId){var noEncounterBanner=new MPageUI.AlertBanner();
noEncounterBanner.setType(MPageUI.ALERT_OPTIONS.TYPE.WARNING);
noEncounterBanner.setSecondaryText(docI18n.PAT_SUBMITTED_DOC_MISSING_ENCOUNTER_MSG);
msgBannerHTML="<div class='doc2-sp-banner-container'>"+noEncounterBanner.render()+"</div>";
}else{if(docObj.encounterId&&docObj.encounterId!==currentEncntrId){var docEncntrInfoObj=this.getDocEncounterInfo(docObj);
var bannerMessage=docI18n.PAT_SUBMITTED_DOC_MISMATCHING_ENCOUNTER_MSG;
bannerMessage=bannerMessage.replace("{0}",docEncntrInfoObj.facility).replace("{1}",docEncntrInfoObj.date).replace("{2}",docEncntrInfoObj.fin);
var mismatchEnctrBanner=new MPageUI.AlertBanner();
mismatchEnctrBanner.setType(MPageUI.ALERT_OPTIONS.TYPE.INFO);
mismatchEnctrBanner.setSecondaryText(bannerMessage);
msgBannerHTML="<div class='doc2-sp-banner-container'>"+mismatchEnctrBanner.render()+"</div>";
}}}var HTMLString=headerHTML+msgBannerHTML+'<div id="sidePanelScrollContainer'+compID+'" class="doc2-sp-scroll-container"><div id="doc2SidePanelViewableContent'+compID+'" class="doc2-preview-content">';
for(var i=0;
i<patQuestionsCount;
i++){questionHtml=this.createPatQuestionHtml(patQuestionsArray[i]);
HTMLString+=questionHtml;
}HTMLString+="</div></div>";
sidePanel.setContents(HTMLString,compContentID);
sidePanel.showPanel();
this.resizeSidePanel();
if(addDocPrivGranted){this.m_docAcceptButton.attachEvents();
this.m_docRejectButton.attachEvents();
}};
DocumentComponent2.prototype.retrieveSidePanelContent=function(eventId){var cachedContent=this.m_documentDisplayCache[eventId];
if(cachedContent){this.updateSidePanelPreviewContent(eventId);
return;
}this.showLoadingPreview(eventId);
this.retrieveDocumentPreview(eventId);
};
DocumentComponent2.prototype.retrieveDocumentPreview=function(eventId){var self=this;
var scriptRequest=new ScriptRequest();
scriptRequest.setProgramName("mp_doc_preview_pane");
scriptRequest.setParameterArray(["^MINE^",eventId+".0"]);
scriptRequest.setResponseHandler(function(scriptReply){self.handleDocumentPreviewResponse(scriptReply,eventId);
});
scriptRequest.performRequest();
};
DocumentComponent2.prototype.updateDocumentDisplayCache=function(contentHtml,eventId,iframe){if(!this.m_documentDisplayCache[eventId]){this.m_documentDisplayCache[eventId]={};
}if(!this.m_documentDisplayCache[eventId].headerHtml){var docObj=this.getDocumentDataObjByEventId(eventId);
this.m_documentDisplayCache[eventId].headerHtml=this.createSidePanelHeaderHTML(docObj);
}if(iframe){this.m_documentDisplayCache[eventId].iframe=iframe;
}var previewContent=this.m_documentDisplayCache[eventId].headerHtml;
previewContent+=contentHtml;
this.m_documentDisplayCache[eventId].html=previewContent;
};
DocumentComponent2.prototype.updateSidePanelPreviewContent=function(eventId){var sidePanel=this.m_sidePanel;
var compContentID=this.getStyles().getContentId();
if(sidePanel){var contents=this.m_documentDisplayCache[eventId].html;
sidePanel.setContents(contents,compContentID);
sidePanel.showPanel();
this.finalizeIFramePreviewContent(eventId);
this.resizeSidePanel();
}};
DocumentComponent2.prototype.finalizeIFramePreviewContent=function(eventId){var iframe=this.m_documentDisplayCache[eventId].iframe;
if(iframe){iframe.finalize();
}};
DocumentComponent2.prototype.postDOMLocationChange=function(){var sidePanel=this.m_sidePanel;
var eventId;
if(this.m_selectedRowObj){eventId=parseInt(this.m_selectedRowObj.attr("data-eventid"),10);
}if(sidePanel&&eventId){this.finalizeIFramePreviewContent(eventId);
}};
DocumentComponent2.prototype.showLoadingPreview=function(eventId){var compID=this.getComponentId();
var loadingContent="<div id='sidePanelScrollContainer"+compID+"' class='doc2-sp-scroll-container'><div id='doc2SidePanelViewableContent"+compID+"' class='doc2-preview-content doc2-sp-loading-container'></div></div>";
this.updateDocumentDisplayCache(loadingContent,eventId);
this.updateSidePanelPreviewContent(eventId);
};
DocumentComponent2.prototype.handleDocumentPreviewResponse=function(scriptReply,eventId){var docI18n=i18n.discernabu.documents_o2;
var compID=this.getComponentId();
var compContentID=this.getStyles().getContentId();
var recordData=scriptReply.getResponse();
var status=scriptReply.getStatus();
var iframe=null;
var HTMLString="<div id='sidePanelScrollContainer"+compID+"' class='doc2-sp-scroll-container'><div id='doc2SidePanelViewableContent"+compID+"' class='doc2-preview-content'>";
var docContentHTML="";
var hasEmbeddedImages=false;
if(status==="S"){var imgPattern=/<img[^<>]+?>/ig;
var blobs=recordData.BLOBS;
var blobHTML=null;
var iframeContent="";
iframe=new MPageIFrame();
iframe.setNamespace(compContentID);
for(var i=0,len=blobs.length;
i<len;
i++){blobHTML=blobs[i].BLOB_HTML;
if(imgPattern.test(blobHTML)){hasEmbeddedImages=true;
blobHTML=blobHTML.replace(imgPattern,'<span class="doc2-replaced-img-box"><span class="doc2-replaced-image">&nbsp;</span></span>');
}iframeContent+="<div class='doc2-preview-section'>"+blobHTML+"</div>";
}this.populatePreviewIFrameContent(iframe,iframeContent);
docContentHTML+=iframe.render();
if(hasEmbeddedImages){HTMLString+="<div class='doc2-side-msg-bar'><span class='doc2-side-msg-icon'>&nbsp;</span>"+docI18n.DOC_CONTAINS_IMAGES+"<br />"+docI18n.CLICK_BUTTON_TO_VIEW+"</div>";
}HTMLString+=docContentHTML;
}else{HTMLString+='<div class="doc2-sp-not-supported">'+docI18n.DOC_NOT_SUPPORTED+"<br />"+docI18n.CLICK_BUTTON_TO_VIEW+"</div>";
}HTMLString+="</div></div>";
this.updateDocumentDisplayCache(HTMLString,eventId,iframe);
var currentRow=this.m_selectedRowObj;
if(currentRow&&parseInt(currentRow.attr("data-eventid"),10)===eventId){this.updateSidePanelPreviewContent(eventId);
}};
DocumentComponent2.prototype.populatePreviewIFrameContent=function(iframe,content){var staticContent=this.getCriterion().static_content;
iframe.setStaticContentPath(staticContent);
iframe.addCssSource("document-preview.css");
iframe.setContent(content);
iframe.setFinalizeFn(this.attachEventsToDocumentPreviewIframe(iframe));
};
DocumentComponent2.prototype.attachEventsToDocumentPreviewIframe=function(iframe){var component=this;
return function(iframeDocument){if(component.isTaggingEnabled()){component.allowTaggingInPreviewPane(iframe,iframeDocument);
}};
};
DocumentComponent2.prototype.allowTaggingInPreviewPane=function(iframe,iframeDocument){var component=this;
function displayTaggingMenu(event){setTimeout(function(){var iframeNode=iframe.getRootElement();
var iframeWindow=iframeNode.contentWindow||iframeNode;
var selectedHtml=DocumentationUtils.getSelectedHtml(iframeDocument,iframeWindow);
if(selectedHtml){var sanitizedHtml=DocumentationUtils.cleanHtml(selectedHtml);
sanitizedHtml=sanitizedHtml.replace(/[\b\f\n\r\t]/gim,"");
var sanitizedTaggedXml=DocumentationUtils.getXHtml(sanitizedHtml);
component.showTaggingMenu(sanitizedTaggedXml,event,iframe);
}},0);
}$(iframeDocument.body).on("mouseup",function(event){displayTaggingMenu(event);
});
$(iframeDocument.body).on("contextmenu",function(event){event.preventDefault();
displayTaggingMenu(event);
});
$(iframeDocument.body).on("click",function(){MP_MenuManager.closeMenuStack(false);
});
};
DocumentComponent2.prototype.showTaggingMenu=function(selectedText,event,iframe){var component=this;
var componentContainer=$("#"+component.getStyles().getId());
if(!selectedText){return;
}var eventId=parseInt(this.m_selectedRowObj.attr("data-eventid"),10);
var iframeRoot=iframe.getRootElement();
var offsetX=event.pageX;
var offsetY=event.pageY;
var el=iframeRoot;
while(el){offsetX+=el.offsetLeft;
offsetY+=el.offsetTop;
if(el.scrollTop){offsetY-=el.scrollTop;
}el=el.offsetParent;
}var contextMenu=MP_MenuManager.getMenuObject("Doc2ContextMenu");
var tagResultSelection=null;
if(!contextMenu){var docI18n=i18n.discernabu.documents_o2;
contextMenu=new ContextMenu("Doc2ContextMenu").setIsRootMenu(true).setAnchorElementId("Doc2ContextMenuAnchor").setAnchorConnectionCorner(["top","left"]).setContentConnectionCorner(["top","left"]);
tagResultSelection=new MenuSelection("Doc2TagResult").setLabel(docI18n.TAG).setIsSelected(true).setSelectedClass("doc2-tag-icon");
contextMenu.addMenuItem(tagResultSelection);
MP_MenuManager.addMenuObject(contextMenu);
}var menuItemArr=contextMenu.getMenuItemArray();
if(menuItemArr){for(var i=menuItemArr.length;
i--;
){if(menuItemArr[i].getId()==="Doc2TagResult"){tagResultSelection=menuItemArr[i];
}}}tagResultSelection.setClickFunction(function(){component.tagResult(selectedText,eventId);
componentContainer.focus();
});
contextMenu.setXOffset(offsetX).setYOffset(offsetY).setAnchorElement();
MP_MenuManager.showMenu("Doc2ContextMenu");
contextMenu.removeAnchorElement();
};
DocumentComponent2.prototype.tagResult=function(documentText,eventId){var categoryMean=this.getCriterion().category_mean;
(new CapabilityTimer("CAP:MPG Documents O2 Tag Text",categoryMean)).capture();
var docI18n=i18n.discernabu.documents_o2;
var resultTag=new TaggedResult();
resultTag.setTagEntityId(eventId);
resultTag.setTagText(documentText);
resultTag.setTagDateTime(new Date());
resultTag.setCategorizationArray([docI18n.TAGGED_TEXT]);
resultTag.setEMRType("TAGTEXT");
MP_TaggingHandler.saveTaggedResult(resultTag);
};
DocumentComponent2.prototype.showSidePanel=function(rowObj){var eventId=rowObj.attr("data-eventid");
eventId=parseInt(eventId,10);
var docDataInfoExtId=rowObj.attr("data-doc-info-ext-id");
docDataInfoExtId=parseInt(docDataInfoExtId,10);
var compID=this.getComponentId();
var self=this;
var panelId="doc2SidePanel"+compID;
var sidePanel=this.m_sidePanel;
if(!sidePanel){sidePanel=new CompSidePanel(compID,panelId);
sidePanel.setExpandOption(sidePanel.expandOption.NONE);
sidePanel.setFullPanelScrollOn(false);
sidePanel.setMaxHeight("1px");
sidePanel.renderSidePanel();
sidePanel.showCloseButton();
sidePanel.m_closeButton.click(function(){self.selectDocument(self.m_selectedRowObj);
});
this.m_sidePanel=sidePanel;
}if(docDataInfoExtId){this.createSidePanelPatSubmittedDocContent(docDataInfoExtId);
}else{this.retrieveSidePanelContent(eventId);
}};
DocumentComponent2.LaunchDocumentEditor=function(eventId,categoryMean){(new CapabilityTimer("CAP:MPG Documents O2 Edit Result",categoryMean)).capture();
var viewer=new ResultViewer();
viewer.setEditModeInd(true);
viewer.addEventId(eventId);
viewer.launchViewer();
};
DocumentComponent2.LaunchDocumentViewer=function(eventId,categoryMean){(new CapabilityTimer("CAP:MPG Documents O2 View Result",categoryMean)).capture();
ResultViewer.launchAdHocViewer(eventId);
};
DocumentComponent2.LaunchDocumentImageViewer=function(eventId,categoryMean){(new CapabilityTimer("CAP:MPG Documents O2 View Image",categoryMean)).capture();
ResultViewer.launchAdHocImageViewer(eventId);
};
MP_Util.setObjectDefinitionMapping("WF_CLIN_DOC",DocumentComponent2);
