function OrderDetailsComponentStyle(){this.initByNamespace("od");
}OrderDetailsComponentStyle.prototype=new ComponentStyle();
OrderDetailsComponentStyle.prototype.constructor=ComponentStyle;
function OrderDetailsComponent(criterion){this.setCriterion(criterion);
this.setStyles(new OrderDetailsComponentStyle());
this.setComponentLoadTimerName("USR:MPG.ORDERDETAILS.O1 - load component");
this.setComponentRenderTimerName("ENG:MPG.ORDERDETAILS.O1 - render component");
this.orderDetailsArray=[];
this.m_lookbackOptions=[];
this.m_synonymIDs=[];
this.lookbackUnits=7;
this.lookbackType=2;
this.setLookbackUnits(this.lookbackUnits);
this.setLookbackUnitTypeFlag(this.lookbackType);
this.setScope(1);
this.defaultLoad=false;
this.sidePanel=null;
this.m_wasListenerAdded=false;
}OrderDetailsComponent.prototype=new MPageComponent();
OrderDetailsComponent.prototype.constructor=MPageComponent;
OrderDetailsComponent.prototype.setWasListenerAdded=function(value){this.m_wasListenerAdded=value;
};
OrderDetailsComponent.prototype.getWasListenerAdded=function(){return this.m_wasListenerAdded;
};
OrderDetailsComponent.prototype.setSynonymIDs=function(synonymIDs){this.m_synonymIDs=synonymIDs;
};
OrderDetailsComponent.prototype.getSynonymIDs=function(){return this.m_synonymIDs;
};
OrderDetailsComponent.prototype.setDetailsArray=function(arrayObject){this.orderDetailsArray=arrayObject;
};
OrderDetailsComponent.prototype.getDetailsArray=function(){return this.orderDetailsArray;
};
OrderDetailsComponent.prototype.resizeComponent=function(){MPageComponent.prototype.resizeComponent.call(this,null);
var compTableHeight=$("#od"+this.getComponentId()+"table").css("height");
if(compTableHeight&&this.sidePanel){this.sidePanel.setHeight(compTableHeight);
this.sidePanel.resizePanel();
}};
OrderDetailsComponent.prototype.loadFilterMappings=function(){this.addFilterMappingObject("WF_SYNONYM_IDS",{setFunction:this.setSynonymIDs,type:"ARRAY",field:"PARENT_ENTITY_ID"});
};
OrderDetailsComponent.prototype.preProcessing=function(){var lookbackMenuItems=this.getLookbackMenuItems()||[];
var menuItem=new ResultRangeSelection();
menuItem.setUnits(""+this.lookbackUnits+"");
menuItem.setType(this.lookbackType);
menuItem.setDisplay(ResultRangeSelectionUtility.getDisplayText(menuItem));
lookbackMenuItems.pop();
lookbackMenuItems.push(menuItem);
this.setLookbackMenuItems(lookbackMenuItems);
};
OrderDetailsComponent.prototype.retrieveComponentData=function(){var criterion=this.getCriterion();
var sendAr=[];
var encntrs=criterion.getPersonnelInfo().getViewableEncounters();
var encntrsList=(encntrs)?"value("+encntrs+")":"0.0";
var lookbackUnits=this.getLookbackUnits();
var lookbackType=this.getLookbackUnitTypeFlag();
var orderSynList=this.getSynonymIDs();
if(this.sidePanel){this.sidePanel=null;
}sendAr.push("^MINE^",criterion.person_id+".0",encntrsList,criterion.provider_id+".0",lookbackUnits,lookbackType,criterion.ppr_cd+".0",MP_Util.CreateParamArray(orderSynList,1));
MP_Core.XMLCclRequestWrapper(this,"MP_RETRIEVE_ORDERS_BY_SYNONYM",sendAr,true);
};
OrderDetailsComponent.prototype.postProcessing=function(){MPageComponent.prototype.postProcessing.call(this);
if(!this.getWasListenerAdded()){CERN_EventListener.addListener(this,EventListener.EVENT_ORDER_ACTION,this.retrieveComponentData,this);
this.setWasListenerAdded(true);
}};
OrderDetailsComponent.prototype.renderComponent=function(scriptReply){var reply=scriptReply;
var comp=this;
var compId="od"+comp.getComponentId();
var tableHTML=[];
comp.setDetailsArray(comp.buildResultsArray(reply));
tableHTML.push(comp.createComponentTable(comp.getDetailsArray()));
tableHTML.push("<div id='"+compId+"SidePanel' class='od-sidepanel-cont'></div>");
comp.finalizeComponent(tableHTML.join(""));
comp.initSidePanel();
var firstResult=$("#"+compId+"tableBody").find(".table-cell")[0];
if(firstResult){comp.defaultLoad=true;
$(firstResult).mouseup();
}};
OrderDetailsComponent.prototype.buildResultsArray=function(ordersReply){var i18nOD=i18n.discernabu.orderDetails;
var df=MP_Util.GetDateFormatter();
var ordReplyArr=ordersReply.ORDERS;
var ordersLen=ordReplyArr.length;
var codesArray=MP_Util.LoadCodeListJSON(ordersReply.CODES);
var prsnlArray=MP_Util.LoadPersonelListJSON(ordersReply.PRSNL);
var inactiveStatuses=["DISCONTINUED","CANCELED","COMPLETED","PENDING","DELETED","VOIDEDWRSLT","TRANS/CANCEL"];
var thisOrderObj=null;
var ordDetailsArray=[];
var ordStatus="";
var prsnl="";
var statusType="";
var statusDisp="";
var venueType="";
var idx=0;
for(idx=0;
idx<ordersLen;
idx++){var curEntry=ordReplyArr[idx];
var isRx=false;
var isDocMed=false;
var ordStatusTxt="";
ordStatus=MP_Util.GetValueFromArray(curEntry.CORE.STATUS_CD,codesArray);
prsnl=MP_Util.GetValueFromArray(curEntry.CORE.RESPONSIBLE_PROVIDER_ID,prsnlArray);
if($.inArray(ordStatus.meaning,inactiveStatuses)>-1){statusType="INACTIVE";
statusDisp=i18nOD.INACTIVE_ORDERS;
}else{if(ordStatus.meaning==="FUTURE"){statusType="FUTURE";
statusDisp=i18nOD.FUTURE_ORDERS;
}else{statusType="ACTIVE";
statusDisp=i18nOD.ACTIVE_ORDERS;
}}if(curEntry.MEDICATION_INFORMATION.ORIGINALLY_ORDERED_AS_TYPE.DOCUMENTED_IND){if(ordStatus.meaning==="ORDERED"){isDocMed=true;
}venueType=i18nOD.DOCUMENTED;
}else{if(curEntry.VENUE.ACUTE_IND){venueType=i18nOD.INPATIENT;
}else{if(curEntry.VENUE.AMBULATORY_IND){venueType=i18nOD.AMBULATORY;
}else{if(curEntry.VENUE.RX_MEDS_IND){if(ordStatus.meaning==="ORDERED"){isRx=true;
}venueType=i18nOD.PRESCRIPTION;
}else{venueType=i18nOD.UNSPECIFIED;
}}}}if(isDocMed){ordStatusTxt=i18n.DOCUMENTED;
}else{if(isRx){ordStatusTxt=i18n.PRESCRIBED;
}else{ordStatusTxt=ordStatus.display;
}}thisOrderObj={ORDER:(curEntry.DISPLAYS.DISPLAY_PREF_NAME)?curEntry.DISPLAYS.DISPLAY_PREF_NAME:curEntry.DISPLAYS.CLINICAL_NAME,ORDER_ID:curEntry.CORE.ORDER_ID,ORDER_DISPLAY_LINE:curEntry.DISPLAYS.CLINICAL_DISPLAY_LINE,ORDERING_PROVIDER:(prsnl)?prsnl.fullName:"--",ORDER_START_DT_TM:df.formatISO8601(curEntry.SCHEDULE.CURRENT_START_DT_TM,mp_formatter.DateTimeFormatter.FULL_DATE_TIME_2YEAR),ORDER_START_DT_TM_UTC:curEntry.SCHEDULE.CURRENT_START_DT_TM,ORDER_STATUS:ordStatusTxt,ORDER_STATUS_TYPE:statusType,ORDER_STATUS_DISP:statusDisp,VENUE_TYPE:venueType};
ordDetailsArray.push(thisOrderObj);
}function sortByStatusType(a,b){if(a.ORDER_STATUS_TYPE<b.ORDER_STATUS_TYPE){return -1;
}if(a.ORDER_STATUS_TYPE>b.ORDER_STATUS_TYPE){return 1;
}return 0;
}ordDetailsArray.sort(sortByStatusType);
return ordDetailsArray;
};
OrderDetailsComponent.prototype.createComponentTable=function(orderResultsObjArr){var i18nOD=i18n.discernabu.orderDetails;
var comp=this;
var compNS=comp.getStyles().getId();
var compId=comp.getComponentId();
var odResults=orderResultsObjArr;
var orderDetailsTable=new ComponentTable();
var clickExtension=new TableCellClickCallbackExtension();
var colArr=[];
var idx=0;
orderDetailsTable.setNamespace(compNS);
orderDetailsTable.setCustomClass("od-sidepanel-adj");
orderDetailsTable.setZebraStripe(true);
colArr=[{ID:"ORDER",CLASS:"od-order-col",DISPLAY:i18n.ORDER_NAME,SORTABLE:true,PRIMARY_SORT:"ORDER",SECONDARY_SORT:"ORDER_DISPLAY_LINE",RENDER_TEMPLATE:"<span>${ORDER}</span> <span class='det-txt'>${ORDER_DISPLAY_LINE}</span>"},{ID:"ORDER_START",CLASS:"od-col",DISPLAY:i18nOD.ORDER_START,SORTABLE:true,PRIMARY_SORT:"ORDER_START_DT_TM_UTC",SECONDARY_SORT:"ORDER",RENDER_TEMPLATE:"${ORDER_START_DT_TM}"},{ID:"ORDER_STATUS",CLASS:"od-col",DISPLAY:i18n.STATUS,SORTABLE:true,PRIMARY_SORT:"ORDER_STATUS",SECONDARY_SORT:"ORDER",RENDER_TEMPLATE:"${ORDER_STATUS}"}];
var colLen=colArr.length;
for(idx=0;
idx<colLen;
idx++){var curCol=colArr[idx];
var column=new TableColumn();
column.setColumnId(curCol.ID);
column.setCustomClass(curCol.CLASS);
column.setColumnDisplay(curCol.DISPLAY);
if(curCol.SORTABLE){column.setPrimarySortField(curCol.PRIMARY_SORT);
column.addSecondarySortField(curCol.SECONDARY_SORT,TableColumn.SORT.ASCENDING);
column.setIsSortable(curCol.SORTABLE);
}column.setRenderTemplate(curCol.RENDER_TEMPLATE);
orderDetailsTable.addColumn(column);
}orderDetailsTable.bindData(odResults);
orderDetailsTable.quickGroup("ORDER_STATUS_TYPE","${ORDER_STATUS_DISP}",false);
if(orderDetailsTable.groupMap&&orderDetailsTable.groupMap.ACTIVE){orderDetailsTable.groupMap.ACTIVE.setCanCollapse(false);
}if(orderDetailsTable.groupMap&&orderDetailsTable.groupMap.INACTIVE){orderDetailsTable.groupMap.INACTIVE.setCanCollapse(false);
}if(orderDetailsTable.groupMap&&orderDetailsTable.groupMap.FUTURE){orderDetailsTable.groupMap.FUTURE.setCanCollapse(false);
}if(orderDetailsTable.getGroupSequence()[0]!=="ACTIVE"){orderDetailsTable.groupSequence.reverse();
}orderDetailsTable.sortByColumnInDirection("ORDER_START",TableColumn.SORT.DESCENDING);
comp.setComponentTable(orderDetailsTable);
clickExtension.setCellClickCallback(function(event,data){comp.getSidePanelDetails(event,data);
});
orderDetailsTable.addExtension(clickExtension);
return orderDetailsTable.render();
};
OrderDetailsComponent.prototype.initSidePanel=function(){var comp=this;
var compId=comp.getComponentId();
this.sidePanel=new CompSidePanel(compId,"od"+compId+"SidePanel");
this.sidePanel.setExpandOption(this.sidePanel.expandOption.EXPAND_DOWN);
var compTableHeight=$("#od"+compId+"table").height();
this.sidePanel.setHeight(compTableHeight+"px");
this.sidePanel.renderSidePanel();
};
OrderDetailsComponent.prototype.getSidePanelDetails=function(e,data){var comp=this;
var compId=comp.getComponentId();
var grabDetails=false;
var mainContentDiv=$("#od"+comp.getComponentId()+"tableBody");
var clickedRow=(e.target.nodeName==="SPAN")?e.target.parentNode.parentNode:e.target.parentNode;
var orderData=data.RESULT_DATA;
if(comp.defaultLoad){$(clickedRow).addClass("od-selected-default");
comp.defaultLoad=false;
grabDetails=true;
}else{if($(clickedRow).hasClass("od-selected-row")===false){if($(clickedRow).hasClass("od-selected-default")===false){grabDetails=true;
}if(mainContentDiv.find(".od-selected-default").length>0){mainContentDiv.find(".od-selected-default").removeClass("od-selected-default");
}else{mainContentDiv.find(".od-selected-row").removeClass("od-selected-row");
}$(clickedRow).addClass("od-selected-row");
}}if(grabDetails){this.sidePanel=(this.sidePanel)?this.sidePanel:new CompSidePanel(compId,"od"+compId+"SidePanel");
var vertOffset=(this.sidePanel.m_sidePanelContents.outerHeight()-this.sidePanel.m_sidePanelContents.height());
var loaderDivHeight=(this.sidePanel.m_sidePanelObj.outerHeight()!=this.sidePanel.m_height.replace("px",""))?this.sidePanel.m_sidePanelContents.height():(this.sidePanel.m_sidePanelObj.height()-vertOffset);
this.sidePanel.setFullPanelScrollOn(false);
this.sidePanel.setContents("<div class='loading-spinner' style='height:"+loaderDivHeight+"px;'>&nbsp;</div>","odContent"+compId);
var sendAr=["^MINE^",orderData.ORDER_ID+".0"];
var request=new MP_Core.ScriptRequest(this);
request.setProgramName("MP_RETRIEVE_ORDER_DETAILS");
request.setParameters(sendAr);
request.setAsync(true);
MP_Core.XMLCCLRequestCallBack(null,request,function(reply){var orderName=orderData.ORDER;
var displayLine=orderData.ORDER_DISPLAY_LINE;
comp.updateSidePanel(reply,orderName,displayLine);
});
}};
OrderDetailsComponent.prototype.updateSidePanel=function(reply,orderName,displayLine){var comp=this;
var compId=comp.getComponentId();
var orderData=comp.getDetailsArray();
var orderDataLen=orderData.length;
var thisOrderData=null;
var ordDetailsJSON=reply.getResponse();
var orderDetails=ordDetailsJSON.ORDER_HISTORY;
var actionLen=orderDetails.ACTION_CNT;
var historyDetailsArr=null;
var sidePanelId="od"+compId+"SidePanel";
var orderDetailsSP=(this.sidePanel)?this.sidePanel:new CompSidePanel(compId,sidePanelId);
var compTableHeight=$("#od"+compId+"table").height();
var spHTML=[];
var commentInd=false;
var commentIdx=null;
var actionInfoStr="";
var idx=0;
var x=0;
for(x=0;
x<orderDataLen;
x++){if(orderDetails.ORDER_ID===orderData[x].ORDER_ID){thisOrderData=orderData[x];
break;
}}historyDetailsArr=comp.buildDetailsArray(ordDetailsJSON);
spHTML.push("<div class='od-sp-header'>",orderName,"</div><div class='od-sp-detail-line'>",displayLine,"</div><div class='sp-separator'></div>");
spHTML.push("<div id='sidePanelScrollContainer"+compId+"' class='od-sp-content'>");
for(idx=0;
idx<actionLen;
idx++){var thisAction=historyDetailsArr[idx];
var actionType=thisAction.ACTION_TYPE;
if(thisAction.COMMENT_IND&&!commentInd){commentIdx=idx;
commentInd=true;
actionType+="<strong style='vertical-align:super;'> &#149;</strong>";
}actionInfoStr=thisAction.ACTION_DT_TM+" ("+thisAction.ACTION_PRSNL+")";
spHTML.push("<div class='od-order-action'><ul><li class='od-sp-detail-value'>",actionType,"</li><li class='od-sp-detail-line'>",thisAction.CLINICAL_DISP_LINE,"</li><li class='od-sp-action-info'>",actionInfoStr,"</li></ul></div>");
}spHTML.push("<div class='sp-separator'></div>");
spHTML.push("<div class='od-sp-orig-details'><div class='od-sp-detail-line'><span>",i18n.TYPE,"</span><span>",i18n.ORDERING_PHYSICIAN,"</span></div>");
spHTML.push("<div class='od-sp-detail-value'><span>",thisOrderData.VENUE_TYPE,"</span><span>",thisOrderData.ORDERING_PROVIDER,"</span></div>");
if(commentInd){var commentLabel="<strong style='vertical-align:super;'>&#149; </strong>"+i18n.COMMENTS;
spHTML.push("<div class='od-sp-comments'>");
spHTML.push("<ul><li class='od-sp-comment-detail'>",commentLabel,"</li><li class='od-sp-detail-value'>",historyDetailsArr[commentIdx].COMMENT,"</li></ul></div>");
}spHTML.push("</div></div>");
orderDetailsSP.setFullPanelScrollOn(true);
orderDetailsSP.setContents(spHTML.join(""),"odContent"+compId);
if(orderDetailsSP.m_sidePanelObj.height()<=compTableHeight&&orderDetailsSP.m_expCollapseIconObj.hasClass("sp-collapse")){orderDetailsSP.expandCollapseSidePanel();
}};
OrderDetailsComponent.prototype.buildDetailsArray=function(detailsJSON){var orderHistoryJSON=detailsJSON.ORDER_HISTORY;
var orderActions=orderHistoryJSON.ACTIONS;
var prsnlList=MP_Util.LoadPersonelListJSON(detailsJSON.PRSNL);
var actionLen=orderHistoryJSON.ACTION_CNT;
var df=MP_Util.GetDateFormatter();
var thisOrderAction=null;
var detailsArray=[];
var actnDtTm="";
var ordDtTm="";
var actionProv="";
var orderProv="";
var idx=0;
for(idx=0;
idx<actionLen;
idx++){var actnDate=new Date();
var ordDate=new Date();
var curAction=orderActions[idx];
actionProv=MP_Util.GetValueFromArray(curAction.ACTION_PERSONNEL_ID,prsnlList);
orderProv=MP_Util.GetValueFromArray(curAction.ORDER_PROVIDER_ID,prsnlList);
actnDate.setISO8601(curAction.ACTION_DT_TM);
actnDtTm=actnDate.format("mediumDate")+" "+actnDate.format("militaryTime");
ordDate.setISO8601(curAction.ORDER_DT_TM);
ordDtTm=ordDate.format("mediumDate")+" "+ordDate.format("militaryTime");
thisOrderAction={ACTION_DT_TM:actnDtTm,ACTION_DT_TM_UTC:actnDate,ACTION_PRSNL:(actionProv.fullName)?actionProv.fullName:"--",ACTION_TYPE:(curAction.ACTION_TYPE_DESC)?curAction.ACTION_TYPE_DESC:"--",CLINICAL_DISP_LINE:(curAction.CLINICAL_DISP_LINE)?curAction.CLINICAL_DISP_LINE:"--",COMMENT_IND:curAction.COMMENT_FLAG,COMMENT:curAction.COMMENT_TEXT,COMMUNICATION_TYPE:curAction.COMMUNICATION_TYPE_DISP,ORDER_DETAIL_LINE:(curAction.ORDER_DETAIL_LINE)?curAction.ORDER_DETAIL_LINE:"--",ORDER_DT_TM:ordDtTm,ORDER_DT_TM_UTC:ordDate,ORDER_PRSNL:(orderProv)?orderProv.fullName:"--"};
detailsArray.push(thisOrderAction);
}function sortDetailsByDate(a,b){return a.ACTION_DT_TM_UTC>b.ACTION_DT_TM_UTC?-1:a.ACTION_DT_TM_UTC<b.ACTION_DT_TM_UTC?1:0;
}detailsArray.sort(sortDetailsByDate);
return detailsArray;
};
MP_Util.setObjectDefinitionMapping("WF_ORDER_DETAILS",OrderDetailsComponent);
