function PersonRegistriesComponentStyle(){this.initByNamespace("hi_pr");
}PersonRegistriesComponentStyle.prototype=new ComponentStyle();
PersonRegistriesComponentStyle.prototype.constructor=ComponentStyle;
function PersonRegistriesComponent(criterion){this.setCriterion(criterion);
this.setComponentLoadTimerName("USR:MPG.PERSONREG - load component");
this.setComponentRenderTimerName("ENG:MPG.PERSONREG - render component");
this.setIncludeLineNumber(true);
this.setStyles(new PersonRegistriesComponentStyle());
this.testURI="";
this.aliasType="";
this.aliasPoolCode=0;
this.lookupKey="";
this.measuresStatusFilter="";
this.allRegistriesCollapsed=false;
}PersonRegistriesComponent.prototype=new MPageComponent();
PersonRegistriesComponent.prototype.constructor=PersonRegistriesComponent;
PersonRegistriesComponent.prototype.setTestURI=function(value){this.testURI=value.replace(/&#047;/g,"/");
};
PersonRegistriesComponent.prototype.getTestURI=function(){return this.testURI;
};
PersonRegistriesComponent.prototype.setAliasType=function(value){this.aliasType=value;
};
PersonRegistriesComponent.prototype.getAliasType=function(){return this.aliasType;
};
PersonRegistriesComponent.prototype.setAliasPoolCode=function(value){this.aliasPoolCode=value[0];
};
PersonRegistriesComponent.prototype.getAliasPoolCode=function(){return this.aliasPoolCode;
};
PersonRegistriesComponent.prototype.setLookupKey=function(value){this.lookupKey=value;
};
PersonRegistriesComponent.prototype.getLookupKey=function(){return this.lookupKey;
};
PersonRegistriesComponent.prototype.getMeasuresStatusFilter=function(){return this.measuresStatusFilter;
};
PersonRegistriesComponent.prototype.setMeasuresStatusFilter=function(value){this.measuresStatusFilter=value;
};
PersonRegistriesComponent.prototype.setAllRegistriesCollapsed=function(value){this.allRegistriesCollapsed=value;
};
PersonRegistriesComponent.prototype.getAllRegistriesCollapsed=function(){return this.allRegistriesCollapsed;
};
PersonRegistriesComponent.prototype.postProcessing=function(){MPageComponent.prototype.postProcessing.call(this);
if(this.getAllRegistriesCollapsed()){$(this.getSectionContentNode()).find(".person-registries-component .sub-sec").addClass("closed");
}this.setCollapseExpandControls();
$("#"+this.getComponentId()+"-person-registries-measure-filter-select").val(this.getMeasuresStatusFilter());
};
PersonRegistriesComponent.prototype.isWorkflow=function(){return this.getStyles().getComponentType()===CERN_COMPONENT_TYPE_WORKFLOW;
};
PersonRegistriesComponent.prototype.registriesComponentToolbar=function(score){var qualityScore="--";
var docI18n=i18n.discernabu.person_registries_o1;
if(score!==undefined&&score!==null){qualityScore=score;
}return"<div class='sub-title-disp'><div id='"+this.getComponentId()+"-person-registries-component-score' class='person-registries-component-score summary'>"+docI18n.QUALITY_SCORE+"<span class='bold-text'>"+qualityScore+"</span>"+this.toolbarButtons()+"<span class='pull-right hi_pr-measures-filter-select'>"+docI18n.MEASURE_FILTER_DISPLAY.replace("{0}",this.buildFilterSelect())+"</span></div></div>";
};
PersonRegistriesComponent.prototype.toolbarButtons=function(){var docI18n=i18n.discernabu.person_registries_o1;
return"<span class='pull-right'><span class='expand-collapse-button' id='collapse-all-registries-btn"+this.getComponentId()+"'>"+docI18n.COLLAPSE_ALL+"</span><span class='expand-collapse-button hide' id='expand-all-registries-btn"+this.getComponentId()+"'>"+docI18n.EXPAND_ALL+"</span></span>";
};
PersonRegistriesComponent.prototype.expandAllRegistries=function(){var componentId=this.getComponentId();
$(this.getSectionContentNode()).find(".person-registries-component .closed .sub-sec-hd-tgl").trigger("click");
$("#expand-all-registries-btn"+componentId).hide();
$("#collapse-all-registries-btn"+componentId).show();
};
PersonRegistriesComponent.prototype.collapseAllRegistries=function(){var componentId=this.getComponentId();
$(this.getSectionContentNode()).find(".person-registries-component .sub-sec-hd-tgl").trigger("click");
$("#collapse-all-registries-btn"+componentId).hide();
$("#expand-all-registries-btn"+componentId).show();
};
PersonRegistriesComponent.prototype.setCollapseExpandControls=function(){var componentId=this.getComponentId(),collapsed=$(this.getSectionContentNode()).find(".person-registries-component .closed").length,$collapseAllBtn=$("#collapse-all-registries-btn"+componentId),$expandAllBtn=$("#expand-all-registries-btn"+componentId);
if(collapsed===0){$collapseAllBtn.not(":visible").show();
$expandAllBtn.not(":hidden").hide();
}else{$collapseAllBtn.not(":hidden").hide();
$expandAllBtn.not(":visible").show();
}};
PersonRegistriesComponent.prototype.buildFilterSelect=function(){var docI18n=i18n.discernabu.person_registries_o1;
return"<select id='"+this.getComponentId()+"-person-registries-measure-filter-select'><option value='all'>"+docI18n.MEASURE_FILTER_ALL+"</option><option value='not_achieved'>"+docI18n.MEASURE_FILTER_NOT_ACHIEVED+"</option><option value='missing'>"+docI18n.MEASURE_FILTER_MISSING+"</option><option value='due'>"+docI18n.MEASURE_FILTER_DUE+"</option></select>";
};
PersonRegistriesComponent.prototype.renderPersonRegistriesComponentBody=function(programs){var output="";
for(var i=0;
i<programs.length;
i++){if(programs.hasOwnProperty(i)){output+=this.buildRegistryList(programs[i]);
}}return output;
};
PersonRegistriesComponent.prototype.buildRegistryList=function(program){var docI18n=i18n.discernabu.person_registries_o1,registryList,i;
registryList="<div class='sub-sec'>"+this.buildRegistryListHeader(program)+"<div class='sub-sec-content'>";
if(program.measures){for(i=0;
i<program.measures.length;
i++){var measure=program.measures[i];
registryList+=this.buildRegistryListBody(measure);
}if(program.measures.length===0){if(program.total_measure_count&&this.getMeasuresStatusFilter()!=="all"){registryList+="<span class='hi_pr-info'>"+docI18n.MEASURE_FILTER_NO_MEASURES+"</span>";
}else{registryList+="<span class='hi_pr-info'>"+docI18n.NO_QUALIFYING_MEASURES+"</span>";
}}}if(program.events){for(i=0;
i<program.events.length;
i++){var event=program.events[i];
registryList+=this.buildRegistryEventBody(event);
}if(program.events.length===0){if(program.total_measure_count&&this.getMeasuresStatusFilter()!=="all"){registryList+="<span class='hi_pr-info'>"+docI18n.MEASURE_FILTER_NO_MEASURES+"</span>";
}else{registryList+="<span class='hi_pr-info'>"+docI18n.NO_QUALIFYING_MEASURES+"</span>";
}}}registryList+="</div></div>";
return registryList;
};
PersonRegistriesComponent.prototype.buildRegistryListHeader=function(program){var docI18n=i18n.discernabu.person_registries_o1;
return"<h3 class='sub-sec-hd'><span class='sub-sec-hd-tgl'>-</span><span class='sub-sec-title bold-text'>"+program.name+"</span> <div class='sub-sec-title met-count'><span class='sub-sec-title met-count'>"+docI18n.COMPLETION_RATIO.replace("{0}",program.met_measure_count).replace("{1}",program.total_measure_count)+"<div class='sub-sec-title icon-info-sprite' data-type='Registry' data-id="+program.id+"></div></span></div></h3>";
};
PersonRegistriesComponent.prototype.buildRegistryListBody=function(measure){var nameDisplay=measure.name,supportingFacts=measure.supporting_facts,measureClass=this.getMeasureClass(measure.outcome),measureStatus=this.getMeasureStatus(measure.outcome),date;
if(supportingFacts.length>0){for(var i=0;
i<supportingFacts.length;
i++){date=supportingFacts[i].date;
break;
}}return"<dl class='hi_pr-info "+measureClass+"-outcome'><dd class='hi_pr-name'><div class='wrapper'><div class="+this.getMeasureIconClass(measure.outcome,measure.measure_due)+" title='"+measureStatus+"'></div><span title='"+nameDisplay+"'>"+nameDisplay+"</span></div><div class='icon-info-sprite' data-id="+measure.fqn+"></div></dd><dd class='hi_pr-stat'>"+this.displayDueDate(measure.due_date,measure.measure_due,measure.outcome)+"</dd><dd class='hi_pr-stat'>"+measure.value_unit+"</dd><dd class='hi_pr-within pull-right'>"+this.dateFormatter(date)+"</dd></dl>";
};
PersonRegistriesComponent.prototype.buildRegistryEventBody=function(event){var body,performedDate=this.dateFormatter(event.date),providerNames=this.getProviderNames(event.responsible_providers),docI18n=i18n.discernabu.person_registries_o1;
body="<div class='event-group'><div class='sub-sec-hd'><span class='sub-sec-title'>"+docI18n.EVENT_PERFORMED.replace("{0}",performedDate).replace("{1}",providerNames)+"</span></div>";
if(event.measures!==undefined&&event.measures!==null&&event.measures.length>0){body+="<div class='event-content'>";
for(var i=0;
i<event.measures.length;
i++){var measure=event.measures[i];
body+=this.buildRegistryListBody(measure);
}body+="</div>";
}body+="</div>";
return body;
};
PersonRegistriesComponent.prototype.getMeasureClass=function(outcome){switch(outcome){case"EXCLUDED":return"excluded";
case"ACHIEVED":return"positive";
case"MISSING_DATA":return"missing-data";
case"NOT_ACHIEVED":return"negative";
default:return null;
}};
PersonRegistriesComponent.prototype.getMeasureIconClass=function(outcome,measureDue){switch(outcome){case"EXCLUDED":return"icon-excluded-sprite";
case"ACHIEVED":return"icon-positive-sprite";
case"MISSING_DATA":return measureDue?"icon-time-negative-sprite":"icon-missing-data-sprite";
case"NOT_ACHIEVED":return measureDue?"icon-time-negative-sprite":"icon-negative-sprite";
default:return null;
}};
PersonRegistriesComponent.prototype.getMeasureStatus=function(outcome){var docI18n=i18n.discernabu.person_registries_o1;
switch(outcome){case"EXCLUDED":return docI18n.MEASURE_EXCLUDED;
case"ACHIEVED":return docI18n.MEASURE_ACHIEVED;
case"MISSING_DATA":return docI18n.MEASURE_MISSING_DATA;
case"NOT_ACHIEVED":return docI18n.MEASURE_NOT_ACHIEVED;
default:return null;
}};
PersonRegistriesComponent.prototype.displayDueDate=function(dueDate,measureDue,outcome){var dueDateIcon,dueDateText;
if(outcome==="EXCLUDED"){return"--";
}if(dueDate){dueDateText=this.dateFormatter(dueDate);
}else{if(measureDue){dueDateText=i18n.discernabu.person_registries_o1.MEASURE_DUE_NOW;
}else{return"--";
}}dueDateIcon=outcome==="ACHIEVED"?"icon-time-positive-sprite":"icon-time-negative-sprite";
return"<div class='wrapper'><div class='"+dueDateIcon+"'></div><span>"+dueDateText+"</span></div>";
};
PersonRegistriesComponent.prototype.dateFormatter=function(date){if(date!==undefined&&date!==null){try{return $.datepicker.parseDate("yy-mm-dd",date.split("T")[0]).format("mediumDate");
}catch(error){logger.logJSError(error,PersonRegistriesComponent,"person-registries-o1.js","dateFormatter");
return date;
}}else{return"--";
}};
PersonRegistriesComponent.prototype.getMeasures=function(program){var measures=[],rawMeasures=[];
if(program.measures){measures=program.measures;
}else{if(program.events){for(var j=0;
j<program.events.length;
j++){var eventBasedMeasures=program.events[j].measures;
if(eventBasedMeasures!==null&&eventBasedMeasures.length>0){rawMeasures.push(eventBasedMeasures);
}}measures=measures.concat.apply(measures,rawMeasures);
}}return measures;
};
PersonRegistriesComponent.prototype.getProviderNames=function(providers){var providerNames=[];
if(providers!==undefined&&providers!==null&&providers.length>0){for(var i=0;
i<providers.length;
i++){var name=providers[i].full_name;
if(name!==null&&name!==""){providerNames.push(name);
}}}return providerNames.join(", ");
};
PersonRegistriesComponent.prototype.measuresStatusFilterChangeEventHandler=function(){this.setMeasuresStatusFilter($("#"+this.getComponentId()+"-person-registries-measure-filter-select").val());
this.retrieveComponentData();
};
PersonRegistriesComponent.prototype.initRegistriesToolbarButtons=function(){var componentId=this.getComponentId(),klass=this;
$("#hi_pr"+componentId).off();
$("#hi_pr"+componentId).on("click","#expand-all-registries-btn"+componentId,function(){klass.expandAllRegistries();
});
$("#hi_pr"+componentId).on("click","#collapse-all-registries-btn"+componentId,function(){klass.collapseAllRegistries();
});
$("#hi_pr"+componentId).on("click",".person-registries-component .sub-sec-hd-tgl",function(){klass.setCollapseExpandControls();
});
$("#"+componentId+"-person-registries-measure-filter-select").off().on("change",function(){klass.measuresStatusFilterChangeEventHandler();
});
};
PersonRegistriesComponent.prototype.initSupportingFacts=function(programs){var klass=this;
$(klass.getSectionContentNode()).off().on("click",".person-registries-component .icon-info-sprite",function(){var $infoIcon=$(this),type=$infoIcon.data("type"),supportingId=$infoIcon.data("id"),docI18n=i18n.discernabu.person_registries_o1,supportingFacts,modalHeaderTitle,noSupportingFactsMsg,tableContent,i;
if(type==="Registry"){for(i=0;
i<programs.length;
i++){if(programs[i].id===supportingId){modalHeaderTitle=docI18n.REGISTRY_SUPPORTING_FACTS_TITLE.replace("{0}",programs[i].name);
supportingFacts=programs[i].supporting_facts;
}}noSupportingFactsMsg=docI18n.NO_REGISTRY_SUPPORTING_FACTS;
}else{for(i=0;
i<programs.length;
i++){var measures=klass.getMeasures(programs[i]);
for(var j=0;
j<measures.length;
j++){if(measures[j].fqn===supportingId){var name=measures[j].name;
modalHeaderTitle=docI18n.MEASURE_SUPPORTING_FACTS_TITLE.replace("{0}",name);
supportingFacts=measures[j].supporting_facts;
break;
}}}noSupportingFactsMsg=docI18n.NO_MEASURE_SUPPORTING_FACTS;
}if(supportingFacts&&supportingFacts.length>0){var tableRows="";
for(i=0;
i<supportingFacts.length;
i++){var supportingFact=supportingFacts[i],factsName=supportingFact.name||"",factsCode=supportingFact.formatted_code||"",factsSource=supportingFact.formatted_source||"",factsDateTime=klass.dateFormatter(supportingFact.date);
tableRows+="<tr class='supporting-facts-content'><td class='fact-description'><div>"+factsName+"</div><div class='meta'>"+factsCode+"</div><div class='meta'>"+factsSource+"</div></td><td><div class='pull-right meta'>"+factsDateTime+"</div></td></tr>";
}tableContent="<table class='supporting-facts'><tbody>"+tableRows+"</tbody></table>";
}else{tableContent="<p>"+noSupportingFactsMsg+"</p>";
}var supportDataModal=new ModalDialog("supportDataModal").setHeaderTitle(modalHeaderTitle);
supportDataModal.setIsBodySizeFixed(false);
supportDataModal.setLeftMarginPercentage(35).setRightMarginPercentage(35).setTopMarginPercentage(20);
supportDataModal.setBodyDataFunction(function(modalObj){modalObj.setBodyHTML(tableContent);
});
var closeButton=new ModalButton("closeButton");
closeButton.setText(docI18n.CLOSE).setCloseOnClick(true);
supportDataModal.addFooterButton(closeButton);
MP_ModalDialog.updateModalDialogObject(supportDataModal);
MP_ModalDialog.showModalDialog("supportDataModal");
});
};
PersonRegistriesComponent.prototype.createComponentHTML=function(response,status,authStatus){var docI18n=i18n.discernabu.person_registries_o1,jsRegistriesHTML="<div class='sub-sec-hd exception-msg'>"+docI18n.REGISTRY_NOT_FOUND+"</div>",programs,componentId=this.getComponentId(),disclaimerBox="",error,componentClass;
if(this.isWorkflow()){componentClass=this.getStyles().getNameSpace()+"-workflow";
}else{componentClass=this.getStyles().getNameSpace()+"-summary";
}if(authStatus!==false){switch(status){case 200:programs=response.programs;
if(programs===undefined||programs===null||programs.length===0){jsRegistriesHTML="<div class='sub-sec-hd exception-msg'>"+docI18n.NOT_QUALIFY+"</div>";
}else{if($("#"+componentId+"-person-registries-component-score").length>0){$("#"+componentId+"-person-registries-component-score").parent().remove();
}$("#hi_pr"+componentId+" .sec-content").before(this.registriesComponentToolbar(response.quality_score));
jsRegistriesHTML=this.renderPersonRegistriesComponentBody(programs);
this.initRegistriesToolbarButtons();
this.initSupportingFacts(programs);
}break;
case 401:case 403:jsRegistriesHTML="<div class='sub-sec-hd exception-msg'>"+docI18n.ACCESS_DENIED+"</div>";
break;
case 400:jsRegistriesHTML="<div class='sub-sec-hd exception-msg'>"+docI18n.BAD_REQUEST+"</div>";
break;
case 204:case 404:break;
default:jsRegistriesHTML="<div class='sub-sec-hd exception-msg'>"+docI18n.SYSTEM_ERROR+"</div>";
}disclaimerBox="<div class='person-registries-component-info "+componentClass+" sub-sec-hd'><span class='sub-sec-title'>"+docI18n.DISCLAIMER+"</span></div>";
}else{error=(this.mfaAuthStatusData&&this.mfaAuthStatusData.message)||"";
jsRegistriesHTML="<div class='sub-sec-hd exception-msg'>"+error+"</div>";
}return"<div class='person-registries-component "+componentClass+"'>"+jsRegistriesHTML+"</div>"+disclaimerBox;
};
PersonRegistriesComponent.prototype.loadFilterMappings=function(){this.addFilterMappingObject("HI_PR_TEST_URI",{setFunction:this.setTestURI,type:"STRING",field:"FREETEXT_DESC"});
this.addFilterMappingObject("HI_PR_ALIAS_TYPE",{setFunction:this.setAliasType,type:"STRING",field:"FREETEXT_DESC"});
this.addFilterMappingObject("HI_PR_ALIAS_POOL_CD",{setFunction:this.setAliasPoolCode,type:"ARRAY",field:"PARENT_ENTITY_ID"});
this.addFilterMappingObject("HI_PR_LOOKUP_KEY",{setFunction:this.setLookupKey,type:"STRING",field:"FREETEXT_DESC"});
this.addFilterMappingObject("HI_PR_MEASURES_STATUS_FILTER",{setFunction:this.setMeasuresStatusFilter,type:"STRING",field:"FREETEXT_DESC"});
this.addFilterMappingObject("HI_PR_COLLAPSE_REGISTRIES",{setFunction:this.setAllRegistriesCollapsed,type:"BOOLEAN",field:"FREETEXT_DESC"});
};
PersonRegistriesComponent.prototype.retrieveComponentData=function(){var status=this.performMultiFactorAuthentication();
if(!status){this.finalizeComponent(this.createComponentHTML("",0,status),MP_Util.CreateTitleText(this,0));
}else{this.setMeasuresStatusFilter(this.getMeasuresStatusFilter()||"not_achieved");
this.setAllRegistriesCollapsed(this.getAllRegistriesCollapsed()===true);
var namespace="Person Registries Proxy Request";
var sendAr=[];
var criterion=this.getCriterion();
var lookupKey=this.getLookupKey()||"HI_RECORD_PERSON_EMPI_LOOKUP";
var personId=criterion.person_id||"0";
var encounterId=criterion.encounter_id||"0";
var providerId=criterion.provider_id||"0";
sendAr.push("^MINE^","^"+lookupKey+"^","^HI_REGISTRIES_PERSON_REGISTRIES^","^JSON^",personId+".0","^"+this.getAliasType()+"^",this.getAliasPoolCode()+".0",encounterId+".0",providerId+".0","^"+this.getTestURI()+"^","^measures_status_filter="+this.getMeasuresStatusFilter()+"^");
var loadTimer=new RTMSTimer(this.getComponentLoadTimerName(),this.getCriterion().category_mean);
loadTimer.addMetaData("namespace",namespace);
var renderTimer=new RTMSTimer(this.getComponentRenderTimerName(),this.getCriterion().category_mean);
renderTimer.addMetaData("namespace",namespace);
var scriptRequest=new ComponentScriptRequest();
scriptRequest.setName(namespace);
scriptRequest.setProgramName("HI_ALIAS_LOOKUP_HTTP_PROXY_GET");
scriptRequest.setParameterArray(sendAr);
scriptRequest.setComponent(this);
scriptRequest.setRawDataIndicator(true);
scriptRequest.setLoadTimer(loadTimer);
scriptRequest.setRenderTimer(renderTimer);
scriptRequest.performRequest();
}};
PersonRegistriesComponent.prototype.renderComponent=function(response){try{var proxyReply=JSON.parse(response.getResponse()).PROXYREPLY,success=proxyReply.TRANSACTIONSTATUS.SUCCESSIND,prereqError=proxyReply.TRANSACTIONSTATUS.PREREQERRORIND,responseBody,status=0,programCount=0;
if(success===1){status=proxyReply.HTTPREPLY.STATUS;
if(status===200){responseBody=JSON.parse(proxyReply.HTTPREPLY.BODY);
if(responseBody.programs!==undefined&&responseBody.programs!==null){programCount=responseBody.programs.length;
}}}else{if(prereqError===1){status=404;
}}this.finalizeComponent(this.createComponentHTML(responseBody,status),MP_Util.CreateTitleText(this,programCount));
}catch(err){MP_Util.LogJSError(this,err,"person-registries-o1.js","renderComponent");
throw err;
}};
PersonRegistriesComponent.prototype.performMultiFactorAuthentication=function(){var authStatus=new Mfa_Auth().RetrieveMfaAuthStatus(),authStatusData,status;
if(authStatus&&authStatus.isResourceAvailable()){authStatusData=authStatus.getResourceData();
if(authStatusData){authStatusData.statusInd=authStatusData.status===0||authStatusData.status===5;
this.mfaAuthStatusData=authStatusData;
}}else{this.mfaAuthStatusData={statusInd:false,status:4,message:i18n.discernabu.mfa_auth.MFA_ERROR_MSG};
}this.auditMultiFactorAuthentication(this.mfaAuthStatusData.status);
return this.mfaAuthStatusData.statusInd;
};
PersonRegistriesComponent.prototype.auditMultiFactorAuthentication=function(status){var criterion=this.getCriterion(),providerID=criterion.provider_id+".0",mpEventAudit=new MP_EventAudit(),dateFormatter=new mp_formatter.DateTimeFormatter(MPAGE_LOCALE),dateTime=dateFormatter.format(new Date(),mp_formatter.DateTimeFormatter.FULL_DATE_TIME_4YEAR);
eventName=this.isWorkflow()?"HR_REGISTRIES_WORKFLOW_MFA_ATTEMPT":"HR_REGISTRIES_SUMMARY_MFA_ATTEMPT";
mpEventAudit.setAuditMode(0);
mpEventAudit.setAuditEventName(eventName);
mpEventAudit.setAuditEventType("SECURITY");
mpEventAudit.setAuditParticipantType("PERSON");
mpEventAudit.setAuditParticipantRoleCd("PROVIDER");
mpEventAudit.setAuditParticipantIDType("PROVIDER_NUMBER");
mpEventAudit.setAuditParticipantID(providerID);
mpEventAudit.setAuditParticipantName("STATUS="+status+"; DATE="+dateTime);
mpEventAudit.addAuditEvent();
mpEventAudit.submit();
};
MP_Util.setObjectDefinitionMapping("HI_REGISTRIES",PersonRegistriesComponent);
MP_Util.setObjectDefinitionMapping("WF_HI_REGISTRIES",PersonRegistriesComponent);
