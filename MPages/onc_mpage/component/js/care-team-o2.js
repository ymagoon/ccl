function CareTeamo2ComponentStyle(){this.initByNamespace("cto2");
}CareTeamo2ComponentStyle.inherits(ComponentStyle);
function CareTeamo2Component(criterion){this.setCriterion(criterion);
this.setStyles(new CareTeamo2ComponentStyle());
this.setComponentLoadTimerName("USR:MPG.CARE_TEAM.O2 - load component");
this.setComponentRenderTimerName("ENG:MPG.CARE_TEAM.O2 - render component");
this.m_renderTimer=null;
this.m_careTeamTable=null;
this.m_lastSelectedRow="";
this.m_providerRowId="";
this.m_rowWasClicked=false;
this.m_previewPaneMinHeight=173;
this.m_primaryContactEventId=0;
this.m_primaryContactEventCd=0;
this.m_plusAddIconEle;
this.compMenuReference={};
this.m_compMenuSequence=[];
this.m_showPanel=false;
this.m_sidePanel=null;
this.m_sidePanelContainer=null;
this.m_tableContainer=null;
this.m_selectedTeamId=null;
this.m_alreadySavedCareTeams={};
this.m_cachedRowData=[];
this.m_providerRoleCodes={};
this.m_nonProviderRoleCodes={};
this.m_communicationTypeCodes=[];
this.m_selected_role="";
this.m_selected_team=undefined;
this.curUserLastSelectedRole=null;
this.selectedPersonId=null;
this.assignedCareTeams=[];
}(function($){function ccl(program,params,timer,callback){var pArr=[];
$.each(params,function(k,v){pArr.push(v.toString());
});
var request=new MP_Core.ScriptRequest(null,"");
request.setProgramName(program);
request.setParameters(pArr);
if(timer){request.setTimer(timer);
}MP_Core.XMLCCLRequestCallBack(null,request,callback);
return request;
}function cclNumber(number){if(typeof number==="undefined"){return"0.0";
}return parseInt(number,10)+".00";
}CareTeamo2Component.prototype=new MPageComponent();
CareTeamo2Component.prototype.constructor=MPageComponent;
CareTeamo2Component.prototype.preProcessing=function(){var compMenu=this.getMenu();
if(compMenu){var compID=this.getComponentId();
var compMenuCtProv=new MenuSelection("compMenuMngCtProv"+compID);
var self=this;
var criterion=self.getCriterion();
compMenuCtProv.setLabel(i18n.discernabu.careteam_o2.MANAGE_CARETEAM_PROVIDERS);
compMenu.addMenuItem(compMenuCtProv);
compMenuCtProv.setIsDisabled(false);
this.compMenuReference[compMenuCtProv.getId()]=compMenuCtProv;
compMenuCtProv.setClickFunction(function(){ManageProvider.manageProviders(criterion.provider_id,criterion.logical_domain_id);
});
}};
CareTeamo2Component.prototype.setPlusAddEnabled=function(){this.m_isPlusAdd=true;
};
CareTeamo2Component.prototype.retrieveComponentData=function(shouldCacheSessionData){var self=this;
var criterion=this.getCriterion();
var logicalDomain=criterion.logical_domain_id;
var encntrId=criterion.encntr_id;
this.m_rowWasClicked=false;
this.m_lastSelectedRow="";
this.m_cachedRowData=[];
this.assignedCareTeams=[];
if(!shouldCacheSessionData){this.curUserLastSelectedRole=null;
}try{if(logicalDomain===null){throw new Error("Logical Domain is null.");
}if(!encntrId){this.finalizeComponent("<p class='disabled'>"+i18n.discernabu.careteam_o2.NO_ENCNTR+"</p>","");
return;
}var sendAr=["^MINE^",cclNumber(criterion.person_id),cclNumber(encntrId),"0.0",logicalDomain,"0"];
var request=new MP_Core.ScriptRequest(self,self.getComponentLoadTimerName());
request.setProgramName("MP_GET_CARE_TEAM_ASSIGN");
request.setParameters(sendAr);
request.setAsync(true);
MP_Core.XMLCCLRequestCallBack(null,request,function(reply){self.m_alreadySavedCareTeams=reply;
self.isAuthorized=reply.getResponse().MANAGE_CARETEAM_PRIV;
if(reply.getStatus()==="S"){self.renderComponent(reply.getResponse());
}else{if(reply.getStatus()==="F"){self.finalizeComponent(MP_Util.HandleErrorResponse(self.getStyles().getNameSpace(),reply.getError()),"");
}else{if(reply.getStatus()==="Z"){self.renderNoCareTeam();
}}}});
}catch(err){MP_Util.LogJSError(err,self,"care-team-o2.js","retrieveComponentData");
self.finalizeComponent(MP_Util.HandleErrorResponse(self.getStyles().getNameSpace(),err.message),"");
}};
CareTeamo2Component.prototype.placePlusAddIcon=function(){var wholeCompId=this.getStyles().getId();
var headerElement=$("#"+wholeCompId).find(".sec-title");
var plusElement=$("#"+wholeCompId+"Add");
if(!plusElement.length){headerElement.append("<a id='"+wholeCompId+"Add' class='add-plus'></a>");
}};
CareTeamo2Component.prototype.createPlusAddControl=function(){var self=this;
var thisVisitIndicator=true;
var addingPctTeamIndicator=true;
var addPlusElement=this.m_plusAddIconEle;
var plusAddIconContainer=$("<div></div>").attr("id","cto2"+self.getComponentId()+"AddPlus").addClass("cto2-addplus-drp-dwn").html("&nbsp;");
var ctI18n=i18n.discernabu.careteam_o2;
this.setPlusAddCustomInd(true);
addPlusElement.html("");
addPlusElement.off("click");
addPlusElement.append(plusAddIconContainer);
assignMyselfTemplate=new TemplateEngine.TemplateFactory((function(){var template=TemplateEngine;
var div=template.tag("div");
return{teamsInfo:function(context){return div({"class":context.CSS_CLASS,id:context._elementId,pct_care_team:context.PCT_CARE_TEAM,ASSIGN_CARE_TEAM:context.ASSIGN_CARE_TEAM,existing_assignment:context.EXISTING_ASSIGNMENT},div({"class":"cto2-team-info"},context.MED_SERVICE_TEAM));
}};
})());
var plusAddControl=new MPageControls.DropDownList($("#cto2"+self.getComponentId()+"AddPlus"));
plusAddControl.setValue("<span class='add-icon'></span>");
self.plusAddControl=plusAddControl;
var detailDialog=plusAddControl.getDetailDialog();
detailDialog.setOnShow(function(){detailDialog.getContents().css("z-index",8);
plusAddControl.onShow();
});
self.plusAddControl.getList().setItemTemplate(assignMyselfTemplate.teamsInfo);
self.plusAddControl.setOnShow(function(){self.plusAddControl.setDisplayKey("MED_SERVICE_TEAM");
self.assignType=ctI18n.ASSIGN_MYSELF;
self.openTab();
});
self.plusAddControl.getList().setOnSelect(function(item){var slaTimer=null;
try{slaTimer=MP_Util.CreateTimer("USR:MPG.CARETEAM.O2_Assign_myself");
if(slaTimer){slaTimer.SubtimerName=self.getCriterion().category_mean;
slaTimer.Start();
}if(!item.EXISTING_ASSIGNMENT){if(item.ASSIGN_NO_PROVIDER_TEAM){self.providerModalPreProcessing(function(){thisVisitIndicator=false;
addingPctTeamIndicator=false;
self.updateRelationshipCodeList(thisVisitIndicator,addingPctTeamIndicator);
});
}if(item.ASSIGN_CARE_TEAM){self.assignType=ctI18n.ASSIGN_CARE_TEAM;
self.openTab();
}else{if(item.PCT_CARE_TEAM){self.m_selectedTeamId=item.PCT_CARE_TEAM;
self.updateRelationshipCodeList(thisVisitIndicator,addingPctTeamIndicator);
}else{if(item.ADD_OTHER){self.providerModalPreProcessing(function(){self.launchProviderSearchModal("provider");
});
}else{if(item.ADD_NON_PROVIDER){self.providerModalPreProcessing(function(){self.launchProviderSearchModal("non-provider");
});
}}}}}}catch(err){if(slaTimer){slaTimer.Abort();
slaTimer=null;
}MP_Util.LogJSError(err,self,"care-team-o2.js","AddPlusControlOnselect");
throw (err);
}finally{if(slaTimer){slaTimer.Stop();
}}});
};
CareTeamo2Component.prototype.CreateDropDownContent=function(data){var self=this;
var cachedData=MP_Util.GetValueFromArray(data.PCT_CARE_TEAM_ID,this.m_cachedRowData);
this.replaceSuggestionsArr=cachedData.REPLACE_OBJ||[];
if(!(data.PRSNL_ID||data.PCT_TEAM_CD)||cachedData.REPLACE_OBJ){return this.replaceSuggestionsArr;
}var retrieveCareTeamSibilings=function(){var sendAr=["^MINE^",data.PCT_CARE_TEAM_ID+".0",0,1];
var request=new MP_Core.ScriptRequest(this,"");
request.setProgramName("MP_GET_RELATED_CARE_TEAMS");
request.setParameters(sendAr);
request.setAsync(false);
MP_Core.XMLCCLRequestCallBack(null,request,function(reply){if(reply.getStatus()==="S"){processSuggestions(reply.getResponse(),data.PCT_CARE_TEAM_ID);
}else{if(reply.getStatus()==="F"){self.finalizeComponent(MP_Util.HandleErrorResponse(self.getStyles().getNameSpace(),reply.getError()),"");
}}});
};
var processSuggestions=function(reply){var sibilingsCareTeams=reply.REQ_TEAMS[0].SIBLINGS;
var sibilings=null;
var codesArray=MP_Util.LoadCodeListJSON(reply.CODES);
var prsnlArray=MP_Util.LoadPersonelListJSON(reply.PRSNL);
var sibilingCareTeamlength=sibilingsCareTeams.length;
for(var i=0;
i<sibilingCareTeamlength;
i++){sibilings=sibilingsCareTeams[i];
if($.inArray(sibilings.ORIG_PCT_TEAM_ID,self.assignedCareTeams)<0){switch(reply.REQ_TEAMS[0].TEAM_TYPE){case 1:sibilings.DISPLAY=MP_Util.GetValueFromArray(sibilings.PCT_MED_SERVICE_CD,codesArray).display;
sibilings.CARE_TEAM_ID=sibilings.ORIG_PCT_TEAM_ID;
break;
case 2:sibilings.DISPLAY=MP_Util.GetValueFromArray(sibilings.PCT_TEAM_CD,codesArray).display;
sibilings.CARE_TEAM_ID=sibilings.ORIG_PCT_TEAM_ID;
break;
case 3:case 4:if(sibilings.PRSNL_ID){sibilings.DISPLAY=MP_Util.GetValueFromArray(sibilings.PRSNL_ID,prsnlArray).fullName;
sibilings.CARE_TEAM_ID=sibilings.ORIG_PCT_TEAM_ID;
}break;
default:continue;
}sibilings.CARE_TEAM_ID=sibilings.ORIG_PCT_TEAM_ID;
if(sibilings.DISPLAY){self.replaceSuggestionsArr.push({DISPLAY:sibilings.DISPLAY,CARE_TEAM_ID:sibilings.CARE_TEAM_ID,IS_PRIMARY:data.IS_PRIMARY,PRSNL_ID:sibilings.PRSNL_ID});
}}}};
retrieveCareTeamSibilings();
self.replaceSuggestionsArr.sort(function(a,b){if(a.DISPLAY.toUpperCase()>b.DISPLAY.toUpperCase()){return 1;
}if(a.DISPLAY.toUpperCase()<b.DISPLAY.toUpperCase()){return -1;
}return 0;
});
cachedData.REPLACE_OBJ=self.replaceSuggestionsArr;
return self.replaceSuggestionsArr;
};
CareTeamo2Component.prototype.addReadPane=function(hasResults){var compID=this.getComponentId();
var ctI18n=i18n.discernabu.careteam_o2;
var self=this;
var tableViewObj=$("#"+compID+"tableView");
var sidePanelContId="ct"+compID+"sidePanelContainer";
this.m_sidePanelContainer=$("#"+sidePanelContId);
var careteamPanelContent=$("#"+compID+"mainContainer");
this.m_tableContainer=tableViewObj;
var initPane=function(){var getAddAssignmentLink=function(){if(self.isAuthorized){$("#"+self.getStyles().getNameSpace()+compID+"Add").addClass("enabled");
return"<a id='cto2"+compID+"addAssignment' href='#'>"+ctI18n.ADD_ASSIGNMENT+"</a>";
}else{return"";
}};
return["<div id='cto2"+compID+"rpContent' class='cto2-rp-content'>","<div class='cto2-rp-no-team-icon'>","&nbsp;","</div>","<div class='cto2-rp-no-team-text secondary-text'>",ctI18n.NO_CARE_TEAM,getAddAssignmentLink(),"</div>","</div>"].join("");
};
if(hasResults){if(this.m_sidePanelContainer.length===0){var careteamSidePanelContainer="<div id='"+sidePanelContId+"' class='cto2-side-panel'>&nbsp;</div>";
careteamPanelContent.append(careteamSidePanelContainer);
}this.m_sidePanel=new CompSidePanel(compID,sidePanelContId);
this.m_sidePanel.setExpandOption(this.m_sidePanel.expandOption.EXPAND_DOWN);
this.m_sidePanel.setOnExpandFunction(function(){$("#sidePanelScrollContainer"+compID).css({overflow:"auto"});
});
this.m_sidePanel.renderPreBuiltSidePanel();
this.m_sidePanel.setHeight(this.m_tableContainer.height()+"px");
this.m_sidePanel.showCornerCloseButton();
this.m_sidePanel.setCornerCloseFunction(function(){$("#cto2"+compID+"table .result-info").removeClass("cto2-row-selected cto2-row-selected-init selected");
self.m_showPanel=false;
self.m_sidePanel.hidePanel();
self.m_tableContainer.removeClass("cto2-side-panel-addition");
self.m_tableContainer.removeClass("cto2-sp-hide-mode");
self.m_lastSelectedRow="";
});
var buttonsHtml=['<div id="cto2'+compID+'rpBtnHolder" class="cto2-rp-btn-holder hidden">','<div id = "cto2'+compID+'remove" class="cto2-rp-btn">',ctI18n.REMOVE,"</div>",'<div id="cto2'+compID+'replace" class="cto2-rp-btn drop-down"></div>','<div id="cto2'+compID+'modify" class="cto2-rp-btn">',ctI18n.MODIFY,"</div>",'<div id="cto2'+compID+'makePrimary" class="cto2-rp-btn">',ctI18n.MAKE_PRIMARY,"</div>","</div>"].join("");
this.m_sidePanel.setActionsAsHTML(buttonsHtml);
this.m_sidePanelContainer=$("#"+sidePanelContId);
}else{var readPane=$("#"+compID+"readPane");
var previewPane=new MPageControls.PreviewPane(this.getStyles().getNameSpace(),compID,readPane,initPane);
previewPane.renderPane();
}var suggestionsTemplate=new TemplateEngine.TemplateFactory((function(){var template=TemplateEngine;
var div=template.tag("div");
return{suggestions:function(context){return div({"class":"search-item",id:context._elementId,"cto2-med-service-team":context.CARE_TEAM_ID,"cto2-is-primary":context.IS_PRIMARY},div({"class":"cto2-provider-name"},context.DISPLAY));
}};
})());
if(hasResults){var $sidePanel=$("#sidePanel"+compID);
var $replaceBtn=$("#cto2"+compID+"replace");
var replaceDropDown=new MPageControls.DropDownList($replaceBtn);
replaceDropDown.setValue(ctI18n.REPLACE);
replaceDropDown.setDisplayKey("DISPLAY");
replaceDropDown.getList().setItemTemplate(suggestionsTemplate.suggestions);
replaceDropDown.getDetailDialog().setOnShow(function(){replaceDropDown.onShow();
var replaceBtnBottom=$replaceBtn.position().top+$replaceBtn.outerHeight(true);
var replaceBtnLeft=$replaceBtn.position().left+parseInt($replaceBtn.css("margin-left"),10);
var sidePanelHeight=$sidePanel.height();
replaceDropDown.getDetailDialog().getContents().css({top:replaceBtnBottom,height:sidePanelHeight-replaceBtnBottom,left:replaceBtnLeft,right:35,"overflow-y":"auto","overflow-x":"hidden","z-index":8});
});
self.replaceDropDown=replaceDropDown;
}else{var $previewPane=$("#pp_"+compID+"_cto2");
$previewPane.css({height:tableViewObj.height()+2+"px","min-width":"275px",width:"100%"});
this.getElementById("addAssignment").click(function(){self.assignType=ctI18n.ASSIGN_CARE_TEAM_MEMBER;
self.openTab();
return false;
});
}};
CareTeamo2Component.prototype.buildPaneHtml=function(paneData){var compID=this.getComponentId();
var ctI18n=i18n.discernabu.careteam_o2;
var getMemberListHTML=function(){return["<div id='cto2"+compID+"memberDisplay' class='cto2-rp-member-display'>","<div id='cto2"+compID+"memberLabel'>",paneData.memberListLabel,"</div>","<div id='cto2"+compID+"memberList'>",paneData.memberList,"</div>","</div>"].join("");
};
if(paneData.showProviderTeam>0){return["<div id="+compID+"rpScrollContainer>","<div id='cto2"+compID+"providerOnly' class='cto2-rp-provider-only'>","<div class='cto2-rp-provider-group'>","<div class='cto2-rp-provider-left'>","<div class='cto2-rp-provider-team-lbl secondary-text'>"+ctI18n.TEAM,"</div>","<div id='cto2"+compID+"teamDisplay' class='cto2-rp-provider-team-display'>",paneData.providerTeam,"</div>","</div>","</div>","<div class='cto2-rp-separator-top'>","&nbsp;","</div>","<div class='cto2-rp-separator-bottom'>","&nbsp;","</div>","</div>",getMemberListHTML(),"</div>"].join("");
}else{return getMemberListHTML();
}};
CareTeamo2Component.prototype.resizeComponent=function(){var compID=this.getComponentId();
this.collapsePane();
MPageComponent.prototype.resizeComponent.call(this,null);
var $previewPane=$("#pp_"+compID+"_cto2");
var $tableViewObj=$("#"+compID+"tableView");
if(!$tableViewObj.hasClass("cto2-empty-table")){$previewPane.css({height:Math.max($tableViewObj.height(),this.m_previewPaneMinHeight)+"px"});
}else{$previewPane.css({height:$tableViewObj.height()+2+"px","min-width":"275px",width:"100%"});
}};
CareTeamo2Component.prototype.createScriptRequest=function(clickValue,data){var self=this;
var criterion=this.getCriterion();
var blobIn=null;
var replaceCareTeam=null;
var params=[];
var mpUpdStartArr=["^MINE^","0"];
var scriptRequest=new MP_Core.ScriptRequest(this,"");
switch(clickValue){case 0:var json="{'PATIENTLIST':{'CNT':1,'QUAL':[{'PERSON_ID':"+criterion.person_id+".0,'ENCNTR_ID':"+criterion.encntr_id+".0,'EVENT_ID':"+self.m_primaryContactEventId+".0}]}}";
params.push("^MINE^",data.PRSNL_ID+".0",0,0,"^"+json+"^",0,0,data.PCT_CARE_TEAM_ID+".0",0);
scriptRequest.setParameters(params);
scriptRequest.setProgramName("MP_ASSIGN_PHYSICIAN_CONTACT");
scriptRequest.setAsync(true);
return scriptRequest;
case 1:replaceCareTeam=data.REPLACE_DATA;
blobIn='{"PATIENTS": {"QUAL":[{"PERSON_ID":'+criterion.person_id+'.0,"ENCNTR_ID":'+criterion.encntr_id+'.0,"ASSIGNMENT_ID":'+data.DCP_SHIFT_ASSIGN_ID+'.0,"ORIG_PCT_TEAM_ID":'+data.PCT_CARE_TEAM_ID+'.0,"ACTIVE_IND":'+1+',"BEGIN_EFFECTIVE_ISO":" ","END_EFFECTIVE_ISO":" "}, {"PERSON_ID":'+criterion.person_id+'.0,"ENCNTR_ID":'+criterion.encntr_id+'.0,"ASSIGNMENT_ID":'+0+',"ORIG_PCT_TEAM_ID":'+replaceCareTeam.CARE_TEAM_ID+'.0,"ACTIVE_IND":'+1+',"BEGIN_EFFECTIVE_ISO":" ","END_EFFECTIVE_ISO":" ","ASSIGNED_RELTN_TYPE_CD":'+data.RELTN_TYPE_CD+".0}]}}";
scriptRequest.setParameters(mpUpdStartArr);
scriptRequest.setProgramName("MP_UPD_CARE_TEAM_ASSIGNMENT");
scriptRequest.setRequestBlobIn(blobIn);
scriptRequest.setAsync(true);
return scriptRequest;
case 2:blobIn='{"PATIENTS": {"QUAL":[{"PERSON_ID":'+criterion.person_id+'.0,"ENCNTR_ID":'+criterion.encntr_id+'.0,"ASSIGNMENT_ID":'+data.DCP_SHIFT_ASSIGN_ID+'.0,"ORIG_PCT_TEAM_ID":'+(data.PCT_CARE_TEAM_ID||"0")+'.0,"ACTIVE_IND":'+1+',"BEGIN_EFFECTIVE_ISO":"","END_EFFECTIVE_ISO":""}]}}';
scriptRequest.setParameters(mpUpdStartArr);
scriptRequest.setProgramName("MP_UPD_CARE_TEAM_ASSIGNMENT");
scriptRequest.setRequestBlobIn(blobIn);
scriptRequest.setAsync(true);
return scriptRequest;
default:return"";
}};
CareTeamo2Component.prototype.addUpdatePrimaryContact=function(clickValue,data){var self=this;
var slaTimer=null;
var request=null;
try{if(clickValue===0){slaTimer=MP_Util.CreateTimer("USR:MPG.CARETEAM.O2 _ Assign_primary_physician");
}else{if(clickValue===2){slaTimer=MP_Util.CreateTimer("USR:MPG.CARETEAM.O2 _ Remove_assignment");
}}if(slaTimer){slaTimer.SubtimerName=self.getCriterion().category_mean;
slaTimer.Start();
}request=self.createScriptRequest(clickValue,data);
MP_Core.XMLCCLRequestCallBack(null,request,function(reply){if(reply.getStatus()==="S"){if(slaTimer){slaTimer.Stop();
}self.m_showPanel=false;
self.retrieveComponentData();
}else{if(reply.getStatus()==="F"){if(slaTimer){slaTimer.Abort();
}self.finalizeComponent(MP_Util.HandleErrorResponse(self.getStyles().getNameSpace(),reply.getError()),"");
}else{if(reply.getStatus()==="Z"&&slaTimer){slaTimer.Stop();
}}}});
}catch(err){if(slaTimer){slaTimer.Abort();
slaTimer=null;
}MP_Util.LogJSError(err,self,"care-team-o2.js","addUpdatePrimaryContact");
throw (err);
}};
CareTeamo2Component.prototype.replacePrimaryContact=function(data,replaceCareTeam){var self=this;
var criterion=this.getCriterion();
try{var request=null;
var sendAr=[];
sendAr.push("^MINE^",replaceCareTeam.PRSNL_ID+".0",0,0,"^{'PATIENTLIST': {'CNT': 1, 'QUAL':[{'PERSON_ID':"+criterion.person_id+".0","'ENCNTR_ID':"+criterion.encntr_id+".0,'EVENT_ID':"+self.m_primaryContactEventId+".0}]}}^",0,0,replaceCareTeam.CARE_TEAM_ID+".0",0);
request=new MP_Core.ScriptRequest(self,"");
request.setProgramName("MP_ASSIGN_PHYSICIAN_CONTACT");
request.setParameters(sendAr);
request.setAsync(true);
MP_Core.XMLCCLRequestCallBack(null,request,function(reply){if(reply.getStatus()==="S"){self.addUpdatePrimaryContact(1,data);
}else{self.finalizeComponent(MP_Util.HandleErrorResponse(self.getStyles().getNameSpace(),reply.getError()),"");
return;
}});
}catch(err){MP_Util.LogJSError(err,self,"care-team-o2.js","replacePrimaryContact");
throw (err);
}};
CareTeamo2Component.prototype.updateInfo=function(selRow,data,isInitialLoad,teamMembers){var compID=this.getComponentId();
var groupRowId=$(selRow).attr("id");
if((this.m_lastSelectedRow===groupRowId)&&!isInitialLoad){if(this.m_showPanel){$("#cornerCloseButton"+compID).trigger("click");
this.m_lastSelectedRow="";
}return;
}this.initSidePanelButtons(data);
this.updateSelRowBgColor(selRow,isInitialLoad);
this.prepareForRenderPane(data,teamMembers);
this.m_lastSelectedRow=groupRowId;
};
CareTeamo2Component.prototype.updateSelRowBgColor=function(selRowObj){var compID=this.getComponentId();
var tableViewObj=$("#"+compID+"tableView");
var prevRow=tableViewObj.find(".selected");
if(prevRow.length>0&&this.m_lastSelectedRow===$(prevRow).attr("id")){prevRow.removeClass("cto2-row-selected");
prevRow.removeClass("cto2-row-selected-init");
prevRow.removeClass("selected");
}$(selRowObj).addClass("cto2-row-selected selected");
};
CareTeamo2Component.prototype.initSidePanelButtons=function(data){var self=this;
var compID=this.getComponentId();
var btnHolder=$("#cto2"+compID+"rpBtnHolder");
var makePrimaryBtn=$("#cto2"+compID+"makePrimary");
var modifyBtn=$("#cto2"+compID+"modify");
var replaceBtn=$("#cto2"+compID+"replace");
var removeBtn=$("#cto2"+compID+"remove");
var bindModifyButton=function(){if(data.PRSNL_ID){modifyBtn.removeClass("hidden").off("click").on("click",function(){var modifyProviderInfo=self.prepModifyModal.call(self,data);
self.providerModalPreProcessing(modifyProviderInfo);
});
}else{unbindModifyButton();
}};
var unbindModifyButton=function(){modifyBtn.addClass("hidden").off("click");
};
var bindRemoveButton=function(){if(CERN_Platform.inMillenniumContext()||data.MEMBER_TYPE!=="LIFETIME_RELATIONSHIP"){removeBtn.removeClass("hidden").off("click").on("click",function(){if(data.MEMBER_TYPE==="LIFETIME_RELATIONSHIP"){self.removeLifetimeReltns.call(self);
}else{self.addUpdatePrimaryContact.call(self,2,data);
}});
}else{unbindRemoveButton();
}};
var unbindRemoveButton=function(){removeBtn.addClass("hidden").removeAttr("click").off("click");
};
var bindMakePrimaryButton=function(){if(data.PRSNL_ID){makePrimaryBtn.removeClass("hidden").off("click").on("click",function(){self.addUpdatePrimaryContact.call(self,0,data);
});
}else{unbindMakePrimaryButton();
}};
var unbindMakePrimaryButton=function(){makePrimaryBtn.addClass("hidden").removeAttr("click").off("click");
};
var bindReplaceButton=function(){unbindReplaceButton();
self.CreateDropDownContent(data);
if(self.replaceSuggestionsArr&&self.replaceSuggestionsArr.length>0){replaceBtn.removeClass("hidden");
self.replaceDropDown.setOnShow(function(){self.replaceDropDown.getList().renderItems(self.replaceSuggestionsArr);
});
self.replaceDropDown.getList().setOnSelect(function(item){var replaceBtnCapTimer=MP_Util.CreateTimer("CAP:MPG.CARETEAM.O2 _ Replace_assignment");
if(replaceBtnCapTimer){replaceBtnCapTimer.SubtimerName=self.getCriterion().category_mean;
replaceBtnCapTimer.Start();
replaceBtnCapTimer.Stop();
}data.REPLACE_DATA=item;
if(data.IS_PRIMARY){self.replacePrimaryContact(data,item);
}else{self.addUpdatePrimaryContact(1,data);
}});
}};
var unbindReplaceButton=function(){replaceBtn.addClass("hidden");
self.replaceDropDown.hide();
};
if(this.isAuthorized){btnHolder.removeClass("hidden");
switch(data.MEMBER_TYPE){case"CARE_TEAM":if(data.IS_PRIMARY){unbindMakePrimaryButton();
unbindRemoveButton();
}else{bindMakePrimaryButton();
bindRemoveButton();
}bindModifyButton();
bindReplaceButton();
break;
case"SHIFT_ASSIGNMENTS":unbindMakePrimaryButton();
unbindModifyButton();
unbindRemoveButton();
unbindReplaceButton();
break;
case"LIFETIME_RELATIONSHIP":unbindMakePrimaryButton();
unbindModifyButton();
bindRemoveButton();
unbindReplaceButton();
break;
default:unbindMakePrimaryButton();
bindModifyButton();
bindRemoveButton();
unbindReplaceButton();
}}};
CareTeamo2Component.prototype.addModalSpinner=function(container){MP_Util.LoadSpinner(container);
var $container=$("#"+container);
var $spinner=$("#"+container+" .loading-screen");
$spinner.css("top",$container.position().top);
$spinner.css("height",$container.height());
};
CareTeamo2Component.prototype.showModifyModal=function(bodyDataFunction,data){var self=this;
var selectedRole=0;
var buildModifyRequestString=function(){var isFreetext=(!(data.MEMBER_TYPE==="CARE_TEAM"||(data.MEMBER_TYPE==="PROVIDER_RELATION"&&data.FREETEXT_IND===0)));
var getPersonJSON=function(){if(isFreetext){return'{"PERSON_ID":'+data.PRSNL_ID+',"FIRST_NAME":"'+$("#cto2FirstNameTextbox").val()+'","MIDDLE_NAME":"'+$("#cto2MiddleNameTextbox").val()+'","LAST_NAME":"'+$("#cto2LastNameTextbox").val()+'"}';
}else{return"";
}};
var getPhonesJSON=function(){var getJSON=function(elementID){if(isFreetext){var phoneID=$(elementID+"PhoneID").val()+".0";
var phoneType=$(elementID+"InputGroup select").val()+".0";
var phoneNumber=$.trim($(elementID).val()).replace(/[^0-9]+/g,"");
if(phoneType!==""&&((phoneID==="0.0"&&phoneNumber!=="")||phoneID!=="0.0")){return'{"PERSON_ID":'+data.PRSNL_ID+',"PHONE_ID":'+phoneID+',"PHONE_TYPE_CD":'+phoneType+',"PHONE_NUMBER":"'+phoneNumber+'"}';
}}return"";
};
var json=[];
var primaryPhone=getJSON("#cto2PrimaryPhoneTextbox");
var secondaryPhone=getJSON("#cto2SecPhoneTextbox");
var tertiaryPhone=getJSON("#cto2TerPhoneTextbox");
if(primaryPhone){json.push(primaryPhone);
}if(secondaryPhone){json.push(secondaryPhone);
}if(tertiaryPhone){json.push(tertiaryPhone);
}return json.join(",");
};
selectedRole=$(".cto2-form-roles-holder .cto2-selected-list").data("value");
return'{"REQUESTIN": {"USER_ID":'+self.getCriterion().provider_id+'.0,"NAME_UPDATES": ['+getPersonJSON()+'],"PHONE_UPDATES": ['+getPhonesJSON()+'],"CARE_TEAM_UPDATES": [{"ASSIGNMENT_ID":'+data.DCP_SHIFT_ASSIGN_ID+'.0,"ROLE_RELTN_CD":'+selectedRole+".0}]}}";
};
var modalId="careTeamModifyModal";
var applyBtnId="ctoApplyBtn";
var cancelBtnId="ctoCancelBtn";
var ctoCancelBtn=new ModalButton(cancelBtnId).setText(i18n.discernabu.careteam_o2.CANCEL).setFocusInd(true);
var ctoApplyBtn=new ModalButton(applyBtnId).setText(i18n.discernabu.careteam_o2.APPLY).setIsDithered(true);
var modifyModal=new ModalDialog(modalId).setTopMarginPercentage(10).setBottomMarginPercentage(5).setLeftMarginPercentage(20).setRightMarginPercentage(20).setIsBodySizeFixed(false).setHeaderTitle(i18n.discernabu.careteam_o2.MODIFY_CARE_TEAM_MEMBER).addFooterButton(ctoApplyBtn).addFooterButton(ctoCancelBtn);
modifyModal.setFooterButtonCloseOnClick(applyBtnId,false);
modifyModal.setFooterButtonOnClickFunction(applyBtnId,function(){self.addModalSpinner("careTeamModifyModalbody");
$("#ctoApplyBtn").prop("disabled",true);
var request=new ScriptRequest().setProgramName("MP_UPD_CARE_TEAM_MEMBER").setParameterArray(["^MINE^"]).setDataBlob(buildModifyRequestString()).setResponseHandler(function(reply){switch(reply.getResponse().STATUS_DATA.STATUS){case"S":self.m_showPanel=false;
if(self.getCriterion().provider_id===data.PRSNL_ID){self.setAssignedRelationshipCode(selectedRole);
}MP_ModalDialog.closeModalDialog(modalId);
self.retrieveComponentData(self.shouldPreserveRole(data));
break;
default:$("#ctoApplyBtn").removeAttr("disabled");
$("#careTeamModifyModalbody .loading-screen").remove();
self.createErrorModal(reply.getError());
}});
request.performRequest();
});
MP_ModalDialog.addModalDialogObject(modifyModal);
modifyModal.setBodyDataFunction(function(){bodyDataFunction.call(modifyModal);
(function bindValidation(){var $modalBody=$("#"+modifyModal.getBodyElementId());
var $firstName=$modalBody.find("#cto2FirstNameTextbox");
var $middleName=$modalBody.find("#cto2MiddleNameTextbox");
var $lastName=$modalBody.find("#cto2LastNameTextbox");
var $primaryPhone=$modalBody.find("#cto2PrimaryPhoneTextbox");
var $secondaryPhone=$modalBody.find("#cto2SecPhoneTextbox");
var $tertiaryPhone=$modalBody.find("#cto2TerPhoneTextbox");
var $primaryPhoneType=$modalBody.find("#cto2PrimaryPhoneTextboxInputGroup select");
var $secondaryPhoneType=$modalBody.find("#cto2SecPhoneTextboxInputGroup select");
var $tertiaryPhoneType=$modalBody.find("#cto2TerPhoneTextboxInputGroup select");
var $role=$modalBody.find(".cto2-form-roles-holder");
var changeDetected=function(){function isChanged($elem){return $elem.val()!=$elem.attr("data-orig-value");
}if(isChanged($firstName)){return true;
}if(isChanged($middleName)){return true;
}if(isChanged($lastName)){return true;
}if(isChanged($primaryPhone)){return true;
}if(isChanged($secondaryPhone)){return true;
}if(isChanged($tertiaryPhone)){return true;
}if(isChanged($primaryPhoneType)){return true;
}if(isChanged($secondaryPhoneType)){return true;
}if(isChanged($tertiaryPhoneType)){return true;
}if($role.find(".cto2-selected-list").attr("data-value")!==$role.attr("data-orig-value")){return true;
}return false;
};
var validInput=function(){var textBoxValidation=function(textInput){if(textInput.is(":not(:disabled)")){if($.trim(textInput.val()).length>0){textInput.addClass("te-valid");
return true;
}else{textInput.removeClass("te-valid");
return false;
}}else{return true;
}};
var phoneValidation=function(phoneInput){if(phoneInput.is(":not(:disabled)")){if($.trim(phoneInput.val()).replace(/[^\d]/g,"").length>0){phoneInput.addClass("te-valid");
return true;
}else{phoneInput.removeClass("te-valid");
return false;
}}else{return true;
}};
var firstNameValid=textBoxValidation($firstName);
var lastNameValid=textBoxValidation($lastName);
var primaryPhoneValid=phoneValidation($primaryPhone);
var roleSelected=($(".cto2-form-roles-holder .cto2-selected-list").length>0);
return(firstNameValid&&lastNameValid&&primaryPhoneValid&&roleSelected);
};
var checkFormStatus=function(){var changed=changeDetected();
var valid=validInput();
if(changed&&valid){$("#ctoApplyBtn").removeAttr("disabled");
}else{$("#ctoApplyBtn").prop("disabled",true);
}};
validInput();
$modalBody.find("input, select").on("change keyup",checkFormStatus);
$(".cto2-form-roles-holder").on("cto2-role-selected",checkFormStatus);
}());
});
MP_ModalDialog.updateModalDialogObject(modifyModal);
MP_ModalDialog.showModalDialog(modifyModal.getId());
};
CareTeamo2Component.prototype.prepModifyModal=function(data){var self=this;
return function(){switch(data.MEMBER_TYPE){case"PROVIDER_RELATION":self.modifyProviderInfo.call(self,data);
break;
case"NONPROVIDER_LIFETIME_RELATION":self.modifyNonProviderInfo.call(self,data);
break;
case"CARE_TEAM":self.modifyCareTeamInfo.call(self,data);
break;
}};
};
CareTeamo2Component.prototype.bindFormEvents=function(modalId){var phoneTypeChange=function(){var $phoneTypeSelects=$(modalId).find(".cto2-phone-type");
$phoneTypeSelects.find("option").prop("disabled",false).css("display","");
$phoneTypeSelects.each(function(){var value=$(this).val();
if(value!==""){var title=$(this).find("[value="+value+"]").attr("title");
$(this).attr("title",title);
$phoneTypeSelects.not($(this)).find("[value="+value+"]").prop("disabled",true).css("display","none");
}});
};
$(modalId).on("change",".cto2-phone-type",phoneTypeChange);
$(modalId).on("click",".cto2-form-roles li",function(event){var $target=$(event.target);
$target.siblings().removeClass("cto2-selected-list");
$target.addClass("cto2-selected-list");
$(".cto2-form-roles-holder").trigger("cto2-role-selected");
});
phoneTypeChange();
};
CareTeamo2Component.prototype.modifyPersonnelInfo=function(data,roleList,isProvider,isFreetext){var self=this;
var bodyDataFunction=function(){var $element=$(self.getProviderNonProviderFormHTML(roleList,isProvider));
var disableInput=function($inputElement){$inputElement.prop("disabled",true).prop("readonly",true);
};
var prepPhoneInputs=function(phone,elementID){var $phoneTextElement=$element.find(elementID);
var $phoneSelectElement=$element.find(elementID+"InputGroup select");
if(!isFreetext){disableInput($phoneTextElement);
disableInput($phoneSelectElement);
}if(phone){$phoneTextElement.attr("value",phone.PHONE_NUM).attr("data-orig-value",phone.PHONE_NUM);
$phoneSelectElement.attr("data-orig-value",phone.PHONE_TYPE_CD);
$element.find(elementID+"InputGroup :selected").removeAttr("selected");
$element.find(elementID+"InputGroup [value="+phone.PHONE_TYPE_CD+"]").attr("selected","selected");
$phoneTextElement.after('<input type="hidden" id="'+elementID.replace("#","")+'PhoneID" value="'+phone.PHONE_ID+'"/>');
}else{$phoneTextElement.attr("data-orig-value","");
$phoneSelectElement.attr("data-orig-value","");
$phoneTextElement.after('<input type="hidden" id="'+elementID.replace("#","")+'PhoneID" value="0"/>');
}};
var prepNameInputs=function(name,elementID){var $nameElement=$element.find(elementID);
$nameElement.attr("value",name).attr("data-orig-value",name);
if(!isFreetext){disableInput($nameElement);
}};
prepNameInputs(data.NAME_FIRST,"#cto2FirstNameTextbox");
prepNameInputs(data.NAME_MIDDLE,"#cto2MiddleNameTextbox");
prepNameInputs(data.NAME_LAST,"#cto2LastNameTextbox");
$element.find(".cto2-form-roles-holder").attr("data-orig-value",data.RELTN_TYPE_CD);
$element.find(".cto2-form-roles-holder li[data-value="+data.RELTN_TYPE_CD+"]").addClass("cto2-selected-list");
prepPhoneInputs(data.PHONES[0],"#cto2PrimaryPhoneTextbox");
prepPhoneInputs(data.PHONES[1],"#cto2SecPhoneTextbox");
prepPhoneInputs(data.PHONES[2],"#cto2TerPhoneTextbox");
this.setBodyHTML($element.html());
self.bindFormEvents("#vwpModalDialogcareTeamModifyModal");
};
this.showModifyModal(bodyDataFunction,data);
};
CareTeamo2Component.prototype.modifyProviderInfo=function(data){var isProvider=true;
var isFreetext=(data.FREETEXT_IND===1);
this.modifyPersonnelInfo(data,this.m_providerRoleCodes,isProvider,isFreetext);
};
CareTeamo2Component.prototype.modifyNonProviderInfo=function(data){var isProvider=false;
var isFreetext=true;
this.modifyPersonnelInfo(data,this.m_nonProviderRoleCodes,isProvider,isFreetext);
};
CareTeamo2Component.prototype.modifyCareTeamInfo=function(data){var isProvider=true;
var isFreetext=false;
this.modifyPersonnelInfo(data,this.m_providerRoleCodes,isProvider,isFreetext);
};
CareTeamo2Component.prototype.prepareForRenderPane=function(data,teamMembers){var self=this;
var getContactPhones=function(){if(paneDataObj.showContactPhones>0){return["<div id='cto2"+self.getComponentId()+"contactPhones' class='cto2-rp-contact-phones'>",paneDataObj.contactPhones,"</div>"].join("");
}else{return"";
}};
var sidePanelContentScrollContainer="";
var paneHtml="";
var mainPaneObj=$("#sidePanelBodyContents"+this.getComponentId());
var paneDataObj=null;
this.m_tableContainer.addClass("cto2-sp-hide-mode");
paneDataObj={rowCareTeamId:data.PCT_CARE_TEAM_ID,contactDisplay:"",showContactPhones:0,contactPhones:"",contactMedService:"",showProviderTeam:0,providerTeam:"--",memberListLabel:"",memberList:""};
this.prepareTopPane(data,paneDataObj);
if(teamMembers){this.prepareBottomPane(data,paneDataObj,teamMembers);
}paneHtml=this.buildPaneHtml(paneDataObj);
var sidePanelHeaderHtml=["<div class='cto2-rp-contact-group'>","<div class='cto2-rp-contact-left'>","<div id='cto2"+this.getComponentId()+"contactDisplay' class='cto2-rp-contact-display'>",paneDataObj.contactDisplay,"</div>",getContactPhones(),"</div>","<div class='cto2-rp-contact-right'>","<div id='cto2"+this.getComponentId()+"contactMedSvc' class='cto2-rp-contact-med-svc secondary-text'>",paneDataObj.contactMedService,"</div>","</div>","</div>"].join("");
if(!this.m_showPanel){this.m_tableContainer.addClass("cto2-side-panel-addition");
this.m_sidePanelContainer.css("display","inline-block");
this.m_showPanel=true;
this.m_sidePanel.showPanel();
}$("#sidePanelHeaderText"+this.getComponentId()).html(sidePanelHeaderHtml).removeClass("hidden");
if($("#sidePanelScrollContainer"+this.getComponentId()).length===0){sidePanelContentScrollContainer="<div id='sidePanelScrollContainer"+this.getComponentId()+"' class='sp-body-content-area'></div>";
mainPaneObj.wrap(sidePanelContentScrollContainer);
}this.m_sidePanel.setContents(paneHtml,this.getComponentId()+"mainContainer");
this.addTeamClickEvents();
};
CareTeamo2Component.prototype.prepareTopPane=function(data,paneDataObj){if(data.PRSNL_ID){var phoneLen=data.PHONES.length;
paneDataObj.contactDisplay="<span>"+data.PRSNL_NAME+"</span>";
paneDataObj.contactMedService="<span>"+data.PCT_MED_SERVICE_DISPLAY+"</span>";
if(phoneLen){var phoneNums="";
for(var i=0;
i<phoneLen;
i++){phoneNums+=["<div class='cto2-rp-contact-phone secondary-text'>",data.PHONES[i].PHONE_NUM+" ("+data.PHONES[i].PHONE_TYPE+")","</div>"].join("");
}paneDataObj.contactPhones=phoneNums;
paneDataObj.showContactPhones=1;
}if(data.PCT_TEAM_CD){paneDataObj.providerTeam="<span>"+data.PCT_TEAM_DISPLAY+"</span>";
}paneDataObj.showProviderTeam=(data.MEMBER_TYPE=="SHIFT_ASSIGNMENTS"||data.MEMBER_TYPE=="LIFETIME_RELATIONSHIP")?0:1;
}else{if(data.PCT_TEAM_CD){paneDataObj.contactDisplay="<span>"+data.PCT_TEAM_DISPLAY+"</span>";
paneDataObj.contactMedService="<span>"+data.PCT_MED_SERVICE_DISPLAY+"</span>";
}else{paneDataObj.contactDisplay="<span>"+data.PCT_MED_SERVICE_DISPLAY+"</span>";
}}};
CareTeamo2Component.prototype.prepareBottomPane=function(data,paneDataObj,teamMembers){var ctI18n=i18n.discernabu.careteam_o2;
var memberListing="";
var codesArray=MP_Util.LoadCodeListJSON(teamMembers.CODES);
var personName="";
var personPhone="";
var memberId=0;
var prsnlArr=MP_Util.LoadPersonelListJSON(teamMembers.PRSNL);
var phoneArr=MP_Util.LoadPhoneListJSON(teamMembers.PHONE_LIST);
var phoneObj=null;
var showTeamPanel=(data.PRSNL_ID&&data.PCT_TEAM_CD)||data.PCT_TEAM_CD;
var prsnlArrLen=prsnlArr.length;
for(var m=0;
m<prsnlArrLen;
m++){phoneObj=MP_Util.GetValueFromArray(prsnlArr[m].name,phoneArr);
prsnlArr[m].value.phone=phoneObj.phones.length?phoneObj.phones[0].phoneNum:"--";
}if(showTeamPanel){prsnlArr.sort(function(a,b){if(a.value.fullName.toUpperCase()>b.value.fullName.toUpperCase()){return 1;
}if(a.value.fullName.toUpperCase()<b.value.fullName.toUpperCase()){return -1;
}return 0;
});
var prsnlLength=prsnlArr.length;
for(var j=0;
j<prsnlLength;
j++){memberId=prsnlArr[j].name;
if(data.PRSNL_ID===memberId){continue;
}personName=MP_Util.GetValueFromArray(memberId,prsnlArr).fullName;
personPhone=MP_Util.GetValueFromArray(memberId,prsnlArr).phone;
memberListing+="<dl class='cto2-member-listing'><dt>Name</dt><dd>"+personName+"</dd><dt>Phone</dt><dd class='secondary-text'>"+personPhone+"</dd></dl>";
}if(memberListing){paneDataObj.memberListLabel="<span class='secondary-text'>"+ctI18n.TEAM_MEMBERS+"</span>";
}}else{var teamCnt=teamMembers.PCT_TEAMS.length;
var teamCd=0;
var teamDisplay="";
var teamPrsnlCnt=0;
var teamFacilityCd=0;
for(var k=0;
k<teamCnt;
k++){teamCd=teamMembers.PCT_TEAMS[k].PCT_TEAM_CD;
teamPrsnlCnt=teamMembers.PCT_TEAMS[k].PRSNL.length;
teamFacilityCd=teamMembers.PCT_TEAMS[k].FACILITY_CD;
if(teamCd&&(teamFacilityCd===data.FACILITY_CD)){teamDisplay=MP_Util.GetValueFromArray(teamCd,codesArray).display;
memberListing+="<div class='cto2-member-group closed'><h3 class='cto2-team-header'><span class='cto2-team-display secondary-text'>"+teamDisplay+"</span><span class='cto2-team-toggle'>&nbsp;</span></h3>";
}for(var x=0;
x<teamPrsnlCnt;
x++){memberId=teamMembers.PCT_TEAMS[k].PRSNL[x].PRSNL_ID;
teamMembers.PCT_TEAMS[k].PRSNL[x].FULL_NAME=MP_Util.GetValueFromArray(memberId,prsnlArr).fullName;
teamMembers.PCT_TEAMS[k].PRSNL[x].PHONE=MP_Util.GetValueFromArray(memberId,prsnlArr).phone;
}teamMembers.PCT_TEAMS[k].PRSNL.sort(function(a,b){if(a.FULL_NAME.toUpperCase()>b.FULL_NAME.toUpperCase()){return 1;
}if(a.FULL_NAME.toUpperCase()<b.FULL_NAME.toUpperCase()){return -1;
}return 0;
});
for(var y=0;
y<teamPrsnlCnt;
y++){memberId=teamMembers.PCT_TEAMS[k].PRSNL[y].PRSNL_ID;
if(data.PRSNL_ID===memberId){continue;
}if(teamFacilityCd===data.FACILITY_CD){memberListing+="<dl class='cto2-member-listing'><dt>Name</dt><dd class='cto2-member-name'>"+teamMembers.PCT_TEAMS[k].PRSNL[y].FULL_NAME+"</dd><dt>Phone</dt><dd class='secondary-text'>"+teamMembers.PCT_TEAMS[k].PRSNL[y].PHONE+"</dd></dl>";
}}if(teamCd&&(teamFacilityCd===data.FACILITY_CD)){memberListing+="</div>";
}}if(memberListing){paneDataObj.memberListLabel="<span class='secondary-text'>"+ctI18n.MEDICAL_SERVICE_MEMBERS+"</span>";
}}paneDataObj.memberList=memberListing;
};
CareTeamo2Component.prototype.addTeamClickEvents=function(){var self=this;
var compID=this.getComponentId();
$("#cto2"+compID+"memberList").on("click",".cto2-member-group",function(){$(this).toggleClass("closed");
self.m_sidePanel.expandSidePanel();
});
};
CareTeamo2Component.prototype.getRowId=function(rowObj){var rowId="";
var identifiers=$(rowObj).attr("id").split(":");
if(identifiers.length>0){rowId=identifiers[2];
}return rowId;
};
CareTeamo2Component.prototype.addCellClickExtension=function(){var component=this;
var cellClickExtension=new TableCellClickCallbackExtension();
cellClickExtension.setCellClickCallback(function(event,data){component.onRowClick(event,data);
});
this.m_careTeamTable.addExtension(cellClickExtension);
};
CareTeamo2Component.prototype.onRowClick=function(event,data){var selRow=$(event.target).parents("dl.result-info");
this.m_rowWasClicked=true;
if(!selRow.length||data.RESULT_DATA===null){return;
}this.getTeamMembers(selRow,data.RESULT_DATA);
};
CareTeamo2Component.prototype.getTeamMembers=function(selRow,rowData){var self=this;
var criterion=this.getCriterion();
var isInitialLoad=!this.m_rowWasClicked;
var cachedData=MP_Util.GetValueFromArray(rowData.PCT_CARE_TEAM_ID,this.m_cachedRowData);
var sendAr=[];
if(cachedData||!rowData.PCT_CARE_TEAM_ID||rowData.ASSIGN_TYPE){this.updateInfo(selRow,rowData,isInitialLoad,cachedData);
return;
}$("#sidePanelBodyContents"+this.getComponentId()).html("<div class='cto2-loading-spinner'>&nbsp;</div>");
$("#sidePanelHeaderText"+this.getComponentId()).addClass("hidden");
$("#cornerCloseButton"+this.getComponentId()).addClass("hidden");
$("#cto2"+this.getComponentId()+"rpBtnHolder").addClass("hidden");
if((rowData.PRSNL_ID&&rowData.PCT_TEAM_CD)||rowData.PCT_TEAM_CD){sendAr.push("^MINE^",criterion.logical_domain_id,cclNumber(rowData.PCT_MED_SERVICE_CD),cclNumber(rowData.PCT_TEAM_CD),0,0,1,rowData.FACILITY_CD+".0");
}else{sendAr.push("^MINE^",criterion.logical_domain_id,cclNumber(rowData.PCT_MED_SERVICE_CD),-1,0,0,1,rowData.FACILITY_CD+".0");
}var request=new MP_Core.ScriptRequest(self,"");
request.setProgramName("MP_GET_PCT_CARE_TEAM_CONFIG");
request.setParameters(sendAr);
request.setAsync(true);
MP_Core.XMLCCLRequestCallBack(null,request,function(reply){var status=reply.getStatus();
if(status==="S"){var response=reply.getResponse();
self.m_cachedRowData.push({name:rowData.PCT_CARE_TEAM_ID,value:response});
self.updateInfo(selRow,rowData,isInitialLoad,response);
}else{if(status==="F"){self.finalizeComponent(MP_Util.HandleErrorResponse(self.getStyles().getNameSpace(),reply.getError()),"");
}else{if(status==="Z"){self.m_cachedRowData.push({name:rowData.PCT_CARE_TEAM_ID,value:null});
self.updateInfo(selRow,rowData,isInitialLoad,null);
}}}});
};
CareTeamo2Component.prototype.removeLifetimeReltns=function(){var criterion=this.getCriterion();
var personId=criterion.person_id;
var encntrId=criterion.encntr_id;
var str="PPR Summary";
this.tabName=[str];
try{var pprLink="/PERSONID="+personId+" /ENCNTRID="+encntrId+" /FIRSTTAB=^"+this.tabName+"^";
APPLINK(0,criterion.executable,pprLink);
}catch(err){MP_Util.LogJSError(err,this,"care-team-o2.js","removeLifetimeReltns");
throw (err);
}};
CareTeamo2Component.prototype.processResultsForRender=function(results){var resultLength=results.length;
var careTeamResult=null;
var ctI18n=i18n.discernabu.careteam_o2;
for(var i=0;
i<resultLength;
i++){careTeamResult=results[i];
var contactIconSpan="<span class='cto2-contact-icon'>&nbsp;</span>";
if(careTeamResult.PRSNL_ID){careTeamResult.CONTACT_DISPLAY=("<span class='cto2-contact-provider'>"+contactIconSpan+careTeamResult.PRSNL_NAME+"</span>");
}else{if(careTeamResult.PCT_TEAM_DISPLAY){careTeamResult.CONTACT_DISPLAY=("<span class='cto2-contact-team'>"+contactIconSpan+careTeamResult.PCT_TEAM_DISPLAY+"</span>");
}else{careTeamResult.CONTACT_DISPLAY=("<span class='cto2-contact-medserv'>"+contactIconSpan+careTeamResult.PCT_MED_SERVICE_DISPLAY+"</span>");
}}careTeamResult.PHONE_DISPLAY=careTeamResult.PHONES.length?careTeamResult.PHONES[0].PHONE_NUM:"--";
if(!careTeamResult.hasOwnProperty("PCT_MED_SERVICE_DISPLAY")){careTeamResult.PCT_MED_SERVICE_DISPLAY="--";
}if(!careTeamResult.hasOwnProperty("PCT_TEAM_DISPLAY")){careTeamResult.PCT_TEAM_DISPLAY="--";
}if(careTeamResult.PRSNL_ID){if(careTeamResult.RELTN_TYPE){careTeamResult.RELTN_TYPE_DISPLAY=careTeamResult.RELTN_TYPE;
}else{if(careTeamResult.ASSIGN_TYPE){careTeamResult.RELTN_TYPE_DISPLAY=careTeamResult.ASSIGN_TYPE;
}else{careTeamResult.RELTN_TYPE_DISPLAY="--";
}}}else{if(careTeamResult.PCT_TEAM_CD){if(careTeamResult.FACILITY_CD){careTeamResult.RELTN_TYPE_DISPLAY=careTeamResult.PCT_MED_SERVICE_DISPLAY+"|"+careTeamResult.PCT_TEAM_DISPLAY;
}else{careTeamResult.RELTN_TYPE_DISPLAY=careTeamResult.PCT_MED_SERVICE_DISPLAY+"|"+careTeamResult.PCT_TEAM_DISPLAY+("<span class='cto2-all-facility-label secondary-text'> ("+ctI18n.ALL_FACILITIES+")</span>");
}}else{if(careTeamResult.FACILITY_CD){careTeamResult.RELTN_TYPE_DISPLAY=careTeamResult.PCT_MED_SERVICE_DISPLAY;
}else{careTeamResult.RELTN_TYPE_DISPLAY=careTeamResult.PCT_MED_SERVICE_DISPLAY+("<span class='cto2-all-facility-label secondary-text'> ("+ctI18n.ALL_FACILITIES+")</span>");
}}}if(careTeamResult.PCT_TEAM_CD==0){careTeamResult.PCT_TEAM_DISPLAY="--";
}if(careTeamResult.PCT_CARE_TEAM_ID){this.assignedCareTeams.push(careTeamResult.PCT_CARE_TEAM_ID);
}if(careTeamResult.MEMBER_TYPE==="CARE_TEAM"&&!careTeamResult.FACILITY_CD){careTeamResult.PCT_MED_SERVICE_DISPLAY=careTeamResult.PCT_MED_SERVICE_DISPLAY+("<span class='cto2-all-facility-label secondary-text'> ("+ctI18n.ALL_FACILITIES+")</span>");
}}};
CareTeamo2Component.prototype.renderComponent=function(reply){var compId=this.getComponentId();
var ctI18n=i18n.discernabu.careteam_o2;
var self=this;
var thisVisitGroup=null;
var crossVisitGroup=null;
var nonprovidersGroup=null;
try{this.m_renderTimer=MP_Util.CreateTimer(this.getComponentRenderTimerName());
this.setPlusAddCustomInd(true);
if(this.isPlusAddEnabled()&&this.isAuthorized){if(!CERN_Platform.inMillenniumContext()){this.placePlusAddIcon();
this.m_plusAddIconEle=$("#"+this.getStyles().getId()+"Add");
}else{this.m_plusAddIconEle=$("#"+this.getStyles().getNameSpace()+compId).find(".add-plus");
}this.m_plusAddIconEle.addClass("enabled");
this.createPlusAddControl();
}var thisVisit=reply.CARE_TEAMS.concat(reply.SHIFT_ASSIGNMENTS);
var crossVisit=reply.LIFETIME_RELTN.concat(reply.PROVIDER_RELTN);
var nonProviders=reply.NONPROVIDER_LIFETIME_RELTN;
this.m_primaryContactEventId=reply.PRIMARY_CONTACT.EVENT_ID;
this.m_primaryContactEventCd=reply.PRIMARY_CONTACT.EVENT_CD;
if(thisVisit){this.processResultsForRender(thisVisit);
}if(crossVisit){this.processResultsForRender(crossVisit);
}if(nonProviders){this.processResultsForRender(nonProviders);
}this.m_careTeamTable=new ComponentTable();
this.m_careTeamTable.setNamespace(this.getStyles().getNameSpace()+compId);
var roleColumn=new TableColumn();
roleColumn.setColumnId("RELATIONSHIP");
roleColumn.setCustomClass("cto2-relationship-col");
roleColumn.setColumnDisplay(ctI18n.RELATIONSHIP);
roleColumn.setRenderTemplate("${ RELTN_TYPE_DISPLAY }");
var contactColumn=new TableColumn();
contactColumn.setColumnId("CONTACT");
contactColumn.setCustomClass("cto2-contact-col");
contactColumn.setColumnDisplay(ctI18n.CONTACT);
contactColumn.setPrimarySortField("CONTACT_DISPLAY");
contactColumn.setIsSortable(true);
contactColumn.setRenderTemplate("${ CONTACT_DISPLAY }");
var phoneColumn=new TableColumn();
phoneColumn.setColumnId("PHONE");
phoneColumn.setCustomClass("cto2-phone-col");
phoneColumn.setColumnDisplay(ctI18n.PHONE);
phoneColumn.setRenderTemplate("${ PHONE_DISPLAY }");
var serviceColumn=new TableColumn();
serviceColumn.setColumnId("SERVICE");
serviceColumn.setColumnDisplay(ctI18n.SERVICE);
serviceColumn.setCustomClass("cto2-sp-hide-col");
serviceColumn.setRenderTemplate("${ PCT_MED_SERVICE_DISPLAY }");
var teamColumn=new TableColumn();
teamColumn.setColumnId("TEAM");
teamColumn.setColumnDisplay(ctI18n.TEAM);
teamColumn.setCustomClass("cto2-sp-hide-col");
teamColumn.setRenderTemplate("${ PCT_TEAM_DISPLAY }");
this.m_careTeamTable.addColumn(roleColumn);
this.m_careTeamTable.addColumn(contactColumn);
this.m_careTeamTable.addColumn(phoneColumn);
this.m_careTeamTable.addColumn(serviceColumn);
this.m_careTeamTable.addColumn(teamColumn);
if(thisVisit&&thisVisit.length){thisVisitGroup=new TableGroup().setDisplay(ctI18n.VISIT).setGroupId(compId+"CARETEAMANDSHIFTASSN").bindData(thisVisit).setCanCollapse(false);
this.m_careTeamTable.addGroup(thisVisitGroup);
}if(crossVisit&&crossVisit.length){crossVisitGroup=new TableGroup().setDisplay(ctI18n.CROSS_VISITS).setGroupId(compId+"PROVIDERS").setCanCollapse(false).bindData(crossVisit);
this.m_careTeamTable.addGroup(crossVisitGroup);
}if(nonProviders&&nonProviders.length){nonprovidersGroup=new TableGroup().setDisplay(ctI18n.NON_PROVIDER).setGroupId(compId+"NONPROVIDER").setCanCollapse(false).bindData(nonProviders);
this.m_careTeamTable.addGroup(nonprovidersGroup);
}this.addCellClickExtension();
this.setComponentTable(this.m_careTeamTable);
this.finalizeComponent(['<div id="'+compId+'mainContainer" class="cto2-main-container">','<div id="'+compId+'tableView" class="cto2-table">',this.m_careTeamTable.render(),"</div>","</div>"].join(""));
this.checkPrimaryContact(reply,thisVisit);
this.addReadPane(1);
var $previewPane=$("#pp_"+compId+"_cto2");
$previewPane.css("width","100%");
this.resizeComponent();
this.attachListeners();
this.m_careTeamTable.toggleColumnSort=function(columnId){ComponentTable.prototype.toggleColumnSort.call(this,columnId);
self.checkPrimaryContact(reply);
};
}catch(err){if(this.m_renderTimer){this.m_renderTimer.Abort();
this.m_renderTimer=null;
}MP_Util.LogJSError(err,self,"care-team-o2.js","renderComponent");
throw (err);
}finally{if(this.m_renderTimer){this.m_renderTimer.Stop();
}}};
CareTeamo2Component.prototype.attachListeners=function(){var self=this;
var compID=this.getComponentId();
var expClpsIconObj=$("#"+compID+"rpExpandCollapseIcon");
var expClpsBarObj=$("#"+compID+"rpExpandCollapse");
var scrollCont=null;
var cto2Content=$("#cto2Content"+compID);
var ppId="#pp_"+compID+"_cto2";
cto2Content.on("mouseenter",ppId,function(){scrollCont=$("#"+compID+"rpScrollContainer");
if(!expClpsBarObj.hasClass("hidden")){return;
}if((this.scrollHeight>this.offsetHeight)||scrollCont.hasClass("cto2-on-expand")){expClpsIconObj.addClass("cto2-expand");
expClpsIconObj.removeClass("cto2-collapse");
expClpsBarObj.removeClass("hidden");
}});
cto2Content.on("mouseleave",ppId,function(){if(expClpsIconObj.hasClass("cto2-expand")){expClpsBarObj.addClass("hidden");
}});
expClpsIconObj.click(function(){self.onExpandCollapsePane();
});
};
CareTeamo2Component.prototype.onExpandCollapsePane=function(){var compID=this.getComponentId();
var ppObject=$("#pp_"+compID+"_cto2");
var tableViewObj=$("#"+compID+"tableView");
var self=this;
if(!ppObject.length){return;
}var scrollContainer=$("#"+compID+"rpScrollContainer");
var contentObj=$("#cto2"+compID+"rpContent");
var expClpsIconObj=$("#"+compID+"rpExpandCollapseIcon");
var readPane=$("#"+compID+"readPane");
if(expClpsIconObj.hasClass("cto2-expand")){readPane.css({position:"absolute"});
ppObject.addClass("cto2-focusin");
var windowPadding=70;
var maxViewHeight=$("#vwpBody").height()-windowPadding;
var contentHeight=contentObj[0].offsetHeight;
var titleHeight=contentHeight-scrollContainer.height();
ppObject.css("max-height",maxViewHeight+"px");
ppObject.css({"min-height":Math.max(tableViewObj.height(),self.m_previewPaneMinHeight)+"px"});
ppObject.css("height","auto");
var scrollMaxHeight=ppObject.height()-titleHeight;
scrollContainer.css("max-height",(++scrollMaxHeight)+"px");
if(scrollMaxHeight==scrollContainer.height()){scrollContainer.addClass("cto2-on-expand");
scrollContainer.css("margin-right",-7+"px");
}expClpsIconObj.addClass("cto2-collapse");
expClpsIconObj.removeClass("cto2-expand");
}else{this.collapsePane();
readPane.css({position:"relative"});
}};
CareTeamo2Component.prototype.enableScrollBar=function(){var compID=this.getComponentId();
var scrollContainer=$("#"+compID+"rpScrollContainer");
var contentObj=$("#cto2"+compID+"rpContent");
var ppObject=$("#pp_"+compID+"_cto2");
var expClpsIconObj=$("#"+compID+"rpExpandCollapseIcon");
var expClpsBarObj=$("#"+compID+"rpExpandCollapse");
if(contentObj.height()>ppObject.height()){expClpsIconObj.addClass("cto2-expand");
expClpsIconObj.removeClass("cto2-collapse");
expClpsBarObj.removeClass("hidden");
}if(!scrollContainer.hasClass("cto2-on-expand")){var contentHeight=contentObj[0].offsetHeight;
var titleHeight=contentHeight-scrollContainer.height();
var scrollMaxHeight=ppObject.height()-titleHeight;
scrollContainer.css("max-height",(++scrollMaxHeight)+"px");
if(scrollMaxHeight==scrollContainer.height()){scrollContainer.addClass("cto2-on-expand");
scrollContainer.css("margin-right",-7+"px");
}}};
CareTeamo2Component.prototype.collapsePane=function(){var compID=this.getComponentId();
var expClpsIconObj=$("#"+compID+"rpExpandCollapseIcon");
var scrollContainer=$("#"+compID+"rpScrollContainer");
if(expClpsIconObj.hasClass("cto2-collapse")){var infoHeight=$("#"+compID+"tableView").height();
var expClpsBarObj=$("#"+compID+"rpExpandCollapse");
var ppObject=$("#pp_"+compID+"_cto2");
ppObject.css("height",Math.max(this.m_previewPaneMinHeight,infoHeight)+"px");
scrollContainer.css("max-height","none");
scrollContainer.removeClass("cto2-on-expand");
scrollContainer.css("margin-right",0+"px");
expClpsIconObj.removeClass("cto2-collapse");
expClpsBarObj.addClass("hidden");
ppObject.removeClass("cto2-focusin");
}};
CareTeamo2Component.prototype.checkPrimaryContact=function(reply){var primaryContactTeamId=0;
var careTeamResult=null;
var rowObj=null;
var contactSpan=null;
var ctI18n=i18n.discernabu.careteam_o2;
var careTeams=reply.CARE_TEAMS;
var primaryContact=reply.PRIMARY_CONTACT;
var primaryContactAssignId=0;
var i=0;
var compID=this.getComponentId();
if(primaryContact.PROVIDER_ID){primaryContactTeamId=primaryContact.PCT_CARE_TEAM_ID;
for(i=0;
i<careTeams.length;
i++){careTeamResult=careTeams[i];
if(careTeamResult.PCT_CARE_TEAM_ID===primaryContactTeamId){this.m_providerRowId="cto2"+compID+":"+compID+"CARETEAMANDSHIFTASSN:row"+i;
rowObj=document.getElementById(this.m_providerRowId+":CONTACT");
contactSpan=$(rowObj).find(".cto2-contact-provider");
$(contactSpan).append("<span class='cto2-primary-label secondary-text'>("+ctI18n.PRIMARY+")</span>");
careTeams[i].IS_PRIMARY=true;
primaryContactAssignId=careTeamResult.DCP_SHIFT_ASSIGN_ID;
}careTeams[i].IPASS_INFO=reply.PRIMARY_CONTACT;
}for(i=0;
i<careTeams.length;
i++){careTeams[i].PRIMARY_ASSIGN_ID=primaryContactAssignId;
}this.movePrimaryToTop();
}else{if(this.m_rowWasClicked){rowObj=document.getElementById(this.m_lastSelectedRow);
this.updateSelRowBgColor(rowObj,false);
}else{rowObj=document.getElementById(this.m_lastSelectedRow);
this.updateSelRowBgColor(rowObj,true);
}}};
CareTeamo2Component.prototype.movePrimaryToTop=function(){var primaryRow=document.getElementById(this.m_providerRowId);
if(primaryRow){var compId=this.getComponentId();
$("#cto2"+compId+"\\:"+compId+"CARETEAMANDSHIFTASSN div").prepend(primaryRow);
this.fixZebraStripes();
}};
CareTeamo2Component.prototype.fixZebraStripes=function(){var compID=this.getComponentId();
var tableBodyArr=$("#cto2"+compID+"\\:"+compID+"CARETEAMANDSHIFTASSN div").children();
for(var i=0;
i<tableBodyArr.length;
i++){tableBodyArr[i].className="result-info "+((i%2===0)?"odd":"even");
}if(this.m_rowWasClicked){var rowObj=document.getElementById(this.m_lastSelectedRow);
this.updateSelRowBgColor(rowObj,false);
}};
CareTeamo2Component.prototype.renderNoCareTeam=function(){var compId=this.getComponentId();
var ctI18n=i18n.discernabu.careteam_o2;
try{var jsHTML="<div id ='"+compId+"mainContainer' class ='cto2-main-container'><div id ='"+compId+"tableView' class ='cto2-empty-table'><span class='cto2-no-results disabled'>"+ctI18n.NO_RESULTS+"</span></div><div id ='"+compId+"readPane' class = 'cto2-read-pane'>&nbsp;</div></div>";
if(this.isPlusAddEnabled()&&this.isAuthorized){if(!CERN_Platform.inMillenniumContext()){this.placePlusAddIcon();
this.m_plusAddIconEle=$("#"+this.getStyles().getId()+"Add");
}else{this.m_plusAddIconEle=$("#"+this.getStyles().getNameSpace()+compId).find(".add-plus");
}this.m_plusAddIconEle.addClass("enabled");
this.createPlusAddControl();
}this.finalizeComponent(jsHTML);
this.addReadPane(0);
}catch(err){MP_Util.LogJSError(err,self,"care-team-o2.js","renderNoCareTeam");
throw (err);
}};
CareTeamo2Component.prototype.renderAddPlusDropDown=function(){var self=this;
var responseJson=self.assignedTeamsJson;
var codesArray=MP_Util.LoadCodeListJSON(responseJson.CODES);
var associatedTeamsInfo=responseJson.PCT_TEAMS;
var teamsLength=responseJson.PCT_TEAMS.length;
var teamObjects=[];
var associatedTeam=null;
var teamName="";
var assignText="";
var allFacilitiesText="";
var ctI18n=i18n.discernabu.careteam_o2;
var assignMyselfCss=teamsLength?"cto2-assign-myself-header":"cto2-assign-myself-header disabled";
teamObjects.push({MED_SERVICE_TEAM:ctI18n.ASSIGN_MYSELF,CSS_CLASS:assignMyselfCss});
for(var i=0;
i<teamsLength;
i++){associatedTeam=associatedTeamsInfo[i];
assignText="";
allFacilitiesText="";
teamName=associatedTeam.PCT_TEAM_CD?(MP_Util.GetValueFromArray(associatedTeam.PCT_TEAM_CD,codesArray).display):"";
associatedTeam.PCT_CARE_TEAM=associatedTeam.ORIG_PCT_TEAM_ID;
associatedTeam.MED_SERVICE_NAME=MP_Util.GetValueFromArray(associatedTeam.PCT_MEDSERV_CD,codesArray).display;
associatedTeam.TEAM_NAME=teamName?("<span class='cto2-provider-medservice-team-separator'>|</span>"+teamName):"";
if($.inArray(associatedTeam.PCT_CARE_TEAM,self.assignedCareTeams)>-1){assignText='<p class="cto2-modal-assigned-text">('+ctI18n.ASSIGNED+")</p>";
associatedTeam.EXISTING_ASSIGNMENT=true;
}else{associatedTeam.EXISTING_ASSIGNMENT=false;
}if(!associatedTeam.FACILITY_CD){allFacilitiesText=" ("+ctI18n.ALL_FACILITIES+")";
}teamObjects.push({MED_SERVICE_TEAM:associatedTeam.MED_SERVICE_NAME+associatedTeam.TEAM_NAME+allFacilitiesText+assignText,PCT_CARE_TEAM:associatedTeam.PCT_CARE_TEAM,CSS_CLASS:"cto2-assign-myself-team",EXISTING_ASSIGNMENT:associatedTeam.EXISTING_ASSIGNMENT,ASSIGN_PCT_CARE_TEAM:true});
}teamObjects.push({MED_SERVICE_TEAM:ctI18n.ASSIGN_NO_PROVIDER_TEAM,CSS_CLASS:"cto2-assign-myself-team",ASSIGN_NO_PROVIDER_TEAM:true});
teamObjects.push({MED_SERVICE_TEAM:ctI18n.ASSIGN_CARE_TEAM,CSS_CLASS:"cto2-assign-myself-footer",ASSIGN_CARE_TEAM:true});
teamObjects.push({MED_SERVICE_TEAM:ctI18n.ASSIGN_OTHER_PROVIDER,CSS_CLASS:"cto2-add-other",ADD_OTHER:true});
teamObjects.push({MED_SERVICE_TEAM:ctI18n.ASSIGN_NON_PROVIDER,CSS_CLASS:"cto2-add-non-provider",ADD_NON_PROVIDER:true});
this.plusAddControl.getList().renderItems(teamObjects);
};
CareTeamo2Component.prototype.openTab=function(){var criterion=this.getCriterion();
var self=this;
var ctI18n=i18n.discernabu.careteam_o2;
var prsnlId=(self.assignType===ctI18n.ASSIGN_MYSELF)?cclNumber(criterion.provider_id):0;
var jsonString=(self.assignType===ctI18n.ASSIGN_MYSELF)?self.assignedTeamsJson:self.careTeamJson;
var slaTimer=null;
try{if(!jsonString){var request=null;
var sendAr=[];
sendAr.push("^MINE^",criterion.logical_domain_id,0,0,prsnlId,0,0,criterion.facility_cd+".0");
request=new MP_Core.ScriptRequest(self,"");
request.setProgramName("MP_GET_PCT_CARE_TEAM_CONFIG");
request.setParameters(sendAr);
request.setAsync(true);
MP_Core.XMLCCLRequestCallBack(null,request,function(reply){if(reply.getStatus()==="S"){if(prsnlId){self.assignedTeamsJson=reply.getResponse();
self.renderAddPlusDropDown();
}else{self.careTeamJson=reply.getResponse();
self.renderCareTeamAssignModal();
}}else{if(reply.getStatus()==="F"){self.finalizeComponent(MP_Util.HandleErrorResponse(self.getStyles().getNameSpace(),reply.getError()),"");
return;
}else{if(reply.getStatus()==="Z"){if(prsnlId){self.assignedTeamsJson=reply.getResponse();
self.renderAddPlusDropDown();
}return;
}}}});
}else{if(prsnlId){self.renderAddPlusDropDown();
}else{self.renderCareTeamAssignModal();
}}}catch(err){if(slaTimer){slaTimer.Abort();
slaTimer=null;
}MP_Util.LogJSError(err,self,"care-team-o2.js","openTab");
throw (err);
}finally{if(slaTimer){slaTimer.Stop();
}}};
CareTeamo2Component.prototype.renderCareTeamAssignModal=function(){this.hideAddDropDownList();
var ctI18n=i18n.discernabu.careteam_o2;
var careTeamJsonReply=this.careTeamJson;
var compId=this.getComponentId();
var providerHtml="";
var providerArray=[];
var teamsHtml="";
var prsnlArray=MP_Util.LoadPersonelListJSON(careTeamJsonReply.PRSNL);
var modalDiv=Util.cep("div",{className:"modal-div"});
var dialog=Util.cep("div",{className:"cto2-modal-dialog"});
var selectedService={};
var selectedTeam={};
var teamsLength=0;
var providersLength=0;
var serviceHtml="";
this.m_selectedTeamId=null;
var providerTemplate=null;
var self=this;
var btnTrue="<button id='careTeam2Assign"+compId+"' class='cto2-modal-button' data-val='1' disabled='disabled'>"+ctI18n.ASSIGN+"</button>";
var btnFalse="<button id='careTeam2Cancel"+compId+"' class='cto2-modal-button' data-val='0'>"+ctI18n.CANCEL+"</button>";
var codesArray=MP_Util.LoadCodeListJSON(careTeamJsonReply.CODES);
var savedTeamsLength=0;
var savedTeamsResponse=self.m_alreadySavedCareTeams.getResponse();
var servicesContainer=null;
var providersContainer=null;
var teamsContainer=null;
var assignBtn=null;
var thisVisitIndicator=true;
var addingPctTeamIndicator=true;
if(self.m_alreadySavedCareTeams.getStatus()==="S"){savedTeamsLength=savedTeamsResponse.CARE_TEAMS.length;
}if(careTeamJsonReply&&careTeamJsonReply.PCT_TEAMS){teamsLength=careTeamJsonReply.PCT_TEAMS.length;
}else{return;
}if(teamsLength){var serviceListItems=null;
for(var i=0;
i<teamsLength;
i++){if(!careTeamJsonReply.PCT_TEAMS[i].PCT_TEAM_CD){serviceListItems=MP_Util.GetValueFromArray(careTeamJsonReply.PCT_TEAMS[i].PCT_MEDSERV_CD,codesArray).display;
serviceHtml+="<li class='cto2-list-item' data-team-id = "+careTeamJsonReply.PCT_TEAMS[i].ORIG_PCT_TEAM_ID+" data-value='"+careTeamJsonReply.PCT_TEAMS[i].PCT_MEDSERV_CD+"' data-facility-cd = "+careTeamJsonReply.PCT_TEAMS[i].FACILITY_CD+">"+serviceListItems+"</li>";
}}}else{return;
}var closeBox=function(){self.providerSearchBar.destroy();
$(".modal-div").remove();
$(".cto2-modal-dialog").remove();
$("html").css("overflow","visible");
};
var assignNewTeams=function(){addingPctTeamIndicator=false;
self.updateRelationshipCodeList(thisVisitIndicator,addingPctTeamIndicator);
closeBox();
};
var cancelAssignNewTeams=function(){closeBox();
};
dialog.innerHTML=["<div id='careTeam2ModalHeader"+compId+"' class='cto2-modal-header'>","<div class='cto2-modal-title'>",ctI18n.CARE_TEAM_ASSIGNMENT,"</div>","<div id='careTeam2CloseModal"+compId+"' class='cto2-modal-close'>","&nbsp;","</div>","</div>","<div id='careTeam2SearchBar"+compId+"' class='cto2-modal-search-bar'>","</div>","<div class='cto2-modal-container'>","<div class='cto2-modal-contents-container'>","<span class='cto2-modal-contents-lbl'>",ctI18n.MEDICAL_SERVICE,"</span>","<ul id='servListContainer"+compId+"' class='cto2-modal-contents-list'>",serviceHtml,"</ul>","</div>","<div class='cto2-modal-contents-container cto2-modal-teams'>","<span class='cto2-modal-contents-lbl'>",ctI18n.TEAM,"</span>","<ul id='careTeamListContainer"+compId+"' class='cto2-modal-contents-list'>","<li class='cto2-default-team-text'>",ctI18n.SELECT_MED_SERVICE,"</li>","</ul>","</div>","<div class='cto2-modal-contents-container cto2-modal-providers'>","<span class='cto2-modal-contents-lbl'>",ctI18n.PROVIDER,"</span>","<ul id='careTeamProviderContainer"+compId+"' class='cto2-modal-contents-list'>","<li class='cto2-default-team-text'>",ctI18n.SELECT_MED_SERVICE_TEAM,"</li>","</ul>","</div>","</div>","<div class='cto2-modal-footer'>","<span class='cto2-modal-button-container'>",btnTrue,"</span>","<span class='cto2-modal-button-container'>",btnFalse,"</span>","</div>"].join("");
$("html").css("overflow","hidden");
$(modalDiv).height($(document).height());
var docBody=document.body;
Util.ac(modalDiv,docBody);
Util.ac(dialog,docBody);
Util.addEvent(_g("careTeam2Assign"+compId),"click",assignNewTeams);
Util.addEvent(_g("careTeam2Cancel"+compId),"click",cancelAssignNewTeams);
Util.addEvent(_g("careTeam2CloseModal"+compId),"click",closeBox);
servicesContainer=$("#servListContainer"+compId);
providersContainer=$("#careTeamProviderContainer"+compId);
teamsContainer=$("#careTeamListContainer"+compId);
assignBtn=$("#careTeam2Assign"+compId);
providerTemplate=new TemplateEngine.TemplateFactory((function(){var template=TemplateEngine;
var div=template.tag("div");
return{providerInfo:function(context){return div({"class":"search-item",id:context._elementId,pct_care_team:context.PCT_CARE_TEAM,med_service_cd:context.PCT_MED_SERVICE_CD,pct_team_cd:context.PCT_TEAM_CD},div({"class":"cto2-provider-name"},context.PCT_PROVIDER_NAME),div({"class":"cto2-med-service-team"},context.MED_SERVICE_TEAM));
}};
})());
var providerSearchBar=new MPageControls.AutoSuggest($("#careTeam2SearchBar"+compId));
providerSearchBar.setDelay(500);
providerSearchBar.setCaption(ctI18n.PROVIDER_SEARCH);
providerSearchBar.activateCaption();
providerSearchBar.setListItemTemplate(providerTemplate.providerInfo);
this.providerSearchBar=providerSearchBar;
providerSearchBar.setOnDelay(function(){var searchText=$("#careTeam2SearchBar"+compId+" :input").val();
searchText=searchText?searchText.replace(/[^a-zA-Z0-9]/g,""):"";
if(searchText){self.retrieveProviders(searchText,providerSearchBar);
}});
providerSearchBar.getList().setOnSelect(function(item){providerSearchBar.activateCaption();
var offset=0;
servicesContainer.find("li").each(function(){if($(this).attr("data-value")==item.MED_SERVICE_CD){$(this).click();
offset=$("#servListContainer"+compId+" li").first().position().top;
servicesContainer.scrollTop($(this).position().top-offset);
}});
teamsContainer.find("li").each(function(){if($(this).attr("data-value")==item.PCT_TEAM_CD){$(this).click();
offset=$("#careTeamListContainer"+compId+" li").first().position().top;
teamsContainer.scrollTop($(this).position().top-offset);
}});
providersContainer.find("li").each(function(){if($(this).attr("data-team-id")==item.PCT_CARE_TEAM){$(this).click();
offset=$("#careTeamProviderContainer"+compId+" li").first().position().top;
providersContainer.scrollTop($(this).position().top-offset);
}});
self.m_selectedTeamId=item.PCT_CARE_TEAM;
if(!($.inArray(self.m_selectedTeamId,self.assignedCareTeams)>-1)){$("#careTeam2Assign"+compId).removeAttr("disabled");
}});
if(careTeamJsonReply.PCT_TEAMS.length){servicesContainer.find("li").each(function(){if(parseFloat($(this).attr("data-facility-cd"))===0){$(this).append("<span class='cto2-all-facility-label secondary-text'>("+ctI18n.ALL_FACILITIES+")</span>");
}});
}if(savedTeamsLength){servicesContainer.find("li").each(function(){for(var j=0;
j<savedTeamsLength;
j++){if($(this).attr("data-team-id")===savedTeamsResponse.CARE_TEAMS[j].PCT_CARE_TEAM_ID){$(this).append($("<p/>",{"class":"cto2-modal-assigned-text",html:"("+ctI18n.ASSIGNED+")"}));
}}});
}var providerSectionHtml=function(providerArrayList,medService){var html="";
providerArrayList.sort(function(a,b){var personnelNameA=MP_Util.GetValueFromArray(a.PRSNL_ID,prsnlArray).fullName.toUpperCase();
var personnelNameB=MP_Util.GetValueFromArray(b.PRSNL_ID,prsnlArray).fullName.toUpperCase();
if(personnelNameA<personnelNameB){return -1;
}if(personnelNameA>personnelNameB){return 1;
}return 0;
});
var arrayLength=providerArrayList.length;
for(var i=0;
i<arrayLength;
i++){html+="<li id='careTeamProvider"+compId+"' class='cto2-list-item' data-value='"+providerArrayList[i].PRSNL_ID+"' data-serv-cd="+medService+" data-team-id = "+providerArrayList[i].PRSNL_ORIG_PCT_CARE_TEAM_ID+">"+MP_Util.GetValueFromArray(providerArrayList[i].PRSNL_ID,prsnlArray).fullName+"</li>";
}return html;
};
servicesContainer.delegate("li","click",function(){selectedService=this;
teamsHtml="";
providerHtml="";
var medServiceCode="";
var selectedServiceFacilityCd=parseFloat(selectedService.getAttribute("data-facility-cd"));
if(providersContainer){providersContainer.html("");
}servicesContainer.find("li").removeClass("primary-select secondary-select");
servicesContainer.find("p").removeClass("cto2-modal-assigned-text-selected");
assignBtn.removeAttr("disabled");
if($(selectedService).find("p").length){$(this).find("p").addClass("cto2-modal-assigned-text-selected");
assignBtn.attr("disabled","disabled");
}$(selectedService).addClass("primary-select");
$(".cto2-default-team-text").remove();
if(teamsContainer){teamsContainer.html("");
}providerArray=[];
for(var j=0;
j<teamsLength;
j++){if(careTeamJsonReply.PCT_TEAMS[j].PCT_TEAM_CD&&(careTeamJsonReply.PCT_TEAMS[j].PCT_MEDSERV_CD==selectedService.getAttribute("data-value"))&&(careTeamJsonReply.PCT_TEAMS[j].FACILITY_CD===selectedServiceFacilityCd)){var teamListItems=MP_Util.GetValueFromArray(careTeamJsonReply.PCT_TEAMS[j].PCT_TEAM_CD,codesArray).display;
teamsHtml+="<li id='careTeamList"+compId+"' class='cto2-list-item' data-value='"+careTeamJsonReply.PCT_TEAMS[j].PCT_TEAM_CD+"' data-serv-cd="+careTeamJsonReply.PCT_TEAMS[j].PCT_MEDSERV_CD+" data-team-id = "+careTeamJsonReply.PCT_TEAMS[j].ORIG_PCT_TEAM_ID+" data-facility-cd = "+careTeamJsonReply.PCT_TEAMS[j].FACILITY_CD+">"+teamListItems+"</li>";
}else{if((careTeamJsonReply.PCT_TEAMS[j].PCT_MEDSERV_CD==selectedService.getAttribute("data-value"))&&(careTeamJsonReply.PCT_TEAMS[j].FACILITY_CD===selectedServiceFacilityCd)&&careTeamJsonReply.PCT_TEAMS[j].PRSNL.length){medServiceCode=careTeamJsonReply.PCT_TEAMS[j].PCT_MEDSERV_CD;
providersLength=careTeamJsonReply.PCT_TEAMS[j].PRSNL.length;
for(var k=0;
k<providersLength;
k++){providerArray.push(careTeamJsonReply.PCT_TEAMS[j].PRSNL[k]);
}}}}if(providerArray){providerHtml=providerSectionHtml(providerArray,medServiceCode);
providersContainer.html(providerHtml);
}if(teamsHtml){teamsContainer.html(teamsHtml);
}if(savedTeamsLength){teamsContainer.find("li").each(function(){for(var j=0;
j<savedTeamsLength;
j++){if($(this).attr("data-team-id")==savedTeamsResponse.CARE_TEAMS[j].PCT_CARE_TEAM_ID){$(this).append($("<p/>",{"class":"cto2-modal-assigned-text",html:"("+ctI18n.ASSIGNED+")"}));
}}});
providersContainer.find("li").each(function(){for(var j=0;
j<savedTeamsLength;
j++){if($(this).attr("data-team-id")==savedTeamsResponse.CARE_TEAMS[j].PCT_CARE_TEAM_ID){$(this).append($("<p/>",{"class":"cto2-modal-assigned-text",html:"("+ctI18n.ASSIGNED+")"}));
}}});
}self.m_selectedTeamId=$(selectedService).attr("data-team-id");
});
teamsContainer.delegate("li","click",function(){var medServiceCode="";
selectedTeam=this;
providerHtml="";
self.m_selectedTeamId=$(this).attr("data-team-id");
if(!self.m_selectedTeamId){assignBtn.attr("disabled","disabled");
return;
}if(providersContainer){providersContainer.html("");
}teamsContainer.find("li").removeClass("primary-select");
teamsContainer.find("li").removeClass("secondary-select");
teamsContainer.find("p").removeClass("cto2-modal-assigned-text-selected");
$(this).addClass("primary-select");
assignBtn.removeAttr("disabled");
if($(this).find("p").length){$(this).find("p").addClass("cto2-modal-assigned-text-selected");
assignBtn.prop("disabled",true);
}$(selectedService).removeClass("primary-select");
$(selectedService).addClass("secondary-select");
var selectedServiceFacilityCd=parseFloat(selectedService.getAttribute("data-facility-cd"));
providerArray=[];
for(var j=0;
j<teamsLength;
j++){var careTeamResult=careTeamJsonReply.PCT_TEAMS[j];
if(careTeamResult.PRSNL.length&&(careTeamResult.FACILITY_CD===selectedServiceFacilityCd)&&(careTeamResult.PCT_TEAM_CD==selectedTeam.getAttribute("data-value"))&&(careTeamResult.PCT_MEDSERV_CD==selectedTeam.getAttribute("data-serv-cd"))){providersLength=careTeamResult.PRSNL.length;
medServiceCode=careTeamResult.PCT_MEDSERV_CD;
var alreadyContainsProvider=function(personnelId){var providerArrayLength=providerArray.length;
for(var i=0;
i<providerArrayLength;
i++){if(providerArray[i].PRSNL_ID===personnelId){return true;
}}return false;
};
for(var k=0;
k<careTeamResult.PRSNL.length;
k++){if(!alreadyContainsProvider(careTeamResult.PRSNL[k].PRSNL_ID)){providerArray.push(careTeamJsonReply.PCT_TEAMS[j].PRSNL[k]);
}}}}if(providerArray){providerHtml=providerSectionHtml(providerArray,medServiceCode);
providersContainer.html(providerHtml);
}if(savedTeamsLength){providersContainer.find("li").each(function(){for(var j=0;
j<savedTeamsLength;
j++){if($(this).attr("data-team-id")==savedTeamsResponse.CARE_TEAMS[j].PCT_CARE_TEAM_ID){$(this).append($("<p/>",{"class":"cto2-modal-assigned-text",html:"("+ctI18n.ASSIGNED+")"}));
}}});
}});
providersContainer.delegate("li","click",function(){self.m_selectedTeamId=$(this).attr("data-team-id");
if(!self.m_selectedTeamId){assignBtn.attr("disabled","disabled");
return;
}providersContainer.find("li").removeClass("primary-select");
providersContainer.find("p").removeClass("cto2-modal-assigned-text-selected");
$(this).addClass("primary-select");
assignBtn.removeAttr("disabled");
if($(this).find("p").length){$(this).find("p").addClass("cto2-modal-assigned-text-selected");
assignBtn.attr("disabled","disabled");
}$(selectedTeam).removeClass("primary-select");
$(selectedTeam).addClass("secondary-select");
$(selectedService).removeClass("primary-select");
$(selectedService).addClass("secondary-select");
});
};
CareTeamo2Component.prototype.retrieveProviders=function(searchText,providerSearchBar){var errMsg=[];
var criterion=this.getCriterion();
var self=this;
var params={Output:"^MINE^","Search String":"^"+searchText+"^","Max Result Count":10,"Logical Domain Id":criterion.logical_domain_id,"Facility Code":criterion.facility_cd+".0"};
try{ccl("mp_search_pct_care_provider",params,"",function(reply){if(reply.getStatus()==="Z"||reply.getStatus()==="S"){self.renderProviders(reply.getResponse(),providerSearchBar);
}else{if(reply.getStatus()==="F"){self.finalizeComponent(MP_Util.HandleErrorResponse(self.getStyles().getNameSpace(),reply.getError()),"");
return;
}}});
}catch(err){errMsg.push(err.message);
self.finalizeComponent(MP_Util.HandleErrorResponse(self.getStyles().getNameSpace(),errMsg.join("<br />")),"");
}};
CareTeamo2Component.prototype.renderProviders=function(providersList,providerSearchBar){var codesArray=MP_Util.LoadCodeListJSON(providersList.CODES);
var ctI18n=i18n.discernabu.careteam_o2;
var providerInfo=providersList.PROVIDER_INFO;
var providerObjects=[];
var providers=null;
var providerLength=providerInfo.length;
var teamName="";
for(var i=0;
i<providerLength;
i++){teamName=providerInfo[i].PCT_TEAM_CD?(MP_Util.GetValueFromArray(providerInfo[i].PCT_TEAM_CD,codesArray).display):"";
providers=providerInfo[i];
providers.PCT_CARE_TEAM=providerInfo[i].PCT_CARE_TEAM_ID;
providers.MED_SERVICE_NAME=MP_Util.GetValueFromArray(providerInfo[i].PCT_MED_SERVICE_CD,codesArray).display;
providers.TEAM_NAME=teamName?("<span class='cto2-provider-medservice-team-separator'>|</span>"+teamName):"";
if(!providers.PCT_FACILITY_CD){providers.TEAM_NAME=providers.TEAM_NAME+" ("+ctI18n.ALL_FACILITIES+") ";
}providerObjects.push({PCT_PROVIDER_NAME:providers.PCT_PROVIDER_NAME,MED_SERVICE_TEAM:providers.MED_SERVICE_NAME+providers.TEAM_NAME,PCT_CARE_TEAM:providers.PCT_CARE_TEAM,MED_SERVICE_CD:providers.PCT_MED_SERVICE_CD,PCT_TEAM_CD:providers.PCT_TEAM_CD});
}providerSearchBar.setSuggestions(providerObjects);
};
CareTeamo2Component.prototype.updateCareTeam=function(assignId,relationCode,addingPctTeamIndicator){this.getElementById("_medical_service").html("<div class='loading-spinner'>&nbsp;</div>");
var request=null;
var self=this;
var criterion=this.getCriterion();
var userId=parseInt(criterion.provider_id,10);
var providerId=parseInt($("#careTeamProviderContainer"+this.getComponentId()).find(".primary-select").attr("data-value"),10);
var assignPatJson='{"PATIENTS":{"QUAL":[{"PERSON_ID":'+criterion.person_id+'.0,"ENCNTR_ID":'+criterion.encntr_id+'.0,"ASSIGNMENT_ID": '+assignId+'.0,"ORIG_PCT_TEAM_ID":'+this.m_selectedTeamId+'.0,"ACTIVE_IND": 1,"BEGIN_EFFECTIVE_ISO": "","END_EFFECTIVE_ISO": "","PRE_GENERATED_ID":0.0,"RELATED_PERSON_ID":0.0,"RELATED_PRSNL_ID":0.0,"ASSIGNED_RELTN_TYPE_CD":'+(addingPctTeamIndicator||userId===providerId?relationCode:0)+".0,}]}}";
request=new MP_Core.ScriptRequest(this,"");
request.setProgramName("MP_UPD_CARE_TEAM_ASSIGNMENT");
request.setParameters(["^MINE^","0"]);
request.setRequestBlobIn(assignPatJson);
request.setAsync(false);
MP_Core.XMLCCLRequestCallBack(null,request,function(reply){if(reply.getStatus()==="S"){self.retrieveComponentData(self.shouldPreserveRole());
}else{if(reply.getStatus()==="F"){self.finalizeComponent(MP_Util.HandleErrorResponse(self.getStyles().getNameSpace(),reply.getError()),"");
}}});
};
CareTeamo2Component.prototype.getElementById=function(id){return $("#cto2"+this.getComponentId()+id);
};
CareTeamo2Component.prototype.providerModalPreProcessing=function(callback){var self=this;
var callbackHasBeenCalled=false;
var handleCallback=function(){if(self.m_communicationTypeCodes.length&&$.isEmptyObject(self.m_providerRoleCodes)===false&&$.isEmptyObject(self.m_nonProviderRoleCodes)===false&&callbackHasBeenCalled===false){callbackHasBeenCalled=true;
callback.call(self);
}};
var loadCodeSet=function(){if($.isEmptyObject(self.m_providerRoleCodes)===true||$.isEmptyObject(self.m_nonProviderRoleCodes)===true){var sendAr=["^MINE^","4003145.00"];
var request=new ScriptRequest().setProgramName("MP_GET_CODESET").setParameterArray(sendAr).setResponseHandler(function(reply){var status=reply.getStatus();
switch(status){case"S":var codesList=reply.getResponse().CODES;
for(var i=0;
i<codesList.length;
i++){if(codesList[i].MEANING==="PROVIDER"){self.m_providerRoleCodes[codesList[i].CODE]=codesList[i].DISPLAY;
}else{self.m_nonProviderRoleCodes[codesList[i].CODE]=codesList[i].DISPLAY;
}}handleCallback();
break;
case"F":MP_ModalDialog.closeModalDialog("assignProviderAndNonProviderModal");
self.createErrorModal("<p>"+i18n.discernabu.careteam_o2.FAILURE_TO_RETRIEVE_ROLE_LIST+"<p>");
logger.logError(reply.getError());
break;
case"Z":MP_ModalDialog.closeModalDialog("assignProviderAndNonProviderModal");
self.createErrorModal("<p>"+i18n.discernabu.careteam_o2.NO_ROLE_LIST+"<p>");
logger.logError("Nothing returned from MP_GET_CODESET for role lists");
break;
}});
request.performRequest();
}else{handleCallback();
}};
var loadContactTypeCodes=function(){if(!self.m_communicationTypeCodes.length){if(!self.pendingContactTypeRequest){self.pendingContactTypeRequest=true;
var sendAr=["^MINE^","43.00"];
var request=new ScriptRequest().setProgramName("MP_GET_CODESET").setParameterArray(sendAr).setResponseHandler(function(reply){var status=reply.getStatus();
self.pendingContactTypeRequest=false;
switch(status){case"S":self.m_communicationTypeCodes=reply.getResponse().CODES;
handleCallback();
break;
case"F":MP_ModalDialog.closeModalDialog("assignProviderAndNonProviderModal");
self.createErrorModal("<p>"+i18n.discernabu.careteam_o2.FAILURE_TO_RETRIEVE_COMM_TYPES+"<p>");
logger.logError(reply.getError());
break;
case"Z":MP_ModalDialog.closeModalDialog("assignProviderAndNonProviderModal");
self.createErrorModal("<p>"+i18n.discernabu.careteam_o2.NO_COMM_TYPES+"<p>");
logger.logError("Nothing returned from MP_GET_CODESET for communication types");
break;
}});
request.performRequest();
}}else{handleCallback();
}};
loadCodeSet();
loadContactTypeCodes();
};
CareTeamo2Component.prototype.hideAddDropDownList=function(){var $plusAddDropDownList=$(".cto2-addplus-drp-dwn div").filter(function(){return this.id.match(/^control_\d+_contents/);
});
$plusAddDropDownList.hide();
};
CareTeamo2Component.prototype.addProviderNoCareTeam=function(relationCode){var self=this;
var criterion=this.getCriterion();
var userid=criterion.provider_id;
var sendAr=["^MINE^","0"];
var jsonString='{"PATIENTS": {"QUAL": [{"PERSON_ID":'+criterion.person_id+'.0,"ENCNTR_ID":'+criterion.encntr_id+'.0,"ASSIGNMENT_ID":0.0,"ORIG_PCT_TEAM_ID":'+(self.m_selected_team||"0")+'.0,"ACTIVE_IND":1,"BEGIN_EFFECTIVE_ISO":"","END_EFFECTIVE_ISO":"","PRE_GENERATED_ID":0.0,"RELATED_PERSON_ID":0.0,"RELATED_PRSNL_ID":'+userid+'.0,"ASSIGNED_RELTN_TYPE_CD":'+relationCode+".0,}]}}";
var request=new MP_Core.ScriptRequest(self,"");
request.setProgramName("MP_UPD_CARE_TEAM_ASSIGNMENT");
request.setRequestBlobIn(jsonString);
request.setParameters(sendAr);
MP_Core.XMLCCLRequestCallBack(null,request,function(updCareTeamReply){if(updCareTeamReply.getStatus()==="S"){var preserveRole=true;
self.retrieveComponentData(preserveRole);
}});
};
CareTeamo2Component.prototype.callUpdateCareTeam=function(lastRole,thisVisitIndicator,addingPctTeamIndicator){var self=this;
if(thisVisitIndicator){self.updateCareTeam(0,lastRole,addingPctTeamIndicator?true:false);
}else{self.addProviderNoCareTeam(lastRole);
}};
CareTeamo2Component.prototype.retrieveLastAssignedRole=function(){var userId=this.getCriterion().provider_id;
var self=this;
var async=false;
var dataIsPersisted=true;
MPage_Core_User_Prefs.UserPrefManager.GetPreference("CARE_TEAM_ROLE",dataIsPersisted,userId,async,function(lastRole){if(lastRole){self.curUserLastSelectedRole=lastRole;
}else{self.curUserLastSelectedRole=0;
}});
};
CareTeamo2Component.prototype.updateRelationshipCodeList=function(thisVisitIndicator,addingPctTeamIndicator){if(this.curUserLastSelectedRole===null){this.retrieveLastAssignedRole();
}this.callUpdateCareTeam(this.curUserLastSelectedRole,thisVisitIndicator,addingPctTeamIndicator);
};
CareTeamo2Component.prototype.setAssignedRelationshipCode=function(roleRelationCode){var userId=this.getCriterion().provider_id;
this.curUserLastSelectedRole=roleRelationCode;
MPage_Core_User_Prefs.UserPrefManager.SavePreference("CARE_TEAM_ROLE",this.curUserLastSelectedRole,true,userId,true);
};
CareTeamo2Component.prototype.shouldPreserveRole=function(data){var providerId=this.getCriterion().provider_id;
return(data&&providerId===data.PRSNL_ID)||providerId===this.selectedPersonId;
};
CareTeamo2Component.prototype.launchProviderSearchModal=function(defaultTab){var self=this;
this.hideAddDropDownList();
this.m_modalPersonnelList=[];
var person_id=this.getCriterion().person_id;
var encntr_id=this.getCriterion().encntr_id;
var user_id=this.getCriterion().provider_id;
var shouldRefresh=false;
var personnelModal=MP_ModalDialog.retrieveModalDialogObject("assignProviderAndNonProviderModal");
if(!personnelModal){var ctoCancelBtn=new ModalButton("ctoCancelBtn").setText(i18n.discernabu.careteam_o2.CANCEL).setFocusInd(true);
var ctoAssignBtn=new ModalButton("ctoAssignBtn").setText(i18n.discernabu.careteam_o2.ASSIGN).setIsDithered(true);
var ctoAssignAndAddBtn=new ModalButton("ctoAssignAndAddBtn").setText(i18n.discernabu.careteam_o2.ASSIGN_AND_ADD_ANOTHER).setIsDithered(true);
var leftRightMargin=($(window).width()>1280)?20:10;
personnelModal=new ModalDialog("assignProviderAndNonProviderModal").setTopMarginPercentage(10).setBottomMarginPercentage(5).setLeftMarginPercentage(leftRightMargin).setRightMarginPercentage(leftRightMargin).setIsBodySizeFixed(false).addFooterButton(ctoAssignBtn).addFooterButton(ctoAssignAndAddBtn).addFooterButton(ctoCancelBtn);
var modalId=personnelModal.getId();
MP_ModalDialog.addModalDialogObject(personnelModal);
personnelModal.setFooterButtonCloseOnClick("ctoAssignBtn",false);
personnelModal.setFooterButtonOnClickFunction("ctoAssignBtn",function(){if($(".cto2-provider-options").length>0){addProviderCareTeam(true);
}else{addProviderandNonProvider(true);
}self.addModalSpinner("assignProviderAndNonProviderModalbody");
});
personnelModal.setFooterButtonCloseOnClick("ctoAssignAndAddBtn",false);
personnelModal.setFooterButtonOnClickFunction("ctoAssignAndAddBtn",function(){if($(".cto2-provider-options").length>0){addProviderCareTeam();
}else{addProviderandNonProvider();
}if($("#providerTab").hasClass("cto2-tab-active-header")){showProviderTab();
}else{showNonProviderTab();
}self.addModalSpinner("assignProviderAndNonProviderModalbody");
});
personnelModal.setFooterButtonOnClickFunction("ctoCancelBtn",function(){if(shouldRefresh===true){self.retrieveComponentData();
}});
personnelModal.setHeaderTitle(i18n.discernabu.careteam_o2.ASSIGN_CARE_TEAM_MEMBER).setHeaderCloseFunction(function(){if(shouldRefresh===true){self.retrieveComponentData();
}});
}personnelModal.primValidPhone="";
personnelModal.secValidPhone="";
personnelModal.terValidPhone="";
personnelModal.setBodyDataFunction(function(){personnelModal.setBodyHTML(['<div class="cto2-tab-holder">','<div class="cto2-tab-container" id="tabContainer'+self.getComponentId()+'">','<div class="cto2-tabs">',"<ul>",'<li id="providerTab" class="cto2-tab-active-header">','<span class="cto2-tab-left-edge">',"&nbsp;","</span>",'<span class="cto2-tab-text">',i18n.discernabu.careteam_o2.PROVIDER,"</span>",'<span class="cto2-tab-right-edge">',"&nbsp;","</span>","</li>",'<li id="nonProviderTab">','<span class="cto2-tab-left-edge">',"&nbsp;","</span>",'<span class="cto2-tab-text">',i18n.discernabu.careteam_o2.NON_PROVIDER,"</span>",'<span class="cto2-tab-right-edge">',"&nbsp;","</span>","</li>","</ul>","</div>","<hr>","</div>","</div>",'<div id="cto2ProviderTab" class="cto2-provider-area"></div>','<div class="cto2-provider-display">','<hr class="cto2-rule">','<div class="cto2-provider-panel"></div>',"</div>"].join(""));
self.initProviderTab();
});
var addProviderandNonProvider=function(closeOnSuccess){$("#ctoAssignAndAddBtn").prop("disabled",true);
$("#ctoAssignBtn").prop("disabled",true);
var sendAr=["^MINE^","~~"];
var capTimer;
var jsonString=buildAddRequestString();
var request=new ScriptRequest();
request.setProgramName("mp_add_freetext_person");
request.setDataBlob(jsonString);
request.setParameterArray(sendAr);
request.setResponseHandler(function(addPersonReply){var addPersonReplyStatus=addPersonReply.getResponse().STATUS_DATA.STATUS;
if(addPersonReplyStatus==="S"){shouldRefresh=true;
if(closeOnSuccess){MP_ModalDialog.closeModalDialog(modalId);
shouldRefresh=false;
self.retrieveComponentData();
}}else{if(addPersonReplyStatus==="Z"){MP_ModalDialog.closeModalDialog("assignProviderAndNonProviderModal");
self.createErrorModal("<p>"+i18n.discernabu.careteam_o2.NO_RESULTS+"</p>");
logger.logError(i18n.discernabu.careteam_o2.NO_RESULTS);
}else{if(addPersonReplyStatus==="F"){MP_ModalDialog.closeModalDialog("assignProviderAndNonProviderModal");
self.createErrorModal("<p>"+i18n.ERROR_OCCURED+"</p>");
logger.logError("Error");
}}}$("#assignProviderAndNonProviderSpinner").remove();
$("#assignProviderAndNonProviderModalbody .loading-screen").remove();
});
if(defaultTab==="provider"){capTimer=new CapabilityTimer("CAP:MPG_Add_New_Care_Team_Provider","New Freetext Provider");
}else{capTimer=new CapabilityTimer("CAP:MPG_Add_New_Care_Team_Non_Provider");
}if(capTimer){capTimer.capture();
}request.performRequest();
};
var addProviderCareTeam=function(closeOnSuccess){$("#ctoAssignAndAddBtn").prop("disabled",true);
$("#ctoAssignBtn").prop("disabled",true);
var sendAr=["^MINE^","0"];
var jsonString='{"PATIENTS": {"QUAL": [{"PERSON_ID":'+self.getCriterion().person_id+'.0,"ENCNTR_ID":'+self.getCriterion().encntr_id+'.0,"ASSIGNMENT_ID":0.0,"ORIG_PCT_TEAM_ID":'+(self.m_selected_team||"0.0")+',"ACTIVE_IND":1,"BEGIN_EFFECTIVE_ISO":"","END_EFFECTIVE_ISO":"","PRE_GENERATED_ID":0.0,"RELATED_PERSON_ID":0.0,"RELATED_PRSNL_ID":'+(self.m_selected_team?"0":$("#cto2ProviderId").val())+'.0,"ASSIGNED_RELTN_TYPE_CD":'+self.m_selected_role+".0,}]}}";
var request=new MP_Core.ScriptRequest(self,"");
request.setProgramName("MP_UPD_CARE_TEAM_ASSIGNMENT");
request.setRequestBlobIn(jsonString);
request.setParameters(sendAr);
request.setAsync(true);
MP_Core.XMLCCLRequestCallBack(null,request,function(updCareTeamReply){var updCareTeamResponseStatus=updCareTeamReply.getStatus();
if(updCareTeamResponseStatus==="S"){shouldRefresh=true;
if(self.getCriterion().provider_id===self.selectedPersonId){var roleCode=updCareTeamReply.getResponse().ID_LIST[0].ASSIGNED_RELTN_TYPE_CD;
self.setAssignedRelationshipCode(roleCode);
}if(closeOnSuccess){MP_ModalDialog.closeModalDialog(modalId);
shouldRefresh=false;
self.retrieveComponentData(self.shouldPreserveRole());
}}else{if(updCareTeamResponseStatus==="Z"){MP_ModalDialog.closeModalDialog("assignProviderAndNonProviderModal");
self.createErrorModal("<p>"+i18n.discernabu.careteam_o2.NO_RESULTS+"</p>");
logger.logError(i18n.discernabu.careteam_o2.NO_RESULTS);
}else{if(updCareTeamResponseStatus==="F"){self.finalizeComponent(MP_Util.HandleErrorResponse(self.getStyles().getNameSpace(),updCareTeamReply.getError()),"");
}}}$("#assignProviderAndNonProviderSpinner").remove();
$("#assignProviderAndNonProviderModalbody .loading-screen").remove();
});
var capTimer=new CapabilityTimer("CAP:MPG_Add_New_Care_Team_Provider","Existing Provider");
if(capTimer){capTimer.capture();
}self.m_selected_role=undefined;
self.m_selected_team=undefined;
};
function showNonProviderTab(){$("#cto2ProviderTab").hide();
var $providerSearchList=$(".dyn-modal-dialog div").filter(function(){return this.id.match(/^control_\d+_content/);
});
$providerSearchList.hide();
$("#providerTab").removeClass("cto2-tab-active-header");
$("#nonProviderTab").addClass("cto2-tab-active-header");
self.addNewNonProviderForm(".cto2-provider-panel");
$("#ctoAssignAndAddBtn").prop("disabled",true);
$("#ctoAssignBtn").prop("disabled",true);
}function showProviderTab(){$("#cto2ProviderTab").show();
$(".cto2-provider-panel").empty();
$(".cto2-provider-display").find("hr").show();
$("#ctoAssignAndAddBtn").prop("disabled",true);
$("#ctoAssignBtn").prop("disabled",true);
$("#nonProviderTab").removeClass("cto2-tab-active-header");
$("#providerTab").addClass("cto2-tab-active-header");
$("#cto2ProviderTab input").filter(function(){return this.id.match(/^control_\d+_textbox/);
}).val("");
$(".cto2-provider-search-placeholder").removeClass("hidden");
}function buildAddRequestString(){var getPersonnelIndicator=function(){if($("#providerTab").hasClass("cto2-tab-active-header")){return'"CREATE_PRSNL_IND":1,';
}else{return'"CREATE_PRSNL_IND":0,';
}};
var getPhoneObject=function(elementID,phoneNum){if($.trim($("#"+elementID+"").val())!==""){return'{"TYPE":'+$("#"+elementID+"InputGroup .cto2-phone-type").val()+'.0,"PHONE_NUMBER":"'+phoneNum+'"}';
}else{return"";
}};
var phones=[];
var primaryPhone=getPhoneObject("cto2PrimaryPhoneTextbox",personnelModal.primValidPhone);
if(primaryPhone){phones.push(primaryPhone);
}var secondaryPhone=getPhoneObject("cto2SecPhoneTextbox",personnelModal.secValidPhone);
if(secondaryPhone){phones.push(secondaryPhone);
}var tertiaryPhone=getPhoneObject("cto2TerPhoneTextbox",personnelModal.terValidPhone);
if(tertiaryPhone){phones.push(tertiaryPhone);
}return'{"REQUESTIN":{"PERSON_ID":'+person_id+'.0,"ENCNTR_ID":'+encntr_id+'.0,"USER_ID":'+user_id+'.0,"NEW_PERSONS":[{'+getPersonnelIndicator()+'"CARE_TEAM_ASSIGNMENT":1,"FIRST_NAME":"'+$.trim($("#cto2FirstNameTextbox").val())+'","LAST_NAME":"'+$.trim($("#cto2LastNameTextbox").val())+'","MIDDLE_NAME":"'+$.trim($("#cto2MiddleNameTextbox").val())+'","RELATIONSHIP_TO_PATIENT_CD":'+$(".cto2-selected-list").attr("data-value")+'.0,"PHONES_LIST":['+phones.join(",")+"]}]}}";
}MP_ModalDialog.updateModalDialogObject(personnelModal);
MP_ModalDialog.showModalDialog(personnelModal.getId());
$("#providerTab").on("click",showProviderTab);
$("#nonProviderTab").on("click",showNonProviderTab);
if(defaultTab==="provider"){showProviderTab();
}else{showNonProviderTab();
}function validateForm(){var textBoxValidation=function(textInput){if($.trim(textInput.val()).length>0){textInput.addClass("te-valid");
}else{textInput.removeClass("te-valid");
}};
var phoneValidation=function(phoneInput){return $.trim(phoneInput.val()).replace(/[^0-9]+/g,"");
};
personnelModal.primValidPhone=phoneValidation($("#cto2PrimaryPhoneTextbox"));
personnelModal.secValidPhone=phoneValidation($("#cto2SecPhoneTextbox"));
personnelModal.terValidPhone=phoneValidation($("#cto2TerPhoneTextbox"));
textBoxValidation($("#cto2FirstNameTextbox"));
textBoxValidation($("#cto2LastNameTextbox"));
textBoxValidation($("#cto2PrimaryPhoneTextbox"));
if($.trim($("#cto2FirstNameTextbox").val())===""||$.trim($("#cto2LastNameTextbox").val())===""||personnelModal.primValidPhone===""||$(".cto2-selected-list").length===0){$("#ctoAssignAndAddBtn").prop("disabled",true);
$("#ctoAssignBtn").prop("disabled",true);
}else{$("#ctoAssignAndAddBtn").prop("disabled",false);
$("#ctoAssignBtn").prop("disabled",false);
}}$(".cto2-provider-display").on("keyup change","input",validateForm);
$(".cto2-provider-display").on("cto2-role-selected",".cto2-form-roles-holder",validateForm);
};
CareTeamo2Component.prototype.addProviderSpinner=function(){var $providerDiv=$("#cto2ProviderTab");
var $modalBody=$("#assignProviderAndNonProviderModalbody");
if($("#assignProviderAndNonProviderSpinner").length===0){var $spinnerDiv=$('<div id="assignProviderAndNonProviderSpinner" class="spinner-container"></div>').css({"margin-top":$providerDiv.position().top+$providerDiv.outerHeight(),right:$modalBody.width()+parseInt($modalBody.css("margin-right"),10)-$providerDiv.width(),bottom:$("#assignProviderAndNonProviderModalfooter").height()});
$("#assignProviderAndNonProviderModalbody").append($spinnerDiv);
this.addModalSpinner("assignProviderAndNonProviderSpinner");
}};
CareTeamo2Component.prototype.initProviderTab=function(){var self=this;
var $providerDiv=$("#cto2ProviderTab");
var personnelSearch=new MPageControls.PersonnelSearch($providerDiv);
personnelSearch.setUserId(this.getCriterion().provider_id);
personnelSearch.setSuggestionLimit(49);
$("#cto2ProviderTab ").append('<span class="cto2-provider-search-placeholder">'+i18n.discernabu.careteam_o2.SEARCH+"</span>");
$(".cto2-provider-search-placeholder").on("click",function(){$("#cto2ProviderTab .search-box").focus();
});
var $footer=$("#assignProviderAndNonProviderModalfooter");
var footerBottom=parseInt($footer.offset().top+$footer.height(),10);
var searchBottom=parseInt($providerDiv.offset().top+$providerDiv.height(),10);
var resultsBoxHeight=footerBottom-searchBottom;
personnelSearch.setTemplateMaxHeight(resultsBoxHeight);
$providerDiv.on("keyup","input",function(event){var $target=$(event.target);
if($target.val()){$(".cto2-provider-search-placeholder").addClass("hidden");
self.addProviderSpinner();
}else{$(".cto2-provider-search-placeholder").removeClass("hidden");
}});
$providerDiv.on("click",".close-btn",function(){$("#assignProviderAndNonProviderSpinner").remove();
$(".cto2-provider-search-placeholder").removeClass("hidden");
});
personnelSearch.setSuggestions=function(items){this.setItems(items);
if(this.getSynchSuggestionsWidth()){$("#control_"+this.getControlId()+"_content").css("min-width",this.getElement().width()+"px");
}this.getList().renderItems(items);
var detailDialog=this.getDetailDialog();
detailDialog.show();
detailDialog.updatePosition();
if(this.getHighlightEnabled()){var hl=new MPageControls.TextHighlighter(this.getList().getElement());
hl.highlight(this.getValue());
}var self=this;
var suggestionsContainer="#control_"+self.getControlId()+"_content .suggestions";
$(suggestionsContainer).attr("tabindex",0).on("blur",function(){setTimeout(function(){if(self.getElement()&&!self.getTextbox().is(":focus")){self.close();
}},300);
});
};
personnelSearch.handleSuccess=function(reqNumber,responseText){if(reqNumber==this.getRequestCount()&&responseText){$("#assignProviderAndNonProviderSpinner").remove();
var jsonSearch=JSON.parse(responseText);
if(jsonSearch.RECORD_DATA.STATUS_DATA.STATUS==="F"){MP_Util.LogScriptCallError(null,responseText,"program_search.js","handleSuccess");
MP_Util.LogError(this.getProgramName()+" failed: "+responseText);
return;
}var context=this.makeContext(jsonSearch);
this.setSuggestions(context);
}};
personnelSearch.setListTemplate(MPageControls.getDefaultTemplates().providerSuggestList);
var personnelList=personnelSearch.getList();
personnelList.setOnSelect(function(){self.processSelection(personnelList.getSelectedItem());
$(".suggestions").hide();
$("#ctoAssignAndAddBtn").prop("disabled",true);
$("#ctoAssignBtn").prop("disabled",true);
self.addProviderSpinner();
});
$("#vwpModalDialogassignProviderAndNonProviderModal").on("click","#newProviderAssignment",function(){self.addNewProviderForm(".cto2-provider-panel");
$(".suggestions").hide();
$("#ctoAssignAndAddBtn").prop("disabled",true);
$("#ctoAssignBtn").prop("disabled",true);
});
};
CareTeamo2Component.prototype.createErrorModal=function(appendHtml){try{if(typeof appendHtml!=="string"||appendHtml===""){throw new Error("CareTeamo2Component.createErrorModal - Error creating error modal dialog : appendHtml is empty or not a string");
}var errorDialogId="careTeamErrorModalDialogId";
var footerButton=new ModalButton("manageCareTeamProviderErrorButton").setText(i18n.discernabu.OK).setCloseOnClick(true).setOnClickFunction(function(){MP_ModalDialog.closeModalDialog(errorDialogId);
MP_ModalDialog.deleteModalDialogObject(errorDialogId);
});
var modalObj=MP_Util.generateModalDialogBody(errorDialogId,"",appendHtml,"").setShowCloseIcon(false).addFooterButton(footerButton);
MP_ModalDialog.updateModalDialogObject(modalObj);
MP_ModalDialog.showModalDialog(errorDialogId);
}catch(err){logger.logError(err.message);
}};
CareTeamo2Component.prototype.getContactTypeOptionList=function(defaultValue){if(this.m_communicationTypeCodes.length){var self=this;
var defaultMatch=false;
var optionList=[];
var codesLength=self.m_communicationTypeCodes.length;
for(var i=0;
i<codesLength;
i++){var typeCode=self.m_communicationTypeCodes[i];
if(typeCode.MEANING===defaultValue){defaultMatch=true;
optionList.push('<option value="'+typeCode.CODE+'" title="'+typeCode.DISPLAY+'" selected="selected">',typeCode.DISPLAY,"</option>");
}else{optionList.push('<option value="'+typeCode.CODE+'" title="'+typeCode.DISPLAY+'">',typeCode.DISPLAY,"</option>");
}}if(defaultMatch===false){optionList.unshift('<option value="" selected="selected"></option>');
}return["<div>",'<select class="cto2-phone-type">',optionList.join(""),"</select>","</div>"].join("");
}else{return"";
}};
CareTeamo2Component.prototype.processSelection=function(selectedItem){var self=this;
self.selectedPersonId=selectedItem.PERSON_ID;
var sendAr=["^MINE^",self.criterion.logical_domain_id,"0.0","0.0",selectedItem.PERSON_ID+".0",0,0,self.criterion.facility_cd+".0"];
var request=new ScriptRequest().setProgramName("MP_GET_PCT_CARE_TEAM_CONFIG").setParameterArray(sendAr).setResponseHandler(function(reply){var status=reply.getStatus();
if(status==="S"||status==="Z"){$("#assignProviderAndNonProviderSpinner").remove();
var response=reply.getResponse();
var codes=response.CODES;
var codesArray=MP_Util.LoadCodeListJSON(codes);
var pctTeams=response.PCT_TEAMS;
var teamsLength=pctTeams.length;
var getProviderList=function(){var list=[];
for(var codeDisplayKey in self.m_providerRoleCodes){if(self.m_providerRoleCodes.hasOwnProperty(codeDisplayKey)){list.push(['<li data-value="'+codeDisplayKey+'">',self.m_providerRoleCodes[codeDisplayKey],"</li>"].join(""));
}}return["<ul>",list.join(""),"</ul>"].join("");
};
var getTeamList=function(){if(teamsLength===0){return["<div>",i18n.discernabu.careteam_o2.NO_TEAM_ASSIGNMENTS,"</div>"].join("");
}var list=[];
for(var i=0;
i<teamsLength;
i++){var team=pctTeams[i];
var pctCareTeamName=MP_Util.GetValueFromArray(team.PCT_MEDSERV_CD,codesArray).display;
if(team.PCT_TEAM_CD){pctCareTeamName+=" | "+MP_Util.GetValueFromArray(team.PCT_TEAM_CD,codesArray).display;
}if(team.FACILITY_CD){pctCareTeamName+=" ("+MP_Util.GetValueFromArray(team.FACILITY_CD,codesArray).display+")";
}list.push(['<li data-value="'+team.ORIG_PCT_TEAM_ID+'">',pctCareTeamName,"</li>"].join(""));
}return["<ul>",list.join(""),"</ul>"].join("");
};
var listHtml=['<div class="cto2-providers" id="cto2-'+selectedItem.PERSON_ID+'">','<input id="cto2ProviderId" type="hidden" value="'+selectedItem.PERSON_ID+'"/>',"<p>",selectedItem.NAME_FULL_FORMATTED,"<p>",'<div class="cto2-provider-options">','<div class="cto2-provider-content">','<span class="te-required-ind">*</span>','<span class="cto2-roles-label">',i18n.discernabu.careteam_o2.PROVIDER_ROLE,"</span>",'<div class="cto2-provider-list">',getProviderList(),"</div>","</div>",'<div class="cto2-team-content">',"<p>",i18n.discernabu.careteam_o2.PROVIDER_TEAM,"</p>",'<div class="cto2-team-list">',getTeamList(),"</div>","</div>","</div>","</div>"].join("");
function highlightLastSelectedRole(){self.m_selected_role=self.curUserLastSelectedRole;
$(".cto2-provider-panel").html(listHtml).find("li[data-value="+self.curUserLastSelectedRole+"]").addClass("cto2-selected-list");
}$("#assignProviderAndNonProviderSpinner").remove();
if(selectedItem.PERSON_ID===self.criterion.provider_id){if(self.curUserLastSelectedRole===null){self.retrieveLastAssignedRole();
}highlightLastSelectedRole();
}else{$(".cto2-provider-panel").html(listHtml);
}$("#vwpModalDialogassignProviderAndNonProviderModal").on("click",".cto2-provider-list li",function(e){$(".cto2-provider-list li").removeClass("cto2-selected-list");
self.m_selected_role=$(e.target).data("value");
$(e.target).addClass("cto2-selected-list");
$(".cto2-provider-display").trigger("cto2-provider-role-selected");
});
$("#vwpModalDialogassignProviderAndNonProviderModal").on("click",".cto2-team-list li",function(e){$(".cto2-team-list li").removeClass("cto2-selected-list");
self.m_selected_team=$(e.target).data("value");
$(e.target).addClass("cto2-selected-list");
$(".cto2-provider-display").trigger("cto2-provider-role-selected");
});
function validateProviderListsSelected(){if($(".cto2-provider-list .cto2-selected-list").length){$("#ctoAssignAndAddBtn").prop("disabled",false);
$("#ctoAssignBtn").prop("disabled",false);
}else{$("#ctoAssignAndAddBtn").prop("disabled",true);
$("#ctoAssignBtn").prop("disabled",true);
}}$(".cto2-provider-display").on("cto2-provider-role-selected",validateProviderListsSelected);
}else{MP_ModalDialog.closeModalDialog("assignProviderAndNonProviderModal");
self.createErrorModal("<p>"+i18n.ERROR_OCCURED+"</p>");
logger.logError("Error");
}});
request.performRequest();
};
CareTeamo2Component.prototype.getProviderNonProviderFormHTML=function(roleList,isProvider){var ctI18n=i18n.discernabu.careteam_o2;
var getRolesList=function(){var list=[];
for(var key in roleList){if(roleList.hasOwnProperty(key)){list.push(['<li data-value="'+key+'">',roleList[key],"</li>"].join(""));
}}return list.join("");
};
var formHTML=['<div class="cto2-assign-provider-form">',"<form>",'<div class="cto2-provider-form-holder">','<div id="cto2-form-inputs" class="cto2-modal-form-inputs">',this.providerFormTextControls("cto2FirstNameTextbox",ctI18n.FIRST,TextControl.width.LARGE,"cto2-form-inputs",true),this.providerFormTextControls("cto2LastNameTextbox",ctI18n.LAST,TextControl.width.LARGE,"cto2-form-inputs",true),this.providerFormTextControls("cto2MiddleNameTextbox",ctI18n.MIDDLE,TextControl.width.LARGE,"cto2-form-inputs"),this.providerFormTextControls("cto2PrimaryPhoneTextbox",ctI18n.PRIMARY_PHONE,TextControl.width.MEDIUM,"cto2-form-inputs",true),this.providerFormTextControls("cto2SecPhoneTextbox","",TextControl.width.MEDIUM,"cto2-form-inputs"),this.providerFormTextControls("cto2TerPhoneTextbox","",TextControl.width.MEDIUM,"cto2-form-inputs"),"</div>",'<div class="cto2-form-roles te-label-top">','<div class="te-label te-required-label">','<span class="te-required-ind">*</span>','<span class="te-label-text">',isProvider?i18n.discernabu.careteam_o2.PROVIDER_ROLE:i18n.discernabu.careteam_o2.NONPROVIDER_ROLE,"</span>","</div>",'<div class="cto2-form-roles-holder">',"<ul>",getRolesList(),"</ul>","</div>","</div>","</div>","</form>","</div>"].join("");
var $formElement=$(formHTML);
$formElement.find("#cto2PrimaryPhoneTextbox, #cto2SecPhoneTextbox, #cto2TerPhoneTextbox").addClass("pull-left");
if(isProvider){$formElement.find("#cto2PrimaryPhoneTextboxInputGroup").append(this.getContactTypeOptionList("BUSINESS"));
$formElement.find("#cto2SecPhoneTextboxInputGroup").append(this.getContactTypeOptionList("MOBILE"));
$formElement.find("#cto2TerPhoneTextboxInputGroup").append(this.getContactTypeOptionList("FAX BUS"));
}else{$formElement.find("#cto2PrimaryPhoneTextboxInputGroup").append(this.getContactTypeOptionList("HOME"));
$formElement.find("#cto2SecPhoneTextboxInputGroup").append(this.getContactTypeOptionList());
$formElement.find("#cto2TerPhoneTextboxInputGroup").append(this.getContactTypeOptionList());
}return $formElement.html();
};
CareTeamo2Component.prototype.addNewProviderNonProviderForm=function(parentSelector,roleList,isProvider){var formHTML=this.getProviderNonProviderFormHTML(roleList,isProvider);
$(parentSelector).html(formHTML);
this.bindFormEvents("#vwpModalDialogassignProviderAndNonProviderModal");
};
CareTeamo2Component.prototype.addNewProviderForm=function(parentSelector){var isProvider=true;
this.addNewProviderNonProviderForm(parentSelector,this.m_providerRoleCodes,isProvider);
};
CareTeamo2Component.prototype.addNewNonProviderForm=function(parentSelector){var isProvider=false;
$(".cto2-provider-display hr").hide();
this.addNewProviderNonProviderForm(parentSelector,this.m_nonProviderRoleCodes,isProvider);
};
CareTeamo2Component.prototype.providerFormTextControls=function(id,label,width,delegate,required){return new TextControl().setId(id).setDelegateId(delegate).setLabel(label).setPredefinedWidth(width).setRequired(!!required).renderRaw();
};
}(jQuery));
MP_Util.setObjectDefinitionMapping("WF_CARE_TEAM",CareTeamo2Component);
