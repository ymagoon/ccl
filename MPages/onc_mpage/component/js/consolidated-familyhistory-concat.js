var CERN_FAM_HISTORY_CONSOLIDATED_PED=function(){var fhxi18n=i18n.discernabu.consolidated_history;
return{GetPatientPortalRecords:function(familyRecords,component){try{if(!component.PEDLoadCAPTimers.FAMILY_HISTORY_LOADED){var fhLoadCAPTimer=new CapabilityTimer("CAP:MPG Histories_Family History Load Patient Entered Data");
fhLoadCAPTimer.capture();
component.PEDLoadCAPTimers.FAMILY_HISTORY_LOADED=true;
}var ppRecords=[];
var familyRecordCnt=familyRecords.length;
for(var i=0;
i<familyRecordCnt;
i++){if(familyRecords[i].INTEROP.length>0&&familyRecords[i].INTEROP[0].EXT_DATA_INFO_ID>0){ppRecords.push(familyRecords[i]);
}}ppRecords.sort(function(a,b){if(a.INTEROP[0].FAMILY_MEMBER.FAMILY_MEMBER.toUpperCase()<b.INTEROP[0].FAMILY_MEMBER.FAMILY_MEMBER.toUpperCase()){return -1;
}return 1;
});
return ppRecords;
}catch(err){logger.logJSError(err,this,"consolidated-familyhistory-ped.js","GetPatientPortalRecords");
}},GetChartFamilyRecords:function(familyRecords){try{var chartRecords=[];
var familyRecordCnt=familyRecords.length;
for(var i=0;
i<familyRecordCnt;
i++){if(familyRecords[i].INTEROP.length===0){chartRecords.push(familyRecords[i]);
}}return chartRecords;
}catch(err){logger.logJSError(err,this,"consolidated-familyhistory-ped.js","GetChartFamilyRecords");
}},processSelectedPEDFhxForRemoval:function(component){var self=CERN_FAM_HISTORY_CONSOLIDATED_PED;
try{var removeFhxArr=[];
var selectedFhx=component.famHxTable.getSelectionData();
var fhxCnt=selectedFhx.length;
if(selectedFhx&&fhxCnt){var recordData=component.getFamRecordData();
var codesArray=MP_Util.LoadCodeListJSON(recordData.CODES);
var statusCodeObj=MP_Util.GetCodeByMeaning(codesArray,"ACKNOWLEDGED");
if(statusCodeObj){var statusCode=statusCodeObj.codeValue;
var criterion=component.getCriterion();
for(var i=0;
i<fhxCnt;
i++){removeFhxArr.push('{"EXT_DATA_INFO_ID":'+selectedFhx[i].record.EXT_DATA_INFO_ID+'.0,"STATUS_CODE":'+statusCode+'.0,"CHART_REFERENCE_ID": 0.0,"PERSONNEL_ID":'+criterion.provider_id+'.0,"ENCNTR_ID":'+criterion.encntr_id+".0}");
}}else{var nullArrayError=new Error("Array not found - Code Array cannot be null or undefined");
logger.logJSError(nullArrayError,this,"consolidated-familyhistory-ped.js","processSelectedPEDFhxForRemoval");
}}return removeFhxArr;
}catch(err){logger.logJSError(err,this,"consolidated-familyhistory-ped.js","processSelectedPEDFhxForRemoval");
self.displayFhxErrorBanner(component);
}},displayFhxErrorBanner:function(component){component.famHxSidePanel.m_sidePanel.removeAlertBanner();
var alertBanner=new MPageUI.AlertBanner();
alertBanner.setType(MPageUI.ALERT_OPTIONS.TYPE.ERROR);
alertBanner.setPrimaryText(fhxi18n.REMOVE_PAT_REQUEST_ERROR_TEXT);
component.famHxSidePanel.m_sidePanel.setAlertBannerAsHTML(alertBanner.render());
},createRemoveRequestButton:function(component,rowCount){var displayCount=(rowCount>1)?" ("+rowCount+")":"";
var removeRequestsBtn=new MPageUI.Button().setLabel(fhxi18n.REMOVE_REQUEST+displayCount).setStyle(MPageUI.BUTTON_OPTIONS.STYLE.SECONDARY).setOnClickCallback(function(){CERN_FAM_HISTORY_CONSOLIDATED_PED.acknowledgeFamHistPatientRequest(component);
});
return removeRequestsBtn;
},acknowledgeFamHistPatientRequest:function(component){var self=this;
try{var fhReconcileCAPTimer=new CapabilityTimer("CAP:MPG Histories_Family History Reconcile Patient Entered Data");
fhReconcileCAPTimer.capture();
var fhxItemsArr=self.processSelectedPEDFhxForRemoval(component);
var requestJson='{"REQUESTIN":{"UPDATESTATUS":['+fhxItemsArr+"]}}";
var scriptRequest=new ScriptRequest();
scriptRequest.setProgramName("mp_exec_std_request");
scriptRequest.setDataBlob(requestJson);
scriptRequest.setRawDataIndicator(true);
scriptRequest.setParameterArray(["^MINE^","^^",3202004,3202004,964756]);
scriptRequest.setResponseHandler(function(scriptReply){try{var responseData=JSON.parse(scriptReply.getResponse());
if(responseData.RECORD_DATA.STATUS.SUCCESS_INDICATOR===1){component.retrieveComponentData();
}else{self.displayFhxErrorBanner(component);
}}catch(err){logger.logJSError(err,this,"consolidated-familyhistory-ped.js","acknowledgeFamHistPatientRequest");
self.displayFhxErrorBanner(component);
}});
scriptRequest.performRequest();
}catch(err){logger.logJSError(err,self,"consolidated-familyhistory-ped.js","acknowledgeFamHistPatientRequest");
self.displayFhxErrorBanner(component);
}},processDataPEDConditionView:function(data,component){var pedTableDisplayList=[];
try{if(data&&data.length&&component){var PEDBaseDisplay=function(){return{request:"--",familyMember:"--",patientComment:"--",condition:null,conditionArr:[],interopInfo:null,origSource:"--",origAuthor:"--",date:"--"};
};
var patientPortalCnt=data.length;
var recordData=component.getFamRecordData();
var codeArray=MP_Util.LoadCodeListJSON(recordData.CODES);
var conditionName="";
var conditions=[];
var currCondition=null;
var comments=null;
var comment="";
var conditionHTML="";
var commentHTML="";
var interopInfo=null;
var origSourceCode=null;
var origSource="";
var requestTypeCode=null;
var requestTypeDisplay="";
var submittedDate="";
var extDataInfoId=0;
var i,j;
for(i=0;
i<patientPortalCnt;
i++){var displayObj=null;
conditionHTML="";
commentHTML="";
interopInfo=data[i].INTEROP[0];
if(interopInfo){displayObj=new PEDBaseDisplay();
conditions=interopInfo.SELECTED_HEALTH_ISSUES;
comments=interopInfo.COMMENTS;
extDataInfoId=interopInfo.EXT_DATA_INFO_ID;
displayObj.extDataInfoId=extDataInfoId;
displayObj.familyMember=(interopInfo.FAMILY_MEMBER&&interopInfo.FAMILY_MEMBER.FAMILY_MEMBER)?interopInfo.FAMILY_MEMBER.FAMILY_MEMBER:"";
if(interopInfo.REQUEST_TYPE){requestTypeCode=MP_Util.GetValueFromArray(interopInfo.REQUEST_TYPE,codeArray);
requestTypeDisplay=(requestTypeCode)?requestTypeCode.display:"";
displayObj.request=requestTypeDisplay;
}if(interopInfo.SUBMITTED_BY_TYPE){origSourceCode=MP_Util.GetValueFromArray(interopInfo.SUBMITTED_BY_TYPE,codeArray);
origSource=(origSourceCode)?origSourceCode.display:"--";
displayObj.origSource=origSource;
}displayObj.origAuthor=interopInfo.SUBMITTED_BY_NAME||"--";
if(interopInfo.SUBMITTED_ON){submittedDate=new Date();
submittedDate.setISO8601(interopInfo.SUBMITTED_ON);
displayObj.date=submittedDate.format("mediumDate")+" "+submittedDate.format("militaryTime");
}if(comments&&comments.length){comment=CERN_FAM_HISTORY_CONSOLIDATED.sanitizeComment(comments[0].COMMENT_TEXT)||"--";
commentHTML="<p class='fhx-comment'>"+fhxi18n.PATIENT_COMMENT+": "+comment+"</p>";
displayObj.patientComment=comment;
}for(j=0;
j<conditions.length;
j++){currCondition=conditions[j];
conditionName=currCondition.HEALTH_ISSUE;
conditionHTML+="<div class='chx-fhx-item chx-info result-info'>"+conditionName+"</div>";
displayObj.conditionArr.push(conditionName);
}displayObj.condition=conditionHTML+"<div class='comment'>"+commentHTML+"</div>";
pedTableDisplayList.push(displayObj);
}}}return pedTableDisplayList;
}catch(err){logger.logJSError(err,this,"consolidated-familyhistory-ped.js","processDataPEDConditionView");
}},processDataPEDFamilyView:function(data,component){var pedTableDisplayList=[];
try{if(data&&data.length&&component){var PEDBaseDisplay=function(){return{request:"--",familyMember:"--",patientComment:"--",condition:null,conditionArr:[],interopInfo:null,origSource:"--",origAuthor:"--",date:"--"};
};
var patientPortalCnt=data.length;
var recordData=component.getFamRecordData();
var codeArray=MP_Util.LoadCodeListJSON(recordData.CODES);
var conditionName="";
var conditions=[];
var currCondition=null;
var comments=null;
var comment="";
var conditionHTML="";
var commentHTML="";
var interopInfo=null;
var origSourceCode=null;
var origSource="";
var requestTypeCode=null;
var requestTypeDisplay="";
var submittedDate="";
var extDataInfoId=0;
var i,j;
for(i=0;
i<patientPortalCnt;
i++){var displayObj=null;
conditionHTML="";
commentHTML="";
interopInfo=data[i].INTEROP[0];
if(interopInfo){displayObj=new PEDBaseDisplay();
conditions=interopInfo.SELECTED_HEALTH_ISSUES;
comments=interopInfo.COMMENTS;
extDataInfoId=interopInfo.EXT_DATA_INFO_ID;
displayObj.extDataInfoId=extDataInfoId;
displayObj.familyMember=(interopInfo.FAMILY_MEMBER&&interopInfo.FAMILY_MEMBER.FAMILY_MEMBER)?interopInfo.FAMILY_MEMBER.FAMILY_MEMBER:"";
if(interopInfo.REQUEST_TYPE){requestTypeCode=MP_Util.GetValueFromArray(interopInfo.REQUEST_TYPE,codeArray);
requestTypeDisplay=requestTypeCode.display;
displayObj.request=requestTypeDisplay||"--";
}if(interopInfo.SUBMITTED_BY_TYPE){origSourceCode=MP_Util.GetValueFromArray(interopInfo.SUBMITTED_BY_TYPE,codeArray);
origSource=origSourceCode.display;
displayObj.origSource=origSource||"--";
}if(interopInfo.SUBMITTED_BY_NAME){displayObj.origAuthor=interopInfo.SUBMITTED_BY_NAME;
}if(interopInfo.SUBMITTED_ON){submittedDate=new Date();
submittedDate.setISO8601(interopInfo.SUBMITTED_ON);
displayObj.date=submittedDate.format("mediumDate")+" "+submittedDate.format("militaryTime");
}if(comments&&comments.length){comment=CERN_FAM_HISTORY_CONSOLIDATED.sanitizeComment(comments[0].COMMENT_TEXT)||"--";
commentHTML="<p class = 'fhx-comment'>"+fhxi18n.PATIENT_COMMENT+": "+comment+"</p>";
displayObj.patientComment=comment;
}for(j=0;
j<conditions.length;
j++){currCondition=conditions[j];
conditionName=currCondition.HEALTH_ISSUE;
conditionHTML+="<div class='chx-fhx-item chx-info result-info'>"+conditionName+"</div>";
displayObj.conditionArr.push(conditionName);
}displayObj.condition=conditionHTML+"<div class='comment'>"+commentHTML+"</div>";
pedTableDisplayList.push(displayObj);
}}}return pedTableDisplayList;
}catch(err){logger.logJSError(err,this,"consolidated-familyhistory-ped.js","processDataPEDFamilyView");
}}};
}();
var CERN_FAM_HISTORY_CONSOLIDATED=function(){var fhxi18n=i18n.discernabu.consolidated_history;
var stdStringSeparator=" - ";
return{resizeComponent:function(component){if(!component){return;
}if(component.famHxTable){var famHxTable=component.famHxTable;
var famHxSP=component.famHxSidePanel;
famHxTable.clearElementCache();
famHxTable.setMaxHeight(CERN_FAM_HISTORY_CONSOLIDATED.computeTableHeight(component));
if(famHxSP){famHxSP.m_sidePanel.setHeight($("#"+famHxTable.getId()).height()+"px");
famHxSP.m_sidePanel.resizePanel();
famHxSP.m_sidePanel.expandSidePanel();
}}},RenderComponentByFamily:function(component){component.setFamHxView("Family");
var recordData=component.getFamRecordData();
var compId=component.getComponentId();
var famHxNS="wf-consol-hx-famHx";
var jsFamHTML=[];
var fhxSummary;
var summaryLabel;
var patientPortalRecords=[];
var shouldDisplayPatientEnteredData;
var chartRecords;
var famHxTable=new MPageUI.Table();
var tableHTML="";
var processedPortalData=null;
var familyRecordsLen;
var patientRequestCount=0;
if(!component.famPatRequestArr){component.famPatRequestArr=[];
}component.famHxSidePanel=null;
fhxSummary=CERN_FAM_HISTORY_CONSOLIDATED.processSummaryLabel(recordData);
summaryLabel="<span class='res-none'>"+fhxSummary+"</span>";
chartRecords=CERN_FAM_HISTORY_CONSOLIDATED_PED.GetChartFamilyRecords(recordData.FAMILIES);
shouldDisplayPatientEnteredData=component.shouldDisplayPatientEnteredData();
if(shouldDisplayPatientEnteredData){if(component.fhxRemoveRequestsButton){component.fhxRemoveRequestsButton.clearElementCache();
}patientPortalRecords=CERN_FAM_HISTORY_CONSOLIDATED_PED.GetPatientPortalRecords(recordData.FAMILIES,component);
if(patientPortalRecords&&patientPortalRecords.length){patientRequestCount=patientPortalRecords.length;
}}familyRecordsLen=chartRecords.length;
if(familyRecordsLen===0&&!shouldDisplayPatientEnteredData){jsFamHTML.push(summaryLabel);
jsFamHTML.push("<span class='res-none'>"+i18n.discernabu.NO_RESULTS_FOUND+"</span>");
}else{if(fhxSummary){jsFamHTML.push('<div class="chx-menu">',summaryLabel,"</div>");
}if(familyRecordsLen||patientRequestCount){if(shouldDisplayPatientEnteredData){processedPortalData=CERN_FAM_HISTORY_CONSOLIDATED_PED.processDataPEDFamilyView(patientPortalRecords,component);
}CERN_FAM_HISTORY_CONSOLIDATED.processDataFamilyView(recordData,chartRecords,component);
tableHTML=CERN_FAM_HISTORY_CONSOLIDATED.prepareFamilyViewTable(famHxTable,chartRecords,processedPortalData,shouldDisplayPatientEnteredData,component);
jsFamHTML.push(tableHTML);
jsFamHTML.push("<div id='famHxSidePanelContainer"+compId+"' class='"+famHxNS+"-sp-container'></div>");
}else{jsFamHTML.push("<span class='res-none'>"+i18n.discernabu.NO_RESULTS_FOUND+"</span>");
}}component.famHxMillCount=familyRecordsLen;
component.famHxPEDCount=patientRequestCount;
component.famHxNamespace=famHxNS;
component.loadTabData(familyRecordsLen,jsFamHTML.join(""),component.HistoryComponentIndexObj.FAMILY_HISTORY,function(){var tabControlObj=component.m_tabControl;
var historiesTabsArray=tabControlObj.getTabs();
var currentFamHxTableId=famHxTable.getId();
tabControlObj.updateCountOnTab(historiesTabsArray[component.HistoryComponentIndexObj.FAMILY_HISTORY],component.famHxMillCount+component.famHxPEDCount);
if(component.famHxTable&&(currentFamHxTableId!==component.famHxTable.getId())){component.famHxTable=null;
}if(tableHTML){component.famHxTable=famHxTable;
CERN_FAM_HISTORY_CONSOLIDATED.resizeComponent(component);
famHxTable.attachEvents();
}},patientRequestCount);
},RenderComponentByCondition:function(component){component.setFamHxView("Condition");
var recordData=component.getFamRecordData();
var compId=component.getComponentId();
var famHxNS="wf-consol-hx-famHx";
var jsFamHTML=[];
var fhxSummary;
var patientPortalRecords=[];
var patientRequestCount=0;
var summaryLabel;
var shouldDisplayPatientEnteredData;
var famHxTable=new MPageUI.Table();
var tableHTML="";
var processedPortalData=null;
if(!component.famPatRequestArr){component.famPatRequestArr=[];
}component.famHxSidePanel=null;
fhxSummary=CERN_FAM_HISTORY_CONSOLIDATED.processSummaryLabel(recordData);
summaryLabel="<span class='res-none'>"+fhxSummary+"</span>";
shouldDisplayPatientEnteredData=component.shouldDisplayPatientEnteredData();
if(shouldDisplayPatientEnteredData){if(component.fhxRemoveRequestsButton){component.fhxRemoveRequestsButton.clearElementCache();
}patientPortalRecords=CERN_FAM_HISTORY_CONSOLIDATED_PED.GetPatientPortalRecords(recordData.FAMILIES,component);
if(patientPortalRecords&&patientPortalRecords.length){patientRequestCount=patientPortalRecords.length;
}}var conditionsLen=recordData.CONDITION_CNT;
if(conditionsLen===0&&!shouldDisplayPatientEnteredData){jsFamHTML.push(summaryLabel);
jsFamHTML.push("<span class='res-none'>"+i18n.discernabu.NO_RESULTS_FOUND+"</span>");
}else{if(fhxSummary){jsFamHTML.push('<div class="chx-menu">',summaryLabel,"</div>");
}if(conditionsLen||patientRequestCount){if(shouldDisplayPatientEnteredData){processedPortalData=CERN_FAM_HISTORY_CONSOLIDATED_PED.processDataPEDConditionView(patientPortalRecords,component);
}CERN_FAM_HISTORY_CONSOLIDATED.processDataCondView(recordData,conditionsLen,component);
tableHTML=CERN_FAM_HISTORY_CONSOLIDATED.prepareConditionViewTable(famHxTable,recordData,processedPortalData,shouldDisplayPatientEnteredData,component);
jsFamHTML.push(tableHTML);
jsFamHTML.push("<div id='famHxSidePanelContainer"+compId+"' class='"+famHxNS+"-sp-container'></div>");
}else{jsFamHTML.push("<span class='res-none'>"+i18n.discernabu.NO_RESULTS_FOUND+"</span>");
}}component.famHxMillCount=conditionsLen;
component.famHxPEDCount=patientRequestCount;
component.famHxNamespace=famHxNS;
component.loadTabData(conditionsLen,jsFamHTML.join(""),component.HistoryComponentIndexObj.FAMILY_HISTORY,function(){component.UPDATE_FAM_HIST_PRIV=recordData.UPDATE_FAM_HIST_PRIV;
var tabControlObj=component.m_tabControl;
var historiesTabsArray=tabControlObj.getTabs();
tabControlObj.updateCountOnTab(historiesTabsArray[component.HistoryComponentIndexObj.FAMILY_HISTORY],component.famHxMillCount+component.famHxPEDCount);
if(tableHTML){component.famHxTable=famHxTable;
CERN_FAM_HISTORY_CONSOLIDATED.resizeComponent(component);
famHxTable.attachEvents();
}},patientRequestCount);
},processSummaryLabel:function(recordData){var fhxSummary="";
var fhxSummaryInd="";
var allHistNeg="";
try{if(recordData){if(recordData.PATIENT_ADOPTED_IND===1){fhxSummary=fhxi18n.ADOPTED;
}if(recordData.HIST_NEG_IND===1){allHistNeg=fhxi18n.FAMILY_HISTORY_NEGATIVE;
}if(recordData.NEGATIVE_IND===1){fhxSummaryInd=fhxi18n.FAMILY_HISTORY_NEGATIVE;
}else{if(recordData.UNKNOWN_IND===1){fhxSummaryInd=fhxi18n.FAMILY_HISTORY_UNKNOWN;
}else{if(recordData.UNABLE_TO_OBTAIN_IND===1){fhxSummaryInd=fhxi18n.UNABLE_TO_OBTAIN;
}}}if(fhxSummaryInd!==""&&recordData.CONDITION_CNT===0){if(fhxSummary===""){fhxSummary=fhxSummaryInd;
}else{fhxSummary+="; "+fhxSummaryInd;
}}if(allHistNeg!==""&&recordData.CONDITION_CNT===0){if(fhxSummary===""){fhxSummary=allHistNeg;
}else{fhxSummary+="; "+allHistNeg;
}}}}catch(err){logger.logJSError(err,this,"consolidated-familyhistory.js","processSummaryLabel");
}return fhxSummary;
},processDataCondView:function(recordData,conditionCount,component){try{var codeArray=MP_Util.LoadCodeListJSON(recordData.CODES);
var compId=component.getComponentId();
var prepareTableFamilyCellData=function(condition){try{var i=0;
if(condition&&condition.FAMILY){condition.REQUEST="--";
var familyLen=condition.FAMILY.length;
var familyDetailsHTML="";
var commentHTML="";
var familyListingHTML="";
var memberDisplay="";
var detailInfo="";
var codeObj="";
var sanitizedComment="";
var SidepanelRenderDetailsObj=function(){return{FAMILY_MEMBER:null,DECEASED_INFO:null,DECEASED_DETAILS:null,ONSET_DATE:null,COMMENTS:[],FULL_NAME:null,LIFECYCLE:null,SEVERITY:null,COURSE:null,LAST_REVIEWED:null};
};
for(i=0;
i<familyLen;
i++){var sidepanelObj=new SidepanelRenderDetailsObj();
var family=condition.FAMILY[i];
var memberOnsetAge="";
if(family.MEMBER){if(family.ONSET_AGE){if(family.ONSET_AGE_PRECISION){memberOnsetAge=family.ONSET_AGE_PRECISION+" "+CERN_FAM_HISTORY_CONSOLIDATED.getAgePhrase(family.ONSET_AGE,family.ONSET_AGEUNIT,1);
}else{memberOnsetAge=fhxi18n.AT_AGE+" "+CERN_FAM_HISTORY_CONSOLIDATED.getAgePhrase(family.ONSET_AGE,family.ONSET_AGEUNIT,1);
}}else{if(family.ONSET_AGE_PRECISION&&family.ONSET_AGE_PRECISION.toUpperCase()==="UNKNOWN"){memberOnsetAge=family.ONSET_AGE_PRECISION;
}}detailInfo=memberOnsetAge?" ("+memberOnsetAge+")":"";
codeObj=MP_Util.GetValueFromArray(family.MEMBER,codeArray);
memberDisplay=codeObj.display;
sidepanelObj.FAMILY_MEMBER=memberDisplay;
sidepanelObj.ONSET_DATE=memberOnsetAge?"("+fhxi18n.ONSET+stdStringSeparator+memberOnsetAge+")":"";
codeObj=MP_Util.GetValueFromArray(family.DECEASED_CD,codeArray);
if(codeObj&&codeObj.meaning==="YES"){var deceased_details=family.DECEASED_DESP?family.DECEASED_DESP:"";
var deceased_age_details="";
if(family.DECEASED_AGE){deceased_age_details=CERN_FAM_HISTORY_CONSOLIDATED.getDeceasedPrecisionFlag(family.DECEASED_AGE_PREC_FLAG)+" "+CERN_FAM_HISTORY_CONSOLIDATED.getAgePhrase(family.DECEASED_AGE,family.DECEASED_AGEUNIT,1);
}else{if(family.DECEASED_AGE_PREC_FLAG===0){deceased_age_details=fhxi18n.AT_AGE+" "+CERN_FAM_HISTORY_CONSOLIDATED.getDeceasedPrecisionFlag(family.DECEASED_AGE_PREC_FLAG);
}}sidepanelObj.DECEASED_INFO=stdStringSeparator+fhxi18n.DECEASED;
if(deceased_details&&deceased_age_details){sidepanelObj.DECEASED_DETAILS="("+deceased_details+stdStringSeparator+deceased_age_details+")";
}else{if(deceased_details||deceased_age_details){sidepanelObj.DECEASED_DETAILS="("+(deceased_details||deceased_age_details)+")";
}}detailInfo+=stdStringSeparator+fhxi18n.DECEASED;
}familyListingHTML+="<div id='condView"+compId+"Item"+i+"' class='chx-fhx-item chx-info result-info'><span>"+memberDisplay+"</span><span class='secondary-text'>"+detailInfo+"</span></div>";
if(family.NAMEFIRST||family.NAMELAST){sidepanelObj.FULL_NAME=(family.NAMEFIRST||"")+" "+(family.NAMELAST||"");
}sidepanelObj.LIFECYCLE=family.LIFECYCLE?family.LIFECYCLE:null;
sidepanelObj.SEVERITY=family.SEVERITY?family.SEVERITY:null;
sidepanelObj.COURSE=family.COURSE?family.COURSE:null;
sidepanelObj.LAST_REVIEWED=family.LASTREVIEWED?CERN_FAM_HISTORY_CONSOLIDATED.formatDate(family.LASTREVIEWED):null;
if(family.COMMENTS&&family.COMMENTS.length){if(family.COMMENTS[0].COMMENT_TEXT){sanitizedComment=CERN_FAM_HISTORY_CONSOLIDATED.sanitizeComment(family.COMMENTS[0].COMMENT_TEXT.replace(/\r\n/g," "));
}sidepanelObj.COMMENTS=family.COMMENTS;
if(!commentHTML){commentHTML="<div class='comment'>";
}commentHTML+="<p class='fhx-comment' title='"+family.COMMENTS[0].COMMENT_TEXT+"'>"+memberDisplay+": "+sanitizedComment+"</p>";
}if(!condition.SP_RENDER_DETAILS){condition.SP_RENDER_DETAILS=[];
}condition.SP_RENDER_DETAILS.push(sidepanelObj);
}}familyDetailsHTML+=familyListingHTML+commentHTML+"</div>";
if(familyDetailsHTML){condition.FAM_COND_DETAILS=familyDetailsHTML;
}}}catch(err){logger.logJSError(err,this,"consolidated-familyhistory.js","prepareTableFamilyCellData");
}};
if(recordData){var condition="";
var group="";
var groupNames=recordData.GroupNames||[];
var i=0,j=0;
var isNullGroupInitialized=false;
if(!recordData.Groups){recordData.Groups={};
var gLen=0;
var otherConditionsGroupName=fhxi18n.OTHER_CONDITIONS;
for(i=0;
i<conditionCount;
i++){condition=recordData.CONDITIONS[i];
gLen=condition.CATEGORY_CNT;
if(gLen){for(j=0;
j<gLen;
j++){group=condition.CATEGORIES[j].CATEGORY;
if(!recordData.Groups.hasOwnProperty(group)){recordData.Groups[group]={conditions:[],name:group};
groupNames.push(group);
}prepareTableFamilyCellData(condition);
recordData.Groups[group].conditions.push(condition);
}}else{if(!recordData.Groups.hasOwnProperty(otherConditionsGroupName)){recordData.Groups[otherConditionsGroupName]={conditions:[],name:otherConditionsGroupName};
isNullGroupInitialized=true;
}prepareTableFamilyCellData(condition);
recordData.Groups[otherConditionsGroupName].conditions.push(condition);
}}groupNames.sort(function(a,b){if(a.toUpperCase()<b.toUpperCase()){return -1;
}return 1;
});
if(isNullGroupInitialized){groupNames.push(otherConditionsGroupName);
}recordData.GroupNames=groupNames;
}}}catch(err){logger.logJSError(err,this,"consolidated-familyhistory.js","processDataCondView");
}},processDataFamilyView:function(recordData,familyMemberDetails,component){try{var codeArray=MP_Util.LoadCodeListJSON(recordData.CODES);
var compId=component.getComponentId();
var i,j;
var commentHTML="";
var currFamilyMemDetail;
var conditionLen;
var famMemAddtnDetails;
var famMemberDisplay;
var familyListingHTML="";
var reusableCodeValObj=null;
var conditionsObj;
var onsetInfo;
var conditionsHTML;
var conditionsCellHTML;
var sanitizedComment="";
var SidepanelRenderDetailsObj=function(){return{CONDITION:null,ONSET_DATE:null,COMMENTS:[],LIFECYCLE:null,SEVERITY:null,COURSE:null,LAST_REVIEWED:null};
};
if(familyMemberDetails){for(i=0;
i<familyMemberDetails.length;
i++){commentHTML="";
currFamilyMemDetail=familyMemberDetails[i];
currFamilyMemDetail.SP_RENDER_MEMBER_DISPLAY_HEADER=null;
currFamilyMemDetail.SP_RENDER_MEMBER_DISPLAY_SUBHEADER=null;
currFamilyMemDetail.SP_RENDER_MEMBER_DISPLAY_SUBHEADER_NAME=null;
currFamilyMemDetail.SP_RENDER_DETAILS=[];
conditionLen=currFamilyMemDetail.COND_CNT;
famMemAddtnDetails="";
famMemberDisplay="";
conditionsObj=null;
conditionsHTML="";
conditionsCellHTML="";
familyListingHTML="";
if(currFamilyMemDetail.MEMBER){reusableCodeValObj=MP_Util.GetValueFromArray(currFamilyMemDetail.MEMBER,codeArray);
famMemberDisplay+=reusableCodeValObj.display;
currFamilyMemDetail.MEMBER_DISPLAY=famMemberDisplay;
currFamilyMemDetail.SP_RENDER_MEMBER_DISPLAY_HEADER=famMemberDisplay;
reusableCodeValObj=MP_Util.GetValueFromArray(currFamilyMemDetail.DECEASED_CD,codeArray);
if(reusableCodeValObj&&reusableCodeValObj.meaning==="YES"){var deceasedAgeStr="";
if(currFamilyMemDetail.DECEASED_AGE){deceasedAgeStr=CERN_FAM_HISTORY_CONSOLIDATED.getDeceasedPrecisionFlag(currFamilyMemDetail.DECEASED_AGE_PREC_FLAG)+" "+CERN_FAM_HISTORY_CONSOLIDATED.getAgePhrase(currFamilyMemDetail.DECEASED_AGE,currFamilyMemDetail.DECEASED_AGEUNIT,1);
}else{if(currFamilyMemDetail.DECEASED_AGE_PREC_FLAG===0){deceasedAgeStr=fhxi18n.AT_AGE+" "+CERN_FAM_HISTORY_CONSOLIDATED.getDeceasedPrecisionFlag(currFamilyMemDetail.DECEASED_AGE_PREC_FLAG);
}}famMemAddtnDetails=stdStringSeparator+fhxi18n.DECEASED;
currFamilyMemDetail.SP_RENDER_MEMBER_DISPLAY_HEADER+=stdStringSeparator+fhxi18n.DECEASED;
currFamilyMemDetail.SP_RENDER_MEMBER_DISPLAY_SUBHEADER=currFamilyMemDetail.DECEASED_DESP;
if(deceasedAgeStr){if(currFamilyMemDetail.DECEASED_DESP){famMemAddtnDetails+=" ("+currFamilyMemDetail.DECEASED_DESP+", "+deceasedAgeStr+")";
currFamilyMemDetail.SP_RENDER_MEMBER_DISPLAY_SUBHEADER+=stdStringSeparator+deceasedAgeStr;
}else{famMemAddtnDetails+=" ("+deceasedAgeStr+")";
currFamilyMemDetail.SP_RENDER_MEMBER_DISPLAY_SUBHEADER+=deceasedAgeStr;
}}else{if(currFamilyMemDetail.DECEASED_DESP){famMemAddtnDetails+=" ("+currFamilyMemDetail.DECEASED_DESP+")";
}}}}familyListingHTML="<div id='familyView"+compId+"Item"+i+"' class='chx-fhx-item chx-info result-info'><span>"+famMemberDisplay+"</span><span class='secondary-text'>"+famMemAddtnDetails+"</span></div>";
currFamilyMemDetail.FAMILY_MEM_DETAILS=familyListingHTML;
if(currFamilyMemDetail.NAMEFIRST||currFamilyMemDetail.NAMELAST){currFamilyMemDetail.SP_RENDER_MEMBER_DISPLAY_SUBHEADER_NAME=(currFamilyMemDetail.NAMEFIRST||"")+" "+(currFamilyMemDetail.NAMELAST||"");
}for(j=0;
j<conditionLen;
j++){var sidepanelObj=new SidepanelRenderDetailsObj();
var onsetAgeStr="";
onsetInfo="";
conditionsObj=currFamilyMemDetail.CONDITION[j];
sidepanelObj.CONDITION=conditionsObj.CONDITION;
if(conditionsObj.ONSET_AGE){if(conditionsObj.ONSET_AGE_PRECISION){onsetAgeStr=conditionsObj.ONSET_AGE_PRECISION+" "+CERN_FAM_HISTORY_CONSOLIDATED.getAgePhrase(conditionsObj.ONSET_AGE,conditionsObj.ONSET_AGEUNIT,1);
}else{onsetAgeStr=fhxi18n.AT_AGE+" "+CERN_FAM_HISTORY_CONSOLIDATED.getAgePhrase(conditionsObj.ONSET_AGE,conditionsObj.ONSET_AGEUNIT,1);
}}else{if(conditionsObj.ONSET_AGE_PRECISION&&conditionsObj.ONSET_AGE_PRECISION.toUpperCase()==="UNKNOWN"){onsetAgeStr=conditionsObj.ONSET_AGE_PRECISION;
}}if(onsetAgeStr){onsetInfo=" ("+onsetAgeStr+")";
sidepanelObj.ONSET_DATE="("+fhxi18n.ONSET+stdStringSeparator+onsetAgeStr+")";
}conditionsHTML+="<div class='chx-fhx-item chx-info result-info'>"+conditionsObj.CONDITION+"<span class='secondary-text'>"+onsetInfo+"</span></div>";
sidepanelObj.LIFECYCLE=conditionsObj.LIFECYCLE?conditionsObj.LIFECYCLE:null;
sidepanelObj.SEVERITY=conditionsObj.SEVERITY?conditionsObj.SEVERITY:null;
sidepanelObj.COURSE=conditionsObj.COURSE?conditionsObj.COURSE:null;
sidepanelObj.LAST_REVIEWED=conditionsObj.LASTREVIEWED?CERN_FAM_HISTORY_CONSOLIDATED.formatDate(conditionsObj.LASTREVIEWED):null;
if(conditionsObj.COMMENTS&&conditionsObj.COMMENTS.length){if(conditionsObj.COMMENTS[0].COMMENT_TEXT){sanitizedComment=CERN_FAM_HISTORY_CONSOLIDATED.sanitizeComment(conditionsObj.COMMENTS[0].COMMENT_TEXT.replace(/\r\n/g," "));
}sidepanelObj.COMMENTS=conditionsObj.COMMENTS;
if(!commentHTML){commentHTML="<div class='comment'>";
}commentHTML+="<p class='fhx-comment' title='"+conditionsObj.COMMENTS[0].COMMENT_TEXT+"'>"+conditionsObj.CONDITION+": "+sanitizedComment+"</p>";
}if(!currFamilyMemDetail.SP_RENDER_DETAILS){currFamilyMemDetail.SP_RENDER_DETAILS=[];
}currFamilyMemDetail.SP_RENDER_DETAILS.push(sidepanelObj);
}conditionsCellHTML=conditionsHTML+commentHTML+"</div>";
if(conditionsCellHTML){currFamilyMemDetail.FAMILY_COND_DETAILS=conditionsCellHTML;
}}}}catch(err){logger.logJSError(err,this,"consolidated-familyhistory.js","processDataFamilyView");
}},prepareConditionViewTable:function(famHxTable,millTableData,tableDataPED,displayPED,component){var tableMarkUp="";
try{var prepareTableGroups=function(){var baseGroupObj={groups:[]};
var ChildGroupObj=function(){return{label:"",expanded:true,records:[]};
};
var i=0,j=0;
if(millTableData){var groupNameLen=millTableData.GroupNames.length;
for(i=0;
i<groupNameLen;
i++){if(millTableData.GroupNames[i]){var group=millTableData.Groups[millTableData.GroupNames[i]];
var conditions=group.conditions;
var conditionsLen=conditions.length;
var tempObj=new ChildGroupObj();
tempObj.label=group.name;
for(j=0;
j<conditionsLen;
j++){tempObj.records.push({CONDITION:conditions[j].CONDITION,FAMILY_MEMBER_DETAILS:conditions[j].FAM_COND_DETAILS,CATEGORY:"MILL",VIEW_IDENTIFIER:"CONDITION",SIDEPANEL_DETAILS:conditions[j].SP_RENDER_DETAILS});
}baseGroupObj.groups.push(tempObj);
}}}if(tableDataPED){var PEDBaseGroupObj;
var PEDRecordsList=[];
for(i=0;
i<tableDataPED.length;
i++){var tableData=tableDataPED[i];
if(tableData){PEDRecordsList.push({REQUEST:tableData.request,ORIG_SOURCE:tableData.origSource,ORIG_AUTHOR:tableData.origAuthor,SUBMITTED_ON_DATE:tableData.date,FAMILY_MEMBER_DETAILS:tableData.familyMember,CONDITION:tableData.condition,CONDITION_ARRAY:tableData.conditionArr,PATIENT_COMMENT:tableData.patientComment,CATEGORY:"PED",EXT_DATA_INFO_ID:tableData.extDataInfoId});
}}PEDBaseGroupObj={groups:[{showCount:true,label:"<span class='chx-pat-req-icon'></span>"+fhxi18n.PATIENT_REQUESTS,expanded:true,collapsible:false,records:PEDRecordsList},{showCount:true,label:fhxi18n.CHART_FAMILY_HISTORY,expanded:true,collapsible:false,groups:baseGroupObj.groups}]};
if(baseGroupObj.groups.length===0){delete PEDBaseGroupObj.groups[1].groups;
PEDBaseGroupObj.groups[1].records=[];
PEDBaseGroupObj.groups[1].showCount=true;
}return PEDBaseGroupObj;
}else{if(!tableDataPED&&displayPED&&millTableData){return{groups:[{showCount:true,label:"<span class='chx-pat-req-icon'></span>"+fhxi18n.PATIENT_REQUESTS,expanded:true,collapsible:false,records:[]},{showCount:true,label:fhxi18n.CHART_FAMILY_HISTORY,expanded:true,collapsible:false,groups:baseGroupObj.groups}]};
}}return baseGroupObj;
};
if(famHxTable){var selection=component.shouldDisplayPatientEnteredData()?MPageUI.TABLE_OPTIONS.SELECT.MULTI_ROW:MPageUI.TABLE_OPTIONS.SELECT.SINGLE_ROW;
famHxTable.setOptions({namespace:"wf-consol-hx-famHx",rows:{striped:true},highlight:MPageUI.TABLE_OPTIONS.HIGHLIGHT.ROW,select:selection});
if(tableDataPED||(displayPED&&millTableData)){famHxTable.setColumns([{id:"request_cond_view_ped",label:fhxi18n.REQUEST,css:"request_cond_view_ped-column",contents:function(record){return(record.REQUEST||"--");
}},{id:"condition_cond_view_ped",label:fhxi18n.CONDITION,css:"condition_cond_view_ped-column",contents:function(record){return record.CONDITION;
}},{id:"fam_member_cond_view_ped",label:fhxi18n.MEMBERS,css:"fam_member_cond_view_ped-column",contents:function(record){return record.FAMILY_MEMBER_DETAILS;
}}]);
}else{famHxTable.setColumns([{id:"condition_cond_view",label:fhxi18n.CONDITION,css:"condition_cond_view-column",contents:function(record){return record.CONDITION;
}},{id:"fam_member_cond_view",label:fhxi18n.MEMBERS,css:"fam_member_cond_view-column",contents:function(record){return record.FAMILY_MEMBER_DETAILS;
}}]);
}famHxTable.setMaxHeight(CERN_FAM_HISTORY_CONSOLIDATED.computeTableHeight(component));
famHxTable.setData(prepareTableGroups());
famHxTable.setOnRowClickCallback(function(data){CERN_FAM_HISTORY_CONSOLIDATED.handleTableRowClick(component,data);
});
tableMarkUp=famHxTable.render();
}}catch(err){logger.logJSError(err,this,"consolidated-familyhistory.js","prepareConditionViewTable");
}return tableMarkUp;
},prepareFamilyViewTable:function(famHxTable,millTableData,tableDataPED,displayPED,component){var tableMarkUp="";
try{var prepareTableGroups=function(){var baseObj={records:[]};
var PEDRecordsList=[];
var i,j;
var PEDBaseGroupObj;
if(millTableData){for(j=0;
j<millTableData.length;
j++){baseObj.records.push({FAMILY_MEMBER_DETAILS:millTableData[j].FAMILY_MEM_DETAILS,CONDITION:millTableData[j].FAMILY_COND_DETAILS,CATEGORY:"MILL",FAMILY_MEMBER:millTableData[j].MEMBER_DISPLAY,VIEW_IDENTIFIER:"FAMILY",SIDEPANEL_HEADER:millTableData[j].SP_RENDER_MEMBER_DISPLAY_HEADER,SIDEPANEL_SUBHEADER:millTableData[j].SP_RENDER_MEMBER_DISPLAY_SUBHEADER,SIDEPANEL_SUBHEADER_NAME:millTableData[j].SP_RENDER_MEMBER_DISPLAY_SUBHEADER_NAME,SIDEPANEL_DETAILS:millTableData[j].SP_RENDER_DETAILS});
}}if(tableDataPED){PEDBaseGroupObj={groups:[{showCount:true,label:"<span class='chx-pat-req-icon'></span>"+fhxi18n.PATIENT_REQUESTS,expanded:true,collapsible:false,records:PEDRecordsList},{showCount:true,label:fhxi18n.CHART_FAMILY_HISTORY,expanded:true,collapsible:false,records:baseObj.records}]};
for(i=0;
i<tableDataPED.length;
i++){var tableData=tableDataPED[i];
if(tableData){PEDRecordsList.push({REQUEST:tableData.request,ORIG_SOURCE:tableData.origSource,ORIG_AUTHOR:tableData.origAuthor,SUBMITTED_ON_DATE:tableData.date,FAMILY_MEMBER_DETAILS:tableData.familyMember,CONDITION:tableData.condition,CONDITION_ARRAY:tableData.conditionArr,PATIENT_COMMENT:tableData.patientComment,CATEGORY:"PED",EXT_DATA_INFO_ID:tableData.extDataInfoId});
}}return PEDBaseGroupObj;
}else{if(!tableDataPED&&displayPED&&millTableData){return{groups:[{showCount:true,label:"<span class='chx-pat-req-icon'></span>"+fhxi18n.PATIENT_REQUESTS,expanded:true,collapsible:false,records:[]},{showCount:true,label:fhxi18n.CHART_FAMILY_HISTORY,expanded:true,collapsible:false,records:baseObj.records}]};
}}return baseObj;
};
if(famHxTable){var selection=component.shouldDisplayPatientEnteredData()?MPageUI.TABLE_OPTIONS.SELECT.MULTI_ROW:MPageUI.TABLE_OPTIONS.SELECT.SINGLE_ROW;
famHxTable.setOptions({namespace:"wf-consol-hx-famHx",sortable:true,rows:{striped:true},highlight:MPageUI.TABLE_OPTIONS.HIGHLIGHT.ROW,select:selection});
if(tableDataPED||(displayPED&&millTableData)){famHxTable.setColumns([{id:"request_fam_view_ped",label:fhxi18n.REQUEST,css:"request_fam_view_ped-column",contents:function(record){return(record.REQUEST||"--");
}},{id:"fam_member_fam_view_ped",label:fhxi18n.MEMBERS,css:"fam_member_fam_view_ped-column",contents:function(record){return record.FAMILY_MEMBER_DETAILS;
},sortOptions:{primary:{field:"FAMILY_MEMBER",direction:MPageUI.TABLE_OPTIONS.SORT.ASCENDING}}},{id:"condition_fam_view_ped",label:fhxi18n.CONDITION,css:"condition_fam_view_ped-column",contents:function(record){return record.CONDITION;
}}]);
famHxTable.sortBy({column:{id:"fam_member_fam_view_ped",direction:MPageUI.TABLE_OPTIONS.SORT.ASCENDING}});
}else{famHxTable.setColumns([{id:"fam_member_fam_view",label:fhxi18n.MEMBERS,css:"fam_member_fam_view-column",contents:function(record){return record.FAMILY_MEMBER_DETAILS;
},sortOptions:{primary:{field:"FAMILY_MEMBER",direction:MPageUI.TABLE_OPTIONS.SORT.ASCENDING}}},{id:"condition_fam_view",label:fhxi18n.CONDITION,css:"condition_fam_view-column",contents:function(record){return record.CONDITION;
}}]);
famHxTable.sortBy({column:{id:"fam_member_fam_view",direction:MPageUI.TABLE_OPTIONS.SORT.ASCENDING}});
}famHxTable.setMaxHeight(CERN_FAM_HISTORY_CONSOLIDATED.computeTableHeight(component));
famHxTable.setData(prepareTableGroups());
famHxTable.setOnRowClickCallback(function(data){CERN_FAM_HISTORY_CONSOLIDATED.handleTableRowClick(component,data);
});
tableMarkUp=famHxTable.render();
}}catch(err){logger.logJSError(err,this,"consolidated-familyhistory.js","prepareFamilyViewTable");
}return tableMarkUp;
},attachOutsideRecordsEvent:function(component){var sidePanelContainer=$("#famHxSidePanelContainer"+component.getComponentId());
sidePanelContainer.off("click",".chx-side-panel-tgl");
sidePanelContainer.on("click",".chx-side-panel-tgl",function(){var $patReqSubSection=sidePanelContainer.find(".chx-expand-content");
var $hideExpandButton=sidePanelContainer.find(".chx-hide-expand-btn");
var $outsideRecordsTarget=$hideExpandButton.length?$hideExpandButton:sidePanelContainer.find(".chx-show-expand-btn");
if($patReqSubSection.hasClass("chx-section-closed")){$outsideRecordsTarget.removeClass("chx-show-expand-btn").addClass("chx-hide-expand-btn");
$patReqSubSection.removeClass("chx-section-closed");
}else{$outsideRecordsTarget.removeClass("chx-hide-expand-btn").addClass("chx-show-expand-btn");
$patReqSubSection.addClass("chx-section-closed");
}});
},getAgePhrase:function(age,unit,yearEnabled){var agePhrase="";
switch(unit){case"YEARS":case"":if(yearEnabled){agePhrase=i18n.discernabu.X_YEARS.replace("{0}",age);
}else{agePhrase=age;
}break;
case"MONTHS":agePhrase=i18n.discernabu.X_MONTHS.replace("{0}",age);
break;
case"DAYS":agePhrase=i18n.discernabu.X_DAYS.replace("{0}",age);
break;
case"WEEKS":agePhrase=i18n.discernabu.X_WEEKS.replace("{0}",age);
break;
default:agePhrase=age;
}return agePhrase;
},sanitizeComment:function(unsanitizedComment){return unsanitizedComment.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\r\n/g,"<br />");
},formatDate:function(date,dateFormat){if(!date){return"--";
}var formattedDate=new Date();
formattedDate.setISO8601(date);
if(!dateFormat){formattedDate=formattedDate.format("shortDate2");
}else{formattedDate=formattedDate.format(dateFormat);
}return formattedDate;
},computeTableHeight:function(component){var viewPointBodyObj=$("#vwpBody");
var chxHeaderHeight=92;
var viewPointBodyHeight=viewPointBodyObj?viewPointBodyObj.height():400;
var tabControlObj=$("#tabData"+component.getComponentId());
var tabControlHeight=tabControlObj?tabControlObj.height():0;
var fhxBannerContainerObj=$("#fhxErrorBannerContainer"+component.getComponentId());
var fhxBannerContainerHeight=fhxBannerContainerObj?fhxBannerContainerObj.height():0;
var fhxPEDAckBannerObj=$(".chx-ack-banner-container");
var fhxPEDAckBannerHeight=fhxPEDAckBannerObj?fhxPEDAckBannerObj.height():0;
return viewPointBodyHeight-(chxHeaderHeight+tabControlHeight+fhxBannerContainerHeight+fhxPEDAckBannerHeight);
},isInvalidSelection:function(rowArr){var len=rowArr.length;
for(var i=0;
i<len;
i++){if(rowArr[i].record.CATEGORY==="MILL"){return true;
}}return false;
},handleTableRowClick:function(component,data){var self=CERN_FAM_HISTORY_CONSOLIDATED;
var sidePanel=component.famHxSidePanel;
var rowSelectionArr=component.famHxTable.getSelectionData();
var selectionCnt=rowSelectionArr.length;
if(sidePanel){sidePanel.m_sidePanel.removeAlertBanner();
}if(!selectionCnt){sidePanel.m_sidePanel.m_cornerCloseButton.click();
}else{if(selectionCnt===1){self.activateSidepanel(component,data,false);
}else{if(component.shouldDisplayPatientEnteredData()){self.activateSidepanel(component,data,true);
sidePanel=component.famHxSidePanel;
if(self.isInvalidSelection(rowSelectionArr)){self.displayInvalidSelectionBanner(sidePanel.m_sidePanel);
sidePanel.m_sidePanel.collapseSidePanel();
sidePanel.m_sidePanel.resizePanel();
sidePanel.m_sidePanel.expandSidePanel();
}}}}},displayInvalidSelectionBanner:function(sidePanel){var invalidSelectionBanner=new MPageUI.AlertBanner();
invalidSelectionBanner.setType(MPageUI.ALERT_OPTIONS.TYPE.INFO);
invalidSelectionBanner.setSecondaryText(fhxi18n.INVALID_SELECTION);
sidePanel.setAlertBannerAsHTML(invalidSelectionBanner.render());
},getSidePanelHTMLMarkup:function(component){var htmlMarkup="";
if(component.famHxTable.getSelectionData().length>1){htmlMarkup=CERN_FAM_HISTORY_CONSOLIDATED.createMultiRowPEDMarkup(component);
}else{htmlMarkup=CERN_FAM_HISTORY_CONSOLIDATED.createSingleRowPEDMarkup(component);
}return htmlMarkup;
},createSingleRowPEDMarkup:function(component){var rowInformation=component.famHxTable.getSelectionData()[0].record;
var compId=component.getComponentId();
var additionHeader=fhxi18n.ADDITION;
var conditionHeader=fhxi18n.CONDITION;
var origSourceHeader=fhxi18n.ORIGINATING_SOURCE;
var origAuthorHeader=fhxi18n.ORIGINATING_AUTHOR;
var patientCommentHeader=fhxi18n.PATIENT_COMMENT;
var conditionText=rowInformation.CONDITION_ARRAY.join(", ");
var additionText=fhxi18n.ADD+" "+rowInformation.FAMILY_MEMBER_DETAILS;
var origSourceText=rowInformation.ORIG_SOURCE;
var origAuthorText=rowInformation.ORIG_AUTHOR;
var patientCommentText=rowInformation.PATIENT_COMMENT||"--";
var outsideRecordsDtDisplay=rowInformation.SUBMITTED_ON_DATE;
var htmlMarkup='<div id = "sidePanelScrollContainer'+compId+'" class="chx-sp-body-contents"><dl class="chx-sp-detail-group"><dt class="chx-expand-content-section"><span title="collapse" class="chx-side-panel-tgl chx-hide-expand-btn">&nbsp;</span><span class="chx-pat-req-icon chx-side-panel-tgl chx-fhx-pointer">&nbsp;</span><span class="chx-side-panel-tgl chx-fhx-pointer">'+fhxi18n.OUTSIDE_REQUESTS+'</span><span class="chx-pull-right">'+outsideRecordsDtDisplay+'</span></dt></dl><div class="chx-expand-content"><dl><dd><dl class="chx-sp-detail-group"><dt class="chx-request-label">'+additionHeader+"</dt><dt>"+additionText+'</dt></dl></dd><dd><dl class="chx-sp-detail-group"><dt class="chx-request-label">'+conditionHeader+"</dt><dt>"+conditionText+'</dt></dl></dd><dd class="chx-sp-detail-group"><dl class="chx-sp-details-sub-section"><dt class="chx-request-label">'+origSourceHeader+"</dt><dd>"+origSourceText+'</dd></dl><dl class="chx-sp-details-sub-section"><dt class="chx-request-label">'+origAuthorHeader+"</dt><dd>"+origAuthorText+'</dd></dl></dd><dd><dl><dt class="chx-request-label">'+patientCommentHeader+"</dt><dd>"+patientCommentText+'</dd></dl></dd></dl></div></div><div class="sp-separator2">&nbsp;</div>';
return htmlMarkup;
},createMultiRowPEDMarkup:function(component){var multiRowArr=component.famHxTable.getSelectionData();
var batchActionMessage=this.getBatchActionUnavailableMessage(multiRowArr);
var compId=component.getComponentId();
var displayArr=[];
var content;
var i;
var arrCondition=[];
var arrFamily=[];
var arrPED=multiRowArr.filter(function(row){return row.record.CATEGORY==="PED";
}).map(function(row){return $(row.record.FAMILY_MEMBER_DETAILS).find("span:first-child").text()||row.record.FAMILY_MEMBER_DETAILS;
});
var arrMILL=multiRowArr.filter(function(row){return row.record.CATEGORY==="MILL";
});
if(component.getFamHxView()==="Family"){arrFamily=arrMILL.map(function(row){var familyMemberDetails=$(row.record.FAMILY_MEMBER_DETAILS).find("span:first-child").text()||row.record.FAMILY_MEMBER_DETAILS;
return familyMemberDetails+" "+batchActionMessage;
});
}else{arrCondition=arrMILL.map(function(row){return row.record.CONDITION+" "+batchActionMessage;
});
}displayArr=arrPED.concat(arrFamily);
displayArr.sort();
arrCondition.sort();
displayArr=displayArr.concat(arrCondition);
var html='<div id="sidePanelScrollContainer'+compId+'">';
for(var j=0;
j<displayArr.length;
j++){html+='<div class="chx-expand-content"><dl><dd><dl class="chx-sp-detail-group"><dt class="chx-seg-control-container">'+displayArr[j]+'</dt></dl></dd></dl></div><div class="sp-separator2">&nbsp;</div>';
}html+="</div>";
return html;
},getBatchActionUnavailableMessage:function(selectedRowArr){var rowCount=selectedRowArr.length;
var pedRowIndicator=false;
var millRowIndicator=false;
for(var i=0;
i<rowCount;
i++){var rowType=selectedRowArr[i].record.CATEGORY;
if(rowType==="PED"){pedRowIndicator=true;
}else{if(rowType==="MILL"){millRowIndicator=true;
}}}var unavailableMessage=(pedRowIndicator&&millRowIndicator)?'<span class="secondary-text chx-batch-act-unavailable">('+fhxi18n.BATCH_ACTIONS_UNAVAILABLE+")</span>":"";
return unavailableMessage;
},getSidePanelHeaderText:function(component){var selectedRowInfo=component.famHxTable.getSelectionData();
var rowCount=selectedRowInfo.length;
var header=selectedRowInfo[0].record.FAMILY_MEMBER_DETAILS||"--";
if(rowCount>1){header=rowCount+" "+fhxi18n.ITEMS_SELECTED;
}return header;
},activateSidepanel:function(component,rowData,isMultiRow){try{if(component&&rowData){if(!component.famHxTable){return;
}var selectionData=component.famHxTable.getSelectionData();
var rowCount=selectionData.length;
var currentSelectedRow=selectionData[rowCount-1].record;
var rowType=currentSelectedRow.CATEGORY;
var compId=component.getComponentId();
var sidePanelContainer=$("#famHxSidePanelContainer"+compId);
var famUpdatePriv=component.getFamRecordData().UPDATE_FAM_HIST_PRIV||0;
var isInvalidSelection=CERN_FAM_HISTORY_CONSOLIDATED.isInvalidSelection(selectionData);
var getTableRowId=function(data){var tableRowSelected=null;
if(data&&data.event){tableRowSelected=$(data.event.currentTarget).attr("id");
}return tableRowSelected;
};
var scrollToSelectedRow=function(selectedRow){if(selectedRow.length){var tableContainer=component.famHxTable.getRootElement().find(".table-body");
var docViewTop=$(window).scrollTop();
var docViewBottom=docViewTop+$(window).height();
var elemTop=selectedRow.offset().top;
var elemBottom=elemTop+selectedRow.height();
var isElementVisible=((elemBottom<=docViewBottom)&&(elemTop>=docViewTop));
if(!isElementVisible){tableContainer.scrollTo("#"+selectedRow.attr("id"));
}}};
var computeSidepanelHeight=function(){var tableContainer=component.famHxTable.getRootElement();
if(!tableContainer){return"200px";
}return tableContainer.height()+"px";
};
if(!component.famHxSidePanel){component.famHxSidePanel={m_isSidepanelCreated:false,m_doesSidePanelExist:false,m_sidePanelMinHeight:"175px",m_sidePanel:null,m_lastRowSelected:null};
}if(sidePanelContainer&&sidePanelContainer.length){var sidePanelProp=component.famHxSidePanel;
if(!sidePanelProp.m_isSidepanelCreated){var actionHolderHTML="<div class='famHxSP-action-holder' id='actionBtnHolder"+compId+"'></div>";
sidePanelProp.m_isSidepanelCreated=true;
sidePanelProp.m_sidePanel=new CompSidePanel(compId,sidePanelContainer.attr("id"));
sidePanelProp.m_doesSidePanelExist=true;
sidePanelProp.m_sidePanel.setExpandOption(sidePanelProp.m_sidePanel.expandOption.EXPAND_DOWN);
sidePanelProp.m_sidePanel.setMinHeight(sidePanelProp.m_sidePanelMinHeight);
sidePanelProp.m_sidePanel.setOffsetHeight(45);
sidePanelProp.m_sidePanel.renderPreBuiltSidePanel();
if(rowType==="MILL"&&!isMultiRow){CERN_FAM_HISTORY_CONSOLIDATED.loadMillSidepanelData(rowData.records[0],sidePanelProp.m_sidePanel,component);
}else{CERN_FAM_HISTORY_CONSOLIDATED.loadPEDSidepanelData(component,sidePanelProp.m_sidePanel);
}CERN_FAM_HISTORY_CONSOLIDATED.addSPDetailsClickEvent("famHxSidePanelContainer",component);
sidePanelProp.m_sidePanel.setActionsAsHTML(actionHolderHTML);
sidePanelProp.m_sidePanel.showCornerCloseButton();
sidePanelProp.m_sidePanel.setCornerCloseFunction(function(){$(".wf-consol-hx-famHx").removeClass("side-panel-active");
sidePanelContainer.removeClass("side-panel-active");
component.famHxTable.deselectAll();
sidePanelProp.m_lastRowSelected=null;
sidePanelProp.m_doesSidePanelExist=false;
});
sidePanelProp.m_lastRowSelected=getTableRowId(rowData);
$(".wf-consol-hx-famHx").addClass("side-panel-active");
sidePanelContainer.addClass("side-panel-active");
sidePanelProp.m_sidePanel.setHeight(computeSidepanelHeight());
sidePanelProp.m_sidePanel.expandSidePanel();
scrollToSelectedRow($(rowData.event.currentTarget));
}else{if(sidePanelProp.m_sidePanel){$(".wf-consol-hx-famHx").addClass("side-panel-active");
sidePanelContainer.addClass("side-panel-active");
sidePanelProp.m_sidePanel.setHeight(computeSidepanelHeight());
if(rowType==="MILL"&&!isMultiRow){CERN_FAM_HISTORY_CONSOLIDATED.loadMillSidepanelData(currentSelectedRow,sidePanelProp.m_sidePanel,component);
}else{CERN_FAM_HISTORY_CONSOLIDATED.loadPEDSidepanelData(component,sidePanelProp.m_sidePanel);
}sidePanelProp.m_sidePanel.showPanel();
sidePanelProp.m_sidePanel.expandSidePanel();
scrollToSelectedRow($(rowData.event.currentTarget));
}}if(famUpdatePriv&&!isInvalidSelection){var removeRequestButton=CERN_FAM_HISTORY_CONSOLIDATED_PED.createRemoveRequestButton(component,rowCount);
sidePanelProp.m_sidePanel.setActionsAsHTML(removeRequestButton.render());
removeRequestButton.attachEvents();
component.famHxRemoveRequestBtn=removeRequestButton;
}else{if(component.famHxRemoveRequestBtn){sidePanelProp.m_sidePanel.setActionsAsHTML("");
}}}}CERN_FAM_HISTORY_CONSOLIDATED.attachOutsideRecordsEvent(component);
}catch(err){logger.logJSError(err,this,"consolidated-familyhistory.js","activateSidePanel");
}},loadPEDSidepanelData:function(component,sidePanel){var titleTextHeader=CERN_FAM_HISTORY_CONSOLIDATED.getSidePanelHeaderText(component);
var sidePanelMarkup=CERN_FAM_HISTORY_CONSOLIDATED.getSidePanelHTMLMarkup(component);
sidePanel.setTitleText(titleTextHeader);
sidePanel.setSubtitleAsHTML("");
sidePanel.setContents(sidePanelMarkup,"sidePanelBodyContents"+component.getComponentId());
},loadMillSidepanelData:function(rowData,spObj,component){try{var compId=component.getComponentId();
var spDetailsObj=null;
var spHeaderStr="";
var spSubHeaderStr="";
var sidepanelHTML="";
if(rowData&&spObj){if(rowData.VIEW_IDENTIFIER==="FAMILY"){spDetailsObj=rowData.SIDEPANEL_DETAILS;
spHeaderStr=rowData.SIDEPANEL_HEADER;
spSubHeaderStr=rowData.SIDEPANEL_SUBHEADER;
if(spDetailsObj&&spHeaderStr){spObj.setTitleText(spHeaderStr);
if(spSubHeaderStr||rowData.SIDEPANEL_SUBHEADER_NAME){var subtitleHTML="";
if(spSubHeaderStr){subtitleHTML+="<div>"+spSubHeaderStr+"</div>";
}if(rowData.SIDEPANEL_SUBHEADER_NAME){subtitleHTML+="<div><span class='secondary-text'>"+fhxi18n.NAME+": </span><span>"+rowData.SIDEPANEL_SUBHEADER_NAME+"</span></div>";
}spObj.setSubtitleAsHTML(subtitleHTML);
}else{spObj.removeSubtitle();
}sidepanelHTML="<div id='sidePanelScrollContainer"+compId+"' class='sp-body-content-area'>"+CERN_FAM_HISTORY_CONSOLIDATED.prepareSidepanelDetails(spDetailsObj,rowData.VIEW_IDENTIFIER,component)+"</div>";
spObj.setContents(sidepanelHTML,"tabContentsContainer"+compId);
}}else{spDetailsObj=rowData.SIDEPANEL_DETAILS;
if(spDetailsObj){spObj.setTitleText(rowData.CONDITION);
sidepanelHTML="<div id='sidePanelScrollContainer"+compId+"' class='sp-body-content-area'>"+CERN_FAM_HISTORY_CONSOLIDATED.prepareSidepanelDetails(spDetailsObj,rowData.VIEW_IDENTIFIER,component)+"</div>";
spObj.setContents(sidepanelHTML,"tabContentsContainer"+compId);
}}CERN_FAM_HISTORY_CONSOLIDATED.resizeComponent(component);
}}catch(err){logger.logJSError(err,this,"consolidated-familyhistory.js","loadMillSidepanelData");
}},prepareSidepanelDetails:function(spData,view,component){try{var i=0;
var j=0;
var sidePanelInfoHTML="";
var compId=component.getComponentId();
if(spData&&view){var spItemHeaderHTML;
var spItemCommentsHTML;
var spItemExtraDetailsHTML;
var spItemCommentsShowAllLink;
for(i=0;
i<spData.length;
i++){spItemHeaderHTML="";
spItemCommentsHTML="";
spItemExtraDetailsHTML="";
spItemCommentsShowAllLink="";
if(view==="FAMILY"){spItemHeaderHTML="<div class='wf-consol-hx-famHx-sp-header-item'>"+spData[i].CONDITION+"<span class='wf-consol-hx-famHx-sp-header-onset secondary-text'>"+(spData[i].ONSET_DATE||"")+"</span></div>";
}else{spItemHeaderHTML="<div class='wf-consol-hx-famHx-sp-header-item'>"+spData[i].FAMILY_MEMBER+"<span class='wf-consol-hx-famHx-sp-deceased-info secondary-text'>"+(spData[i].DECEASED_INFO||"")+"</span><span class='wf-consol-hx-famHx-sp-header-onset secondary-text'>"+(spData[i].ONSET_DATE||"")+"</span><span class='wf-consol-hx-famHx-sp-deceased-details secondary-text'>"+(spData[i].DECEASED_DETAILS||"")+"</span></div>";
}if(spData[i].LIFECYCLE){spItemExtraDetailsHTML+="<div><span class='secondary-text'>"+fhxi18n.LIFECYCLE+": </span><span>"+spData[i].LIFECYCLE+"</span></div>";
}if(spData[i].FULL_NAME){spItemExtraDetailsHTML+="<div><span class='secondary-text'>"+fhxi18n.NAME+": </span><span>"+spData[i].FULL_NAME+"</span></div>";
}if(spData[i].SEVERITY){spItemExtraDetailsHTML+="<div><span class='secondary-text'>"+fhxi18n.SEVERITY+": </span><span>"+spData[i].SEVERITY+"</span></div>";
}if(spData[i].COURSE){spItemExtraDetailsHTML+="<div><span class='secondary-text'>"+fhxi18n.COURSE+": </span><span>"+spData[i].COURSE+"</span></div>";
}if(spData[i].LAST_REVIEWED){spItemExtraDetailsHTML+="<div><span class='secondary-text'>"+fhxi18n.LASTREVIEWED+": </span><span>"+spData[i].LAST_REVIEWED+"</span></div>";
}if(spData[i].COMMENTS&&spData[i].COMMENTS.length){var commentsHTML="";
var commentsLen=spData[i].COMMENTS.length;
if(commentsLen){if(spData[i].COMMENTS[0].COMMENT_TEXT){commentsHTML+="<div><div class='wf-consol-hx-famHx-sp-comment-item'>"+CERN_FAM_HISTORY_CONSOLIDATED.sanitizeComment(spData[i].COMMENTS[0].COMMENT_TEXT)+"</div>";
commentsHTML+="<div class='wf-consol-hx-famHx-sp-comment-details secondary-text'>"+(CERN_FAM_HISTORY_CONSOLIDATED.trackPersonnelId(spData[i].COMMENTS[0].COMMENT_AUTHOR_ID,component.famRecordData.PRSNL)||"");
commentsHTML+="<span class='wf-consol-hx-famHx-sp-comment-date'>"+CERN_FAM_HISTORY_CONSOLIDATED.formatDate(spData[i].COMMENTS[0].COMMENT_DT_TM,"mediumDate")+"</span></div></div>";
}}if(commentsLen>1){spItemCommentsShowAllLink="<a id='showAllComments"+compId+"Link"+i+"' href='#!' data-comment-count='"+commentsLen+"' data-comment-text-toggled=0 class='wf-consol-hx-famHx-sp-showAll-link'>"+fhxi18n.SHOW_ALL_COMMENTS.replace("{0}","("+commentsLen+")")+"</a>";
for(j=1;
j<commentsLen;
j++){if(spData[i].COMMENTS[j].COMMENT_TEXT){commentsHTML+="<div class='wf-consol-hx-famHx-sp-hide-comment'><div class='wf-consol-hx-famHx-sp-comment-item'>"+CERN_FAM_HISTORY_CONSOLIDATED.sanitizeComment(spData[i].COMMENTS[j].COMMENT_TEXT)+"</div>";
commentsHTML+="<div class='wf-consol-hx-famHx-sp-comment-details secondary-text'>"+(CERN_FAM_HISTORY_CONSOLIDATED.trackPersonnelId(spData[i].COMMENTS[j].COMMENT_AUTHOR_ID,component.famRecordData.PRSNL)||"");
commentsHTML+="<span class='wf-consol-hx-famHx-sp-comment-date'>"+CERN_FAM_HISTORY_CONSOLIDATED.formatDate(spData[i].COMMENTS[j].COMMENT_DT_TM,"mediumDate")+"</span></div></div>";
}}}spItemCommentsHTML="<div class='secondary-text'>"+fhxi18n.COMMENTS+": </div>"+commentsHTML;
}sidePanelInfoHTML+="<div id='spContainerBody"+compId+"Item"+i+"' class='wf-consol-hx-famHx-sp-content-data'>"+spItemHeaderHTML+"<div class='wf-consol-hx-famHx-sp-content-container'>"+(spItemExtraDetailsHTML?"<div class='wf-consol-hx-famHx-sp-content-details'>"+spItemExtraDetailsHTML+"</div>":"")+(spItemCommentsHTML?"<div class='wf-consol-hx-famHx-sp-comment'>"+spItemCommentsHTML+"</div>"+spItemCommentsShowAllLink:"")+"</div></div>";
}}return sidePanelInfoHTML;
}catch(err){logger.logJSError(err,this,"consolidated-familyhistory.js","prepareSidepanelDetails");
}},addSPDetailsClickEvent:function(containerId,component){try{if(containerId&&component){var compId=component.getComponentId();
$("#"+containerId+compId).on("click",".wf-consol-hx-famHx-sp-showAll-link",component,function(){$(this).parent().find("div .wf-consol-hx-famHx-sp-hide-comment").toggle();
component.famHxSidePanel.m_sidePanel.expandSidePanel();
if(parseInt($(this).attr("data-comment-text-toggled"),10)){$(this).text(fhxi18n.SHOW_ALL_COMMENTS.replace("{0}","("+$(this).attr("data-comment-count")+")"));
$(this).attr("data-comment-text-toggled","0");
}else{$(this).text(fhxi18n.SHOW_LESS_COMMENTS);
$(this).attr("data-comment-text-toggled","1");
}});
}}catch(err){logger.logJSError(err,this,"consolidated-familyhistory.js","addSPDetailsClickEvent");
}},trackPersonnelId:function(prnslId,personnelList){try{var authorFullName="";
var i=0;
if(prnslId&&personnelList&&personnelList.length){for(i=0;
i<personnelList.length;
i++){if(prnslId===personnelList[i].ID){authorFullName=personnelList[i].PROVIDER_NAME.NAME_FULL;
}}}return authorFullName;
}catch(err){logger.logJSError(err,this,"consolidated-familyhistory.js","trackPersonnelId");
}},getDeceasedPrecisionFlag:function(flagId){try{switch(flagId){case 0:return fhxi18n.UNKNOWN;
case 1:return fhxi18n.BEFORE;
case 2:return fhxi18n.AFTER;
case 3:return fhxi18n.ABOUT;
default:return fhxi18n.AT_AGE;
}}catch(err){logger.logJSError(err,this,"consolidated-familyhistory.js","getDeceasedPrecisionFlag");
}}};
}();
