/* eslint
 "no-underscore-dangle": [2, { "allowAfterThis": true, "allow": ["_state"] }]
 */

import { KEY_CODES } from "../const";

/**
 * Handles the TextBox key down event.
 * @param {SearchBar} control - The search bar instance.
 * @param {string} eventName - The event name.
 * @returns {function} The handler for the TextBox key down event.
 */
const handleTextBoxKeyDown = (control, eventName) => (e) => {
    control.stopPropagation(eventName);

    // Check if it's a navigation event
    if (e.keyCode === KEY_CODES.ARROW_UP || e.keyCode === KEY_CODES.ARROW_DOWN) {
        /*
         * Prevent default behavior, otherwise this could cause the
         * page to scroll.
         */
        e.preventDefault();

        control.emit(
            control.getProp("navigationEventName"), control,
            e.keyCode, (e.keyCode === KEY_CODES.ARROW_DOWN ? 1 : -1)
        );
    }
};

/**
 * Handles the TextBox key up event.
 * @param {SearchBar} control - The search bar instance.
 * @param {string} eventName - The event name.
 * @returns {function} The handler for the TextBox key up event.
 */
const handleTextBoxKeyUp = (control, eventName) => (e) => {
    control.stopPropagation(eventName);

    // Confirm
    if (e.keyCode === KEY_CODES.ENTER) {
        control.emit(control.getProp("confirmEventName"), control);
    }

    // Cancel (treated as input)
    if (e.keyCode === KEY_CODES.ESC) {
        control.getChild("textBox")
            .setProp("value", "");

        control.getChild("searchTextClearIcon")
            .setProp("isClearIconVisible", false);

        control.update();

        // De-bounce
        clearTimeout(control._state.inputDebounce);
        control._state.inputDebounce = setTimeout(() => {
            control.emit(control.getProp("inputEventName"), control, "");
        }, control.getProp("throttle"));
    }
};

/**
 * Handles the TextBox input event.
 * @param {SearchBar} control - The search bar instance.
 * @param {string} eventName - The event name.
 * @returns {function} The handler for the TextBox input event.
 */
const handleTextBoxInput = (control, eventName) => (src, value) => {
    control.stopPropagation(eventName);

    control.getChild("searchTextClearIcon")
        .setProp("isClearIconVisible", !!value);

    control.update();

    // De-bounce
    clearTimeout(control._state.inputDebounce);
    control._state.inputDebounce = setTimeout(() => {
        control.emit(control.getProp("inputEventName"), control, value);
    }, control.getProp("throttle"));
};

/**
 * Handles the clear button click (the x button). This is treated as input, since it modifies
 * the input value.
 * @param {SearchBar} control - The search bar instance.
 * @param {string} eventName - The event name.
 * @returns {function} The handler for the clear button click.
 */
const handleClearClick = (control, eventName) => () => {
    control.stopPropagation(eventName);

    control.getChild("textBox")
        .setProp("value", "");

    control.getChild("searchTextClearIcon")
        .setProp("isClearIconVisible", false);

    control.update();

    // De-bounce
    clearTimeout(control._state.inputDebounce);
    control._state.inputDebounce = setTimeout(() => {
        control.emit(control.getProp("inputEventName"), control, "");
    }, control.getProp("throttle"));
};

export {
    handleClearClick,
    handleTextBoxKeyDown,
    handleTextBoxKeyUp,
    handleTextBoxInput
};
