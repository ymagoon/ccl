"use strict";
function HIVProfileComponentStyle(){this.initByNamespace("hivprofile");
}HIVProfileComponentStyle.inherits(ComponentStyle);
function HIVProfileComponent(criterion){var that,prEventCode,rtEventCode,prNoMutationsFilter,rtNoMutationsFilter,disclaimerText;
var hiv_i18n=i18n.discernabu.hiv_profile_o1;
var finalReportEventCode=[];
that=this;
function contentNode(){return $(".sec-content","#"+that.getRootComponentNode().id);
}function rootNode(){return $(".sec-total","#"+that.getRootComponentNode().id);
}function getHTML(){return['<div class="content-hdr">                              ','  <table class="lab-table">                                 ',"    <tbody>                                                 ",'      <tr class="lab-hdr">                                  ','        <th class="lab-res1">                               ','          <span id="currentLabel">&nbsp;</span>             ',"        </th>                                               ",'        <th class="lab-res2">                               ','          <span id="summationLabel">&nbsp;</span>           ',"        </th>                                               ","      </tr>                                                 ","    </tbody>                                                ","  </table>                                                  ","</div>                                                      ","<!-- PR mutation sub section -->                            ",'<div class="sub-sec">                                       ','  <h3 class="sub-sec-hd">                                   ','    <span id="prLabel" class="sub-sec-title">&nbsp;</span>  ',"  </h3>                                                     ",'  <div class="sub-sec-content">                             ','    <table class="lab-table">                               ',"      <tbody>                                               ",'        <tr class="even">                                   ',"<!-- current -->                                            ",'          <td class="lab-res0">                             ','              <div id="prCurrentResults">                   ','                <span class="lab-info">--</span>            ',"              </div>                                        ",'              <span id="prCurrentWithin" class="within"/>   ',"          </td>                                             ","<!-- summation -->                                          ",'          <td class="lab-res1">                             ','            <div id="prSummationResults">                   ','              <span class="lab-info">--</span>              ',"            </div>                                          ",'            <span id="prSummationSince" class="within"/>    ',"          </td>                                             ","        </tr>                                               ","      </tbody>                                              ","    </table>                                                ","  </div>                                                    ","<!-- RT mutation sub section -->                            ",'<div class="sub-sec">                                       ','  <h3 class="sub-sec-hd">                                   ','    <span id="rtLabel" class="sub-sec-title">&nbsp;</span>  ',"  </h3>                                                     ",'  <div class="sub-sec-content">                             ','    <table class="lab-table">                               ',"      <tbody>                                               ",'        <tr class="even">                                   ',"<!-- current -->                                            ",'          <td class="lab-res0">                             ','              <div id="rtCurrentResults">                   ','                <span class="lab-info">--</span>            ',"              </div>                                        ",'              <span id="rtCurrentWithin" class="within"/>   ',"          </td>                                             ","<!-- summation -->                                          ",'          <td class="lab-res1">                             ','            <div id="rtSummationResults">                   ','              <span class="lab-info">--</span>              ',"            </div>                                          ",'            <span id="rtSummationSince" class="within"/>    ',"          </td>                                             ","        </tr>                                               ","      </tbody>                                              ","    </table>                                                ","  </div>                                                    ","</div>                                                      ",'<div class="content-hdr">                                   ','  <table class="lab-table">                                 ',"    <tbody>                                                 ",'      <tr class="lab-hdr">                                  ','        <th class="lab-res1  hiv-report-hdr" colspan="2">   ','          <span id="hivDisclaimer">                         ',"            &nbsp;                                          ","          </span>                                           ","        </th>                                               ","      </tr>                                                 ","    </tbody>                                                ","  </table>                                                  ","</div>"].join("");
}function getFinalReportHTML(){return['<div id="finalReportSection" class="sub-sec">          ','  <h3 class="sub-sec-hd">                                   ','    <span id="finalReportLabel" class="sub-sec-title">      ',"      &nbsp;                                                ","    </span>                                                 ","  </h3>                                                     ",'  <div class="sub-sec-content">                             ','    <table class="lab-table">                               ',"      <tbody>                                               ",'        <tr class="even">                                   ','          <td class="lab-res0">                             ','            <ul id="finalReportContent" class="lab-info">   ',"              <li>--</li>                                   ","            </ul>                                           ","          </td>                                             ","        </tr>                                               ","    </tbody>                                                ","</table>                                                    ","</div>"].join("");
}function ajaCcl(settings){var criterion,options,info,sendAr;
sendAr=[];
criterion=that.getCriterion();
options=$.extend({success:function(){},error:function(){},zero:function(){},output:"^MINE^",patientId:criterion.person_id.toFixed(1),encounterIds:0,personnelId:criterion.provider_id.toFixed(1),numberOfResults:10000,eventCodes:0,eventSetCodes:0,classifications:"^measurement^",lookbackUnits:that.getLookbackUnits(),positionCodes:criterion.position_cd.toFixed(1),pprCode:criterion.ppr_cd.toFixed(1),lookbackUnitType:that.getLookbackUnitTypeFlag()},settings);
info=new XMLCclRequest();
info.onreadystatechange=function(){var jsonEval,callback,data,cclStatus;
if(info.readyState===4){jsonEval=JSON.parse(info.responseText);
callback=options.complete;
if(info.status===200){cclStatus=jsonEval.RECORD_DATA.STATUS_DATA.STATUS;
if(cclStatus==="F"){callback=options.error;
}else{if(cclStatus==="S"){callback=options.success;
}else{callback=options.zero;
}}data=jsonEval.RECORD_DATA;
}else{callback=options.error;
data=null;
}callback(data,cclStatus);
}};
var eC=options.eventCodes;
var sEC="value("+eC.toFixed(1)+")";
info.open("GET","MP_GET_N_RESULTS");
sendAr.push(options.output,options.patientId,options.encounterIds,options.personnelId,options.numberOfResults,options.eventSetCodes,sEC,options.classifications,options.lookbackUnits,options.positionCodes,options.pprCode,options.lookbackUnitType);
MP_Util.LogDebug("MP_GET_N_RESULTS HIV Profile request: "+sendAr.join(","));
info.send(sendAr.join(","));
}function ajaCclFinalReport(encounterId,finalReportEventCodes,callback){var criterion=that.getCriterion();
var request=new MP_Core.ScriptRequest(that,"HIV_PROFILE:MP_RETRIEVE_N_RESULTS_JSON final report");
request.setProgramName("MP_RETRIEVE_N_RESULTS_JSON");
var sendAr=[];
var eventCodes;
if(finalReportEventCodes.length>1){eventCodes="value(";
for(var i=0;
i<finalReportEventCodes.length;
i++){finalReportEventCodes[i]=finalReportEventCodes[i]+".0";
}eventCodes=eventCodes+finalReportEventCodes.join(",");
eventCodes=eventCodes+")";
}else{eventCodes=finalReportEventCodes[0];
}MP_Util.LogDebug("Order of final report event codes: "+eventCodes);
sendAr.push("^MINE^",criterion.person_id+".0",encounterId,criterion.provider_id+".0","0.0","5","^^","0.0",eventCodes);
request.setParameters(sendAr);
request.setAsync(true);
MP_Core.XMLCCLRequestCallBack(that,request,callback);
}$(that).bind("loadingError",[],function(e){rootNode().text("");
contentNode().html(["<span class='res-normal'>",i18n.ERROR_RETREIVING_DATA,"</span></h3>"].join(""));
});
$(that).bind("allDataLoaded",[],function(e){rootNode().text("");
});
this.InsertData=function(){var openRequestCount,eventCodes,currentEncounterIDs;
function insertFinalReportData(encounterIds){var openRequests=0;
function decrementOpenReqCount(){openRequests=openRequests-1;
if(openRequests===0){$(that).trigger("allDataLoaded");
}}function getDocViewerLink(personId,encounterId,eventId,effectiveDate,additionalText){displayDateTime=(function(){var dateTime=new Date();
dateTime.setISO8601(effectiveDate);
if(that.getDateFormat()===4||that.getDateFormat()===3){return dateTime.format("longDateTime2");
}return MP_Util.DisplayDateByOption(that,dateTime);
}());
var docViewerType='"DOC"';
var params=[personId,encounterId,eventId,docViewerType];
var ar=["<a href='#' onclick='javascript:MP_Util.LaunchClinNoteViewer(",params.join(","),");'>",displayDateTime+"<br>&nbsp;&nbsp;"+additionalText,"</a>"];
link=ar.join("");
return link;
}function renderFinalReportLinks(reply){var timerRenderComponent=MP_Util.CreateTimer("ENG:MPG.HIV_PROFILE.O1 - render component");
MP_Util.LogDebug("Final report response: "+reply);
try{if(reply.getStatus!=="F"){var recordData=reply.getResponse();
var links=[];
var additionalLinks=[];
if(recordData.RESULTS&&recordData.RESULTS!==null){if(recordData.RESULTS.length===0){decrementOpenReqCount();
return;
}var finalFinalCode=finalReportEventCode[finalReportEventCode.length-1];
MP_Util.LogDebug("Bedrock last event code: "+finalFinalCode);
for(var i=0;
i<recordData.RESULTS.length;
i++){var result=recordData.RESULTS[i];
var displayText="";
try{displayText=getCodes(recordData,result.EVENT_CD);
}catch(err){MP_Util.LogError("Error getting code display: "+err.message);
}var clinEvent=result.CLINICAL_EVENTS[0];
if(clinEvent.MEASUREMENTS&&clinEvent.MEASUREMENTS!==null){for(var j=0;
j<clinEvent.MEASUREMENTS.length;
j++){var data=clinEvent.MEASUREMENTS[j];
var link=getDocViewerLink(data.PATIENT_ID,data.ENCOUNTER_ID,data.EVENT_ID,data.EFFECTIVE_DATE," ("+displayText+")");
if(result.EVENT_CD==finalFinalCode){links.push(link);
}else{additionalLinks.push(link);
}}}if(clinEvent.DOCUMENTS&&clinEvent.DOCUMENTS!==null){for(var j=0;
j<clinEvent.DOCUMENTS.length;
j++){var data=clinEvent.DOCUMENTS[j];
var additionalText;
var link=getDocViewerLink(data.PATIENT_ID,data.ENCOUNTER_ID,data.EVENT_ID,data.EFFECTIVE_DATE," ("+displayText+")");
if(result.EVENT_CD==finalFinalCode){links.push(link);
}else{additionalLinks.push(link);
}}}for(var j=0;
j<links.length;
j++){var link=links[j];
if(j===0){$("#finalReportContent").html("<li>"+link+"</li>");
}else{$("#finalReportContent").append("<li>"+link+"</li>");
}}for(var j=0;
j<additionalLinks.length;
j++){var link=additionalLinks[j];
$("#finalReportContent").append("<li>"+link+"</li>");
}}decrementOpenReqCount();
}}}catch(err){MP_Util.LogError("Error in rendering the final report links: "+err.message);
$(that).trigger("loadingError");
if(timerRenderComponent){timerRenderComponent.Abort();
timerRenderComponent=null;
}throw (err);
}finally{if(timerRenderComponent){timerRenderComponent.Stop();
}}}for(var i=0;
i<encounterIds.length;
i++){openRequests=openRequests+1;
ajaCclFinalReport(encounterIds[i],finalReportEventCode,renderFinalReportLinks);
}}function getCodes(recordData,eventCode){try{for(var i=0;
i<recordData.CODES.length;
i++){var code=recordData.CODES[i];
MP_Util.LogDebug("Code display: "+code.DISPLAY);
if(code.CODE==eventCode){return code.DISPLAY;
}}}catch(err){MP_Util.LogError("Error getting code display for '"+eventCode+"': "+err.message);
}}function decrementOpenReqCount(){openRequestCount=openRequestCount-1;
if(openRequestCount===0){if(currentEncounterIDs.length>0&&finalReportEventCode.length>0){insertFinalReportData(currentEncounterIDs);
}else{$(that).trigger("allDataLoaded");
}}}function successResults(recordData){var encounterId,resultValues,eventCd,mapObjects;
encounterId=recordData.RESULTS[0].CLINICAL_EVENTS[0].ENCNTR_ID;
if($.inArray(encounterId,currentEncounterIDs)===-1){currentEncounterIDs.push(encounterId);
}resultValues=[];
mapObjects=HIV_PROFILE_RESULTS.loadMeasurementData(recordData);
$.each(mapObjects,function(index,eventsWithCode){resultValues.push(eventsWithCode.value);
eventCd=eventsWithCode.name;
$.each(resultValues,function(index,result){var mutationResult,filterText;
if(eventCd===prEventCode){filterText=prNoMutationsFilter;
}else{if(eventCd===rtEventCode){filterText=rtNoMutationsFilter;
}}mutationResult=new HIV_PROFILE_RESULTS.MutationResult(result,filterText);
if(mutationResult.getCurrent()){if(eventCd===prEventCode){$("#prCurrentResults").html(mutationResult.getCurrent().getResult());
$("#prCurrentWithin").html(MP_Util.DisplayDateByOption(that,mutationResult.getCurrent().getDateTime()));
}else{if(eventCd===rtEventCode){$("#rtCurrentResults").html(mutationResult.getCurrent().getResult());
$("#rtCurrentWithin").html(MP_Util.DisplayDateByOption(that,mutationResult.getCurrent().getDateTime()));
}}}if(mutationResult.getSummation()){if(eventCd===prEventCode){$("#prSummationResults").html(mutationResult.getSummation().getResult());
$("#prSummationSince").html(mutationResult.getSummation().getDateTime().format("shortDate5"));
}else{if(eventCd===rtEventCode){$("#rtSummationResults").html(mutationResult.getSummation().getResult());
$("#rtSummationSince").html(mutationResult.getSummation().getDateTime().format("shortDate5"));
}}}});
});
decrementOpenReqCount();
}contentNode().html(getHTML());
if(finalReportEventCode.length>0){contentNode().append(getFinalReportHTML());
}$.each({currentLabel:(function(){var str=i18n.CURRENT;
if(that.getDateFormat()===3){str=str+"<br/>"+i18n.WITHIN;
}return str;
}()),summationLabel:hiv_i18n.HIV_SUMMATION,prLabel:hiv_i18n.HIV_PR_SUBSECTION_NAME,rtLabel:hiv_i18n.HIV_RT_SUBSECTION_NAME,finalReportLabel:hiv_i18n.HIV_FINAL_REPORT_SUBSECTION_NAME,hivDisclaimer:disclaimerText},function(key,value){$("#"+key).html(value);
});
eventCodes=[rtEventCode,prEventCode];
currentEncounterIDs=[];
openRequestCount=eventCodes.length;
$.each(eventCodes,function(index,code){ajaCcl({eventCodes:code,success:successResults,zero:decrementOpenReqCount,error:function(data){$(that).trigger("loadingError");
}});
});
};
this.setFinalReportEventCode=function(eventCode){if(eventCode){finalReportEventCode=eventCode;
}return that;
};
this.setRtEventCode=function(eventCode){if(eventCode){rtEventCode=eventCode;
}return that;
};
this.setPrEventCode=function(eventCode){if(eventCode){prEventCode=eventCode;
}return that;
};
this.setPrNoMutationsFilter=function(text){if(text){prNoMutationsFilter=text;
}return that;
};
this.setRtNoMutationsFilter=function(text){if(text){rtNoMutationsFilter=text;
}return that;
};
this.setDisclaimerText=function(text){if(text){disclaimerText=text;
}return that;
};
this.setCriterion(criterion);
this.setStyles(new HIVProfileComponentStyle());
}HIVProfileComponent.inherits(MPageComponent);
