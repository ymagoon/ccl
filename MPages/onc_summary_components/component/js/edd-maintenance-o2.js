function EDDMaintenanceComponentWFStyle(){this.initByNamespace("edd-wf");
}EDDMaintenanceComponentWFStyle.inherits(ComponentStyle);
function EDDMaintenanceComponentWF(criterion){this.setCriterion(criterion);
this.setStyles(new EDDMaintenanceComponentWFStyle());
this.setComponentLoadTimerName("USR:MPG.EDDMAINTENANCE.O2 - load component");
this.setComponentRenderTimerName("ENG:MPG.EDDMAINTENANCE.O2 - render component");
this.setIncludeLineNumber(true);
this.setResourceRequired(true);
CERN_EventListener.addListener(this,"pregnancyInfoAvailable",this.retrieveComponentData,this);
}EDDMaintenanceComponentWF.prototype=new MPageComponent();
EDDMaintenanceComponentWF.prototype.constructor=MPageComponent;
MP_Util.setObjectDefinitionMapping("WF_PREG_EDD_MAINT",EDDMaintenanceComponentWF);
EDDMaintenanceComponentWF.prototype.RetrieveRequiredResources=function(){var pregInfoSR=MP_Resources.getSharedResource("pregnancyInfo");
if(pregInfoSR&&pregInfoSR.isResourceAvailable()){this.retrieveComponentData();
}else{PREGNANCY_BASE_UTIL_O1.LoadPregnancyData(this.getCriterion());
}};
EDDMaintenanceComponentWF.prototype.openTab=function(){var criterion=this.getCriterion();
var formObject=null;
try{MP_Util.LogDiscernInfo(this,"PREGNANCY","edd-maintenance-o2.js","openTab");
formObject=window.external.DiscernObjectFactory("PREGNANCY");
}catch(err){MP_Util.LogJSError(err,this,"edd-maintenance-o2.js","openTab");
return;
}if(!formObject){var discernError=new Error(i18n.DISCERN_ERROR);
MP_Util.LogJSError(discernError,this,"edd-maintenance-o2.js","openTab");
return;
}var pregInfoSR=MP_Resources.getSharedResource("pregnancyInfo");
var modified=false;
try{if(pregInfoSR&&pregInfoSR.isResourceAvailable()){var pregInfoObj=pregInfoSR.getResourceData();
modified=formObject.AddEDD(window,criterion.person_id,criterion.encntr_id,pregInfoObj.getPregnancyId());
if(modified){PREGNANCY_BASE_UTIL_O1.LoadPregnancyData(criterion);
}}}catch(error){MP_Util.LogError("Attempt to ADD/MODIFY EDD failed");
}};
EDDMaintenanceComponentWF.prototype.retrieveComponentData=function(){var component=this;
var criterion=this.getCriterion();
var eddi18n=i18n.discernabu.eddmaintenance_o2;
var sendAr=[];
var compId=this.getComponentId();
var messageHTML="";
var countText="";
var pregInfoSR=MP_Resources.getSharedResource("pregnancyInfo");
var pregInfoObj=null;
var pregnancyId=0;
var patientGenderInfo=criterion.getPatientInfo().getSex();
if(patientGenderInfo===null||patientGenderInfo.meaning===null||patientGenderInfo.meaning!=="FEMALE"){messageHTML="<h3 class='info-hd'><span class='res-normal'>"+eddi18n.NOT_FEMALE+"</span></h3><span class='res-none'>"+eddi18n.NOT_FEMALE+"</span>";
this.finalizeComponent(messageHTML,countText);
return;
}else{if(pregInfoSR&&pregInfoSR.isResourceAvailable()){pregInfoObj=pregInfoSR.getResourceData();
pregnancyId=pregInfoObj.getPregnancyId();
if(pregnancyId===-1){messageHTML="<h3 class='info-hd'><span class='res-normal'>"+eddi18n.PREG_DATA_ERROR+"</span></h3><span class='res-none'>"+eddi18n.PREG_DATA_ERROR+"</span>";
this.finalizeComponent(messageHTML,countText);
return;
}else{if(!pregnancyId){messageHTML="<h3 class='info-hd'><span class='res-normal'>"+eddi18n.NO_ACTIVE_PREG+"</span></h3><span class='res-none'>"+eddi18n.NO_ACTIVE_PREG+"</span>";
this.finalizeComponent(messageHTML,countText);
return;
}else{sendAr.push("^MINE^",pregnancyId);
var request=new MP_Core.ScriptRequest(this,this.getComponentLoadTimerName());
request.setProgramName("MP_PREG_EDD_MAINTS");
request.setParameters(sendAr);
request.setAsync(true);
MP_Core.XMLCCLRequestCallBack(this,request,function(reply){if(reply.getResponse().QUAL.length>0){component.renderComponent(reply.getResponse());
return;
}messageHTML="<span class='res-none'>"+eddi18n.NO_DATA_FOUND+"&nbsp;<a href=# class='edd-wf-add-edd' id='addEDD"+compId+"'>"+eddi18n.ADD_EDD+"</a></span>";
component.finalizeComponent(messageHTML,"(0)");
CERN_EventListener.fireEvent(component,component,EventListener.EVENT_COUNT_UPDATE,{count:0});
var addEDDObj=$("#addEDD"+compId);
addEDDObj.click(function(){component.openTab(component);
});
return;
});
}}}}};
EDDMaintenanceComponentWF.prototype.renderComponent=function(recordData){var timerRenderComponent=MP_Util.CreateTimer(this.getComponentRenderTimerName(),this.getCriterion().category_mean);
var component=this;
var eddMaintenancei18n=i18n.discernabu.eddmaintenance_o2;
var criterion=this.getCriterion();
var dateFormat=MP_Util.GetDateFormatter();
var compId=this.getComponentId();
var countText="";
var jsEddHTML="";
var hoverHTML=[];
var slaTimer=MP_Util.CreateTimer("CAP:MPG.EDDMAINTENANCE.O2 - Rendering component");
if(slaTimer){slaTimer.SubtimerName=criterion.category_mean;
slaTimer.Stop();
}try{var pregInfoSR=MP_Resources.getSharedResource("pregnancyInfo");
var pregInfoObj=pregInfoSR.getResourceData();
var pregnancyId=pregInfoObj.getPregnancyId();
var eddGesAge=0;
var egaWeeks=0;
var egaDays=0;
var eddMethod="";
var eddDate="";
var docDate="";
var methodDate="";
var arrEstimationDeliveryDateId=[];
var eddComments="";
var eddMaintenanceArray=recordData.QUAL;
var eddLength=eddMaintenanceArray.length;
var arrEDDResults=[];
for(var i=0;
i<eddLength;
i++){var eddStatusStyle=(pregInfoObj.getEddId()===eddMaintenanceArray[i].PREGNANCY_ESTIMATE_ID)?"edd-wf-edd-status-pic":"";
var eddCommentStyle=eddMaintenanceArray[i].COMMENT!==""?"edd-wf-comments-pic":"";
var eddStatus=eddMaintenanceArray[i].STATUS_DISPLAY;
eddMethod=eddMaintenanceArray[i].METHOD_DISPLAY;
eddGesAge=eddMaintenanceArray[i].EST_GEST_AGE_DAYS;
egaWeeks=Math.floor(eddGesAge/7);
egaDays=eddGesAge%7;
eddDate=this.getFormattedDateTime(eddMaintenanceArray[i].EST_DELIVERY_DT_TM,mp_formatter.DateTimeFormatter.FULL_DATE_4YEAR);
docDate=this.getFormattedDateTime(eddMaintenanceArray[i].ENTERED_DT_TM,mp_formatter.DateTimeFormatter.FULL_DATE_4YEAR);
methodDate=this.getFormattedDateTime(eddMaintenanceArray[i].METHOD_DT_TM,mp_formatter.DateTimeFormatter.FULL_DATE_4YEAR);
arrEstimationDeliveryDateId.push(eddMaintenanceArray[i].PREGNANCY_ESTIMATE_ID);
eddComments=eddMaintenanceArray[i].COMMENT;
var egaResult="";
if(eddMethod!=="Ultrasound"){egaResult="--";
}else{if(egaDays===0){egaResult=egaWeeks+"&nbsp;"+eddMaintenancei18n.WEEKS;
}else{egaResult=egaWeeks+"&nbsp;"+eddMaintenancei18n.WEEKS+"&nbsp;"+egaDays+"&nbsp;"+eddMaintenancei18n.DAYS;
}}arrEDDResults.push({Delivery_Date:"<span class = 'edd-wf-edd-date "+eddStatusStyle+"'>"+eddDate+"</span><span id = 'modifyEDDResult_"+i+"_"+compId+"' class = 'edd-wf-modify-edd'>"+eddMaintenancei18n.MODIFY_EDD+"</span>",EDD_Method:eddMethod+"&nbsp;&nbsp; <span class = 'edd-wf-method-date'>("+methodDate+")</span>",Ultrasound_EGA:egaResult,Documented_By:eddMaintenanceArray[i].AUTHOR_NAME,EDD_Comments:"<span class = '"+eddCommentStyle+"'>&nbsp;</span>"});
hoverHTML[i]="<div class='hvr edd-wf-hover'><dl><dt><span>";
hoverHTML[i]+=eddMaintenancei18n.DATE_DOCUMENTED+":</span></dt><dd><span>"+docDate+"</span></dd><dt><span>";
hoverHTML[i]+=eddMaintenancei18n.COMMENTS+":</span></dt><dd><span>"+eddMaintenanceArray[i].COMMENT+"</span></dd><dt><span>";
hoverHTML[i]+=eddMaintenancei18n.STATUS+":</span></dt><dd><span>"+eddMaintenanceArray[i].STATUS_DISPLAY+"</span></dd><dt><span></dl></div>";
}var eddTable=new ComponentTable();
eddTable.setNamespace(this.getStyles().getNameSpace());
eddTable.setZebraStripe(true);
var deliveryDateColumn=new TableColumn();
deliveryDateColumn.setColumnId("Delivery_Date"+compId);
deliveryDateColumn.setCustomClass("edd-wf-edd-column");
deliveryDateColumn.setColumnDisplay(eddMaintenancei18n.EDD);
deliveryDateColumn.setPrimarySortField("Delivery_Date");
deliveryDateColumn.setRenderTemplate("${Delivery_Date}");
var eddMethodColumn=new TableColumn();
eddMethodColumn.setColumnId("EDD_Method"+compId);
eddMethodColumn.setCustomClass("edd-wf-edd-method-column");
eddMethodColumn.setColumnDisplay(eddMaintenancei18n.EDD_METHOD);
eddMethodColumn.setPrimarySortField("EDD_Method");
eddMethodColumn.setIsSortable(true);
eddMethodColumn.setRenderTemplate("${EDD_Method}");
var ultrasoundEGAColumn=new TableColumn();
ultrasoundEGAColumn.setColumnId("Ultrasound_EGA"+compId);
ultrasoundEGAColumn.setCustomClass("edd-wf-ultrasound-ega-column");
ultrasoundEGAColumn.setColumnDisplay(eddMaintenancei18n.ULTRASOUND_EGA);
ultrasoundEGAColumn.setPrimarySortField("Ultrasound_EGA");
ultrasoundEGAColumn.setIsSortable(true);
ultrasoundEGAColumn.setRenderTemplate("${Ultrasound_EGA}");
var documentedByColumn=new TableColumn();
documentedByColumn.setColumnId("Documented_By"+compId);
documentedByColumn.setCustomClass("edd-wf-documented-by-column");
documentedByColumn.setColumnDisplay(eddMaintenancei18n.DOCUMENTED_BY);
documentedByColumn.setPrimarySortField("Documented_By");
documentedByColumn.setIsSortable(true);
documentedByColumn.setRenderTemplate("${Documented_By}");
var commentsColumn=new TableColumn();
commentsColumn.setColumnId("EDD_Comments"+compId);
commentsColumn.setCustomClass("edd-wf-comments-column");
commentsColumn.setColumnDisplay(eddMaintenancei18n.COMMENT);
commentsColumn.setPrimarySortField("EDD_Comments");
commentsColumn.setRenderTemplate("${EDD_Comments}");
eddTable.addColumn(deliveryDateColumn);
eddTable.addColumn(eddMethodColumn);
eddTable.addColumn(ultrasoundEGAColumn);
eddTable.addColumn(documentedByColumn);
eddTable.addColumn(commentsColumn);
eddTable.bindData(arrEDDResults);
var rowHoverExtension=new TableRowHoverExtension();
rowHoverExtension.setHoverRenderer(function(data){var columnHTML=data.RESULT_DATA.Delivery_Date;
var modifyEDDiD=columnHTML.split("_")[1];
index=parseInt(modifyEDDiD,10);
return hoverHTML[index];
});
eddTable.addExtension(rowHoverExtension);
this.setComponentTable(eddTable);
jsEddHTML=[];
jsEddHTML.push(eddTable.render());
var componentHTML="<div id='eddTable"+compId+"' class='edd-wf-table'>";
componentHTML+=jsEddHTML.join("")+"</div>";
this.finalizeComponent(componentHTML,MP_Util.CreateTitleText(this,eddLength));
var rootNode=this.getRootComponentNode();
$(rootNode).find(".edd-wf-modify-edd").click(function(){var modifyEDDiDLink=this.id;
var modifyEDDiD=modifyEDDiDLink.split("_")[1];
var index=parseInt(modifyEDDiD,10);
component.modifyEddMaintenanceResult(arrEstimationDeliveryDateId[index]);
});
CERN_EventListener.fireEvent(this,this,EventListener.EVENT_COUNT_UPDATE,{count:eddLength});
$("#edd-wfcolumnHeaderDelivery_Date"+compId).addClass("edd-wf-edd-column-header");
}catch(err){MP_Util.LogJSError(err,this,"edd-maintenance-o2.js","renderComponent");
if(timerRenderComponent){timerRenderComponent.Abort();
timerRenderComponent=null;
}throw (err);
}finally{if(timerRenderComponent){timerRenderComponent.Stop();
}}};
EDDMaintenanceComponentWF.prototype.getFormattedDateTime=function(dateTime,option){var dateFormat=MP_Util.GetDateFormatter();
if(dateTime){return dateFormat.formatISO8601(dateTime,option);
}return"--";
};
EDDMaintenanceComponentWF.prototype.modifyEddMaintenanceResult=function(estimationDeliveryDateId){var eddMaintenanceFormObject=null;
var eddMaintenancei18n=i18n.discernabu.eddmaintenance_o2;
var criterion=this.getCriterion();
var person_id=criterion.person_id;
var encounter_id=criterion.encounter_id;
var formObject=null;
try{eddMaintenanceFormObject=window.external.DiscernObjectFactory("PREGNANCY");
MP_Util.LogDiscernInfo(null,"PREGNANCY","edd-maintenance-o2.js","modifyEddMaintenanceResult");
}catch(err){var discernObjectFactoryError=new Error(eddMaintenancei18n.DISCERN_OBJ_FACTORY_FAILURE+": "+err.name+" "+err.message);
MP_Util.LogJSError(discernObjectFactoryError,this,"edd-maintenance-o2.js","modifyEddMaintenanceResult");
return;
}if(!eddMaintenanceFormObject){var pregFormObjectError=new Error(eddMaintenancei18n.PREG_FORM_OBJ_FAILURE);
MP_Util.LogJSError(pregFormObjectError,this,"edd-maintenance-o2.js","modifyEddMaintenanceResult");
return false;
}var success=false;
try{success=eddMaintenanceFormObject.ModifyEDD(window,criterion.person_id,criterion.encntr_id,estimationDeliveryDateId);
if(success){PREGNANCY_BASE_UTIL_O1.LoadPregnancyData(this.getCriterion());
}}catch(error){MP_Util.LogError(eddMaintenancei18n.MODIFYEDD_EXCEPTION);
throw (error);
}};
