(function(){var floatSpaceTpl=CKEDITOR.addTemplate("floatcontainer",'<div id="cke_{name}" class="cke {id} cke_reset_all cke_chrome cke_editor_{name} cke_float cke_{langDir} '+CKEDITOR.env.cssClass+'" dir="{langDir}" title="'+(CKEDITOR.env.gecko?" ":"")+'" lang="{langCode}" role="application" style="{style}"><div class="cke_inner"><div id="{topId}" class="cke_top" role="presentation">{content}</div></div></div>');
CKEDITOR.plugins.add("floatingspace",{init:function(editor){editor.on("loaded",function(){attach(editor);
},null,null,20);
}});
var win=CKEDITOR.document.getWindow();
var pixelate=CKEDITOR.tools.cssLength;
function scrollOffset(side){var pageOffset=side=="left"?"pageXOffset":"pageYOffset",docScrollOffset=side=="left"?"scrollLeft":"scrollTop";
return(pageOffset in win.$)?win.$[pageOffset]:CKEDITOR.document.$.documentElement[docScrollOffset];
}function attach(editor){var mode;
var config=editor.config;
var dockedOffsetX=config.floatSpaceDockedOffsetX||0,dockedOffsetY=config.floatSpaceDockedOffsetY||0,pinnedOffsetX=config.floatSpacePinnedOffsetX||0,pinnedOffsetY=config.floatSpacePinnedOffsetY||0;
var layout=function(evt){function updatePos(pos,prop,val){floatSpace.setStyle(prop,pixelate(val));
floatSpace.setStyle("position",pos);
}function changeMode(newMode){var editorPos=editable.getDocumentPosition();
switch(newMode){case"top":updatePos("absolute","top",editorPos.y-spaceHeight-dockedOffsetY);
break;
case"pin":updatePos("fixed","top",pinnedOffsetY);
break;
case"bottom":updatePos("absolute","top",editorPos.y+(editorRect.height||editorRect.bottom-editorRect.top)+dockedOffsetY);
break;
}mode=newMode;
}var editable=editor.editable();
if(!editable){return;
}evt.name=="focus"&&floatSpace.show();
floatSpace.removeStyle("left");
floatSpace.removeStyle("right");
var spaceRect=floatSpace.getClientRect(),editorRect=editable.getClientRect(),spaceHeight=spaceRect.height,pageScrollX=scrollOffset("left");
if(!mode){mode="pin";
changeMode("pin");
layout(evt);
return;
}else{if(mode=="top"&&spaceRect.top<pinnedOffsetY){changeMode("pin");
}else{if(mode=="pin"){if(editorRect.top>dockedOffsetY+spaceHeight){changeMode("top");
}else{if(editorRect.bottom-spaceRect.bottom<spaceHeight){changeMode("bottom");
}}}else{if(mode=="bottom"){if(editorRect.top>dockedOffsetY+spaceHeight){changeMode("top");
}else{if(editorRect.bottom>2*spaceHeight+pinnedOffsetY){changeMode("pin");
}}}}}}var viewRect=win.getViewPaneSize();
var mid=viewRect.width/2;
var alignSide=(editorRect.left>0&&editorRect.right<viewRect.width&&editorRect.width>spaceRect.width)?(editor.config.contentsLangDirection=="rtl"?"right":"left"):(mid-editorRect.left>editorRect.right-mid?"left":"right"),offset;
if(spaceRect.width>viewRect.width){alignSide="left";
offset=0;
}else{if(alignSide=="left"){if(editorRect.left>0){offset=editorRect.left;
}else{offset=0;
}}else{if(editorRect.right<viewRect.width){offset=viewRect.width-editorRect.right;
}else{offset=0;
}}if(offset+spaceRect.width>viewRect.width){alignSide=alignSide=="left"?"right":"left";
offset=0;
}}var scroll=mode=="pin"?0:alignSide=="left"?pageScrollX:-pageScrollX;
floatSpace.setStyle(alignSide,pixelate((mode=="pin"?pinnedOffsetX:dockedOffsetX)+offset+scroll));
};
var body=CKEDITOR.document.getBody();
var vars={id:editor.id,name:editor.name,langDir:editor.lang.dir,langCode:editor.langCode};
var topHtml=editor.fire("uiSpace",{space:"top",html:""}).html;
if(topHtml){var floatSpace=body.append(CKEDITOR.dom.element.createFromHtml(floatSpaceTpl.output(CKEDITOR.tools.extend({topId:editor.ui.spaceId("top"),content:topHtml,style:"display:none;z-index:"+(editor.config.baseFloatZIndex-1)},vars))));
floatSpace.unselectable();
floatSpace.on("mousedown",function(evt){evt=evt.data;
if(!evt.getTarget().hasAscendant("a",1)){evt.preventDefault();
}});
editor.on("focus",function(evt){layout(evt);
win.on("scroll",layout);
win.on("resize",layout);
});
editor.on("blur",function(){floatSpace.hide();
win.removeListener("scroll",layout);
win.removeListener("resize",layout);
});
editor.on("destroy",function(){win.removeListener("scroll",layout);
win.removeListener("resize",layout);
floatSpace.clearCustomData();
floatSpace.remove();
});
if(editor.focusManager.hasFocus){floatSpace.show();
}editor.focusManager.add(floatSpace,1);
}}})();
