"use strict";
const path = require("path");
const fs = require("fs-extra");

/**
 * Makes the set of icons that were added.
 * @param {Array<string>} historyAll - The names of all the icons that were created on the last run.
 * @param {Array<string>} newSet - The names of the icons that were processed during this run.
 * @returns {{added: (Array<string>)}} The names of icons that were added during the current run.
 */
const addedIcons = (historyAll, newSet) => newSet.filter((item) => !historyAll.includes(item));

/**
 * Makes the set of icons that were removed since the last run.
 * @param {Array<string>} historyAll - The names of all the icons that were created on the last run.
 * @param {Array<string>} newSet - The names of the icons that were processed during this run.
 * @returns {{removed: (Array<string>)}} The names of icons that were removed during the current run.
 */
const removedIcons = (historyAll, newSet) => historyAll.filter((item) => !newSet.includes(item))

/**
 * Sorts history items by date.
 * @param {Array<Object>} history - The history.
 * @returns {Array<Object>} The history sorted by date.
 */
const sortByDate = (history = []) => history.sort((a, b) => (new Date(b.date) - new Date(a.date)));

/**
 * Takes a data stream which returns a Promise that,
 * when resolved, will return the new history.
 * @param {Array<Object>} data - The data stream.
 * @returns {Array<Object>} new history generated.
 */
const makeHistory = (data) => fs.readJSON(path.join(__dirname, ".historyjson"))
    .catch((err) => {
        console.error(err);
        console.warn("There was an issue parsing the history file, proceeding with an empty history.");
        return [];
    })
    .then(sortByDate)
    .then(historyByDate => {
        // In the case of no history, default the first to the empty object
        // Since we use the `all` property, default it to the empty array
        const { all = [] } = historyByDate[0] || {};
        // Create the history output fields
        return {
            history: [
                {
                    added: addedIcons(all, data),
                    removed: removedIcons(all, data),
                    all: data,
                    date: new Date().toISOString()
                },
                ...historyByDate
            ]
        };
    });

module.exports = {
    makeHistory
};
