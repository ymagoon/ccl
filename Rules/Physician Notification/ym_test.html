<!DOCTYPE html>
<html style="width:100%;height:100%">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="discernadvisor" content="CCLEVENT,CCLEKSREPLYOBJECT,XMLCCLREQUEST,MPAGES_EVENT">
	<!-- <link rel="stylesheet" type="text/css" href="@OPT_FREETEXT_PARAM/jquery-ui.min.css"/>
  <link rel="stylesheet" type="text/css" href="@OPT_FREETEXT_PARAM/ym_test.css"/> -->
  <link rel="stylesheet" type="text/css" href="jquery-ui.min.css"/>
	<link rel="stylesheet" type="text/css" href="ym_test.css"/>
  </head>
  <body>
  	<div id='mainDiv'></div>
  </body>
  
  <script type="text/javascript" src="demographics.js"></script>
  <script type="text/javascript" src="data2.js"></script>
  <script>
  //  let personId = @PATIENTID:{Patient}, encntrId = @ENCOUNTERID:{Patient} , pt = @MISC:{Banner}; // prod
    let personId = 13952764, encntrId = 117531822;
	
	let orders = function() {
      // let list = @MISC:{Orders}; // prod
      console.log(list);
      return {
      //  flag      : function() {return list.flag;},
      //  count     : function() {return list.count;},
        orders    : function(index) {return list.orders[index];},
        allOrders : function() {return list.orders;},
        getIndications : function(catalogCd) {
            for (let item in list.map) {
              for (let ord in list.map[item].orders) {
                let order = list.map[item].orders[ord];

                if (catalogCd === order.catalogCd) return order.orderSentences; 
              }
            }
        },
      //  reLoad    : function() {list = @MISC:{orders};},
      //  admin     : function(index) {return list.orders[index].mar;},
        prsnlId        : function() {return list.prsnlId;},
      }
   }();
  </script>
  <!-- <script language="javascript" type="text/javascript" src="@OPT_FREETEXT_PARAM/jquery.min.js"></script>
  <script language="javascript" type="text/javascript" src="@OPT_FREETEXT_PARAM/jquery-ui.min.js"></script> -->
  <script type="text/javascript" src="jquery.min.js"></script> <!-- test -->
  <script type="text/javascript" src="jquery-ui.min.js"></script> <!-- test -->
  <script>
    $(function() {
 
      function addSections() {
        let txt = [
          "<div id='topDiv'>",
            "<div id='bannerDiv' class='banner'>banner</div>",
          "</div>",
          "<div id='ordersDiv'>orders</div>",
          "<div id='footerDiv'>footer</div>"];

        $('#mainDiv').html(txt.join(""));
      }
      
      //  CREATE BANNER DISPLAY
      function bannerBar() {
        let txt = [
        "<table class='bannerTable'>",
          "<tr>",
            "<td class='bannerCell pt-name'>",pt.name,"</td>",
            "<td class='bannerCell'>DOB: ",pt.dob,"</td>",
            "<td class='bannerCell'>Age: ",pt.age,"</td>",
            "<td class='bannerCell'>Sex: ",pt.sex,"</td>",
            "<td class='bannerCell bold'>MRN: ",pt.mrn,"</td>",
            
          "</tr>",
          "<tr>",
            "<td class='bannerCell'>Allergies: ",pt.allergies,"</td>",
            "<td class='bannerCell'>Dose Wt: ",pt.weight,"</td>",
            "<td class='bannerCell'>Height: ",pt.height,"</td>",
            "<td class='bannerCell bold'>Fin#: ",pt.fin,"</td>",
            "<td class='bannerCell'>Location: ",pt.location,"</td>",
          "</tr>",
        "</table>"];
        $('#bannerDiv').html(txt.join(""));
      }
 
      // MESSAGE HEADER
      function headerMsg() {
        let txt = [
          "<div class='head'>",
            "<div class='order-details'>Order Name/Details</div>",
            "<div class='continue'>icon</div>",
            "<div class='discontinue'>icon</div>",
            "<div class='indication'>Indication</div>",
            "<div class='start'>",
            "<div class='stop'>",
          "</div>"
        ];
      }

	  // CREATE TABLE TO DISPLAY EXPIRING ORDERS
      function displayOrders() {

        let txt = [
        "<table id='ordersTable' class='ordTable'>",
          "<thead class = 'header'>",
            "<tr>",
              "<th class='column1'>Order Name/Details</th>",
              // "<th class='radio'><img src='@OPT_FREETEXT_PARAM/anteca/imgs/continue.png' alt='Continue Order' /></th>", // prod
              // "<th class='radio'><img src='@OPT_FREETEXT_PARAM/anteca/imgs/discontinue.png' alt='Discontinue Order' /></th>", // prod
              "<th class='radio'><img src='imgs/continue.png' alt='Continue Order' /></th>", // test
              "<th class='radio'><img src='imgs/discontinue.png' alt='Discontinue Order' /></th>", // test
              "<th class='column2'>Continue Reason</th>",
              "<th class='column3'>Start</th>",
              "<th class='column3'>Stop</th>",
            "</tr>",
          "</thead>",
          "<tr class='order-type'>",
            "<td colspan=6>Cathether and Line Care Orders</td>",
          "</td>"];

        orders.allOrders().filter(item => item.type === 'care').forEach(function(item, index){
          let indications = displayIndications(item.catalogCd);

          txt.push(
          "<tr class='row'>",
            "<td class='column1' name='ord' id='n",item.orderId,"' idx=",index,"><span class='mySpan' id='l",item.orderId,"'>",
              item.orderMnemonic,"</span>",
            "</td>",
            "<td class='radio'>",
              "<input type='radio' name=order",index," value=continue idx=",index,">",
            "</td>",
            "<td class='radio'>",
              "<input type='radio' name=order",index," value=discontinue idx=",index,">",
            "</td>",
            "<td>"
          );

          if (indications.length) {
            txt.push(
              "<select class='indication' name='indication",index,"'>",
                indications, 
              "</select>"
            )
          }

          txt.push(
            "</td>",
              "<td class='column3' id='s",item.orderId,"'>",item.startDtTm,"</td>",
              "<td class='column3' id='e",item.orderId,"'>",item.stopDtTm,"</td>",
            "</tr>"
          )

        });

        txt.push("</table>");
        $('#ordersDiv').html(txt.join(""));
        
		    let maxLength = [];
        orders.allOrders().forEach(function(item, index){
          let curLength = $('#l'+item.orderId).width()
          maxLength.push(curLength);
        });
        $('.column2').css('width', (Math.max.apply(null,maxLength)+5) + "px");
      }

      function displayIndications(catalogCd) {
        let indications = orders.getIndications(catalogCd);
        let txt = [];

        if (indications.length) {
          indications.forEach(function(indication, index) {
            txt.push("<option orderSentenceId=",indication.orderSentenceId,">",indication.indication,"</option>");
          });
        }
        return txt.join("");
      }
	  
	  // FOOTER DISPLAY
      function footerDisplay() {
        $('#footerDiv').html("<input type='button' value='Continue As Ordered' id='bContinue' class='button'>\
                              &nbsp&nbsp&nbsp&nbsp<input type='button' value='Reset' id='bReset' class='button'>");
      }
	  
	  $(document).ready(function(){
        console.log("lets begin");
        addSections();
        bannerBar();
        headerMsg();
		    displayOrders();
	      footerDisplay();
		    resetButtons();
      });
	  
	   // RADIO BUTTONS 
      $(document).on('click', '.radio', function (e) {
        if (e.target.type === 'radio') {
          let idx = $(e.target).attr("idx");

          if (e.target.value === 'continue') {
            orders.orders(idx).status = 1;

            // show indications
            console.log('.indication' + idx);
            console.log($('.indication1'));
            $('.indication' + idx).css("visibility", "visible");
          } else if (e.target.value === 'discontinue') {
            orders.orders(idx).status = 0;

            // get rid of indications
          }
        }
        // console.log(orders.allOrders());
      });

      // CONTINUE BUTTON
      $(document).on('click', '#bContinue', function () {
        processOrders();
      });
	  
	  function resetButtons() {
        $('.btn-grp').on('click', '.myButton', function() {
          $(this).addClass('myButton-active').siblings().removeClass('myButton-active').addClass('myButton');
          let index = $(this).attr('idx');
          let tValue = $(this).attr('value');
          let tClass = orders.orders(index).orderId;
 
		  // cancel / DC
          if (tValue == 2) {
            orders.orders(index).status = 2;
            $('#n'+tClass).html(orders.orders(index).orderMnemonic.strike());
            $('#s'+tClass).html(orders.orders(index).startDtTm.strike());
            $('#e'+tClass).html(orders.orders(index).stopDtTm.strike());
          }
		  // Renew
          else if (tValue == 1) {
            orders.orders(index).status = 1;
            $('#n'+tClass).html(orders.orders(index).orderMnemonic);
            $('#s'+tClass).html(orders.orders(index).startDtTm);
            $('#e'+tClass).html(orders.orders(index).stopDtTm);
          };
        });

        // ADD MOUSE HOVER DISPLAY ON ORDER VIA JQUERYUI
        $( "[name=ord]" ).tooltip({
          items: "[name=ord]",
          content: function () { return displayTooltip($(this).attr('idx')); }
        });
      }
	  
	  // PERFORMS SELECTED ACTIONS ON EACH ORDER
      function processOrders() {
        // todo
        // 1. check to see if all orders that need to have been selected. If not, display missing orders and force user to address them
        // 2. prevent more than one care order / discontinue order from being placed at the same time
        // 3. Call CCL program and pass it list of order_id's that need to be completed

        // loop through order
        // check status
        // if status is 1, then we place new order
          // pull indication
        // if status is 0, then we place discontinue order

        // add former order to list of orders to complete

        let value = [personId, encntrId] //, txt = ["1",orders.me()];
        let orderTxt = "";
        let doAction = 0;
        
        // A set of flags that can be used to define the style of the Modal Order Entry Window. 
        // Use a value of 24 to enable PowerPlans. 
        // Otherwise, set this flag to 0.
        let customizeFlags = "0";

        // The tab that is to be modified. 
        // Use a value of 2 for customizations to the Order List profile. 
        // Use a value of 3 for customizations to the Medication List profile.
        let tab = "2";

        // A set of flags that can be used to define the style of the tab being altered by 'tab'. 
        // For full PowerOrders functionality, a value of 127 will need to be set.
        let tabDisplayFlags = "127";

        let tabLst = `{${tab}|${tabDisplayFlags}}`

        // The view to display by default when launching into the Modal Order Entry Window. 
        // A value of 8 will default to the order search. 
        // A value of 16 will default to the order profile. 
        // A value of 32 will default to the orders for signature.
        let defaultDisplay = "32";

        // A Boolean flag used to determine if the Modal Order Entry Window should sign orders silently.  
        // When this flag is set, and the required details on each new order are pre-populated, it causes the orders to be signed automatically 
        // without displaying the Modal Order Entry Window.  Orders are signed automatically when existing orders are not already on the scratchpad 
        // and no other orderActions are present.
        let silentSignFlag = "1";
       
        let customParams = `${customizeFlags}|${tabLst}|${defaultDisplay}|${silentSignFlag}`; // e.g. 0|{2|127}|32|1
        
        // CREATES WIN32-POWERORDERS AND CHECKS TO SEE IF ORDER CAN BE RENEWED OR NEEDS TO BE DC-REORDER
        //let PowerOrders = window.external.DiscernObjectFactory("POWERORDERS");
        //let moew = PowerOrders.CreateMOEW(personId, encntrId, 0, 2, 127);
        orders.allOrders().forEach(function(item) {
          // {ORDER|672556|0|0|961514|1}
          if (item.status == 1) {
        //    let availableActions = PowerOrders.GetAvailableOrderActions(moew,item.orderId);
        // Can be renewed
	    	//	orderTxt += availableActions;
        //    if ((availableActions & 2048) === 2048) {
        //      orderTxt += "{RENEW|"+item.orderId+"}";
				    orderTxt += "{ORDER|"+item.orderId+"}";
        //      txt.push(item.orderId,"r");
        //    }
            // DC-Reorder
        //    else if ((availableActions & 2097152) === 2097152) {
        //      orderTxt += "{CANCEL REORD|"+item.orderId+"}";
        //      txt.push(item.orderId,"cr");
        //    };
        //    doAction = 1;
        //  }
        //  else if (item.status == 2) {
        //    orderTxt += "{CANCEL DC|"+item.orderId+"}";
        //    doAction = 1;
        //    txt.push(item.orderId,"dc");
        //  }
        //  else {
        //    txt.push(item.orderId,"na");
          };
        });
        //PowerOrders.DestroyMOEW(moew);
 
        // SEND ORDER ACTIONS TO MPAGES_EVENT TO EXECUTE
       // if (doAction == 1) {
		  // 13954786|117579795|undefined{RENEW|534870007}|0|{2|127}|32|1
      // value.push(orderTxt,customParams);
      value.push("{ORDER|20230938|0|0|0}",customParams);
      console.log(value.join("|"));

          javascript:MPAGES_EVENT("ORDERS", value.join("|"));
		  
		  CCLEVENT('EVENT_EKS_OK');
      //  }
      //  expertEvent(txt.join("|"));
      }
	  // DISPLAY ORDER INFO ON MOUSE HOVER
      function displayTooltip(index) {
        let txt = ["Ordered By: <b>", orders.orders(index).orderPhys,"</b><br>",
                   "Clinical Display Line: ","<br>",
				   orders.orders(index).clinDisplay
				  ];
        return txt.join("");
      }

      function getIndications(type) {
        if (type === 'Arterial') {
          return "";
        }
        // console.log('inside function');
        // console.log(type);

        let indications = ["<option idx=0>Select Continue Reason...</option>"]; //default blank row
        // let urinaryCathIndication = ["<option idx=0>Select Continue Reason...</option>"]; //default blank row
        // let centralVenousIndication = ["<option idx=0>Select Continue Reason...</option>"]; //default blank row

        orders.allIndications().forEach(function(indication, index) {
          if (indication.type === type) {
            indications.push(
              "<option idx=",index,">",indication.description,"</option>"
            );
          }
        });

        return indications.join("");
      }
	});
	
  </script>
</html>
 
