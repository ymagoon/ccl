<!DOCTYPE html>
<html style="width:100%;height:100%">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="discernadvisor" content="CCLEVENT,CCLEKSREPLYOBJECT,XMLCCLREQUEST,MPAGES_EVENT">
	<!-- <link rel="stylesheet" type="text/css" href="@OPT_FREETEXT_PARAM/jquery-ui.min.css"/>
  <link rel="stylesheet" type="text/css" href="@OPT_FREETEXT_PARAM/ym_test.css"/> -->
  <link rel="stylesheet" type="text/css" href="jquery-ui.min.css"/>
	<link rel="stylesheet" type="text/css" href="ym_test.css"/>
  </head>
  <body>
  	<div id='mainDiv'></div>
  </body>
  
  <script type="text/javascript" src="demographics.js"></script>
  <script type="text/javascript" src="data.js"></script>
  <script>
  //  let personId = @PATIENTID:{Patient}, encntrId = @ENCOUNTERID:{Patient}; //, pt = @MISC:{Banner};
	
	let orders = function() {
      // let list = @MISC:{Orders};
      return {
      //  flag      : function() {return list.flag;},
      //  count     : function() {return list.count;},
        orders    : function(index) {return list.orders[index];},
        allOrders : function() {return list.orders;},
      //  reLoad    : function() {list = @MISC:{orders};},
      //  admin     : function(index) {return list.orders[index].mar;},
        me        : function() {return list.me;}
      //  omd       : function(index){return list.order[index].omd;}
      }
   }();
  </script>
  <!-- <script language="javascript" type="text/javascript" src="@OPT_FREETEXT_PARAM/jquery.min.js"></script>
  <script language="javascript" type="text/javascript" src="@OPT_FREETEXT_PARAM/jquery-ui.min.js"></script> -->
  <script type="text/javascript" src="jquery.min.js"></script>
  <script type="text/javascript" src="jquery-ui.min.js"></script>
  <script>
    $(function() {
 
      function addSections() {
        let txt = [
          "<div id='topDiv'>",
          "<div id='bannerDiv' class='banner'>banner</div>",
          "<div id='headerDiv' class='header'>header</div>",
		  "<div id='testDiv' class='test'>test</div>",
          "</div>",
          "<div id='ordersDiv'>orders</div>",
          "<div id='footerDiv'>footer</div>"
		];
        $('#mainDiv').html(txt.join(""));
      }
      
 
      //  CREATE BANNER DISPLAY
      function bannerBar() {
        let txt = [
        "<table class='bannerTable'>",
          "<tr>",
            "<td class='bannerCell'><b>",pt.name,"</b></td>",
            "<td class='bannerCell'>DOB:</b> ",pt.dob,"</td>",
            "<td class='bannerCell'>Age:</b> ",pt.age,"</td>",
            "<td class='bannerCell'>Sex:</b> ",pt.sex,"</td>",
            "<td class='bannerCell'><b>MRN: ",pt.mrn,"</b></td>",
            
          "</tr>",
          "<tr>",
            "<td class='bannerCell'>Allergies: ",pt.allergies,"</td>",
            "<td class='bannerCell'>Dose Wt: ",pt.weight,"</td>",
            "<td class='bannerCell'>Height:</b> ",pt.height,"</td>",
            "<td class='bannerCell'><b>Fin#: ",pt.fin,"</b></td>",
            "<td class='bannerCell'>Location: ",pt.location,"</td>",
          "</tr>",
          "<tr>",
            
            
            
          "</tr>",
        "</table>"];
        $('#bannerDiv').html(txt.join(""));
      }
 
      // MESSAGE HEADER
      function headerMsg() {
      	$('#headerDiv').html("The following orders will be expiring within the next <span class='highlight'>12 hours</span>.\
          &nbsp&nbspPlease select whether to renew or discontinue each order.  <span class='redH'>Making no selection will\
          allow the order to Expire.</span>")
      }
	  
	  // CREATE TABLE TO DISPLAY EXPIRING ORDERS
      function displayOrders() {
        var txt = [
        "<br><table id='ordersTable' class='ordTable'>",
          "<tr>",
            "<th class='column1'>&nbsp</th>",
            "<th class='column2'>Order</th>",
            "<th class='column3'>Start</th>",
            "<th class='column3'>Stop</th>",
          "</tr>"];
 
        orders.allOrders().forEach(function(item, index){
          txt.push(
          "<tr>",
            "<td class='column1'>",
            "<div class='btn-grp'>",
              "<button class='myButton' value=1 idx=",index,">Renew</button>&nbsp&nbsp",
              "<button class='myButton' value=2 idx=",index,">Cancel/DC</button>&nbsp",
            "</div>",
            "</td>",
            "<td class='column2' name='ord' id='n",item.orderId,"' idx=",index,"><span class='mySpan' id='l",item.orderId,"'>",
              item.orderMnemonic,"</span></td>",
            "<td class='column3' id='s",item.orderId,"'>",item.startDtTm,"</td>",
            "<td class='column3' id='e",item.orderId,"'>",item.stopDtTm,"</td>",
          "</tr>");
        })
        txt.push("</table><br><br>");
        $('#ordersDiv').html(txt.join(""));
        
		let maxLength = [];
        orders.allOrders().forEach(function(item, index){
          let curLength = $('#l'+item.orderId).width()
          maxLength.push(curLength);
        });
        $('.column2').css('width', (Math.max.apply(null,maxLength)+5) + "px");
      }
	  
	  // FOOTER DISPLAY
      function footerDisplay() {
        $('#footerDiv').html("<input type='button' value='Continue As Ordered' id='bContinue' class='button'>\
                              &nbsp&nbsp&nbsp&nbsp<input type='button' value='Reset' id='bReset' class='button'>");
      }
	  
	  // TEST MESSAGE
      function testMsg() {
      	$('#testDiv').html("This is a test rule. <span class='redH'>Please ignore.</span>")
      }
	  
	  $(document).ready(function(){
        console.log("lets begin");
        addSections();
        bannerBar();
        headerMsg();
		    displayOrders();
	      footerDisplay();
		    resetButtons();
      });
	  
	  // CONTINUE BUTTON
      $(document).on('click', '#bContinue', function () {
        processOrders();
      });
	  
	  function resetButtons() {
        $('.btn-grp').on('click', '.myButton', function() {
          $(this).addClass('myButton-active').siblings().removeClass('myButton-active').addClass('myButton');
          let index = $(this).attr('idx');
          let tValue = $(this).attr('value');
          let tClass = orders.orders(index).orderId;
 
		  // cancel / DC
          if (tValue == 2) {
            orders.orders(index).status = 2;
            $('#n'+tClass).html(orders.orders(index).orderMnemonic.strike());
            $('#s'+tClass).html(orders.orders(index).startDtTm.strike());
            $('#e'+tClass).html(orders.orders(index).stopDtTm.strike());
          }
		  // Renew
          else if (tValue == 1) {
            orders.orders(index).status = 1;
            $('#n'+tClass).html(orders.orders(index).orderMnemonic);
            $('#s'+tClass).html(orders.orders(index).startDtTm);
            $('#e'+tClass).html(orders.orders(index).stopDtTm);
          };
        });

        // ADD MOUSE HOVER DISPLAY ON ORDER VIA JQUERYUI
        $( "[name=ord]" ).tooltip({
          items: "[name=ord]",
          content: function () { return displayTooltip($(this).attr('idx')); }
        });
      }
	  
	  // PERFORMS SELECTED ACTIONS ON EACH ORDER
      function processOrders() {
        let value = [personId, encntrId] //, txt = ["1",orders.me()];
        let orderTxt = "";
		let doAction = 0;
 
        // CREATES WIN32-POWERORDERS AND CHECKS TO SEE IF ORDER CAN BE RENEWED OR NEEDS TO BE DC-REORDER
        //let PowerOrders = window.external.DiscernObjectFactory("POWERORDERS");
        //let moew = PowerOrders.CreateMOEW(personId, encntrId, 0, 2, 127);
		
        orders.allOrders().forEach(function(item) {
        //  if (item.status == 1) {
        //    let availableActions = PowerOrders.GetAvailableOrderActions(moew,item.orderId);
            // Can be renewed
		//	orderTxt += availableActions;
        //    if ((availableActions & 2048) === 2048) {
        //      orderTxt += "{RENEW|"+item.orderId+"}";
				orderTxt += "{CANCEL REORD|"+item.orderId+"}";
        //      txt.push(item.orderId,"r");
        //    }
            // DC-Reorder
        //    else if ((availableActions & 2097152) === 2097152) {
        //      orderTxt += "{CANCEL REORD|"+item.orderId+"}";
        //      txt.push(item.orderId,"cr");
        //    };
            doAction = 1;
        //  }
        //  else if (item.status == 2) {
        //    orderTxt += "{CANCEL DC|"+item.orderId+"}";
        //    doAction = 1;
        //    txt.push(item.orderId,"dc");
        //  }
        //  else {
        //    txt.push(item.orderId,"na");
        //  };
        });
        //PowerOrders.DestroyMOEW(moew);
 
        // SEND ORDER ACTIONS TO MPAGES_EVENT TO EXECUTE
        if (doAction == 1) {
		  // 13954786|117579795|undefined{RENEW|534870007}|0|{2|127}|32|1
          value.push(orderTxt,"0|{2|127}|32|1");
		  let str = value.join("|")
		  $('#testDiv').html(str);
          javascript:MPAGES_EVENT("ORDERS", value.join("|"));
		  
		  CCLEVENT('EVENT_EKS_OK');
        }
      //  expertEvent(txt.join("|"));
      }
	  // DISPLAY ORDER INFO ON MOUSE HOVER
      function displayTooltip(index) {
        let txt = ["Ordered By: <b>", orders.orders(index).orderPhys,"</b><br>",
                   "Clinical Display Line: ","<br>",
				   orders.orders(index).clinDisplay
				  ];
		//let txt = ["index=",index,orders.orders(index).order
       // rx.admin(index).forEach(function (item, index) {
       //   txt.push("<br>&nbsp&nbsp&nbsp&nbsp",item.actionDate," - ",item.marAction);//:null;
       // });
        return txt.join("");
      }
	});
	
  </script>
</html>
 
