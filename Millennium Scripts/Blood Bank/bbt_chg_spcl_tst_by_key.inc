 ;;Solution_Test/script/PathNet -- BB Transfusion/RESULTENTRYFORBLOODBANK/BBT_CHG_SPCL_TST_BY_KEY.INC Turn on black mode

/*
 *  PURPOSE:  Update special_testing row by unique key (NOTE:  see also bbt_chg_prs_antigen.inc)
 *
 *  PRELIMINARIES:
 *   1)  Include the following code in calling program:
 *           %i cclsource:bbt_chg_special_testing_by_key.inc
 *           END        ; end subroutine CHG_SPCL_TST_BY_KEY
 *
 *   2)  Declare the followoing variables in the calling program, prior to calling the subroutine:
 *           set gsub_rh_phenotype_status     = "  "      ; (gsub = global subroutine variable)
 *
 *   3)  Call subroutine using CALL FORMAT below
 *
 *   4)  After control returns from subroutine, evaluate gsub_rh_phenotype_status as follows:
 *         "FL" = Lock forupdate failed for special_testing failed
 *         "FU" = Update for special_testing failed
 *         "OK" = Update successful                                           
 *
 *  CALL FORMAT (this may be copied into calling program): */
 ;       call CHG_SPCL_TST_BY_KEY
 ;          (                             ** These <variables> set in calling program **
 ;           /* special_testing_id */ <special_testing_id>
 ;           /* updt_cnt          */ , <rh_phenotype_updt_cnt>
 ;           /* active_ind        */ , <active_ind>
 ;           /* active_status_cd  */ , <reqdata->in/active_status_cd>
 ;          )

subroutine CHG_SPECIAL_TESTING_BY_KEY
    (
     sub_special_testing_id
     , sub_updt_cnt
     , sub_active_ind
     , sub_active_status_cd
    )

/* Initialize gsub_rh_phenotype_status */
set gsub_rh_phenotype_status = "  "

/*
 * Lock special_testing row forupdate 
 */
select into "nl:"
    st.special_testing_id
from
    special_testing st
where
    st.special_testing_id  = sub_special_testing_id
      and st.updt_cnt          = sub_updt_cnt
with    nocounter

if (curqual = 0)
    set gsub_rh_phenotype_status = "FL"
else
    /*
     * Update special_testing row
     */
    update into special_testing st set
        st.updt_cnt                 = st.updt_cnt + 1
        , st.updt_dt_tm             = cnvtdatetime(curdate,curtime3)
        , st.updt_id                = reqinfo->updt_id
        , st.updt_cnt               = 0
        , st.updt_task              = reqinfo->updt_task
        , st.updt_applctx           = reqinfo->updt_applctx      
        , st.active_ind             = sub_active_ind
        , st.active_status_cd       = sub_active_status_cd

    where   st.special_testing_id    = sub_special_testing_id

    with    nocounter

    if (curqual = 0)
        set gsub_rh_phenotype_status = "FU"
    else
        set gsub_rh_phenotype_status = "OK"
    endif
endif

/* END for subroutine is to be included in calling program */   

;Generated by GNU enscript 1.6.4.
