 ;;Solution_Test/script/PathNet -- BB Transfusion/RESULTENTRYFORBLOODBANK/BBT_CHG_PERSON_ANTIGEN_BY_KEY.INC Turn on black mode

/*
 *  PURPOSE:  Update person_antigen row by unique key (NOTE:  see also bbt_chg_prs_antigen.inc)
 *
 *  PRELIMINARIES:
 *   1)  Include the following code in calling program:
 *           %i cclsource:bbt_chg_person_antigen_by_key.inc
 *           END        ; end subroutine CHG_PERSON_ANTIGEN_BY_KEY
 *
 *   2)  Declare the followoing variables in the calling program, prior to calling the subroutine:
 *           set gsub_rh_phenotype_status     = "  "      ; (gsub = global subroutine variable)
 *
 *   3)  Call subroutine using CALL FORMAT below
 *
 *   4)  After control returns from subroutine, evaluate gsub_rh_phenotype_status as follows:
 *         "FL" = Lock forupdate failed for person_antigen failed
 *         "FU" = Update for person_antigen failed
 *         "OK" = Update successful                                           
 *
 *  CALL FORMAT (this may be copied into calling program): */
 ;       call CHG_PERSON_ANTIGEN_BY_KEY
 ;          (                             ** These <variables> set in calling program **
 ;           /* person_antigen_id */ <person_antigen_id>
 ;           /* updt_cnt          */ , <updt_cnt>
 ;           /* active_ind        */ , <active_ind>
 ;           /* active_status_cd  */ , <reqdata->in/active_status_cd>
 ;          )

subroutine CHG_PERSON_ANTIGEN_BY_KEY
    (
     sub_person_antigen_id
     , sub_updt_cnt
     , sub_active_ind
     , sub_active_status_cd
    )

/* Initialize gsub_rh_phenotype_status */
set gsub_rh_phenotype_status = "  "

/*
 * Lock person_antigen row forupdate 
 */
select into "nl:"
    pa.person_antigen_id
from
    person_antigen pa
where
    pa.person_antigen_id  = sub_person_antigen_id
      and pa.updt_cnt          = sub_updt_cnt
with    nocounter

if (curqual = 0)
    set gsub_rh_phenotype_status = "FL"
else
    /*
     * Update person_antigen row
     */
    update into person_antigen pa set
        pa.updt_cnt                 = pa.updt_cnt + 1
        , pa.updt_dt_tm             = cnvtdatetime(curdate,curtime3)
        , pa.updt_id                = reqinfo->updt_id
        , pa.updt_cnt               = 0
        , pa.updt_task              = reqinfo->updt_task
        , pa.updt_applctx           = reqinfo->updt_applctx      
        , pa.active_ind             = sub_active_ind
        , pa.active_status_cd       = sub_active_status_cd

    where   pa.person_antigen_id    = sub_person_antigen_id

    with    nocounter

    if (curqual = 0)
        set gsub_rh_phenotype_status = "FU"
    else
        set gsub_rh_phenotype_status = "OK"
    endif
endif

/* END for subroutine is to be included in calling program */   

;Generated by GNU enscript 1.6.4.
