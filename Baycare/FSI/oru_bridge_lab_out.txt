/*
 *  ---------------------------------------------------------------------------------------------
 *  Script Name:  oru_bridge_lab_out
 *  Description:  Script for Lab results outbound to Bridge
 *  Type:         Modify Object Script
 *  ---------------------------------------------------------------------------------------------
 *  Author:         Hope Kaczmarczyk
 *  Library:        OEOCF23ORUORU
 *  Creation Date:  8/1/17 01:05:00 PM
 *  ---------------------------------------------------------------------------------------------
 *  Mod#     Date     Author                         Description & Requestor Information
 *
 *   1.       01/11/18  H Kaczmarczyk                Copy/modification of oru_bayc_out mod object script
 *                                                   to send a limited amount of Lab results to the Bridge.
 *  002		11/27/18	Yitzhak Magoon				Update for modal
 *  ---------------------------------------------------------------------------------------------
*/
 
 If (oen_reply->RES_ORU_GROUP [1]->OBR [1]->diag_serv_sec_id not in ("BB", "Lab"))
     set OenStatus->Ignore=1
 Endif


/*********************Add the PCPE to PD1:4 H Kaczmarczyk 11/13/13*******************************************/

declare pt_enctr_id = f8
declare phys_NPInbr = vc
declare phys_name_first = vc
declare phys_name_last = vc

set pt_enctr_id = oen_reply->cerner->encntr_prsnl_info->encntr [1]->encntr_id
set phys_reltn = uar_get_code_by ("MEANING",333,"PCPE")
set phys_number = uar_get_code_by ("DISPLAY",263,"NPI Number")

select into "nl:"
  p.alias
  , pr.name_last
  , pr.name_first
from 
  encntr_prsnl_reltn e
  , prsnl_alias p
  , prsnl pr
plan e
  where e.encntr_id = pt_enctr_id  
    and e.encntr_prsnl_r_cd = phys_reltn  
	and e.manual_create_ind = 0 
join p
  where e.prsnl_person_id = p.person_id   
    and p.alias_pool_cd = phys_number
join pr
  where p.person_id = pr.person_id
detail
  phys_NPInbr = p.alias
  phys_name_first = pr.name_first
  phys_name_last = pr.name_last  
with nocounter

/*********************10/27/16  Add Mod 10: PD1 Clear all old life time PCP identifiers Hope K.************************/

set pd1_size = size(oen_reply->PERSON_GROUP [1]->PAT_GROUP [1]->PD1, 5)

if (pd1_size > 0)
  set stat = alterlist(oen_reply->PERSON_GROUP [1]->PAT_GROUP [1]->PD1, 0)
endif
 
if (phys_NPInbr not in("", NULL, " "))
  set oen_reply->PERSON_GROUP [1]->PAT_GROUP [1]->PD1 [1]->pat_primary_provider [1]->id_nbr =  phys_NPInbr
  set oen_reply->PERSON_GROUP [1]->PAT_GROUP [1]->PD1 [1]->pat_primary_provider [1]->last_name =  phys_name_last
  set oen_reply->PERSON_GROUP [1]->PAT_GROUP [1]->PD1 [1]->pat_primary_provider [1]->first_name = phys_name_first
  set oen_reply->PERSON_GROUP [1]->PAT_GROUP [1]->PD1 [1]->pat_primary_provider [1]->assign_auth->name_id  = "NPI Number"
  set oen_reply->PERSON_GROUP [1]->PAT_GROUP [1]->PD1 [1]->pat_primary_provider [1]->name_type = "Personnel"
  set oen_reply->PERSON_GROUP [1]->PAT_GROUP [1]->PD1 [1]->pat_primary_provider [1]->id_type = "National Provider Identifier"
endif

#exit_25