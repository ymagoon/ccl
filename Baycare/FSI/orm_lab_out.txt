/*
 *  ---------------------------------------------------------------------------------------------
 *  Script Name:  orm_lab_out
 *  Description:  Script for lab orders & ht/wt messages outbound
 *  Type:         Modify Object Script
 *  ---------------------------------------------------------------------------------------------
 *  Author:         Yitzhak Magoon
 *  Library:        OEOCF23ORMORM
 *  Creation Date:  11/20/2018
 *  ---------------------------------------------------------------------------------------------
 *  Mod#  Date    Author       Description & Requestor Information
 *
*/
 
/***1/9/2009 - adding logic to put facility code in MSH for cloverleaf routing - FSI redesign***/
execute op_MSH_FAC_MODOBJ_OUT

;todo - this suppression logic needs to be moved up to global suppression script
if (oen_reply->PERSON_GROUP [1]->PAT_GROUP [1]->PV1 [1]->patient_type = "A") 
  set oenstatus->ignore=1
endif

if (oen_reply->CONTROL_GROUP [1]->MSH [1]->message_type->messg_type = "ORM")
  if(oen_reply->PERSON_GROUP [1]->PAT_GROUP [1]->PV1 [1]->patient_type = "JHOUTREACH")
    set oenstatus->ignore=1
  endif

  if(oen_reply->PERSON_GROUP [1]->PAT_GROUP [1]->PV1 [1]->patient_type = "MPOUTREACH")
    set oenstatus->ignore=1
  endif
endif

if (oen_reply->CONTROL_GROUP [1]->MSH [1]->message_type->messg_trigger = "O01")

else
 /* This needs to be removed - we need to move height and weight out of this interface 
   free set obr_temp
   set obr_temp = size(oen_reply->RES_ORU_GROUP,5)
   execute oencpm_msglog(build("ORC size -> ", obr_temp))

   free set c
   set c = 0

   free set res_fill_entity
   free set res_fill_name
   free set res_fill_univ
   free set res_fill_type

   free set res_plac_entity
   free set res_plac_name
   free set res_plac_univ
   free set res_plac_type

   set res_fill_entity = trim(oen_reply->RES_ORU_GROUP [1]->ORC [1]->filler_ord_nbr [1]->entity_id) 
   set res_fill_name = trim(oen_reply->RES_ORU_GROUP [1]->ORC [1]->filler_ord_nbr [1]->name_id) 
   set res_fill_univ = trim(oen_reply->RES_ORU_GROUP [1]->ORC [1]->filler_ord_nbr [1]->univ_id)
   set res_fill_type = trim(oen_reply->RES_ORU_GROUP [1]->ORC [1]->filler_ord_nbr [1]->univ_id_type)

   set res_plac_entity = trim(oen_reply->RES_ORU_GROUP [1]->ORC [1]->placer_ord_nbr [1]->entity_id)
   set res_plac_name = trim(oen_reply->RES_ORU_GROUP [1]->ORC [1]->placer_ord_nbr [1]->name_id) 
   set res_plac_univ = trim(oen_reply->RES_ORU_GROUP [1]->ORC [1]->placer_ord_nbr [1]->univ_id) 
   set res_plac_type = trim(oen_reply->RES_ORU_GROUP [1]->ORC [1]->placer_ord_nbr [1]->univ_id_type) 

   Set oen_reply->RES_ORU_GROUP [1]->ORC [1]->placer_ord_nbr [1]->entity_id =   res_fill_entity
   Set oen_reply->RES_ORU_GROUP [1]->ORC [1]->placer_ord_nbr [1]->name_id = res_fill_name
   Set oen_reply->RES_ORU_GROUP [1]->ORC [1]->placer_ord_nbr [1]->univ_id = res_fill_univ
   Set oen_reply->RES_ORU_GROUP [1]->ORC [1]->placer_ord_nbr [1]->univ_id_type = res_fill_type

   Set oen_reply->RES_ORU_GROUP [1]->ORC [1]->filler_ord_nbr [1]->entity_id = res_plac_entity
   Set oen_reply->RES_ORU_GROUP [1]->ORC [1]->filler_ord_nbr [1]->name_id = res_plac_name
   Set oen_reply->RES_ORU_GROUP [1]->ORC [1]->filler_ord_nbr [1]->univ_id = res_plac_univ
   Set oen_reply->RES_ORU_GROUP [1]->ORC [1]->filler_ord_nbr [1]->univ_id_type = res_plac_type

   free set res_obr_fill_entity
   free set res_obr_fill_name
   free set res_obr_fill_univ
   free set res_obr_fill_type

   free set res_obr_plac_entity
   free set res_obr_plac_name
   free set res_obr_plac_univ
   free set res_obr_plac_type

   For (c = 1 to obr_temp)
   set res_obr_fill_entity = trim(oen_reply->RES_ORU_GROUP [c]->OBR [1]->filler_ord_nbr [1]->entity_id)
   set res_obr_fill_name = trim(oen_reply->RES_ORU_GROUP [c]->OBR [1]->filler_ord_nbr [1]->name_id)
   set res_obr_fill_univ = trim(oen_reply->RES_ORU_GROUP [c]->OBR [1]->filler_ord_nbr [1]->univ_id)
   set res_obr_fill_type = trim(oen_reply->RES_ORU_GROUP [c]->OBR [1]->filler_ord_nbr [1]->univ_id_type)

   set res_obr_plac_entity = trim(oen_reply->RES_ORU_GROUP [c]->OBR [1]->placer_ord_nbr [1]->entity_id)
   set res_obr_plac_name = trim(oen_reply->RES_ORU_GROUP [c]->OBR [1]->placer_ord_nbr [1]->name_id)
   set res_obr_plac_univ = trim(oen_reply->RES_ORU_GROUP [c]->OBR [1]->placer_ord_nbr [1]->univ_id)
   set res_obr_plac_type = trim(oen_reply->RES_ORU_GROUP [c]->OBR [1]->placer_ord_nbr [1]->univ_id_type)

   Set oen_reply->RES_ORU_GROUP [c]->OBR [1]->filler_ord_nbr [1]->entity_id =    res_obr_plac_entity
   Set oen_reply->RES_ORU_GROUP [c]->OBR [1]->filler_ord_nbr [1]->name_id =  res_obr_plac_name
   Set oen_reply->RES_ORU_GROUP [c]->OBR [1]->filler_ord_nbr [1]->univ_id =  res_obr_plac_univ
   Set oen_reply->RES_ORU_GROUP [c]->OBR [1]->filler_ord_nbr [1]->univ_id_type =   res_obr_plac_type

   Set oen_reply->RES_ORU_GROUP [c]->OBR [1]->placer_ord_nbr [1]->entity_id =  res_obr_fill_entity
   Set oen_reply->RES_ORU_GROUP [c]->OBR [1]->placer_ord_nbr [1]->name_id =  res_obr_fill_name
   Set oen_reply->RES_ORU_GROUP [c]->OBR [1]->placer_ord_nbr [1]->univ_id = res_obr_fill_univ
   Set oen_reply->RES_ORU_GROUP [c]->OBR [1]->placer_ord_nbr [1]->univ_id_type = res_obr_fill_type
   Endfor
  end height and weight */
endif

;todo - remove height and weight from this interface
if (oen_reply->ORDER_GROUP [1]->OBR_GROUP [1]->OBR->univ_service_id [1]->identifier in ("DEHTWT", "Discern Birth HT WT"))
  execute op_height_weight_modobj_out3
endif

/***3/31/2015 - Block BMG/UC Ht Wt messages OB ***/ /*todo-this might be able to be removed if we remove height and weight from this interface */
if (oen_reply->CONTROL_GROUP [1]->MSH [1]->message_type->messg_type = "ORU")
  if(oen_reply->PERSON_GROUP [1]->PAT_GROUP [1]->PV1 [1]->patient_type IN ("A", "OFFM", "OFFO", "OFFW", "OFFU")) 
    set oenstatus->ignore = 1
  endif
endif

/***3/17/10  by TDillon - adding logic to call doctor filter script***/
execute op_doc_filter_gen_out