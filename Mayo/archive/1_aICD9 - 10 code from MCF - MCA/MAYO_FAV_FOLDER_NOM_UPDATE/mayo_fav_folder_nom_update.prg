DROP PROGRAM MAYO_FAV_FOLDER_NOM_UPDATE :DBA GO
CREATE PROGRAM MAYO_FAV_FOLDER_NOM_UPDATE :DBA
DECLARE DIAGNOSIS_VAR = F8 WITH CONSTANT (UAR_GET_CODE_BY ("DISPLAY_KEY" ,25321 ,"DIAGNOSIS" ) ) ,
PROTECT
DECLARE PROBLEM_VAR = F8 WITH CONSTANT (UAR_GET_CODE_BY ("DISPLAY_KEY" ,25321 ,"PROBLEM" ) ) ,PROTECT
 
FREE RECORD NOMEN_UPDATES
RECORD NOMEN_UPDATES (
  1 LIST [*]
    2 OLD_NOMEN_ID = F8
    2 NEW_NOMEN_ID = F8
    2 NOMEN_CAT_LIST_ID = F8
    2 CONCEPT_CKI = VC
)
DECLARE MAX_NUM = F8 WITH PROTECT
DECLARE START_NUM = F8 WITH PROTECT
DECLARE END_NUM = F8 WITH PROTECT
DECLARE PROCESS_FLAG = I4 WITH PROTECT
DECLARE CNT1 =I4
SET CNT1 = 0
 
;select query to populate the NOMEN_UPDATES record structure
SELECT INTO "nl:"
FROM NOMEN_CATEGORY NC
,NOMEN_CAT_LIST NCL
,NOMENCLATURE N
,PRSNL PR
PLAN NC WHERE NC.CATEGORY_TYPE_CD IN (639016,639017)
;(DIAGNOSIS_VAR ,PROBLEM_VAR)
AND NC.PARENT_ENTITY_NAME ="PRSNL"
JOIN NCL WHERE NCL.PARENT_CATEGORY_ID = NC.NOMEN_CATEGORY_ID
JOIN N WHERE N.NOMENCLATURE_ID = NCL.NOMENCLATURE_ID
AND N.NOMENCLATURE_ID > 0
AND N.SOURCE_VOCABULARY_CD = 1231.00
JOIN PR WHERE PR.ACTIVE_IND > 0
AND PR.PERSON_ID = NC.PARENT_ENTITY_ID
;AND PR.PERSON_ID = 4274836 ; test patient id
AND PR.END_EFFECTIVE_DT_TM > SYSDATE+1
DETAIL
CNT1 = (CNT1 + 1 ) ,
STAT = ALTERLIST (NOMEN_UPDATES->LIST ,CNT1 ) ,
NOMEN_UPDATES->LIST[CNT1 ]->OLD_NOMEN_ID = NCL.NOMENCLATURE_ID ,
NOMEN_UPDATES->LIST[CNT1 ]->NOMEN_CAT_LIST_ID = NCL.NOMEN_CAT_LIST_ID ,
NOMEN_UPDATES->LIST[CNT1]->CONCEPT_CKI = N.CONCEPT_CKI
WITH NOCOUNTER
 
;Select query to get the new nomenclature id in the record structure
SELECT INTO "nl:"
FROM (CMT_CROSS_MAP X ) ,
(NOMENCLATURE N1 ) ,
(DUMMYT D WITH SEQ = SIZE (NOMEN_UPDATES->LIST ,5 ) )
PLAN D
JOIN X WHERE X.MAP_TYPE_CD = (SELECT CODE_VALUE FROM CODE_VALUE
WHERE CODE_SET = 29223  AND CDF_MEANING = "ICD9=MAYO" AND ACTIVE_IND = 1 )
AND X.CONCEPT_CKI = NOMEN_UPDATES->LIST[D.SEQ ]->CONCEPT_CKI
JOIN N1 WHERE X.TARGET_CONCEPT_CKI = N1.CONCEPT_CKI
AND N1.PRIMARY_VTERM_IND = 1
AND N1.END_EFFECTIVE_DT_TM > SYSDATE
DETAIL
NOMEN_UPDATES->LIST[D.SEQ ]->NEW_NOMEN_ID = N1.NOMENCLATURE_ID
WITH NOCOUNTER
 
;Select query to populate all the updating rows into a file
SELECT INTO "mhs_prg:nom_favs_update.txt"
FROM (DUMMYT D WITH SEQ = SIZE (NOMEN_UPDATES->LIST ,5 ) )
PLAN D
HEAD REPORT
CALL PRINT ("The following rows will be updated" ) ,
ROW + 1 ,
CALL PRINT ("Old Nomen|New Nomen|Nomen CAT List Id" ) ,
ROW + 1
HEAD REPORT
OLD_NOMEN = "                                                     " ,
NEW_NOMEN = "                                                     " ,
NOMEN_CAT_LIST_ID = "                                                "
DETAIL
OLD_NOMEN = TRIM (CNVTSTRING (NOMEN_UPDATES->LIST[D.SEQ ]->OLD_NOMEN_ID ) ) ,
NEW_NOMEN = TRIM (CNVTSTRING (NOMEN_UPDATES->LIST[D.SEQ ]->NEW_NOMEN_ID ) ) ,
NEW_NOMEN_CAT_LIST_ID = TRIM (CNVTSTRING (NOMEN_UPDATES->LIST[D.SEQ ]->NOMEN_CAT_LIST_ID ) ) ,
CALL PRINT (CONCAT (OLD_NOMEN ,"|" ,NEW_NOMEN ,"|" ,NOMEN_CAT_LIST_ID ) ) ,
ROW + 1
WITH NOCOUNTER
 
SET CNT = 0
FOR (X = 1 TO SIZE (NOMEN_UPDATES->LIST ,5 ) )
IF (NOMEN_UPDATES->LIST[X ]->NEW_NOMEN_ID > 0 )
SET CNT = (CNT + 1 )
UPDATE FROM (NOMEN_CAT_LIST NCL )
SET NCL.NOMENCLATURE_ID = NOMEN_UPDATES->LIST[X ]->NEW_NOMEN_ID ,
NCL.updt_applctx=888.60364,
NCL.updt_id=13825979, ; same id used in mhprd for problem migration
NCL.updt_task = 2100013,
NCL.UPDT_DT_TM = SYSDATE ,
NCL.UPDT_CNT = (NCL.UPDT_CNT + 1 )
PLAN NCL WHERE (NCL.NOMEN_CAT_LIST_ID = NOMEN_UPDATES->LIST[X ]->NOMEN_CAT_LIST_ID )
WITH NOCOUNTER
ENDIF
IF ((CNT > 10000 ) )
COMMIT
SET CNT = 0
ENDIF
ENDFOR
COMMIT
 
END GO
 
