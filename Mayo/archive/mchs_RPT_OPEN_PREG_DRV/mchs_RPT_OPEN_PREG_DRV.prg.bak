DROP PROGRAM mchs_RPT_OPEN_PREG_DRV :DBA GO
CREATE PROGRAM mchs_RPT_OPEN_PREG_DRV :DBA
CALL ECHO ("Enter dcp_rpt_open_preg_drv" )
SET MODIFY = PREDECLARE
DECLARE TESTVAR1 = VC WITH PERSISTSCRIPT
DECLARE TESTVAR2 = VC WITH PERSISTSCRIPT
DECLARE TESTVAR3 = VC WITH PERSISTSCRIPT
DECLARE DEBUG_PERSON_1 = F8 WITH PERSISTSCRIPT
DECLARE DEBUG_PERSON_2 = F8 WITH PERSISTSCRIPT
DECLARE ORG_IDX = I4 WITH PROTECT ,NOCONSTANT (0 )
DECLARE PROMPT11 = I4 WITH PROTECT ,NOCONSTANT (0 )
DECLARE PROMPT8 = I4 WITH PROTECT ,NOCONSTANT (0 )
SET PROMPT11 = PARAMETER (11 ,1 )
SET PROMPT8 = PARAMETER (8 ,1 )
IF (NOT (VALIDATE (PREGNANCY ,0 ) ) )
FREE RECORD PREGNANCY
RECORD PREGNANCY (
  1 PATIENT [*]
    2 PERSON_LASTNAME = VC
    2 PERSON_FIRSTNAME = VC
    2 MRN = VC
    2 GEST_AGE = VC
    2 PRIMARY_PHYSICIAN = VC
    2 FACILITY = VC
    2 EDD = VC
  1 PATIENT_CNT = I4
)
ENDIF
FREE RECORD TEMP
RECORD TEMP (
  1 PATIENT [*]
    2 PERSON_LASTNAME = VC
    2 PERSON_FIRSTNAME = VC
    2 MRN = VC
    2 GEST_AGE = VC
    2 GEST_AGE_DELIVERY = VC
    2 PRIMARY_PHYSICIAN = VC
    2 FACILITY = VC
    2 EDD = VC
    2 PERSON_ID = F8
    2 PREGNANCY_ID = F8
    2 EGA = I4
    2 PRINT_IND = I4
    2 R_EST_DELIVERY_DATE = DQ8
    2 R_DELIVERY_DATE = DQ8
    2 R_GEST_AGE_DELIVERY = I4
    2 R_CURRENT_GEST_AGE = I4
    2 ORG_DISPLAY = VC
)
FREE RECORD REQUEST_FINAL_EGA
RECORD REQUEST_FINAL_EGA (
  1 PATIENT_LIST [*]
    2 PATIENT_ID = F8
    2 ENCNTR_ID = F8
  1 PREGNANCY_LIST [*]
    2 PREGNANCY_ID = F8
  1 MULTIPLE_EGAS = I2
)
FREE RECORD ORG
RECORD ORG (
  1 REC [*]
    2 ORGANIZATION_ID = F8
    2 DISPLAY = VC
  1 COUNT = I4
  1 DISPLAY = VC
)
FREE RECORD ATTENDING
RECORD ATTENDING (
  1 REC [*]
    2 PERSON_ID = F8
    2 DISPLAY = VC
  1 COUNT = I4
)
IF (NOT (VALIDATE (REPLY ,0 ) ) )
RECORD REPLY (
  1 STATUS_DATA
    2 STATUS = C1
    2 SUBEVENTSTATUS [1 ]
      3 OPERATIONNAME = C25
      3 OPERATIONSTATUS = C1
      3 TARGETOBJECTNAME = C25
      3 TARGETOBJECTVALUE = VC
)
ENDIF
SET REPLY->STATUS_DATA->STATUS = "F"
DECLARE DEBUG_IND = I2 WITH PROTECT ,NOCONSTANT (0 )
SET DEBUG_IND = 0
IF ((VALIDATE (I18NUAR_DEF ,999 ) = 999 ) )
CALL ECHO ("Declaring i18nuar_def" )
DECLARE I18NUAR_DEF = I2 WITH PERSIST
SET I18NUAR_DEF = 1
DECLARE UAR_I18NLOCALIZATIONINIT ((P1 = I4 ) ,(P2 = VC ) ,(P3 = VC ) ,(P4 = F8 ) ) = I4 WITH
PERSIST
DECLARE UAR_I18NGETMESSAGE ((P1 = I4 ) ,(P2 = VC ) ,(P3 = VC ) ) = VC WITH PERSIST
DECLARE UAR_I18NBUILDMESSAGE () = VC WITH PERSIST
DECLARE UAR_I18NGETHIJRIDATE ((IMONTH = I2 (VAL ) ) ,(IDAY = I2 (VAL ) ) ,(IYEAR = I2 (VAL ) ) ,(
SDATEFORMATTYPE = VC (REF ) ) ) = C50 WITH IMAGE_AXP = "shri18nuar" ,IMAGE_AIX =
"libi18n_locale.a(libi18n_locale.o)" ,UAR = "uar_i18nGetHijriDate" ,PERSIST
DECLARE UAR_I18NBUILDFULLFORMATNAME ((SFIRST = VC (REF ) ) ,(SLAST = VC (REF ) ) ,(SMIDDLE = VC (
REF ) ) ,(SDEGREE = VC (REF ) ) ,(STITLE = VC (REF ) ) ,(SPREFIX = VC (REF ) ) ,(SSUFFIX = VC (REF
) ) ,(SINITIALS = VC (REF ) ) ,(SORIGINAL = VC (REF ) ) ) = C250 WITH IMAGE_AXP = "shri18nuar" ,
IMAGE_AIX = "libi18n_locale.a(libi18n_locale.o)" ,UAR = "i18nBuildFullFormatName" ,PERSIST
DECLARE UAR_I18NGETARABICTIME ((CTIME = VC (REF ) ) ) = C20 WITH IMAGE_AXP = "shri18nuar" ,
IMAGE_AIX = "libi18n_locale.a(libi18n_locale.o)" ,UAR = "i18n_GetArabicTime" ,PERSIST
ENDIF
IF ((VALIDATE (I18NUAR_DEF ,999 ) = 999 ) )
CALL ECHO ("Declaring i18nuar_def" )
DECLARE I18NUAR_DEF = I2 WITH PERSIST ,NOCONSTANT (1 )
DECLARE UAR_I18NLOCALIZATIONINIT ((P1 = I4 ) ,(P2 = VC ) ,(P3 = VC ) ,(P4 = F8 ) ) = I4 WITH
PERSIST
DECLARE UAR_I18NGETMESSAGE ((P1 = I4 ) ,(P2 = VC ) ,(P3 = VC ) ) = VC WITH PERSIST
DECLARE UAR_I18NBUILDMESSAGE () = VC WITH PERSIST
ENDIF
DECLARE I18NHANDLE = I4 WITH PERSISTSCRIPT
CALL UAR_I18NLOCALIZATIONINIT (I18NHANDLE ,CURPROG ,"" ,CURCCLREV )
DECLARE TITLECAPTION = VC WITH PERSISTSCRIPT
DECLARE TITLECAPTION_CONT = VC WITH PERSISTSCRIPT
DECLARE REPORTCAPTION = VC WITH PERSISTSCRIPT
DECLARE REPORTBYCAPTION = VC WITH PERSISTSCRIPT
DECLARE PATIENTIDCAPTION = VC WITH PERSISTSCRIPT
DECLARE LASTNAMECAPTION = VC WITH PERSISTSCRIPT
DECLARE FIRSTNAMECAPTION = VC WITH PERSISTSCRIPT
DECLARE GESTAGECAPTION = VC WITH PERSISTSCRIPT
DECLARE EDDCAPTION = VC WITH PERSISTSCRIPT
DECLARE PHYSICIANCAPTION = VC WITH PERSISTSCRIPT
DECLARE NODATACAPTION = VC WITH PERSISTSCRIPT
DECLARE NOENCOUNTERCAPTION = VC WITH PERSISTSCRIPT
DECLARE FACILITYCAPTION = VC WITH PERSISTSCRIPT
DECLARE PATIENTCAPTION = VC WITH PERSISTSCRIPT
DECLARE TIMEREPORTCAPTION = VC WITH PERSISTSCRIPT
DECLARE ENDOFREPORTCAPTION = VC WITH PERSISTSCRIPT
DECLARE ORGCAPTION = VC WITH PERSISTSCRIPT
DECLARE ORGSCAPTION = VC WITH PERSISTSCRIPT
DECLARE ALLORGCAPTION = VC WITH PERSISTSCRIPT
DECLARE RANGECAPTIONEDD = VC WITH PERSISTSCRIPT
DECLARE RANGECAPTIONEGA = VC WITH PERSISTSCRIPT
DECLARE GREATERTHANCAPTION = VC WITH PERSISTSCRIPT
DECLARE LESSTHANCAPTION = VC WITH PERSISTSCRIPT
DECLARE EQUALTOCAPTION = VC WITH PERSISTSCRIPT
DECLARE BETWEENCAPTION = VC WITH PERSISTSCRIPT
DECLARE WEEKSCAPTION = VC WITH PERSISTSCRIPT
DECLARE FILTERCAPTIONP = VC WITH PERSISTSCRIPT
DECLARE FILTERCAPTIONG = VC WITH PERSISTSCRIPT
DECLARE FILTERCAPTIONA = VC WITH PERSISTSCRIPT
DECLARE FILTERCAPTION = VC WITH PERSISTSCRIPT
DECLARE FILTERBYCAPTION = VC WITH PERSISTSCRIPT
DECLARE PAGECAPTION = VC WITH PROTECT
DECLARE CNT = I4 WITH PROTECT ,NOCONSTANT (0 )
DECLARE MRN_CD = F8 WITH PROTECT ,CONSTANT (UAR_GET_CODE_BY ("MEANING" ,4 ,"MRN" ) )
DECLARE FACILITY_CD = F8 WITH PROTECT ,CONSTANT (UAR_GET_CODE_BY ("MEANING" ,222 ,"FACILITY" ) )
DECLARE PROVIDER_GROUP_CD = F8 WITH PROTECT ,CONSTANT (UAR_GET_CODE_BY_CKI ("CKI.CODEVALUE!111133"
) )
DECLARE NDX_V = I2 WITH PROTECT ,NOCONSTANT (0 )
DECLARE ACTIVE_PREG_CNT = I4 WITH PROTECT ,NOCONSTANT (0 )
DECLARE EST_DELIVERY_DATE = DQ8 WITH PROTECT
DECLARE DELIVERY_DATE = DQ8 WITH PROTECT
DECLARE ORG_DISPLAY = VC WITH PROTECT ,NOCONSTANT ("" )
DECLARE GEST_AGE_DELIVERY = I4 WITH PROTECT ,NOCONSTANT (0 )
DECLARE GESTAGEWEEKS = I4 WITH PROTECT ,NOCONSTANT (0 )
DECLARE NEW_CUR_GEST_AGE = I4 WITH PROTECT ,NOCONSTANT (0 )
DECLARE GESTAGE = I4 WITH PROTECT ,NOCONSTANT (0 )
DECLARE GESTAGEDAYS = I4 WITH PROTECT ,NOCONSTANT (0 )
DECLARE EGA_CALCULATED = I2 WITH PROTECT ,NOCONSTANT (0 )
DECLARE PRINT_PRSNL_NAME = VC WITH PERSISTSCRIPT ,NOCONSTANT ("" )
DECLARE IREQUESTSIZE = I4 WITH PROTECT ,NOCONSTANT (0 )
DECLARE IDX = I4 WITH PROTECT ,NOCONSTANT (0 )
DECLARE EXPAND_START = I4 WITH PROTECT ,NOCONSTANT (1 )
DECLARE EXPAND_SIZE = I4 WITH PROTECT ,NOCONSTANT (100 )
DECLARE EXPAND_TOTAL = I4 WITH PROTECT ,NOCONSTANT (0 )
DECLARE BSTATUS = I2 WITH PROTECT ,NOCONSTANT (0 )
DECLARE CSTATUS = I2 WITH PROTECT ,NOCONSTANT (0 )
DECLARE SERRORMSG = VC WITH PROTECT ,NOCONSTANT ("" )
DECLARE IERRORCODE = I2 WITH PROTECT ,NOCONSTANT (0 )
DECLARE S_ORG = VC WITH PERSISTSCRIPT
DECLARE ORG_CAPTION = VC WITH PERSISTSCRIPT
DECLARE RANGECAPTION = VC WITH PERSISTSCRIPT
DECLARE DT_OR_AGE_RANGE = VC WITH PERSISTSCRIPT
DECLARE RPT_TIME_DISPLAY = VC WITH PERSISTSCRIPT
DECLARE NUM_DAYS_INT_S = I4 WITH PROTECT ,NOCONSTANT (0 )
DECLARE NUM_DAYS_INT_E = I4 WITH PROTECT ,NOCONSTANT (0 )
DECLARE ORG_INT = I4 WITH PROTECT ,NOCONSTANT (0 )
DECLARE PER_INT = I4 WITH PROTECT ,NOCONSTANT (0 )
DECLARE ISTAT = I4 WITH PROTECT ,NOCONSTANT (0 )
DECLARE S_CONDITION_PARSER = VC WITH PERSISTSCRIPT ,NOCONSTANT (" " )
DECLARE VALID_PI_ORG_ID_IND = I4 WITH PROTECT ,CONSTANT (CHECKDIC (
"PREGNANCY_INSTANCE.ORGANIZATION_ID" ,"A" ,0 ) )
DECLARE ALL_ORGS_FLAG = I4 WITH PROTECT ,NOCONSTANT (0 )
SET TITLECAPTION = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap1" ,"Open Pregnancies by EGA/EDD" )
SET TITLECAPTION_CONT = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap1.5" ,
"Estimated Gestational Age Report (continued)" )
SET REPORTCAPTION = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap2" ,"Report as of:" )
SET PATIENTIDCAPTION = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap3" ,"Patient MRN / ID" )
SET LASTNAMECAPTION = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap4" ,"Last Name" )
SET FIRSTNAMECAPTION = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap5" ,"First Name" )
SET GESTAGECAPTION = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap6" ,"Gestational Age" )
SET PHYSICIANCAPTION = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap7" ,"Pregnancy Added By" )
SET NODATACAPTION = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap8" ,"No qualifying data available" )
SET FACILITYCAPTION = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap9" ,"Facility Name" )
SET REPORTBYCAPTION = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap10" ,"Report run by:   " )
SET PATIENTCAPTION = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap11" ,"Patient" )
SET TIMEREPORTCAPTION = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap12" ,"Time of Report:   " )
SET ENDOFREPORTCAPTION = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap13" ,"*** End of Report ***" )
SET PAGECAPTION = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap14" ,"Page" )
SET EDDCAPTION = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap15" ,"EDD" )
SET ORGCAPTION = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap16" ,"Organization: " )
SET ORGSCAPTION = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap17" ,"Organizations: " )
SET RANGECAPTIONEGA = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap18" ,
"Estimated Gestational Age Range:   " )
SET RANGECAPTIONEDD = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap19" ,"Estimated Delivery Date Range:   "
)
SET GREATERTHANCAPTION = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap20" ,"Greater than" )
SET LESSTHANCAPTION = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap21" ,"Less than" )
SET EQUALTOCAPTION = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap22" ,"Equal to" )
SET BETWEENCAPTION = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap23" ,"Range" )
SET ALLORGCAPTION = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap24" ,"All Organizations" )
SET WEEKSCAPTION = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap25" ,"weeks" )
SET FILTERCAPTIONP = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap26" ,"Physician" )
SET FILTERCAPTIONG = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap27" ,"Physician group" )
SET FILTERCAPTIONA = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap28" ,"All physicians" )
SET FILTERBYCAPTION = UAR_I18NGETMESSAGE (I18NHANDLE ,"cap29" ,"Filtered by:" )

record fac (
1 qual[*]
  2 prefix = c2
)

if ($8 = "SWMN")
  set stat = alterlist(fac->qual,2)
  set fac->qual[1].prefix = "MA"
  set fac->qual[2].prefix = "FA"
elseif ($8 = "SEMN")
  set stat = alterlist(fac->qual,7)
  set fac->qual[1].prefix = "AL"
  set fac->qual[2].prefix = "AU"
  set fac->qual[3].prefix = "CA"
  set fac->qual[4].prefix = "LC"
  set fac->qual[5].prefix = "OW"
  set fac->qual[6].prefix = "RW"
  set fac->qual[7].prefix = "FB"
elseif ($8 = "NWWI")
  set stat = alterlist(fac->qual,2)
  set fac->qual[1].prefix = "EU"
  set fac->qual[2].prefix = "ME"
elseif ($8 = "SWWI")
  set stat = alterlist(fac->qual,1)
  set fac->qual[1].prefix = "LA"
endif


select into "nl:"
from 
(dummyt d with seq = size(fac->qual,5)),
code_value cv, 
location l, 
organization o

plan d

join cv
where cv.code_set = 220 
and cv.active_ind = 1
and cv.cdf_meaning = "FACILITY" 
and cv.display_key = fac->qual[d.seq].prefix
and not cv.display_key in  ("*HOSP*","MAYOMHS")

join l
where l.location_cd = cv.code_value

join o
where o.organization_id = l.organization_id

order cv.display

HEAD REPORT
CNT = 0
DETAIL
CNT = (CNT + 1 ) ,
STAT = ALTERLIST (ORG->REC ,CNT ) ,
ORG->REC[CNT ]->ORGANIZATION_ID = O.ORGANIZATION_ID ,
ORG->REC[CNT ]->DISPLAY = O.ORG_NAME ,
IF ((CNT > 1 ) ) ORG->DISPLAY = CONCAT (ORG->DISPLAY ,"; " ,TRIM (O.ORG_NAME ) )
ELSE ORG->DISPLAY = TRIM (O.ORG_NAME )
ENDIF
FOOT REPORT
ORG->COUNT = CNT
WITH NOCOUNTER

;SELECT INTO "nl:"
;FROM (ORGANIZATION O )
;PLAN (O
;WHERE (O.ORGANIZATION_ID IN ($8 ) ) AND (O.ORGANIZATION_ID != 0 ) )
;HEAD REPORT
;CNT = 0
;DETAIL
;CNT = (CNT + 1 ) ,
;STAT = ALTERLIST (ORG->REC ,CNT ) ,
;ORG->REC[CNT ]->ORGANIZATION_ID = O.ORGANIZATION_ID ,
;ORG->REC[CNT ]->DISPLAY = O.ORG_NAME ,
;IF ((CNT > 1 ) ) ORG->DISPLAY = CONCAT (ORG->DISPLAY ,"; " ,TRIM (O.ORG_NAME ) )
;ELSE ORG->DISPLAY = TRIM (O.ORG_NAME )
;ENDIF
;FOOT REPORT
;ORG->COUNT = CNT
;WITH NOCOUNTER

IF ((SIZE (ORG->REC ,5 ) = 0 ) )
SET ALL_ORGS_FLAG = 1
ENDIF
IF ((CNVTINT ($2 ) = 1 ) )
SET NUM_DAYS_INT_S = (CNVTINT ($4 ) * 7 )
SET NUM_DAYS_INT_E = (CNVTINT ($5 ) * 7 )
SET RANGECAPTION = RANGECAPTIONEGA
ENDIF
IF ((CNVTINT ($2 ) = 2 ) )
SET RANGECAPTION = RANGECAPTIONEDD
SET DT_OR_AGE_RANGE = CONCAT (TRIM ($6 ) ," - " ,TRIM ($7 ) )
ELSEIF ((CNVTINT ($3 ) = 1 ) )
SET S_CONDITION_PARSER = "new_cur_gest_age = value(num_days_int_s)"
SET DT_OR_AGE_RANGE = CONCAT (EQUALTOCAPTION ," " ,TRIM ($4 ) ," " ,WEEKSCAPTION )
ELSEIF ((CNVTINT ($3 ) = 2 ) )
SET S_CONDITION_PARSER = "new_cur_gest_age > value(num_days_int_s)"
SET DT_OR_AGE_RANGE = CONCAT (GREATERTHANCAPTION ," " ,TRIM ($4 ) ," " ,WEEKSCAPTION )
ELSEIF ((CNVTINT ($3 ) = 3 ) )
SET S_CONDITION_PARSER = "new_cur_gest_age < value(num_days_int_s)"
SET DT_OR_AGE_RANGE = CONCAT (LESSTHANCAPTION ," " ,TRIM ($4 ) ," " ,WEEKSCAPTION )
ELSEIF ((CNVTINT ($3 ) = 4 ) )
SET S_CONDITION_PARSER = "new_cur_gest_age between value(num_days_int_s) and value(num_days_int_e)"
SET DT_OR_AGE_RANGE = CONCAT (BETWEENCAPTION ," " ,TRIM ($4 ) ," - " ,TRIM ($5 ) ," " ,WEEKSCAPTION
)
ENDIF
IF ((CNVTINT ($9 ) = 1 ) )
IF ((PROMPT11 = 0 ) )
SET FILTERCAPTION = FILTERCAPTIONA
ELSE
SELECT INTO "nl:"
FROM (PRSNL PR )
PLAN (PR
WHERE (PR.PERSON_ID IN ($11 ) ) AND (PR.PERSON_ID != 0 ) )
HEAD REPORT
P_CNT = 0
DETAIL
P_CNT = (P_CNT + 1 ) ,
IF ((P_CNT > SIZE (ATTENDING->REC ,5 ) ) ) STAT = ALTERLIST (ATTENDING->REC ,(P_CNT + 9 ) )
ENDIF
,
ATTENDING->REC[P_CNT ]->PERSON_ID = PR.PERSON_ID ,
ATTENDING->REC[P_CNT ]->DISPLAY = PR.NAME_LAST
FOOT REPORT
ATTENDING->COUNT = P_CNT ,
STAT = ALTERLIST (ATTENDING->REC ,P_CNT )
WITH NOCOUNTER
SET FILTERCAPTION = FILTERCAPTIONP
ENDIF
ELSEIF ((CNVTINT ($9 ) = 2 ) )
SET FILTERCAPTION = FILTERCAPTIONG
IF ((ISNUMERIC (PARAMETER (11 ,1 ) ) > 0 ) )
SELECT INTO "nl:"
FROM (PRSNL_GROUP_RELTN PGR ) ,
(PRSNL PR )
PLAN (PGR
WHERE (PGR.PRSNL_GROUP_ID IN ($11 ) ) )
AND (PR
WHERE (PR.PERSON_ID = PGR.PERSON_ID ) AND (PR.ACTIVE_IND = 1 ) )
ORDER BY PR.PERSON_ID
HEAD REPORT
P_CNT = 0
HEAD PR.PERSON_ID
P_CNT = (P_CNT + 1 ) ,
IF ((P_CNT > SIZE (ATTENDING->REC ,5 ) ) ) STAT = ALTERLIST (ATTENDING->REC ,(P_CNT + 9 ) )
ENDIF
,ATTENDING->REC[P_CNT ]->PERSON_ID = PR.PERSON_ID ,ATTENDING->REC[P_CNT ]->DISPLAY = PR.NAME_LAST
FOOT REPORT
ATTENDING->COUNT = P_CNT ,
STAT = ALTERLIST (ATTENDING->REC ,P_CNT )
WITH NOCOUNTER
ELSE
SELECT INTO "nl:"
FROM (PRSNL_GROUP PG ) ,
(PRSNL_GROUP_RELTN PGR ) ,
(PRSNL PR )
PLAN (PG
WHERE (PG.PRSNL_GROUP_CLASS_CD = PROVIDER_GROUP_CD ) AND (PG.END_EFFECTIVE_DT_TM > CNVTDATETIME (
CURDATE ,CURTIME3 ) ) AND (PG.ACTIVE_IND = 1 ) )
AND (PGR
WHERE (PGR.PRSNL_GROUP_ID = PG.PRSNL_GROUP_ID ) AND (PGR.PRSNL_GROUP_ID != 0 ) )
AND (PR
WHERE (PR.PERSON_ID = PGR.PERSON_ID ) AND (PR.ACTIVE_IND = 1 ) )
ORDER BY PR.PERSON_ID
HEAD REPORT
P_CNT = 0
HEAD PR.PERSON_ID
P_CNT = (P_CNT + 1 ) ,
IF ((P_CNT > SIZE (ATTENDING->REC ,5 ) ) ) STAT = ALTERLIST (ATTENDING->REC ,(P_CNT + 9 ) )
ENDIF
,ATTENDING->REC[P_CNT ]->PERSON_ID = PR.PERSON_ID ,ATTENDING->REC[P_CNT ]->DISPLAY = PR.NAME_LAST
FOOT REPORT
ATTENDING->COUNT = P_CNT ,
STAT = ALTERLIST (ATTENDING->REC ,P_CNT )
WITH NOCOUNTER
ENDIF
ENDIF
DECLARE LOADPREGNANCYORGANIZATIONSECURITYLIST () = NULL
IF ((VALIDATE (PREG_ORG_SEC_IND ) = 0 ) )
DECLARE PREG_ORG_SEC_IND = I4 WITH NOCONSTANT (0 )
SELECT INTO "nl:"
FROM (DM_INFO D1 ) ,
(DM_INFO D2 )
WHERE (D1.INFO_DOMAIN = "SECURITY" ) AND (D1.INFO_NAME = "SEC_ORG_RELTN" ) AND (D1.INFO_NUMBER = 1
) AND (D2.INFO_DOMAIN = "SECURITY" ) AND (D2.INFO_NAME = "SEC_PREG_ORG_RELTN" ) AND (D2.INFO_NUMBER
= 1 )
DETAIL
PREG_ORG_SEC_IND = 1
WITH NOCOUNTER
CALL ECHO (BUILD ("preg_org_sec_ind=" ,PREG_ORG_SEC_IND ) )
IF ((PREG_ORG_SEC_IND = 1 ) )
FREE RECORD PREG_SEC_ORGS
RECORD PREG_SEC_ORGS (
  1 QUAL [*]
    2 ORG_ID = F8
    2 CONFID_LEVEL = I4
)
CALL LOADPREGNANCYORGANIZATIONSECURITYLIST (NULL )
ENDIF
ENDIF
SUBROUTINE  LOADPREGNANCYORGANIZATIONSECURITYLIST (NULL )
DECLARE ORG_CNT = I2 WITH NOCONSTANT (0 )
DECLARE STAT = I2 WITH PROTECT ,NOCONSTANT (0 )
IF ((VALIDATE (SAC_ORG ) = 1 ) )
FREE RECORD SAC_ORG
ENDIF
RECORD SAC_ORG (
  1 ORGANIZATIONS [*]
    2 ORGANIZATION_ID = F8
    2 CONFID_CD = F8
    2 CONFID_LEVEL = I4
)
EXECUTE SECRTL
DECLARE ORGCNT = I4 WITH PROTECTED ,NOCONSTANT (0 )
DECLARE SECSTAT = I2
DECLARE LOGONTYPE = I4 WITH PROTECT ,NOCONSTANT (- (1 ) )
DECLARE CONFID_CD = F8 WITH PROTECTED ,NOCONSTANT (0.0 )
DECLARE ROLE_PROFILE_ORG_ID = F8 WITH PROTECTED ,NOCONSTANT (0.0 )
CALL UAR_SECGETCLIENTLOGONTYPE (LOGONTYPE )
CALL ECHO (BUILD ("logontype:" ,LOGONTYPE ) )
IF ((LOGONTYPE = 0 ) )
SELECT DISTINCT INTO "nl:"
FROM (PRSNL_ORG_RELTN POR ) ,
(ORGANIZATION O ) ,
(PRSNL P )
PLAN (P
WHERE (P.PERSON_ID = REQINFO->UPDT_ID ) )
AND (POR
WHERE (POR.PERSON_ID = P.PERSON_ID ) AND (POR.ACTIVE_IND = 1 ) AND (POR.BEG_EFFECTIVE_DT_TM <=
CNVTDATETIME (CURDATE ,CURTIME3 ) ) AND (POR.END_EFFECTIVE_DT_TM > CNVTDATETIME (CURDATE ,CURTIME3
) ) )
AND (O
WHERE (POR.ORGANIZATION_ID = O.ORGANIZATION_ID ) )
DETAIL
ORGCNT = (ORGCNT + 1 ) ,
IF ((MOD (ORGCNT ,10 ) = 1 ) ) SECSTAT = ALTERLIST (SAC_ORG->ORGANIZATIONS ,(ORGCNT + 9 ) )
ENDIF
,
SAC_ORG->ORGANIZATIONS[ORGCNT ]->ORGANIZATION_ID = POR.ORGANIZATION_ID ,
SAC_ORG->ORGANIZATIONS[ORGCNT ]->CONFID_CD = POR.CONFID_LEVEL_CD ,
CONFID_CD = UAR_GET_COLLATION_SEQ (POR.CONFID_LEVEL_CD ) ,
SAC_ORG->ORGANIZATIONS[ORGCNT ]->CONFID_LEVEL =
IF ((CONFID_CD > 0 ) ) CONFID_CD
ELSE 0
ENDIF
WITH NOCOUNTER
SET SECSTAT = ALTERLIST (SAC_ORG->ORGANIZATIONS ,ORGCNT )
ENDIF
IF ((LOGONTYPE = 1 ) )
CALL ECHO ("entered into NHS logon" )
DECLARE HPROP = I4 WITH PROTECT ,NOCONSTANT (0 )
DECLARE TMPSTAT = I2
DECLARE SPROPNAME = VC
DECLARE SROLEPROFILE = VC
SET HPROP = UAR_SRVCREATEPROPERTY ()
SET TMPSTAT = UAR_SECGETCLIENTATTRIBUTESEXT (5 ,HPROP )
SET SPROPNAME = UAR_SRVFIRSTPROPERTY (HPROP )
SET SROLEPROFILE = UAR_SRVGETPROPERTYPTR (HPROP ,NULLTERM (SPROPNAME ) )
CALL ECHO (SROLEPROFILE )
DECLARE NHSTRUSTCHILD_ORG_ORG_RELTN_CD = F8
SET NHSTRUSTCHILD_ORG_ORG_RELTN_CD = UAR_GET_CODE_BY ("MEANING" ,369 ,"NHSTRUSTCHLD" )
SELECT INTO "nl:"
FROM (PRSNL_ORG_RELTN_TYPE PRT ) ,
(PRSNL_ORG_RELTN POR ) ,
(ORGANIZATION O )
PLAN (PRT
WHERE (PRT.ROLE_PROFILE = SROLEPROFILE ) AND (PRT.ACTIVE_IND = 1 ) AND (PRT.BEG_EFFECTIVE_DT_TM <=
CNVTDATETIME (CURDATE ,CURTIME3 ) ) AND (PRT.END_EFFECTIVE_DT_TM > CNVTDATETIME (CURDATE ,CURTIME3
) ) )
AND (O
WHERE (O.ORGANIZATION_ID = PRT.ORGANIZATION_ID ) )
AND (POR
WHERE (OUTERJOIN (PRT.ORGANIZATION_ID ) = POR.ORGANIZATION_ID ) AND (POR.PERSON_ID = OUTERJOIN (
PRT.PRSNL_ID ) ) AND (POR.ACTIVE_IND = OUTERJOIN (1 ) ) AND (POR.BEG_EFFECTIVE_DT_TM <= OUTERJOIN (
CNVTDATETIME (CURDATE ,CURTIME3 ) ) ) AND (POR.END_EFFECTIVE_DT_TM > OUTERJOIN (CNVTDATETIME (
CURDATE ,CURTIME3 ) ) ) )
ORDER BY POR.PRSNL_ORG_RELTN_ID
DETAIL
ORGCNT = 1 ,
STAT = ALTERLIST (SAC_ORG->ORGANIZATIONS ,1 ) ,
SAC_ORG->ORGANIZATIONS[1 ]->ORGANIZATION_ID = PRT.ORGANIZATION_ID ,
ROLE_PROFILE_ORG_ID = SAC_ORG->ORGANIZATIONS[ORGCNT ]->ORGANIZATION_ID ,
SAC_ORG->ORGANIZATIONS[1 ]->CONFID_CD = POR.CONFID_LEVEL_CD ,
CONFID_CD = UAR_GET_COLLATION_SEQ (POR.CONFID_LEVEL_CD ) ,
SAC_ORG->ORGANIZATIONS[1 ]->CONFID_LEVEL =
IF ((CONFID_CD > 0 ) ) CONFID_CD
ELSE 0
ENDIF
WITH MAXREC = 1
SELECT INTO "nl:"
FROM (PRSNL_ORG_RELTN POR )
PLAN (POR
WHERE (POR.PERSON_ID = REQINFO->UPDT_ID ) AND (POR.ACTIVE_IND = 1 ) AND (POR.BEG_EFFECTIVE_DT_TM <=
CNVTDATETIME (CURDATE ,CURTIME3 ) ) AND (POR.END_EFFECTIVE_DT_TM > CNVTDATETIME (CURDATE ,CURTIME3
) ) )
HEAD REPORT
IF ((ORGCNT > 0 ) ) STAT = ALTERLIST (SAC_ORG->ORGANIZATIONS ,10 )
ENDIF
DETAIL
IF ((ROLE_PROFILE_ORG_ID != POR.ORGANIZATION_ID ) ) ORGCNT = (ORGCNT + 1 ) ,
IF ((MOD (ORGCNT ,10 ) = 1 ) ) STAT = ALTERLIST (SAC_ORG->ORGANIZATIONS ,(ORGCNT + 9 ) )
ENDIF
,SAC_ORG->ORGANIZATIONS[ORGCNT ]->ORGANIZATION_ID = POR.ORGANIZATION_ID ,SAC_ORG->ORGANIZATIONS[
ORGCNT ]->CONFID_CD = POR.CONFID_LEVEL_CD ,CONFID_CD = UAR_GET_COLLATION_SEQ (POR.CONFID_LEVEL_CD )
,SAC_ORG->ORGANIZATIONS[ORGCNT ]->CONFID_LEVEL =
IF ((CONFID_CD > 0 ) ) CONFID_CD
ELSE 0
ENDIF
ENDIF
FOOT REPORT
STAT = ALTERLIST (SAC_ORG->ORGANIZATIONS ,ORGCNT )
WITH NOCOUNTER
CALL UAR_SRVDESTROYHANDLE (HPROP )
ENDIF
SET ORG_CNT = SIZE (SAC_ORG->ORGANIZATIONS ,5 )
CALL ECHO (BUILD ("org_cnt: " ,ORG_CNT ) )
SET STAT = ALTERLIST (PREG_SEC_ORGS->QUAL ,(ORG_CNT + 1 ) )
FOR (COUNT = 1 TO ORG_CNT )
SET PREG_SEC_ORGS->QUAL[COUNT ]->ORG_ID = SAC_ORG->ORGANIZATIONS[COUNT ]->ORGANIZATION_ID
SET PREG_SEC_ORGS->QUAL[COUNT ]->CONFID_LEVEL = SAC_ORG->ORGANIZATIONS[COUNT ]->CONFID_LEVEL
ENDFOR
SET PREG_SEC_ORGS->QUAL[(ORG_CNT + 1 ) ]->ORG_ID = 0.00
SET PREG_SEC_ORGS->QUAL[(ORG_CNT + 1 ) ]->CONFID_LEVEL = 0
END ;Subroutine
SELECT INTO "nl:"
FROM (PRSNL P )
PLAN (P
WHERE (P.PERSON_ID = REQINFO->UPDT_ID ) )
DETAIL
PRINT_PRSNL_NAME = SUBSTRING (1 ,40 ,P.NAME_FULL_FORMATTED )
WITH NOCOUNTER
IF ((DEBUG_IND >= 1 ) )
CALL ECHO (BUILD ("PRSNL_ID: " ,REQINFO->UPDT_ID ) )
CALL ECHO (BUILD ("PRSNL_NAME: " ,PRINT_PRSNL_NAME ) )
ENDIF
SET RPT_TIME_DISPLAY = FORMAT (CNVTDATETIME (CURDATE ,CURTIME3 ) ,"@SHORTDATETIME" )
IF ((ALL_ORGS_FLAG = 1 ) )
SELECT
IF ((PREG_ORG_SEC_IND = 1 ) AND (VALID_PI_ORG_ID_IND > 0 ) )
FROM (PREGNANCY_INSTANCE PI ) ,
(ENCOUNTER E ) ,
(ORGANIZATION O ) ,
(PROBLEM PR ) ,
(DUMMYT D1 WITH SEQ = SIZE (PREG_SEC_ORGS->QUAL ,5 ) )
PLAN (PI
WHERE (PI.PREG_END_DT_TM >= CNVTDATETIME (CURDATE ,CURTIME3 ) ) AND (PI.ACTIVE_IND = 1 ) AND (
PI.HISTORICAL_IND = 0 ) )
AND (PR
WHERE (PR.PROBLEM_ID = PI.PROBLEM_ID ) AND (PR.ACTIVE_IND = 1 ) )
AND (E
WHERE (E.PERSON_ID = PI.PERSON_ID ) AND (CNVTINT (FORMAT (E.REG_DT_TM ,"YYYYMMDD;;D" ) ) >= CNVTINT
(FORMAT (PR.ONSET_DT_TM ,"YYYYMMDD;;D" ) ) ) )
AND (O
WHERE (O.ORGANIZATION_ID = E.ORGANIZATION_ID ) )
AND (D1
WHERE (O.ORGANIZATION_ID = PREG_SEC_ORGS->QUAL[D1.SEQ ]->ORG_ID ) )
ELSE
FROM (PREGNANCY_INSTANCE PI ) ,
(ENCOUNTER E ) ,
(ORGANIZATION O ) ,
(PROBLEM PR )
PLAN (PI
WHERE (PI.PREG_END_DT_TM >= CNVTDATETIME (CURDATE ,CURTIME3 ) ) AND (PI.ACTIVE_IND = 1 ) AND (
PI.HISTORICAL_IND = 0 ) )
AND (PR
WHERE (PR.PROBLEM_ID = PI.PROBLEM_ID ) AND (PR.ACTIVE_IND = 1 ) )
AND (E
WHERE (E.PERSON_ID = PI.PERSON_ID ) AND (CNVTINT (FORMAT (E.REG_DT_TM ,"YYYYMMDD;;D" ) ) >= CNVTINT
(FORMAT (PR.ONSET_DT_TM ,"YYYYMMDD;;D" ) ) ) )
AND (O
WHERE (O.ORGANIZATION_ID = E.ORGANIZATION_ID ) )
ENDIF
ORDER BY PI.PREGNANCY_ID ,
O.ORGANIZATION_ID
HEAD REPORT
ACTIVE_PREG_CNT = 0 ,
ORG_CNT = 0
HEAD PI.PREGNANCY_ID
ACTIVE_PREG_CNT = (ACTIVE_PREG_CNT + 1 ) ,
IF ((ACTIVE_PREG_CNT > SIZE (REQUEST_FINAL_EGA->PREGNANCY_LIST ,5 ) ) ) BSTATUS = ALTERLIST (
REQUEST_FINAL_EGA->PREGNANCY_LIST ,(ACTIVE_PREG_CNT + 9 ) ) ,CSTATUS = ALTERLIST (TEMP->PATIENT ,(
ACTIVE_PREG_CNT + 9 ) )
ENDIF
,REQUEST_FINAL_EGA->PREGNANCY_LIST[ACTIVE_PREG_CNT ]->PREGNANCY_ID = PI.PREGNANCY_ID ,TEMP->PATIENT[
ACTIVE_PREG_CNT ]->PREGNANCY_ID = PI.PREGNANCY_ID ,TEMP->PATIENT[ACTIVE_PREG_CNT ]->PERSON_ID =
PI.PERSON_ID ,ORG_CNT = 0
HEAD O.ORGANIZATION_ID
ORG_CNT = (ORG_CNT + 1 ) ,
IF ((ORG_CNT = 1 ) ) TEMP->PATIENT[ACTIVE_PREG_CNT ]->ORG_DISPLAY = TRIM (O.ORG_NAME )
ELSE TEMP->PATIENT[ACTIVE_PREG_CNT ]->ORG_DISPLAY = CONCAT (TEMP->PATIENT[ACTIVE_PREG_CNT ]->
ORG_DISPLAY ," ," ,TRIM (O.ORG_NAME ) )
ENDIF
FOOT REPORT
BSTATUS = ALTERLIST (REQUEST_FINAL_EGA->PREGNANCY_LIST ,ACTIVE_PREG_CNT ) ,
CSTATUS = ALTERLIST (TEMP->PATIENT ,ACTIVE_PREG_CNT )
WITH NOCOUNTER
ELSE
SELECT
IF ((PREG_ORG_SEC_IND = 1 ) AND (VALID_PI_ORG_ID_IND > 0 ) )
FROM (PREGNANCY_INSTANCE PI ) ,
(ENCOUNTER E ) ,
(ORGANIZATION O ) ,
(PROBLEM PR )
PLAN (PI
WHERE (PI.PREG_END_DT_TM >= CNVTDATETIME (CURDATE ,CURTIME3 ) ) AND (PI.ACTIVE_IND = 1 ) AND (
PI.HISTORICAL_IND = 0 ) )
AND (PR
WHERE (PR.PROBLEM_ID = PI.PROBLEM_ID ) AND (PR.ACTIVE_IND = 1 ) )
AND (E
WHERE (E.PERSON_ID = PI.PERSON_ID ) AND (CNVTINT (FORMAT (E.REG_DT_TM ,"YYYYMMDD;;D" ) ) >= CNVTINT
(FORMAT (PR.ONSET_DT_TM ,"YYYYMMDD;;D" ) ) ) AND EXPAND (ORG_IDX ,1 ,ORG->COUNT ,E.ORGANIZATION_ID ,
ORG->REC[ORG_IDX ]->ORGANIZATION_ID ) AND EXPAND (ORG_IDX ,1 ,SIZE (PREG_SEC_ORGS->QUAL ,5 ) ,
E.ORGANIZATION_ID ,PREG_SEC_ORGS->QUAL[ORG_IDX ]->ORG_ID ) )
AND (O
WHERE (O.ORGANIZATION_ID = E.ORGANIZATION_ID ) )
ELSE
FROM (PREGNANCY_INSTANCE PI ) ,
(ENCOUNTER E ) ,
(ORGANIZATION O ) ,
(PROBLEM PR )
PLAN (PI
WHERE (PI.PREG_END_DT_TM >= CNVTDATETIME (CURDATE ,CURTIME3 ) ) AND (PI.ACTIVE_IND = 1 ) AND (
PI.HISTORICAL_IND = 0 ) )
AND (PR
WHERE (PR.PROBLEM_ID = PI.PROBLEM_ID ) AND (PR.ACTIVE_IND = 1 ) )
AND (E
WHERE (E.PERSON_ID = PI.PERSON_ID ) AND (CNVTINT (FORMAT (E.REG_DT_TM ,"YYYYMMDD;;D" ) ) >= CNVTINT
(FORMAT (PR.ONSET_DT_TM ,"YYYYMMDD;;D" ) ) ) AND EXPAND (ORG_IDX ,1 ,ORG->COUNT ,E.ORGANIZATION_ID ,
ORG->REC[ORG_IDX ]->ORGANIZATION_ID ) )
AND (O
WHERE (O.ORGANIZATION_ID = E.ORGANIZATION_ID ) )
ENDIF
ORDER BY PI.PREGNANCY_ID ,
O.ORGANIZATION_ID
HEAD REPORT
ACTIVE_PREG_CNT = 0 ,
ORG_CNT = 0
HEAD PI.PREGNANCY_ID
ACTIVE_PREG_CNT = (ACTIVE_PREG_CNT + 1 ) ,
IF ((ACTIVE_PREG_CNT > SIZE (REQUEST_FINAL_EGA->PREGNANCY_LIST ,5 ) ) ) BSTATUS = ALTERLIST (
REQUEST_FINAL_EGA->PREGNANCY_LIST ,(ACTIVE_PREG_CNT + 9 ) ) ,CSTATUS = ALTERLIST (TEMP->PATIENT ,(
ACTIVE_PREG_CNT + 9 ) )
ENDIF
,REQUEST_FINAL_EGA->PREGNANCY_LIST[ACTIVE_PREG_CNT ]->PREGNANCY_ID = PI.PREGNANCY_ID ,TEMP->PATIENT[
ACTIVE_PREG_CNT ]->PREGNANCY_ID = PI.PREGNANCY_ID ,TEMP->PATIENT[ACTIVE_PREG_CNT ]->PERSON_ID =
PI.PERSON_ID ,ORG_CNT = 0
HEAD O.ORGANIZATION_ID
ORG_CNT = (ORG_CNT + 1 ) ,
IF ((ORG_CNT = 1 ) ) TEMP->PATIENT[ACTIVE_PREG_CNT ]->ORG_DISPLAY = TRIM (O.ORG_NAME )
ELSE TEMP->PATIENT[ACTIVE_PREG_CNT ]->ORG_DISPLAY = CONCAT (TEMP->PATIENT[ACTIVE_PREG_CNT ]->
ORG_DISPLAY ," ," ,TRIM (O.ORG_NAME ) )
ENDIF
FOOT REPORT
BSTATUS = ALTERLIST (REQUEST_FINAL_EGA->PREGNANCY_LIST ,ACTIVE_PREG_CNT ) ,
CSTATUS = ALTERLIST (TEMP->PATIENT ,ACTIVE_PREG_CNT )
WITH NOCOUNTER
ENDIF
IF ((DEBUG_IND >= 2 ) )
CALL ECHORECORD (REQUEST_FINAL_EGA )
ENDIF
SET MODIFY = NOPREDECLARE
IF ((VALID_PI_ORG_ID_IND > 0 ) )
EXECUTE DCP_GET_FINAL_EGA WITH REPLACE ("REQUEST" ,REQUEST_FINAL_EGA ) ,
REPLACE ("REPLY" ,REPLY_FINAL_EGA )
ELSE
EXECUTE PCM_WH_GET_FINAL_EGA WITH REPLACE ("REQUEST" ,REQUEST_FINAL_EGA ) ,
REPLACE ("REPLY" ,REPLY_FINAL_EGA )
ENDIF
SET MODIFY = PREDECLARE
IF ((DEBUG_IND >= 2 ) )
CALL ECHORECORD (REPLY_FINAL_EGA )
ENDIF
IF ((REPLY_FINAL_EGA->STATUS_DATA->STATUS = "F" ) )
SET REPLY->STATUS_DATA->STATUS = "F"
SET REPLY->SUBEVENTSTATUS[1 ]->OPERATIONNAME = "Execute"
SET REPLY->SUBEVENTSTATUS[1 ]->OPERATIONSTATUS = "F"
SET REPLY->SUBEVENTSTATUS[1 ]->TARGETOBJECTNAME = "dcp_get_final_ega"
SET REPLY->SUBEVENTSTATUS[1 ]->TARGETOBJECTVALUE = "fail status returned from dcp_get_final_ega"
GO TO EXIT_REPORT
ELSEIF ((SIZE (REPLY_FINAL_EGA->GESTATION_INFO ,5 ) = 0 ) ) GO TO NO_ENCNTR
ENDIF
SELECT INTO "nl:"
FROM (DUMMYT D1 WITH SEQ = SIZE (REPLY_FINAL_EGA->GESTATION_INFO ,5 ) ) ,
(DUMMYT D2 WITH SEQ = SIZE (TEMP->PATIENT ,5 ) )
PLAN (D1 )
AND (D2
WHERE (TEMP->PATIENT[D2.SEQ ]->PREGNANCY_ID = REPLY_FINAL_EGA->GESTATION_INFO[D1.SEQ ]->PREGNANCY_ID
 ) )
DETAIL
TEMP->PATIENT[D2.SEQ ]->R_EST_DELIVERY_DATE = REPLY_FINAL_EGA->GESTATION_INFO[D1.SEQ ]->
EST_DELIVERY_DATE ,
TEMP->PATIENT[D2.SEQ ]->R_DELIVERY_DATE = REPLY_FINAL_EGA->GESTATION_INFO[D1.SEQ ]->DELIVERY_DATE ,
TEMP->PATIENT[D2.SEQ ]->R_GEST_AGE_DELIVERY = REPLY_FINAL_EGA->GESTATION_INFO[D1.SEQ ]->
GEST_AGE_AT_DELIVERY ,
TEMP->PATIENT[D2.SEQ ]->R_CURRENT_GEST_AGE = REPLY_FINAL_EGA->GESTATION_INFO[D1.SEQ ]->
CURRENT_GEST_AGE
WITH NOCOUNTER
SET IREQUESTSIZE = SIZE (TEMP->PATIENT ,5 )
SET EXPAND_TOTAL = (CEIL ((CNVTREAL (IREQUESTSIZE ) / EXPAND_SIZE ) ) * EXPAND_SIZE )
SET BSTATUS = ALTERLIST (TEMP->PATIENT ,EXPAND_TOTAL )
SELECT
IF ((PROMPT11 = 0 ) )
FROM (PREGNANCY_INSTANCE PI ) ,
(PERSON P ) ,
(PERSON_ALIAS PA ) ,
(PREGNANCY_ACTION PRA ) ,
(PERSON P2 ) ,
(DUMMYT D WITH SEQ = VALUE ((1 + ((EXPAND_TOTAL - 1 ) / EXPAND_SIZE ) ) ) )
PLAN (D
WHERE INITARRAY (EXPAND_START ,EVALUATE (D.SEQ ,1 ,1 ,(EXPAND_START + EXPAND_SIZE ) ) ) )
AND (PI
WHERE EXPAND (IDX ,EXPAND_START ,(EXPAND_START + (EXPAND_SIZE - 1 ) ) ,PI.PREGNANCY_ID ,TEMP->
PATIENT[IDX ]->PREGNANCY_ID ) AND (PI.ACTIVE_IND = 1 ) AND (PI.PREG_END_DT_TM >= CNVTDATETIME (
CURDATE ,CURTIME3 ) ) )
AND (P
WHERE (PI.PERSON_ID = P.PERSON_ID ) AND (P.ACTIVE_IND = 1 ) )
AND (PA
WHERE (P.PERSON_ID = PA.PERSON_ID ) AND (PA.PERSON_ALIAS_TYPE_CD IN (MRN_CD ) ) AND (PA.ACTIVE_IND
= 1 ) )
AND (PRA
WHERE (PRA.PREGNANCY_ID = OUTERJOIN (PI.PREGNANCY_ID ) ) )
AND (P2
WHERE (P2.PERSON_ID = OUTERJOIN (PRA.PRSNL_ID ) ) )
ELSE
FROM (PREGNANCY_INSTANCE PI ) ,
(PERSON P ) ,
(PERSON_ALIAS PA ) ,
(PREGNANCY_ACTION PRA ) ,
(PERSON P2 ) ,
(DUMMYT D WITH SEQ = VALUE ((1 + ((EXPAND_TOTAL - 1 ) / EXPAND_SIZE ) ) ) )
PLAN (D
WHERE INITARRAY (EXPAND_START ,EVALUATE (D.SEQ ,1 ,1 ,(EXPAND_START + EXPAND_SIZE ) ) ) )
AND (PI
WHERE EXPAND (IDX ,EXPAND_START ,(EXPAND_START + (EXPAND_SIZE - 1 ) ) ,PI.PREGNANCY_ID ,TEMP->
PATIENT[IDX ]->PREGNANCY_ID ) AND (PI.ACTIVE_IND = 1 ) AND (PI.PREG_END_DT_TM >= CNVTDATETIME (
CURDATE ,CURTIME3 ) ) )
AND (P
WHERE (PI.PERSON_ID = P.PERSON_ID ) AND (P.ACTIVE_IND = 1 ) )
AND (PA
WHERE (P.PERSON_ID = PA.PERSON_ID ) AND (PA.PERSON_ALIAS_TYPE_CD IN (MRN_CD ) ) AND (PA.ACTIVE_IND
= 1 ) )
AND (PRA
WHERE (PRA.PREGNANCY_ID = PI.PREGNANCY_ID ) AND EXPAND (PER_INT ,1 ,ATTENDING->COUNT ,PRA.PRSNL_ID ,
ATTENDING->REC[PER_INT ]->PERSON_ID ) )
AND (P2
WHERE (P2.PERSON_ID = PRA.PRSNL_ID ) )
ENDIF
INTO "nl:"
ORDER BY PI.PREGNANCY_ID ,
PRA.UPDT_DT_TM DESC ,
P.NAME_LAST_KEY ,
P.NAME_FIRST_KEY ,
PA.ALIAS
HEAD REPORT
CNT = 0 ,
Q_CNT = 0
HEAD PI.PREGNANCY_ID
Q_CNT = (Q_CNT + 1 ) ,PREGIDX = LOCATEVAL (IDX ,1 ,IREQUESTSIZE ,PI.PREGNANCY_ID ,TEMP->PATIENT[IDX
]->PREGNANCY_ID ) ,NEW_CUR_GEST_AGE = 0 ,EGA_CALCULATED = 0 ,
IF ((TEMP->PATIENT[IDX ]->R_CURRENT_GEST_AGE = 0 ) AND (TEMP->PATIENT[IDX ]->R_DELIVERY_DATE !=
NULL ) ) NEW_CUR_GEST_AGE = (TEMP->PATIENT[IDX ]->R_GEST_AGE_DELIVERY + DATETIMEDIFF (CNVTDATETIME (
CURDATE ,CURTIME3 ) ,TEMP->PATIENT[IDX ]->R_DELIVERY_DATE ) )
ELSEIF ((TEMP->PATIENT[IDX ]->R_CURRENT_GEST_AGE = 0 ) AND (TEMP->PATIENT[IDX ]->R_EST_DELIVERY_DATE
 != 0 ) ) NEW_CUR_GEST_AGE = ((40 * 7 ) + DATETIMEDIFF (CNVTDATETIME (CURDATE ,CURTIME3 ) ,TEMP->
PATIENT[IDX ]->R_EST_DELIVERY_DATE ) ) ,EGA_CALCULATED = 1
ELSE NEW_CUR_GEST_AGE = TEMP->PATIENT[IDX ]->R_CURRENT_GEST_AGE
ENDIF
,
IF ((CNVTINT ($2 ) = 2 ) )
IF ((TEMP->PATIENT[IDX ]->R_EST_DELIVERY_DATE BETWEEN CNVTDATETIME (VALUE ($6 ) ) AND CNVTDATETIME (
VALUE ($7 ) ) ) ) TEMP->PATIENT[IDX ]->PRINT_IND = 1
ENDIF
ELSEIF ((CNVTINT ($2 ) = 1 ) )
IF ((CNVTINT ($3 ) = 1 ) )
IF ((NEW_CUR_GEST_AGE = (CNVTINT ($4 ) * 7 ) ) ) TEMP->PATIENT[IDX ]->PRINT_IND = 1
ENDIF
ELSEIF ((CNVTINT ($3 ) = 2 ) )
IF ((NEW_CUR_GEST_AGE > (CNVTINT ($4 ) * 7 ) ) ) TEMP->PATIENT[IDX ]->PRINT_IND = 1
ENDIF
ELSEIF ((CNVTINT ($3 ) = 3 ) )
IF ((NEW_CUR_GEST_AGE < (CNVTINT ($4 ) * 7 ) ) ) TEMP->PATIENT[IDX ]->PRINT_IND = 1
ENDIF
ELSEIF ((CNVTINT ($3 ) = 4 ) )
IF ((NEW_CUR_GEST_AGE BETWEEN (CNVTINT ($4 ) * 7 ) AND (CNVTINT ($5 ) * 7 ) ) ) TEMP->PATIENT[IDX ]
->PRINT_IND = 1
ENDIF
ENDIF
ENDIF
,TEMP->PATIENT[IDX ]->MRN = TRIM (PA.ALIAS ) ,TEMP->PATIENT[IDX ]->PERSON_LASTNAME = SUBSTRING (1 ,
18 ,TRIM (P.NAME_LAST ) ) ,TEMP->PATIENT[IDX ]->PERSON_FIRSTNAME = SUBSTRING (1 ,18 ,TRIM (
P.NAME_FIRST ) ) ,
IF ((SIZE (TRIM (P2.NAME_FULL_FORMATTED ) ) > 0 ) ) TEMP->PATIENT[IDX ]->PRIMARY_PHYSICIAN =
P2.NAME_FULL_FORMATTED
ELSE TEMP->PATIENT[IDX ]->PRIMARY_PHYSICIAN = "--"
ENDIF
,
IF ((TEMP->PATIENT[IDX ]->R_EST_DELIVERY_DATE = NULL ) ) TEMP->PATIENT[IDX ]->EDD = "--"
ELSEIF ((TEMP->PATIENT[IDX ]->R_EST_DELIVERY_DATE = 0 ) ) TEMP->PATIENT[IDX ]->EDD = "--"
ELSE TEMP->PATIENT[IDX ]->EDD = FORMAT (TEMP->PATIENT[IDX ]->R_EST_DELIVERY_DATE ,"@SHORTDATE" )
ENDIF
,GESTAGE = NEW_CUR_GEST_AGE ,GESTAGEWEEKS = (GESTAGE / 7 ) ,GESTAGEDAYS = MOD (GESTAGE ,7 ) ,
IF ((GESTAGEDAYS > 0 ) ) TEMP->PATIENT[IDX ]->GEST_AGE = CONCAT (TRIM (CNVTSTRING (GESTAGEWEEKS ) )
," " ,TRIM (CNVTSTRING (GESTAGEDAYS ) ) ,"/7" )
ELSE TEMP->PATIENT[IDX ]->GEST_AGE = BUILD (GESTAGEWEEKS )
ENDIF
,
IF ((GESTAGE = 0 ) ) TEMP->PATIENT[IDX ]->GEST_AGE = "--"
ENDIF
,TEMP->PATIENT[IDX ]->PREGNANCY_ID = PI.PREGNANCY_ID ,TEMP->PATIENT[IDX ]->PERSON_ID = PI.PERSON_ID
,TEMP->PATIENT[IDX ]->EGA = NEW_CUR_GEST_AGE
WITH NOCOUNTER
CALL ECHO (BUILD ("iRequestSize   :" ,IREQUESTSIZE ) )
SET ISTAT = ALTERLIST (TEMP->PATIENT ,IREQUESTSIZE )
SET IERRORCODE = ERROR (SERRORMSG ,1 )
IF ((IERRORCODE != 0 ) )
CALL ECHO ("*********************************" )
CALL ECHO (BUILD ("ERROR MESSAGE : " ,SERRORMSG ) )
CALL ECHO ("*********************************" )
SET REPLY->STATUS_DATA->STATUS = "F"
SET REPLY->SUBEVENTSTATUS[1 ]->OPERATIONNAME = "Execute"
SET REPLY->SUBEVENTSTATUS[1 ]->OPERATIONSTATUS = "F"
SET REPLY->SUBEVENTSTATUS[1 ]->TARGETOBJECTNAME = "DCP_RPT_PREGNANCY_CLOSE_OUT"
SET REPLY->SUBEVENTSTATUS[1 ]->TARGETOBJECTVALUE = "Failure while retrieving pregnancy details"
GO TO EXIT_REPORT
ELSEIF ((SIZE (TEMP->PATIENT ,5 ) = 0 ) )
IF ((DEBUG_IND >= 1 ) )
CALL ECHO ("Printing report - no data " )
ENDIF
GO TO NO_ENCNTR
ELSE
IF ((DEBUG_IND >= 1 ) )
CALL ECHO (BUILD ("Printing report - pregnancy count: " ,SIZE (TEMP->PATIENT ,5 ) ) )
ENDIF
ENDIF
SELECT INTO "nl:"
SORT =
IF ((CNVTINT ($2 ) = 1 ) ) TEMP->PATIENT[D.SEQ ]->EGA
ELSEIF ((CNVTINT ($2 ) = 2 ) ) TEMP->PATIENT[D.SEQ ]->R_EST_DELIVERY_DATE
ENDIF
,
SORT2 = TEMP->PATIENT[D.SEQ ]->PRIMARY_PHYSICIAN ,
SORT3 = TEMP->PATIENT[D.SEQ ]->PERSON_LASTNAME
FROM (DUMMYT D WITH SEQ = SIZE (TEMP->PATIENT ,5 ) )
WHERE (TEMP->PATIENT[D.SEQ ]->PRINT_IND = 1 )
ORDER BY SORT ,
SORT2 ,
SORT3
HEAD REPORT
TEMP_CNT = 0
DETAIL
TEMP_CNT = (TEMP_CNT + 1 ) ,
IF ((TEMP_CNT > SIZE (PREGNANCY->PATIENT ,5 ) ) ) STAT = ALTERLIST (PREGNANCY->PATIENT ,(TEMP_CNT +
99 ) )
ENDIF
,
PREGNANCY->PATIENT[TEMP_CNT ]->MRN = TEMP->PATIENT[D.SEQ ]->MRN ,
PREGNANCY->PATIENT[TEMP_CNT ]->PERSON_LASTNAME = TEMP->PATIENT[D.SEQ ]->PERSON_LASTNAME ,
PREGNANCY->PATIENT[TEMP_CNT ]->PERSON_FIRSTNAME = TEMP->PATIENT[D.SEQ ]->PERSON_FIRSTNAME ,
PREGNANCY->PATIENT[TEMP_CNT ]->GEST_AGE = TEMP->PATIENT[D.SEQ ]->GEST_AGE ,
PREGNANCY->PATIENT[TEMP_CNT ]->EDD = TEMP->PATIENT[D.SEQ ]->EDD ,
PREGNANCY->PATIENT[TEMP_CNT ]->PRIMARY_PHYSICIAN = TEMP->PATIENT[D.SEQ ]->PRIMARY_PHYSICIAN ,
PREGNANCY->PATIENT[TEMP_CNT ]->FACILITY = TEMP->PATIENT[D.SEQ ]->ORG_DISPLAY
FOOT REPORT
STAT = ALTERLIST (PREGNANCY->PATIENT ,TEMP_CNT ) ,
PREGNANCY->PATIENT_CNT = TEMP_CNT
WITH NOCOUNTER
IF ((DEBUG_IND >= 1 ) )
CALL ECHORECORD (PREGNANCY )
ENDIF
CALL ECHORECORD (PREGNANCY )
#NO_ENCNTR
SET IERRORCODE = ERROR (SERRORMSG ,1 )
IF ((IERRORCODE != 0 ) )
CALL ECHO ("*********************************" )
CALL ECHO (BUILD ("ERROR MESSAGE : " ,SERRORMSG ) )
CALL ECHO ("*********************************" )
SET REPLY->STATUS_DATA->STATUS = "F"
SET REPLY->SUBEVENTSTATUS[1 ]->OPERATIONNAME = "Execute"
SET REPLY->SUBEVENTSTATUS[1 ]->OPERATIONSTATUS = "F"
SET REPLY->SUBEVENTSTATUS[1 ]->TARGETOBJECTNAME = "DCP_RPT_PREGNANCY_CLOSE_OUT"
SET REPLY->SUBEVENTSTATUS[1 ]->TARGETOBJECTVALUE = "Failure while printing NO DATA."
ELSE
SET REPLY->STATUS_DATA->STATUS = "S"
ENDIF
GO TO EXIT_REPORT
#EXIT_REPORT
FREE RECORD REQUEST_FINAL_EGA
FREE RECORD REPLY_FINAL_EGA
FREE RECORD ATTENDING
FREE RECORD TEMP
SET MODIFY = NOPREDECLARE
SET SCRIPT_VERSION = "003 12/12/2012 ss026368"
END GO

