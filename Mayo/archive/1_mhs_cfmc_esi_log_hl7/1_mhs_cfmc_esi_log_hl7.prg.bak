;*** Generated by translate command; please verify contents before re-including in CCL ***
/***********************************************************************
 *                  GENERATED MODIFICATION CONTROL LOG                 *
 ***********************************************************************
 *                                                                     *
 *Mod Date     Engineer             Comment                            *
 *--- -------- -------------------- -----------------------------------*
 *000                               translate version                  *
 *001 02/25/11 Akcia                changes to improve efficiency and add db2 code     *
 ***********************************************************************/
 DROP PROGRAM   1_mhs_cfmc_esi_log_hl7 : dba GO
CREATE PROGRAM  1_mhs_cfmc_esi_log_hl7 : dba
prompt
	"Output to File/Printer/MINE" = "MINE"
	, "Enter Contributor System (ie, CFMC_SYS)" = "CFMC_RIMS_SYS"
	, "Enter number of days back for report to run:" = 0
 
with PROMPT1, PROMPT2, PROMPT3

/*** START 001 ***/
;*********************************************************************
;*** If PROD / CERT then run as 2nd oracle instance to improve
;*** efficiency. Will auto Fail-over to Instance 1 if Instance 2 down.
;*********************************************************************
IF(CURDOMAIN = "PROD")
  FREE DEFINE oraclesystem
  DEFINE oraclesystem 'v500/fullmoon@mhprbrpt'
ELSEIF(CURDOMAIN = "MHPRD")
  FREE DEFINE oraclesystem
  DEFINE oraclesystem 'v500/fullmoon@mhprbrpt'
ELSEIF(CURDOMAIN="MHCRT")
  FREE DEFINE oraclesystem
  DEFINE oraclesystem 'v500/java4t2@mhcrtrpt'
ENDIF ;CURDOMAIN
;*** Write instance ccl ran in to the log file
;SET Iname = fillstring(10," ")
;SELECT INTO value("mayo_logfiles:mayo_instance2.log")
;  run_date = format(sysdate,";;q")
; ,Iname = substring(1,7,instance_name)
;FROM v$instance
;DETAIL
;  col  1 run_date
;  col +1 curprog
;  col +1 " *Instance="
;  col +1 Iname
;with nocounter
;   , format
;****************** End of INSTANCE 2 routine ************************
/*** END 001 ***/ 

SELECT  INTO  $1
 MESSAGEDATE =E.MSH_DATE,
 APPLICATION =E.MSH_SENDING_APP,
 PATIENT =E.NAME_FULL_FORMATTED,
 ERROR =E.ERROR_TEXT,
 HL7MESSAGE = SUBSTRING ( 1 ,  650 , O.MSG_TEXT)
FROM ( OEN_TXLOG  O ),
( ESI_LOG  E )
 
;001  WHERE (O.TX_KEY=E.TX_KEY) AND (E.MSH_SENDING_APP= $2 ) AND (E.ERROR_STAT= "ESI_STAT_FAILURE" ) AND (
;001 E.UPDT_DT_TM>= CNVTDATETIME (( CURDATE - $3 ),  0 ))
plan e															;001
where e.create_dt_tm >= cnvtdatetime((curdate - $3),0)			;001
  and e.msh_sending_app = $2									;001
  and e.error_stat = "ESI_STAT_FAILURE"							;001
 
join o															;001
where o.tx_key = e.tx_key	
ORDER BY E.MSH_DATE DESC
 WITH  FORMAT , SEPARATOR = " " , DIO = 38

/*** START 001 ***/
;*** After report put back to instance 1
IF(CURDOMAIN = "PROD")
  FREE DEFINE oraclesystem
  DEFINE oraclesystem 'v500/fullmoon@mhprb1'
ELSEIF(CURDOMAIN = "MHPRD")
  FREE DEFINE oraclesystem
  DEFINE oraclesystem 'v500/fullmoon@mhprb1'
ELSEIF(CURDOMAIN="MHCRT")
  FREE DEFINE oraclesystem
  DEFINE oraclesystem 'v500/java4t2@mhcrt1'
ENDIF ;CURDOMAIN
/*** END 001 ***/ 

END GO
